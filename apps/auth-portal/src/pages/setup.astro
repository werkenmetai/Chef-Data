---
import Layout from '../layouts/Layout.astro';
import { Database } from '../lib/database';

const env = Astro.locals.runtime.env;
const db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

// Check if user is logged in
const sessionId = Astro.cookies.get('session_id')?.value;
let user: { email: string } | null = null;
let apiKey: string | null = null;
let hasConnection = false;
let showApiKeyBanner = false;

// Check for new API key from callback (shown once)
const newApiKey = Astro.cookies.get('new_api_key')?.value;
if (newApiKey) {
  apiKey = newApiKey;
  showApiKeyBanner = true;
  // Clear the cookie after reading (one-time display)
  Astro.cookies.delete('new_api_key', { path: '/' });
}

if (sessionId) {
  const sessionResult = await db.validateSession(sessionId);
  if (sessionResult) {
    user = { email: sessionResult.user.email };
    const connections = await db.getConnectionsByUser(sessionResult.user.id);
    hasConnection = connections.length > 0;
  }
}

// MCP Server URL - general URL for OAuth-based platforms
const mcpUrl = "https://api.praatmetjeboekhouding.nl/mcp";

// Display key for config (use real key or placeholder) - only for Claude Code
const displayKey = apiKey || "JOUW_API_KEY";
---

<Layout title="Setup Instructies">
  <div class="max-w-3xl mx-auto px-4 py-12">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">MCP Configureren</h1>
    <p class="text-gray-600 mb-4">Volg deze stappen om Exact Online te gebruiken met je favoriete AI assistant.</p>

    {/* Progress indicator */}
    <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
      <div class="flex items-center justify-between text-sm">
        <div class="flex items-center gap-2">
          <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${hasConnection ? 'bg-green-500 text-white' : 'bg-exact-blue text-white'}`}>
            {hasConnection ? '✓' : '1'}
          </span>
          <span class={hasConnection ? 'text-green-700 font-medium' : 'text-gray-900 font-medium'}>Verbinden</span>
        </div>
        <div class={`flex-1 h-0.5 mx-2 ${hasConnection ? 'bg-green-500' : 'bg-gray-300'}`}></div>
        <div class="flex items-center gap-2">
          <span class={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${hasConnection ? 'bg-exact-blue text-white' : 'bg-gray-300 text-gray-600'}`}>2</span>
          <span class={hasConnection ? 'text-gray-900 font-medium' : 'text-gray-500'}>Configureren</span>
        </div>
        <div class="flex-1 h-0.5 mx-2 bg-gray-300"></div>
        <div class="flex items-center gap-2">
          <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold bg-gray-300 text-gray-600">3</span>
          <span class="text-gray-500">Herstarten</span>
        </div>
        <div class="flex-1 h-0.5 mx-2 bg-gray-300"></div>
        <div class="flex items-center gap-2">
          <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold bg-gray-300 text-gray-600">4</span>
          <span class="text-gray-500">Testen</span>
        </div>
      </div>
    </div>

    {/* New API Key Banner - shown once after registration */}
    {showApiKeyBanner && apiKey && (
      <div class="mb-8 p-6 bg-green-50 border-2 border-green-300 rounded-xl">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div class="ml-4 flex-1">
            <h3 class="text-lg font-bold text-green-900">Account aangemaakt! Hier is je API Key:</h3>
            <p class="text-green-700 text-sm mt-1 mb-3">
              Bewaar deze key veilig. De configuratie hieronder is al ingevuld met jouw key.
            </p>
            <div class="bg-white rounded-lg border border-green-300 p-3 font-mono text-sm break-all select-all">
              {apiKey}
            </div>
            <button
              id="copyApiKeyBanner"
              data-key={apiKey}
              class="mt-3 px-4 py-2 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700 transition-colors"
            >
              Kopieer API Key
            </button>
          </div>
        </div>
      </div>
    )}

    {/* User status banner */}
    {!showApiKeyBanner && user ? (
      <div class={`mb-8 p-4 rounded-lg border ${hasConnection ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'}`}>
        <p class={hasConnection ? 'text-green-800' : 'text-yellow-800'}>
          {hasConnection ? (
            <>
              <strong>Ingelogd als {user.email}</strong> - Je Exact Online account is verbonden.
              <a href="/dashboard" class="underline ml-2">Naar Dashboard</a>
            </>
          ) : (
            <>
              <strong>Ingelogd als {user.email}</strong> - Je hebt nog geen Exact Online verbonden.
              <a href="/connect" class="underline ml-2">Nu verbinden</a>
            </>
          )}
        </p>
      </div>
    ) : !showApiKeyBanner && (
      <div class="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-blue-800">
          <strong>Nog niet ingelogd?</strong>
          <a href="/connect" class="underline ml-2">Verbind eerst je Exact Online account</a> om een API key te krijgen.
        </p>
      </div>
    )}

    <!-- Prerequisites -->
    <section class="mb-10">
      <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
        <span class="w-8 h-8 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center font-bold mr-3 text-sm">0</span>
        Vereisten
      </h2>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 ml-11">
        <ul class="space-y-2 text-gray-600">
          <li class="flex items-center">
            <svg class="w-5 h-5 text-exact-blue mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Een Exact Online account met toegang tot minimaal 1 administratie
          </li>
          <li class="flex items-center">
            <svg class="w-5 h-5 text-exact-blue mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Een AI assistant met MCP ondersteuning (Claude, Cursor, Windsurf, etc.)
          </li>
        </ul>
      </div>
    </section>

    <!-- Step 1 -->
    <section class="mb-10">
      <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
        <span class={`w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3 text-sm ${hasConnection ? 'bg-green-500 text-white' : 'bg-exact-blue text-white'}`}>
          {hasConnection ? '✓' : '1'}
        </span>
        Verbind Exact Online & krijg API Key
      </h2>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 ml-11">
        {hasConnection ? (
          <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-green-800 font-medium">Je Exact Online account is verbonden!</p>
            <p class="text-green-700 text-sm mt-1">
              Ga naar je <a href="/dashboard" class="underline">Dashboard</a> om je API key te kopiëren of een nieuwe te genereren.
            </p>
          </div>
        ) : (
          <>
            <p class="text-gray-600 mb-4">
              Klik op de knop hieronder om je Exact Online account te verbinden. Na succesvolle verbinding ontvang je een API key.
            </p>
            <a
              href="/connect"
              class="inline-block px-6 py-3 bg-exact-blue text-white font-semibold rounded-lg hover:bg-exact-dark transition-colors"
            >
              Verbinden met Exact Online
            </a>
          </>
        )}
        <div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
          <h4 class="font-medium text-gray-900 mb-2">Na het verbinden ontvang je:</h4>
          <ul class="text-sm text-gray-700 space-y-1">
            <li>• Een persoonlijke <strong>API key</strong> (begint met <code class="bg-gray-200 px-1 rounded">exa_</code>)</li>
            <li>• Toegang tot al je administraties via AI</li>
            <li>• 200 gratis API calls per maand (Free plan)</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Step 2 -->
    <section class="mb-10">
      <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
        <span class="w-8 h-8 bg-exact-blue text-white rounded-full flex items-center justify-center font-bold mr-3 text-sm">2</span>
        Configureer je AI Assistant
      </h2>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 ml-11">
        <!-- Tabs -->
        <div class="flex flex-wrap border-b border-gray-200 mb-4 gap-1">
          <button class="tab-btn px-4 py-2 text-exact-blue border-b-2 border-exact-blue font-medium" data-tab="desktop">
            Claude Desktop
          </button>
          <button class="tab-btn px-4 py-2 text-gray-500 hover:text-gray-700" data-tab="chatgpt">
            ChatGPT
          </button>
          <button class="tab-btn px-4 py-2 text-gray-500 hover:text-gray-700" data-tab="cursor">
            Cursor
          </button>
          <button class="tab-btn px-4 py-2 text-gray-500 hover:text-gray-700" data-tab="windsurf">
            Windsurf
          </button>
          <button class="tab-btn px-4 py-2 text-gray-500 hover:text-gray-700" data-tab="code">
            Claude Code
          </button>
        </div>

        <!-- Claude Desktop Tab -->
        <div id="tab-desktop" class="tab-content">
          <!-- Known bug warning -->
          <div class="mb-6 p-4 bg-amber-50 border border-amber-300 rounded-lg">
            <div class="flex items-start gap-3">
              <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <div>
                <p class="text-amber-800 text-sm font-medium">
                  Bekend probleem bij Anthropic
                </p>
                <p class="text-amber-700 text-sm mt-1">
                  De "Custom Connector" functie in Claude Desktop werkt momenteel niet correct voor remote MCP servers.
                  Je kunt de connector wel lokaal aansluiten via een config bestand.
                </p>
                <p class="text-amber-700 text-sm mt-2">
                  <a href="/docs/claude-desktop-setup" class="underline font-medium">Bekijk de volledige instructies →</a>
                </p>
                <p class="text-amber-600 text-xs mt-2">
                  We houden dit in de gaten en laten het weten als de algemene link weer werkt.
                </p>
              </div>
            </div>
          </div>

          <!-- Aanbevolen: JSON config methode -->
          <div class="mb-6 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
            <h4 class="font-semibold text-green-900 mb-2">Aanbevolen: Via config bestand</h4>
            <p class="text-green-700 text-sm mb-4">
              Open het Claude Desktop configuratiebestand en voeg de connector toe:
            </p>
            <div class="bg-gray-100 rounded-lg p-3 mb-2 text-sm">
              <p class="font-medium text-gray-700">macOS:</p>
              <code class="text-gray-800 break-all">~/Library/Application Support/Claude/claude_desktop_config.json</code>
            </div>
            <div class="bg-gray-100 rounded-lg p-3 mb-4 text-sm">
              <p class="font-medium text-gray-700">Windows:</p>
              <code class="text-gray-800 break-all">%APPDATA%\Claude\claude_desktop_config.json</code>
            </div>
            <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto relative">
              <button class="copy-btn absolute top-2 right-2 px-2 py-1 bg-gray-700 text-gray-300 text-xs rounded hover:bg-gray-600">
                Kopieer
              </button>
              <pre class="text-sm text-gray-100"><code id="config-desktop">{`{
  "mcpServers": {
    "exact-online": {
      "command": "npx",
      "args": ["-y", "mcp-remote", "${mcpUrl}"]
    }
  }
}`}</code></pre>
            </div>
            <p class="text-green-600 text-xs mt-3">
              Herstart Claude Desktop na het opslaan. Bij eerste gebruik log je in met je Exact Online account.
            </p>
          </div>

          <!-- Link naar volledige instructies -->
          <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-blue-800 text-sm">
              <strong>Meer hulp nodig?</strong>
              <a href="/docs/claude-desktop-setup" class="underline ml-1">Bekijk de volledige stap-voor-stap instructies</a>
              met screenshots voor macOS, Windows en Linux.
            </p>
          </div>
        </div>

        <!-- ChatGPT Tab -->
        <div id="tab-chatgpt" class="tab-content hidden">
          <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-green-800 text-sm">
              <strong>ChatGPT Plus/Team/Enterprise vereist</strong> - Connectors zijn alleen beschikbaar voor betaalde abonnementen.
            </p>
          </div>

          <h4 class="font-semibold text-gray-900 mb-3">Stap 1: Developer Mode inschakelen</h4>
          <ol class="list-decimal list-inside space-y-2 text-gray-600 mb-6">
            <li>Open <a href="https://chatgpt.com" target="_blank" class="text-exact-blue hover:underline">chatgpt.com</a> in je browser</li>
            <li>Klik op je <strong>profielfoto</strong> (rechtsboven) → <strong>Settings</strong></li>
            <li>Ga naar <strong>Connectors</strong> → <strong>Advanced settings</strong></li>
            <li>Zet <strong>"Developer mode"</strong> aan</li>
          </ol>

          <h4 class="font-semibold text-gray-900 mb-3">Stap 2: Connector toevoegen</h4>
          <ol class="list-decimal list-inside space-y-2 text-gray-600 mb-6">
            <li>Ga terug naar <strong>Connectors</strong> → klik <strong>Create</strong></li>
            <li>Vul in:
              <ul class="ml-6 mt-2 space-y-1">
                <li>• <strong>Name:</strong> <code class="bg-gray-100 px-1 rounded">Praat met je Boekhouding</code></li>
                <li>• <strong>URL:</strong> kopieer de URL hieronder</li>
                <li>• <strong>Authentication:</strong> <code class="bg-gray-100 px-1 rounded">No authentication</code></li>
              </ul>
            </li>
            <li>Vink aan: <strong>"I trust this application"</strong></li>
            <li>Klik <strong>Create</strong></li>
          </ol>

          <div class="mb-6 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
            <p class="text-green-700 text-sm mb-2">MCP Server URL:</p>
            <div class="flex items-center gap-2">
              <input
                type="text"
                value={mcpUrl}
                readonly
                class="flex-1 bg-white border border-green-300 rounded px-3 py-2 text-sm font-mono"
              />
              <button class="copy-url-btn px-3 py-2 bg-green-600 text-white text-sm font-semibold rounded hover:bg-green-700" data-url={mcpUrl}>
                Kopieer URL
              </button>
            </div>
            <p class="text-green-600 text-xs mt-2">
              ✓ Je logt in via OAuth - geen API key nodig in de URL
            </p>
          </div>

          <h4 class="font-semibold text-gray-900 mb-3">Stap 3: Connector gebruiken in chat</h4>
          <ol class="list-decimal list-inside space-y-2 text-gray-600 mb-6">
            <li>Open een <strong>nieuwe chat</strong></li>
            <li>Klik op <strong>"+"</strong> in de berichtenbalk</li>
            <li>Selecteer <strong>More</strong> → <strong>Developer Mode</strong></li>
            <li>Klik <strong>Add sources</strong></li>
            <li>Schakel je connector in</li>
            <li>Bij eerste gebruik: log in met je Exact Online account</li>
          </ol>
        </div>

        <!-- Cursor Tab -->
        <div id="tab-cursor" class="tab-content hidden">
          <p class="text-gray-600 mb-4">
            In Cursor kun je MCP servers toevoegen via Settings:
          </p>
          <ol class="list-decimal list-inside space-y-2 text-gray-600 mb-4">
            <li>Open Cursor Settings (<kbd class="bg-gray-100 px-1 rounded">Cmd/Ctrl + ,</kbd>)</li>
            <li>Zoek naar "MCP" of ga naar <strong>Features → MCP Servers</strong></li>
            <li>Klik op <strong>Add new MCP server</strong></li>
            <li>Selecteer <strong>SSE</strong> als type</li>
            <li>Plak de URL hieronder</li>
          </ol>

          <div class="mb-6 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
            <p class="text-green-700 text-sm mb-2">MCP Server URL:</p>
            <div class="flex items-center gap-2">
              <input
                type="text"
                value={mcpUrl}
                readonly
                class="flex-1 bg-white border border-green-300 rounded px-3 py-2 text-sm font-mono"
              />
              <button class="copy-url-btn px-3 py-2 bg-green-600 text-white text-sm font-semibold rounded hover:bg-green-700" data-url={mcpUrl}>
                Kopieer URL
              </button>
            </div>
            <p class="text-green-600 text-xs mt-2">
              ✓ Je logt in via OAuth - geen API key nodig
            </p>
          </div>

          <p class="text-gray-600 mb-4">
            Of bewerk handmatig <code class="bg-gray-100 px-1 rounded">~/.cursor/mcp.json</code>:
          </p>
          <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto relative">
            <button class="copy-btn absolute top-2 right-2 px-2 py-1 bg-gray-700 text-gray-300 text-xs rounded hover:bg-gray-600">
              Kopieer
            </button>
            <pre class="text-sm text-gray-100"><code>{`{
  "mcpServers": {
    "exact-online": {
      "url": "${mcpUrl}"
    }
  }
}`}</code></pre>
          </div>
        </div>

        <!-- Windsurf Tab -->
        <div id="tab-windsurf" class="tab-content hidden">
          <p class="text-gray-600 mb-4">
            In Windsurf kun je MCP servers toevoegen via de configuratie:
          </p>

          <div class="mb-6 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
            <p class="text-green-700 text-sm mb-2">MCP Server URL:</p>
            <div class="flex items-center gap-2">
              <input
                type="text"
                value={mcpUrl}
                readonly
                class="flex-1 bg-white border border-green-300 rounded px-3 py-2 text-sm font-mono"
              />
              <button class="copy-url-btn px-3 py-2 bg-green-600 text-white text-sm font-semibold rounded hover:bg-green-700" data-url={mcpUrl}>
                Kopieer URL
              </button>
            </div>
            <p class="text-green-600 text-xs mt-2">
              ✓ Je logt in via OAuth - geen API key nodig
            </p>
          </div>

          <div class="bg-gray-100 rounded-lg p-3 mb-4 text-sm">
            <p class="font-medium text-gray-700">Config bestand:</p>
            <code class="text-gray-800">~/.codeium/windsurf/mcp_config.json</code>
          </div>
          <p class="text-gray-600 mb-4">Voeg deze configuratie toe:</p>
          <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto relative">
            <button class="copy-btn absolute top-2 right-2 px-2 py-1 bg-gray-700 text-gray-300 text-xs rounded hover:bg-gray-600">
              Kopieer
            </button>
            <pre class="text-sm text-gray-100"><code>{`{
  "mcpServers": {
    "exact-online": {
      "serverUrl": "${mcpUrl}"
    }
  }
}`}</code></pre>
          </div>
        </div>

        <!-- Claude Code Tab -->
        <div id="tab-code" class="tab-content hidden">
          <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-blue-800 text-sm">
              <strong>Let op:</strong> Claude Code vereist een API key (andere platforms gebruiken OAuth).
              Genereer een sleutel via je <a href="/dashboard" class="underline">Dashboard</a>.
            </p>
          </div>

          <p class="text-gray-600 mb-4">
            De makkelijkste manier is via de CLI:
          </p>
          <div class="bg-gray-900 rounded-lg p-4 mb-4 overflow-x-auto relative">
            <button class="copy-btn absolute top-2 right-2 px-2 py-1 bg-gray-700 text-gray-300 text-xs rounded hover:bg-gray-600">
              Kopieer
            </button>
            <pre class="text-sm text-gray-100"><code>{`claude mcp add exact-online --transport http "${mcpUrl}" --header "Authorization: Bearer ${displayKey}"`}</code></pre>
          </div>

          {!apiKey && (
            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
              <p class="text-yellow-800 text-sm">
                Vervang <code class="bg-yellow-100 px-1 rounded">JOUW_API_KEY</code> met je sleutel van het <a href="/dashboard" class="underline">Dashboard</a>.
              </p>
            </div>
          )}

          <!-- Remove existing MCP server -->
          <details class="group mb-4">
            <summary class="cursor-pointer text-gray-600 hover:text-gray-900 mb-2">
              <span class="font-medium">Server bestaat al? Eerst verwijderen</span>
            </summary>
            <div class="mt-3 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <p class="text-yellow-800 text-sm mb-3">
                Als je de fout <code class="bg-yellow-100 px-1 rounded">"MCP server exact-online already exists"</code> krijgt:
              </p>
              <div class="bg-gray-900 rounded-lg p-3 mb-3 overflow-x-auto relative">
                <button class="copy-btn absolute top-2 right-2 px-2 py-1 bg-gray-700 text-gray-300 text-xs rounded hover:bg-gray-600">
                  Kopieer
                </button>
                <pre class="text-sm text-gray-100"><code>claude mcp remove exact-online</code></pre>
              </div>
              <p class="text-yellow-700 text-sm">
                Daarna kun je de server opnieuw toevoegen met het commando hierboven.
              </p>
              <div class="mt-3 pt-3 border-t border-yellow-200">
                <p class="text-yellow-800 text-sm font-medium">Andere handige commando's:</p>
                <ul class="text-yellow-700 text-sm mt-1 space-y-1">
                  <li><code class="bg-yellow-100 px-1 rounded">claude mcp list</code> - Toon alle geconfigureerde servers</li>
                  <li><code class="bg-yellow-100 px-1 rounded">claude mcp get exact-online</code> - Toon configuratie van een server</li>
                </ul>
              </div>
            </div>
          </details>

          <p class="text-gray-600 mb-4">
            Of bewerk handmatig <code class="bg-gray-100 px-1 rounded">~/.claude/settings.json</code>:
          </p>
          <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto relative">
            <button class="copy-btn absolute top-2 right-2 px-2 py-1 bg-gray-700 text-gray-300 text-xs rounded hover:bg-gray-600">
              Kopieer
            </button>
            <pre class="text-sm text-gray-100"><code>{`{
  "mcpServers": {
    "exact-online": {
      "url": "${mcpUrl}",
      "headers": {
        "Authorization": "Bearer ${displayKey}"
      }
    }
  }
}`}</code></pre>
          </div>
        </div>

        <!-- API Key reminder - only for Claude Code -->
        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <p class="text-sm text-blue-800">
            <strong>Alleen Claude Code</strong> vereist een API key. Ga naar je <a href="/dashboard" class="text-blue-600 underline">Dashboard</a> om een sleutel te genereren.
            Andere platforms (ChatGPT, Claude Desktop, etc.) gebruiken OAuth login.
          </p>
        </div>
      </div>
    </section>

    <!-- Step 3 -->
    <section class="mb-10">
      <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
        <span class="w-8 h-8 bg-exact-blue text-white rounded-full flex items-center justify-center font-bold mr-3 text-sm">3</span>
        Herstart je AI Assistant
      </h2>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 ml-11">
        <p class="text-gray-600 mb-4">
          Sluit je AI assistant volledig af en start opnieuw op. De MCP server wordt automatisch geladen.
        </p>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <p class="text-yellow-800 text-sm">
            <strong>Tip:</strong> Op macOS gebruik <kbd class="bg-yellow-100 px-1 rounded">Cmd+Q</kbd> om apps volledig af te sluiten. Het kruisje sluit alleen het venster.
          </p>
        </div>
      </div>
    </section>

    <!-- Step 4 -->
    <section class="mb-10">
      <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
        <span class="w-8 h-8 bg-exact-blue text-white rounded-full flex items-center justify-center font-bold mr-3 text-sm">4</span>
        Test de verbinding
      </h2>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 ml-11">
        <p class="text-gray-600 mb-4">
          Open een nieuwe chat en probeer een van deze vragen:
        </p>
        <div class="space-y-3 mb-4">
          <div class="bg-gray-100 rounded-lg p-3 flex items-center justify-between">
            <p class="text-gray-800 italic">"Welke Exact Online administraties heb ik?"</p>
            <button class="copy-example text-xs text-exact-blue hover:underline" data-text="Welke Exact Online administraties heb ik?">kopieer</button>
          </div>
          <div class="bg-gray-100 rounded-lg p-3 flex items-center justify-between">
            <p class="text-gray-800 italic">"Toon alle openstaande facturen"</p>
            <button class="copy-example text-xs text-exact-blue hover:underline" data-text="Toon alle openstaande facturen">kopieer</button>
          </div>
          <div class="bg-gray-100 rounded-lg p-3 flex items-center justify-between">
            <p class="text-gray-800 italic">"Geef een overzicht van de omzet dit jaar"</p>
            <button class="copy-example text-xs text-exact-blue hover:underline" data-text="Geef een overzicht van de omzet dit jaar">kopieer</button>
          </div>
        </div>
        <p class="text-gray-600 text-sm">
          De AI roept automatisch de juiste Exact Online tools aan om je vraag te beantwoorden.
        </p>
      </div>
    </section>

    <!-- What you can do -->
    <section class="mb-10">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Wat kun je vragen?</h2>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <p class="text-gray-600 mb-4">Na configuratie kun je je AI vragen stellen over je Exact Online data:</p>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 bg-gray-50 rounded-lg">
            <p class="font-medium text-gray-900 mb-2">Administraties</p>
            <p class="text-sm text-gray-600">"Welke administraties heb ik toegang tot?"</p>
          </div>
          <div class="p-4 bg-gray-50 rounded-lg">
            <p class="font-medium text-gray-900 mb-2">Relaties & Klanten</p>
            <p class="text-sm text-gray-600">"Toon alle klanten met openstaand saldo"</p>
          </div>
          <div class="p-4 bg-gray-50 rounded-lg">
            <p class="font-medium text-gray-900 mb-2">Facturen</p>
            <p class="text-sm text-gray-600">"Welke facturen zijn meer dan 30 dagen oud?"</p>
          </div>
          <div class="p-4 bg-gray-50 rounded-lg">
            <p class="font-medium text-gray-900 mb-2">Financieel</p>
            <p class="text-sm text-gray-600">"Wat is de winst- en verliesrekening van Q1?"</p>
          </div>
          <div class="p-4 bg-gray-50 rounded-lg">
            <p class="font-medium text-gray-900 mb-2">Artikelen</p>
            <p class="text-sm text-gray-600">"Zoek alle producten met 'printer' in de naam"</p>
          </div>
          <div class="p-4 bg-gray-50 rounded-lg">
            <p class="font-medium text-gray-900 mb-2">Projecten</p>
            <p class="text-sm text-gray-600">"Toon actieve projecten en hun budget"</p>
          </div>
        </div>
        <p class="text-sm text-gray-500 mt-4">
          Bekijk alle 15+ beschikbare tools in de <a href="/docs" class="text-exact-blue hover:underline">Documentatie</a>.
        </p>
      </div>
    </section>

    <!-- Privacy Tip -->
    <section class="mb-10">
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start">
          <div class="flex-shrink-0 text-blue-600 mr-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <h4 class="font-medium text-blue-900">Je kiest zelf welke AI je gebruikt</h4>
            <p class="text-blue-800 text-sm mt-1">
              Wij sturen je boekhouddata naar de AI die jij configureert.
              Check de privacy-instellingen van jouw AI-provider om te bepalen
              hoe zij met je data omgaan.
            </p>
            <a href="/docs/ai-privacy" class="text-blue-600 text-sm font-medium hover:underline mt-2 inline-block">
              Bekijk privacy tips per AI →
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Troubleshooting -->
    <section>
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Problemen oplossen</h2>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="space-y-4">
          <details class="group">
            <summary class="font-medium text-gray-900 cursor-pointer hover:text-exact-blue">
              De AI ziet de MCP server niet
            </summary>
            <ul class="text-gray-600 text-sm mt-2 ml-4 list-disc list-inside space-y-1">
              <li>Controleer of de JSON syntax correct is (geen trailing comma's)</li>
              <li>Zorg dat je de app volledig hebt herstart</li>
              <li>Check of de URL correct is: <code class="bg-gray-100 px-1 rounded">{mcpUrl}</code></li>
            </ul>
          </details>
          <details class="group">
            <summary class="font-medium text-gray-900 cursor-pointer hover:text-exact-blue">
              "Authentication required" of "Unauthorized" fout
            </summary>
            <ul class="text-gray-600 text-sm mt-2 ml-4 list-disc list-inside space-y-1">
              <li>Controleer of je API key correct is gekopieerd (inclusief <code class="bg-gray-100 px-1 rounded">exa_</code> prefix)</li>
              <li>Check of de header exact <code class="bg-gray-100 px-1 rounded">Bearer JOUW_KEY</code> is (met spatie na Bearer)</li>
              <li>Genereer een nieuwe key via <a href="/dashboard" class="text-exact-blue hover:underline">Dashboard</a></li>
            </ul>
          </details>
          <details class="group">
            <summary class="font-medium text-gray-900 cursor-pointer hover:text-exact-blue">
              "No connections found" fout
            </summary>
            <ul class="text-gray-600 text-sm mt-2 ml-4 list-disc list-inside space-y-1">
              <li>Je hebt nog geen Exact Online account verbonden</li>
              <li>Ga naar <a href="/connect" class="text-exact-blue hover:underline">Verbinden</a> om je account te koppelen</li>
            </ul>
          </details>
          <details class="group">
            <summary class="font-medium text-gray-900 cursor-pointer hover:text-exact-blue">
              "Token expired" fout
            </summary>
            <ul class="text-gray-600 text-sm mt-2 ml-4 list-disc list-inside space-y-1">
              <li>Je Exact Online token is verlopen (na 30+ dagen inactiviteit)</li>
              <li><a href="/connect" class="text-exact-blue hover:underline">Verbind opnieuw</a> om een nieuwe token te krijgen</li>
            </ul>
          </details>
        </div>
        <div class="mt-6 pt-4 border-t border-gray-100">
          <p class="text-gray-600">
            Nog steeds problemen? <a href="mailto:support@praatmetjeboekhouding.nl" class="text-exact-blue hover:underline">Neem contact op</a> of bekijk de <a href="/faq" class="text-exact-blue hover:underline">FAQ</a>.
          </p>
        </div>
      </div>
    </section>

    <!-- External Resources -->
    <section class="mb-10">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Externe bronnen</h2>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <p class="text-gray-600 mb-4">Meer hulp nodig? Bekijk deze gidsen:</p>
        <ul class="space-y-2 text-gray-600">
          <li class="flex items-start">
            <svg class="w-5 h-5 text-exact-blue mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
            <a href="https://developers.make.com/mcp-server/connect-using-mcp-token/usage-with-chatgpt" target="_blank" rel="noopener" class="text-exact-blue hover:underline">
              Make.com: MCP gebruiken met ChatGPT
            </a>
            <span class="text-gray-500 text-sm ml-2">- Gedetailleerde gids voor ChatGPT MCP setup</span>
          </li>
          <li class="flex items-start">
            <svg class="w-5 h-5 text-exact-blue mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
            <a href="https://modelcontextprotocol.io/" target="_blank" rel="noopener" class="text-exact-blue hover:underline">
              Model Context Protocol (MCP)
            </a>
            <span class="text-gray-500 text-sm ml-2">- Officiële MCP documentatie</span>
          </li>
        </ul>
      </div>
    </section>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const button = btn as HTMLElement;
        const tabId = button.dataset.tab;

        // Update buttons
        document.querySelectorAll('.tab-btn').forEach(b => {
          b.classList.remove('text-exact-blue', 'border-b-2', 'border-exact-blue', 'font-medium');
          b.classList.add('text-gray-500');
        });
        btn.classList.add('text-exact-blue', 'border-b-2', 'border-exact-blue', 'font-medium');
        btn.classList.remove('text-gray-500');

        // Update content
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`tab-${tabId}`)?.classList.remove('hidden');
      });
    });

    // Copy API key banner button
    const copyApiKeyBanner = document.getElementById('copyApiKeyBanner');
    if (copyApiKeyBanner) {
      copyApiKeyBanner.addEventListener('click', () => {
        const key = copyApiKeyBanner.getAttribute('data-key');
        if (key) {
          navigator.clipboard.writeText(key);
          copyApiKeyBanner.textContent = 'Gekopieerd!';
          setTimeout(() => copyApiKeyBanner.textContent = 'Kopieer API Key', 2000);
        }
      });
    }

    // Copy buttons for config
    document.querySelectorAll('.copy-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const button = btn as HTMLElement;
        const code = button.parentElement?.querySelector('code')?.textContent;
        if (code) {
          navigator.clipboard.writeText(code);
          button.textContent = 'Gekopieerd!';
          setTimeout(() => button.textContent = 'Kopieer', 2000);
        }
      });
    });

    // Copy example questions
    document.querySelectorAll('.copy-example').forEach((btn) => {
      btn.addEventListener('click', () => {
        const button = btn as HTMLElement;
        const text = button.dataset.text;
        if (text) {
          navigator.clipboard.writeText(text);
          button.textContent = 'gekopieerd!';
          setTimeout(() => button.textContent = 'kopieer', 2000);
        }
      });
    });

    // Copy URL buttons
    document.querySelectorAll('.copy-url-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const button = btn as HTMLElement;
        const url = button.dataset.url;
        if (url) {
          navigator.clipboard.writeText(url);
          button.textContent = 'Gekopieerd!';
          setTimeout(() => button.textContent = 'Kopieer URL', 2000);
        }
      });
    });
  </script>
</Layout>
