---
/**
 * Admin Inbox Thread View
 *
 * Shows a communication event with full context:
 * - Full message content
 * - Related messages (same conversation or email thread)
 * - Reply functionality
 */
import Layout from '../../../layouts/Layout.astro';
import { Database } from '../../../lib/database';

const { id } = Astro.params;

// Check admin access
const env = Astro.locals.runtime?.env;
const sessionId = Astro.cookies.get('session_id')?.value;

if (!env?.DB || !sessionId) {
  return Astro.redirect('/connect');
}

const db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);
const session = await db.validateSession(sessionId);

if (!session) {
  return Astro.redirect('/connect');
}

const adminEmails = (env.ADMIN_EMAILS || '').split(',').map((e: string) => e.trim().toLowerCase());
const isAdmin = adminEmails.includes(session.user.email.toLowerCase());

if (!isAdmin) {
  return Astro.redirect('/dashboard');
}

// Get the main communication event
const comm = await env.DB.prepare(`
  SELECT
    ce.*,
    u.id as customer_id,
    u.email as user_email,
    u.name as user_name
  FROM communication_events ce
  LEFT JOIN users u ON ce.user_id = u.id
  WHERE ce.id = ?
`).bind(id).first<any>();

if (!comm) {
  return Astro.redirect('/admin/inbox');
}

// Parse metadata
function parseMetadata(metadataStr: string | null): Record<string, unknown> {
  if (!metadataStr) return {};
  try {
    return JSON.parse(metadataStr);
  } catch {
    return {};
  }
}

const metadata = parseMetadata(comm.metadata);

// Get related messages
let relatedMessages: any[] = [];

if (comm.related_id) {
  // Has a conversation_id - get all messages from that conversation
  const related = await env.DB.prepare(`
    SELECT
      ce.*,
      u.email as user_email,
      u.name as user_name
    FROM communication_events ce
    LEFT JOIN users u ON ce.user_id = u.id
    WHERE ce.related_id = ? AND ce.id != ?
    ORDER BY ce.created_at ASC
  `).bind(comm.related_id, id).all();
  relatedMessages = related.results || [];
} else if (metadata.from_email) {
  // Unknown sender - find other messages from same email
  const fromEmail = (metadata.from_email as string).toLowerCase();
  const related = await env.DB.prepare(`
    SELECT
      ce.*,
      u.email as user_email,
      u.name as user_name
    FROM communication_events ce
    LEFT JOIN users u ON ce.user_id = u.id
    WHERE ce.id != ?
      AND (
        ce.metadata LIKE ?
        OR ce.metadata LIKE ?
      )
    ORDER BY ce.created_at ASC
    LIMIT 20
  `).bind(id, `%"from_email":"${fromEmail}"%`, `%"to_email":"${fromEmail}"%`).all();
  relatedMessages = related.results || [];
} else if (comm.user_id) {
  // Known user but no conversation - get recent messages for this user
  const related = await env.DB.prepare(`
    SELECT
      ce.*,
      u.email as user_email,
      u.name as user_name
    FROM communication_events ce
    LEFT JOIN users u ON ce.user_id = u.id
    WHERE ce.user_id = ? AND ce.id != ?
    ORDER BY ce.created_at DESC
    LIMIT 10
  `).bind(comm.user_id, id).all();
  relatedMessages = (related.results || []).reverse();
}

// Combine current message with related, sorted by date
const allMessages = [...relatedMessages, comm].sort((a, b) =>
  new Date(a.created_at).getTime() - new Date(b.created_at).getTime()
);

function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  return date.toLocaleString('nl-NL', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function getDirectionLabel(direction: string): string {
  return direction === 'out' ? 'Ontvangen' : 'Verzonden';
}

function getDirectionColor(direction: string): string {
  return direction === 'out' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
}

const contactEmail = metadata.from_email || metadata.to_email || comm.user_email || 'Onbekend';
const contactName = comm.user_name || (metadata.from_email as string)?.split('@')[0] || 'Onbekend';
const isUnknown = !comm.user_id;
---

<Layout title={`Inbox: ${comm.subject || 'Bericht'}`} noindex={true}>
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200">
      <div class="max-w-4xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <a href="/admin/inbox" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
            </a>
            <div>
              <h1 class="text-xl font-bold text-gray-900">{comm.subject || '(geen onderwerp)'}</h1>
              <p class="text-sm text-gray-500">
                {allMessages.length} bericht{allMessages.length !== 1 ? 'en' : ''} in dit gesprek
              </p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            {comm.user_id && (
              <a
                href={`/admin/customer/${comm.user_id}`}
                class="px-3 py-1.5 bg-exact-blue text-white rounded-lg hover:bg-exact-dark transition-colors text-sm"
              >
                Bekijk klant
              </a>
            )}
            <button
              onclick="document.getElementById('reply-form').classList.toggle('hidden')"
              class="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm"
            >
              Reageer
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 py-6">
      <!-- Contact info -->
      <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center">
            <span class="text-xl font-bold text-gray-600">
              {contactName.charAt(0).toUpperCase()}
            </span>
          </div>
          <div>
            <p class="font-medium text-gray-900">{contactName}</p>
            <p class="text-sm text-gray-500">{contactEmail}</p>
          </div>
          {isUnknown && (
            <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs font-medium">
              Onbekende afzender
            </span>
          )}
        </div>
      </div>

      <!-- Reply form (hidden by default) -->
      <div id="reply-form" class="hidden bg-white rounded-lg border border-gray-200 p-4 mb-6">
        <h3 class="font-medium text-gray-900 mb-3">Reageer</h3>
        <form id="reply-form-element" class="space-y-4">
          <input type="hidden" name="toEmail" value={contactEmail} />
          <input type="hidden" name="userId" value={comm.user_id || ''} />
          <input type="hidden" name="conversationId" value={comm.related_id || ''} />

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Onderwerp</label>
            <input
              type="text"
              name="subject"
              value={`Re: ${comm.subject || ''}`}
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-exact-blue focus:border-exact-blue"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Bericht</label>
            <textarea
              name="content"
              rows="5"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-exact-blue focus:border-exact-blue"
              placeholder="Typ je reactie..."
            ></textarea>
          </div>

          <div>
            <div class="flex items-center justify-between mb-1">
              <label class="text-sm font-medium text-gray-700">Handtekening</label>
              <button
                type="button"
                onclick="document.getElementById('signature-field').classList.toggle('hidden'); document.getElementById('signature-preview').classList.toggle('hidden');"
                class="text-xs text-exact-blue hover:underline"
              >
                Aanpassen
              </button>
            </div>
            <textarea
              id="signature-field"
              name="signature"
              rows="3"
              class="hidden w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-exact-blue focus:border-exact-blue text-sm"
              placeholder="Met vriendelijke groet,&#10;Naam&#10;Praat met je Boekhouding Support"
            ></textarea>
            <p id="signature-preview" class="text-sm text-gray-500 italic">Laden...</p>
          </div>

          <div class="flex items-center gap-3">
            <label class="flex items-center gap-2">
              <input type="checkbox" name="sendEmail" checked class="rounded border-gray-300 text-exact-blue focus:ring-exact-blue" />
              <span class="text-sm text-gray-700">Ook per email versturen</span>
            </label>
          </div>

          <div class="flex justify-end gap-2">
            <button
              type="button"
              onclick="document.getElementById('reply-form').classList.add('hidden')"
              class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
            >
              Annuleren
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-exact-blue text-white rounded-lg hover:bg-exact-dark transition-colors"
            >
              Versturen
            </button>
          </div>
        </form>
      </div>

      <!-- Message thread -->
      <div class="space-y-4">
        {allMessages.map((msg: any) => {
          const msgMeta = parseMetadata(msg.metadata);
          const isCurrentMessage = msg.id === id;
          const isSent = msg.direction === 'in';

          return (
            <div
              class={`bg-white rounded-lg border ${isCurrentMessage ? 'border-exact-blue ring-2 ring-exact-blue/20' : 'border-gray-200'}`}
              id={msg.id}
            >
              <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class={`px-2 py-0.5 rounded text-xs font-medium ${getDirectionColor(msg.direction)}`}>
                    {getDirectionLabel(msg.direction)}
                  </span>
                  <span class="text-sm text-gray-600">
                    {isSent ? 'Naar' : 'Van'}: {isSent ? (msg.user_email || msgMeta.to_email || 'Klant') : (msgMeta.from_email || msg.user_email || 'Onbekend')}
                  </span>
                </div>
                <span class="text-sm text-gray-500">{formatDate(msg.created_at)}</span>
              </div>
              <div class="p-4">
                {msg.subject && (
                  <p class="font-medium text-gray-900 mb-2">{msg.subject}</p>
                )}
                <div class="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap">
                  {msg.content || '(geen inhoud)'}
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('reply-form-element') as HTMLFormElement;
    const signatureField = document.getElementById('signature-field') as HTMLTextAreaElement;
    const signaturePreview = document.getElementById('signature-preview');

    // Load admin's saved signature
    async function loadSignature() {
      try {
        const res = await fetch('/api/admin/signature');
        const data = await res.json() as { signature?: string; isDefault?: boolean; error?: string };

        if (res.ok && data.signature) {
          if (signatureField) {
            signatureField.value = data.signature;
          }
          if (signaturePreview) {
            signaturePreview.textContent = data.signature.replace(/\n/g, ' - ');
          }
        }
      } catch (err) {
        console.error('Error loading signature:', err);
        if (signaturePreview) {
          signaturePreview.textContent = 'Kon handtekening niet laden';
        }
      }
    }

    // Load signature on page load
    loadSignature();

    // Toggle signature preview visibility when field is shown/hidden
    signatureField?.addEventListener('input', () => {
      if (signaturePreview) {
        signaturePreview.textContent = signatureField.value.replace(/\n/g, ' - ');
      }
    });

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const sigField = document.getElementById('signature-field') as HTMLTextAreaElement;
      // Always include the signature (loaded from API or edited by admin)
      const signature = sigField?.value || undefined;

      const data = {
        toEmail: formData.get('toEmail'),
        userId: formData.get('userId') || undefined,
        subject: formData.get('subject'),
        content: formData.get('content'),
        conversationId: formData.get('conversationId') || undefined,
        sendEmail: formData.get('sendEmail') === 'on',
        signature,
      };

      try {
        const res = await fetch('/api/admin/reply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await res.json() as { error?: string };

        if (res.ok) {
          alert('Reactie verstuurd!');
          location.reload();
        } else {
          alert('Fout: ' + (result.error || 'Onbekende fout'));
        }
      } catch (err) {
        alert('Fout bij versturen');
      }
    });
  </script>
</Layout>
