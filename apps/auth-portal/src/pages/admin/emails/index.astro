---
/**
 * Admin Email Logs Dashboard
 *
 * Overview of all sent emails with filtering and pagination.
 */
import Layout from '../../../layouts/Layout.astro';
// AdminAppLauncher now in Layout.astro header
import { Database, type EmailLogWithUser } from '../../../lib/database';

const env = Astro.locals.runtime?.env;
let db: Database | null = null;
let isAdmin = false;

interface EmailStats {
  total: number;
  sent: number;
  failed: number;
  devMode: number;
}

let emails: EmailLogWithUser[] = [];
let totalCount = 0;
let stats: EmailStats = {
  total: 0,
  sent: 0,
  failed: 0,
  devMode: 0,
};

// Filters
const filterStatus = Astro.url.searchParams.get('status') || '';
const filterStartDate = Astro.url.searchParams.get('start_date') || '';
const filterEndDate = Astro.url.searchParams.get('end_date') || '';
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const limit = 50;
const offset = (page - 1) * limit;

try {
  if (env?.DB) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());

        if (isAdmin) {
          // Get filtered emails
          const result = await db.getEmailLogs({
            status: filterStatus || undefined,
            startDate: filterStartDate || undefined,
            endDate: filterEndDate || undefined,
            limit,
            offset,
          });

          emails = result.emails;
          totalCount = result.total;

          // Get stats
          const statsResult = await env.DB.prepare(`
            SELECT
              COUNT(*) as total,
              SUM(CASE WHEN status = 'sent' THEN 1 ELSE 0 END) as sent,
              SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed,
              SUM(CASE WHEN status = 'dev_mode' THEN 1 ELSE 0 END) as dev_mode
            FROM email_log
          `).first<{ total: number; sent: number; failed: number; dev_mode: number }>();

          if (statsResult) {
            stats = {
              total: statsResult.total || 0,
              sent: statsResult.sent || 0,
              failed: statsResult.failed || 0,
              devMode: statsResult.dev_mode || 0,
            };
          }
        }
      }
    }
  }
} catch (e) {
  console.error('Admin emails error:', e);
}

const totalPages = Math.ceil(totalCount / limit);

const statusColors: Record<string, { bg: string; text: string }> = {
  sent: { bg: 'bg-green-100', text: 'text-green-800' },
  failed: { bg: 'bg-red-100', text: 'text-red-800' },
  dev_mode: { bg: 'bg-yellow-100', text: 'text-yellow-800' },
};

const statusLabels: Record<string, string> = {
  sent: 'Verzonden',
  failed: 'Mislukt',
  dev_mode: 'Dev Mode',
};

function formatDateTime(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleString('nl-NL', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}

function buildPageUrl(newPage: number): string {
  const params = new URLSearchParams();
  if (filterStatus) params.set('status', filterStatus);
  if (filterStartDate) params.set('start_date', filterStartDate);
  if (filterEndDate) params.set('end_date', filterEndDate);
  params.set('page', String(newPage));
  return `/admin/emails?${params.toString()}`;
}

// Pre-compute page numbers to avoid <= operators in template (Astro parser issue)
function getPageNumbers(): number[] {
  const maxVisible = Math.min(5, totalPages);
  return Array.from({ length: maxVisible }, (_, i) => {
    if (totalPages < 6) return i + 1;
    if (page < 4) return i + 1;
    if (page > totalPages - 3) return totalPages - 4 + i;
    return page - 2 + i;
  });
}
const pageNumbers = getPageNumbers();
---

<Layout title="Email Logs">
  <div class="max-w-7xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          &larr; Terug naar Dashboard
        </a>
      </div>
    ) : (
      <>
        <!-- Header with App Launcher -->
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Email Logs</h1>
            <p class="text-gray-600">Overzicht van alle verzonden emails</p>
          </div>
          <a
            href="/admin"
            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
          >
            &larr; Admin Home
          </a>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500">Totaal</h3>
            <p class="text-3xl font-bold text-gray-900 mt-2">{stats.total}</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500">Verzonden</h3>
            <p class="text-3xl font-bold text-green-600 mt-2">{stats.sent}</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500">Mislukt</h3>
            <p class="text-3xl font-bold text-red-600 mt-2">{stats.failed}</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500">Dev Mode</h3>
            <p class="text-3xl font-bold text-yellow-600 mt-2">{stats.devMode}</p>
          </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
          <form method="GET" class="flex flex-wrap gap-4 items-end">
            <div>
              <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select
                name="status"
                id="status"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              >
                <option value="">Alle statussen</option>
                <option value="sent" selected={filterStatus === 'sent'}>Verzonden</option>
                <option value="failed" selected={filterStatus === 'failed'}>Mislukt</option>
                <option value="dev_mode" selected={filterStatus === 'dev_mode'}>Dev Mode</option>
              </select>
            </div>

            <div>
              <label for="start_date" class="block text-sm font-medium text-gray-700 mb-1">Van datum</label>
              <input
                type="date"
                name="start_date"
                id="start_date"
                value={filterStartDate}
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              />
            </div>

            <div>
              <label for="end_date" class="block text-sm font-medium text-gray-700 mb-1">Tot datum</label>
              <input
                type="date"
                name="end_date"
                id="end_date"
                value={filterEndDate}
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              />
            </div>

            <button
              type="submit"
              class="px-4 py-2 bg-exact-blue text-white font-medium rounded-lg hover:bg-exact-dark transition-colors"
            >
              Filter
            </button>

            {(filterStatus || filterStartDate || filterEndDate) && (
              <a
                href="/admin/emails"
                class="px-4 py-2 text-gray-600 hover:text-gray-900"
              >
                Reset
              </a>
            )}
          </form>
        </div>

        <!-- Email Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          {emails.length === 0 ? (
            <div class="p-8 text-center text-gray-500">
              Geen emails gevonden
            </div>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Datum/Tijd</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Ontvanger</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Onderwerp</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Template</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Gebruiker</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                  {emails.map((email) => {
                    const colors = statusColors[email.status] || { bg: 'bg-gray-100', text: 'text-gray-800' };
                    return (
                      <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                          {formatDateTime(email.sent_at)}
                        </td>
                        <td class="px-4 py-3">
                          <span class="text-sm font-medium text-gray-900">{email.to_email}</span>
                        </td>
                        <td class="px-4 py-3">
                          <span class="text-sm text-gray-900" title={email.subject}>
                            {email.subject.length > 50 ? email.subject.substring(0, 50) + '...' : email.subject}
                          </span>
                          {email.error_message && (
                            <p class="text-xs text-red-600 mt-1" title={email.error_message}>
                              {email.error_message.length > 60 ? email.error_message.substring(0, 60) + '...' : email.error_message}
                            </p>
                          )}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                          {email.template_name || '-'}
                        </td>
                        <td class="px-4 py-3">
                          <span class={`px-2 py-1 rounded-full text-xs font-medium ${colors.bg} ${colors.text}`}>
                            {statusLabels[email.status] || email.status}
                          </span>
                        </td>
                        <td class="px-4 py-3">
                          {email.user_name || email.user_email ? (
                            <div>
                              <span class="text-sm text-gray-900">{email.user_name || '-'}</span>
                              {email.user_email && (
                                <p class="text-xs text-gray-500">{email.user_email}</p>
                              )}
                            </div>
                          ) : (
                            <span class="text-sm text-gray-400">-</span>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </div>

        <!-- Pagination -->
        {totalPages > 1 && (
          <div class="mt-6 flex items-center justify-between">
            <p class="text-sm text-gray-600">
              Toon {offset + 1} - {Math.min(offset + limit, totalCount)} van {totalCount} emails
            </p>
            <div class="flex gap-2">
              {page > 1 && (
                <a
                  href={buildPageUrl(page - 1)}
                  class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  &larr; Vorige
                </a>
              )}

              {/* Page numbers */}
              <div class="flex gap-1">
                {pageNumbers.map((pageNum) => (
                    <a
                      href={buildPageUrl(pageNum)}
                      class={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        pageNum === page
                          ? 'bg-exact-blue text-white'
                          : 'border border-gray-300 text-gray-700 hover:bg-gray-50'
                      }`}
                    >
                      {pageNum}
                    </a>
                ))}
              </div>

              {page < totalPages && (
                <a
                  href={buildPageUrl(page + 1)}
                  class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  Volgende &rarr;
                </a>
              )}
            </div>
          </div>
        )}

        <!-- Info about email logging -->
        <div class="mt-8 p-4 bg-gray-50 rounded-xl border border-gray-200">
          <h3 class="font-semibold text-gray-900 mb-2">Over Email Logs</h3>
          <p class="text-sm text-gray-600">
            Alle verzonden emails worden gelogd voor debugging en audit doeleinden.
            In development mode (dev_mode) worden emails niet daadwerkelijk verzonden,
            maar wel gelogd zodat je kunt zien welke emails zouden worden verstuurd.
          </p>
        </div>
      </>
    )}
  </div>
</Layout>
