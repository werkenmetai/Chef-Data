---
/**
 * OAuth Login Page
 *
 * This page handles the OAuth authorization flow for MCP clients (like Claude).
 * It authenticates the user and generates an authorization code.
 *
 * Security features:
 * - redirect_uri validation against registered URIs (HIGH fix)
 * - CSRF token validation on POST (HIGH fix)
 * - try/catch error handling (HIGH fix)
 */
import Layout from '../../layouts/Layout.astro';
import { Database } from '../../lib/database';

const env = Astro.locals.runtime?.env;
const db = env?.DB ? new Database(env.DB, env.TOKEN_ENCRYPTION_KEY) : null;

// Get OAuth parameters from URL
const url = new URL(Astro.request.url);
const authRequestId = url.searchParams.get('auth_request_id');
const clientId = url.searchParams.get('client_id');
const redirectUri = url.searchParams.get('redirect_uri');
const scope = url.searchParams.get('scope') || 'openid profile';
const state = url.searchParams.get('state') || '';
const codeChallenge = url.searchParams.get('code_challenge');
const codeChallengeMethod = url.searchParams.get('code_challenge_method') || 'S256';

// Check for session
const sessionId = Astro.cookies.get('session_id')?.value;
let isAuthenticated = false;
let user: { id: string; email: string; name: string | null } | null = null;
let clientName = 'Unknown Client';
let error: string | null = null;

// Validate required parameters
if (!clientId || !redirectUri || !codeChallenge) {
  error = 'Invalid authorization request. Missing required parameters.';
}

// Get client info AND validate redirect_uri (HIGH security fix)
let registeredRedirectUris: string[] = [];
if (db && clientId && !error) {
  const client = await db.getDb().prepare(`
    SELECT client_name, redirect_uris FROM oauth_clients WHERE client_id = ?
  `).bind(clientId).first<{ client_name: string; redirect_uris: string }>();

  if (!client) {
    error = 'Unknown OAuth client.';
  } else {
    clientName = client.client_name;

    // Parse and validate redirect_uri against registered URIs
    try {
      registeredRedirectUris = JSON.parse(client.redirect_uris || '[]');
      if (!registeredRedirectUris.includes(redirectUri!)) {
        error = 'Invalid redirect URI for this client.';
        console.error(`[OAuth] redirect_uri mismatch: ${redirectUri} not in ${client.redirect_uris}`);
      }
    } catch (e) {
      error = 'Client configuration error.';
      console.error('[OAuth] Failed to parse redirect_uris:', e);
    }
  }
}

// Check if user is logged in
let hasExactConnection = false;
if (db && sessionId && !error) {
  const sessionResult = await db.validateSession(sessionId);
  if (sessionResult) {
    isAuthenticated = true;
    user = {
      id: sessionResult.user.id,
      email: sessionResult.user.email,
      name: sessionResult.user.name,
    };

    // P22 FIX: Check if user has connected Exact Online (has entries in user_divisions)
    // Without this, user can authorize MCP but tools will fail with "no_division_linked"
    const divisionCheck = await db.getDb().prepare(`
      SELECT COUNT(*) as count FROM user_divisions WHERE oauth_user_id = ?
    `).bind(sessionResult.user.id).first<{ count: number }>();

    hasExactConnection = (divisionCheck?.count ?? 0) > 0;
  }
}

// If user is authenticated but has no Exact connection, redirect to connect first
if (isAuthenticated && !hasExactConnection && !error) {
  return Astro.redirect(`/connect?oauth_return=${encodeURIComponent(url.toString())}`);
}

// Generate CSRF token for form protection (HIGH security fix)
// Token = HMAC(sessionId + timestamp_bucket, secret)
// Using session-only CSRF to avoid URL encoding issues with OAuth params
async function generateCsrfToken(): Promise<string> {
  if (!sessionId) return '';
  // Use 10-minute time buckets to allow for slight timing differences
  const timeBucket = Math.floor(Date.now() / (10 * 60 * 1000));
  const data = `${sessionId}:oauth-consent:${timeBucket}`;
  const encoder = new TextEncoder();
  const key = await crypto.subtle.importKey(
    'raw',
    encoder.encode(env?.TOKEN_ENCRYPTION_KEY || 'csrf-fallback-key'),
    { name: 'HMAC', hash: 'SHA-256' },
    false,
    ['sign']
  );
  const signature = await crypto.subtle.sign('HMAC', key, encoder.encode(data));
  return Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('').slice(0, 32);
}

// Also check previous time bucket (in case of bucket boundary crossing)
async function validateCsrfToken(submitted: string | null): Promise<boolean> {
  if (!submitted || !sessionId) return false;
  const current = await generateCsrfToken();
  if (submitted === current) return true;

  // Check previous bucket
  const prevBucket = Math.floor(Date.now() / (10 * 60 * 1000)) - 1;
  const prevData = `${sessionId}:oauth-consent:${prevBucket}`;
  const encoder = new TextEncoder();
  const key = await crypto.subtle.importKey(
    'raw',
    encoder.encode(env?.TOKEN_ENCRYPTION_KEY || 'csrf-fallback-key'),
    { name: 'HMAC', hash: 'SHA-256' },
    false,
    ['sign']
  );
  const signature = await crypto.subtle.sign('HMAC', key, encoder.encode(prevData));
  const prevToken = Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('').slice(0, 32);
  return submitted === prevToken;
}

const csrfToken = isAuthenticated ? await generateCsrfToken() : '';

// Handle authorization (POST request) with try/catch (HIGH security fix)
if (Astro.request.method === 'POST' && isAuthenticated && user && db && !error) {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get('action');
    const submittedCsrf = formData.get('csrf_token');

    // Get OAuth params from form (more reliable than URL re-parsing)
    const formClientId = formData.get('client_id') as string || clientId;
    const formRedirectUri = formData.get('redirect_uri') as string || redirectUri;
    const formCodeChallenge = formData.get('code_challenge') as string || codeChallenge;
    const formCodeChallengeMethod = formData.get('code_challenge_method') as string || codeChallengeMethod;
    const formScope = formData.get('scope') as string || scope;
    const formState = formData.get('state') as string || state;

    // Validate CSRF token using session-based validation with time bucket tolerance
    const csrfValid = await validateCsrfToken(submittedCsrf as string | null);
    if (!csrfValid) {
      error = 'Beveiligingstoken ongeldig. Ververs de pagina en probeer opnieuw.';
      console.error('[OAuth] CSRF token validation failed - sessionId exists:', !!sessionId);
    } else if (action === 'authorize') {
      // Validate required params
      if (!formClientId || !formRedirectUri || !formCodeChallenge) {
        error = 'Ontbrekende OAuth parameters. Start de autorisatie opnieuw.';
        console.error('[OAuth] Missing params - clientId:', !!formClientId, 'redirectUri:', !!formRedirectUri, 'codeChallenge:', !!formCodeChallenge);
      } else {
        // Generate authorization code
        const code = crypto.randomUUID().replace(/-/g, '') + crypto.randomUUID().replace(/-/g, '');
        const codeId = crypto.randomUUID();
        const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes

        // Store authorization code
        await db.getDb().prepare(`
          INSERT INTO oauth_auth_codes (
            id, code, client_id, user_id, redirect_uri, scope,
            code_challenge, code_challenge_method, expires_at
          )
          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(
          codeId,
          code,
          formClientId,
          user.id,
          formRedirectUri,
          formScope,
          formCodeChallenge,
          formCodeChallengeMethod,
          expiresAt.toISOString()
        ).run();

        // Build the redirect URL
        const redirectUrl = new URL(formRedirectUri);
        redirectUrl.searchParams.set('code', code);
        if (formState) {
          redirectUrl.searchParams.set('state', formState);
        }

        // Direct redirect for all cases (including localhost)
        // ChatGPT desktop and other MCP clients expect immediate redirect
        return Astro.redirect(redirectUrl.toString());
      }
    } else if (action === 'deny') {
      // Redirect back to client with error
      if (!formRedirectUri) {
        error = 'Geen redirect URI beschikbaar.';
      } else {
        const redirectUrl = new URL(formRedirectUri);
        redirectUrl.searchParams.set('error', 'access_denied');
        redirectUrl.searchParams.set('error_description', 'User denied the authorization request');
        if (formState) {
          redirectUrl.searchParams.set('state', formState);
        }

        return Astro.redirect(redirectUrl.toString());
      }
    }
  } catch (e) {
    console.error('[OAuth] POST handler error:', e);
    error = 'Er is een fout opgetreden. Probeer het opnieuw.';
  }
}
---

<Layout title="Authorize Application">
  <div class="max-w-md mx-auto px-4 py-16">
    {error ? (
      <div class="bg-white rounded-xl shadow-sm border border-red-200 p-8 text-center">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </div>
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Authorization Error</h1>
        <p class="text-gray-600">{error}</p>
      </div>
    ) : !isAuthenticated ? (
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
        <div class="text-center mb-6">
          <div class="w-16 h-16 bg-exact-light rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-exact-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-gray-900">Log in om door te gaan</h1>
          <p class="text-gray-600 mt-2">
            <strong>{clientName}</strong> wil toegang tot je Exact Online data.
          </p>
        </div>

        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <p class="text-sm text-gray-600">
            Je moet eerst inloggen met je Exact Online account om toegang te verlenen.
          </p>
        </div>

        <a
          href={`/connect?oauth_return=${encodeURIComponent(url.toString())}`}
          class="block w-full px-6 py-3 bg-exact-blue text-white font-semibold rounded-lg hover:bg-exact-dark transition-colors text-center"
        >
          Inloggen met Exact Online
        </a>

        <p class="text-center text-sm text-gray-500 mt-4">
          Na het inloggen kun je toegang verlenen aan {clientName}.
        </p>
      </div>
    ) : (
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
        <div class="text-center mb-6">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-gray-900">Toegang verlenen?</h1>
          <p class="text-gray-600 mt-2">
            <strong>{clientName}</strong> vraagt om toegang tot je account.
          </p>
        </div>

        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <p class="text-sm font-medium text-gray-700 mb-2">Ingelogd als:</p>
          <p class="text-gray-900">{user?.name || user?.email}</p>
          <p class="text-sm text-gray-500">{user?.email}</p>
        </div>

        <div class="bg-blue-50 rounded-lg p-4 mb-6">
          <p class="text-sm font-medium text-blue-900 mb-2">Deze applicatie kan:</p>
          <ul class="text-sm text-blue-800 space-y-1">
            <li class="flex items-center">
              <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              Je Exact Online data lezen (facturen, klanten, etc.)
            </li>
            <li class="flex items-center">
              <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              Je naam en e-mailadres bekijken
            </li>
          </ul>
        </div>

        <div class="bg-amber-50 rounded-lg p-4 mb-6">
          <p class="text-sm text-amber-800">
            <strong>Let op:</strong> Deze applicatie kan geen wijzigingen maken in je administratie.
          </p>
        </div>

        <form id="authorize-form" method="POST" action={url.pathname + url.search} class="space-y-3">
          <input type="hidden" name="action" value="authorize" />
          <input type="hidden" name="csrf_token" value={csrfToken} />
          <input type="hidden" name="client_id" value={clientId || ''} />
          <input type="hidden" name="redirect_uri" value={redirectUri || ''} />
          <input type="hidden" name="code_challenge" value={codeChallenge || ''} />
          <input type="hidden" name="code_challenge_method" value={codeChallengeMethod} />
          <input type="hidden" name="scope" value={scope} />
          <input type="hidden" name="state" value={state} />
          <button
            type="submit"
            id="authorize-btn"
            class="w-full px-6 py-3 bg-exact-blue text-white font-semibold rounded-lg hover:bg-exact-dark transition-colors cursor-pointer"
          >
            Toegang verlenen
          </button>
        </form>

        <form id="deny-form" method="POST" action={url.pathname + url.search} class="mt-3">
          <input type="hidden" name="action" value="deny" />
          <input type="hidden" name="csrf_token" value={csrfToken} />
          <input type="hidden" name="client_id" value={clientId || ''} />
          <input type="hidden" name="redirect_uri" value={redirectUri || ''} />
          <input type="hidden" name="state" value={state} />
          <button
            type="submit"
            id="deny-btn"
            class="w-full px-6 py-3 bg-white text-gray-700 font-semibold rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors cursor-pointer"
          >
            Weigeren
          </button>
        </form>

        <p class="text-center text-xs text-gray-500 mt-4">
          Door toegang te verlenen ga je akkoord met onze
          <a href="/terms" class="text-exact-blue hover:underline">algemene voorwaarden</a> en
          <a href="/privacy" class="text-exact-blue hover:underline">privacyverklaring</a>.
        </p>
      </div>
    )}
  </div>

  <script>
    // Ensure form submission works correctly
    document.addEventListener('DOMContentLoaded', () => {
      const authorizeForm = document.getElementById('authorize-form') as HTMLFormElement | null;
      const authorizeBtn = document.getElementById('authorize-btn') as HTMLButtonElement | null;
      const denyForm = document.getElementById('deny-form') as HTMLFormElement | null;
      const denyBtn = document.getElementById('deny-btn') as HTMLButtonElement | null;

      // Handle authorize button click
      if (authorizeBtn && authorizeForm) {
        authorizeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          authorizeBtn.disabled = true;
          authorizeBtn.textContent = 'Bezig...';
          authorizeForm.submit();
        });
      }

      // Handle deny button click
      if (denyBtn && denyForm) {
        denyBtn.addEventListener('click', (e) => {
          e.preventDefault();
          denyBtn.disabled = true;
          denyBtn.textContent = 'Bezig...';
          denyForm.submit();
        });
      }
    });
  </script>
</Layout>
