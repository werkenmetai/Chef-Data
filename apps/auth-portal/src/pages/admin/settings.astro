---
/**
 * AIOPS-002: Admin Settings Page
 *
 * Feature toggles and system-wide configuration for the admin panel.
 * Controls features like:
 * - Proactive emails
 * - AI drafting suggestions
 * - Auto-reply
 * - Screenshot capture
 */
import Layout from '../../layouts/Layout.astro';
// AdminAppLauncher now in Layout.astro header
import { Database } from '../../lib/database';

const env = Astro.locals.runtime?.env;
let db: Database | null = null;
let isAdmin = false;
let adminEmail: string | null = null;

// Feature flags and settings data
interface FeatureFlag {
  id: string;
  key: string;
  name: string;
  description: string | null;
  enabled: boolean;
  config: Record<string, unknown> | null;
  updated_at: string;
  updated_by: string | null;
}

let featureFlags: FeatureFlag[] = [];
let systemSettings: Record<string, string> = {};
let success: string | null = null;
let error: string | null = null;

try {
  if (env?.DB) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());
        adminEmail = session.user.email;

        if (isAdmin) {
          // Load feature flags
          const flagsResult = await env.DB.prepare('SELECT * FROM feature_flags ORDER BY name')
            .all<{
              id: string;
              key: string;
              name: string;
              description: string | null;
              enabled: number;
              config: string | null;
              updated_at: string;
              updated_by: string | null;
            }>();

          featureFlags = (flagsResult.results || []).map(flag => ({
            ...flag,
            enabled: Boolean(flag.enabled),
            config: flag.config ? JSON.parse(flag.config) : null,
          }));

          // Load system settings
          systemSettings = await db.getAllSystemSettings();
        }
      }
    }
  }
} catch (e) {
  console.error('Admin settings error:', e);
  error = 'Er is een fout opgetreden bij het laden van de instellingen.';
}

// Helper to format date
function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('nl-NL', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}

// Feature flag icons based on key
function getFlagIcon(key: string): string {
  const icons: Record<string, string> = {
    proactive_emails: 'M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z',
    ai_drafting: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z',
    auto_reply: 'M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z',
    screenshot_capture: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z',
    conversation_threading: 'M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z',
    customer_health_score: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z',
  };
  return icons[key] || 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z';
}
---

<Layout title="Admin Instellingen">
  <div class="max-w-4xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          Terug naar Dashboard
        </a>
      </div>
    ) : (
      <>
        {/* Header with App Launcher */}
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Admin Instellingen</h1>
            <p class="text-gray-600">Beheer feature toggles en systeem configuratie</p>
          </div>
          <a href="/admin" class="text-gray-600 hover:text-gray-900 flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
            &larr; Admin Home
          </a>
        </div>

        {/* Notifications */}
        <div id="notification" class="hidden mb-6 p-4 rounded-lg"></div>

        {error && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-700">{error}</p>
          </div>
        )}

        {/* Feature Toggles Section */}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-8">
          <div class="p-6 border-b border-gray-100">
            <h2 class="text-lg font-semibold text-gray-900">Feature Toggles</h2>
            <p class="text-sm text-gray-500 mt-1">Schakel features in of uit voor het hele systeem</p>
          </div>

          <div class="divide-y divide-gray-100">
            {featureFlags.map((flag) => (
              <div class="p-6 hover:bg-gray-50 transition-colors" data-flag-key={flag.key}>
                <div class="flex items-start justify-between gap-4">
                  <div class="flex items-start gap-4">
                    {/* Icon */}
                    <div class={`p-3 rounded-lg ${flag.enabled ? 'bg-green-100' : 'bg-gray-100'}`}>
                      <svg class={`w-6 h-6 ${flag.enabled ? 'text-green-600' : 'text-gray-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={getFlagIcon(flag.key)} />
                      </svg>
                    </div>

                    {/* Content */}
                    <div class="flex-1">
                      <h3 class="font-medium text-gray-900">{flag.name}</h3>
                      <p class="text-sm text-gray-500 mt-1">{flag.description}</p>

                      {/* Config preview */}
                      {flag.config && (
                        <details class="mt-3">
                          <summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-600">
                            Bekijk configuratie
                          </summary>
                          <pre class="mt-2 p-3 bg-gray-50 rounded-lg text-xs text-gray-600 overflow-x-auto">
{JSON.stringify(flag.config, null, 2)}
                          </pre>
                        </details>
                      )}

                      {/* Last updated */}
                      <p class="text-xs text-gray-400 mt-2">
                        Laatst gewijzigd: {formatDate(flag.updated_at)}
                      </p>
                    </div>
                  </div>

                  {/* Toggle */}
                  <div class="flex-shrink-0">
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input
                        type="checkbox"
                        class="sr-only peer feature-toggle"
                        data-key={flag.key}
                        checked={flag.enabled}
                      />
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-exact-blue"></div>
                    </label>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Email Signature Section */}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-8">
          <div class="p-6 border-b border-gray-100">
            <h2 class="text-lg font-semibold text-gray-900">Email Handtekening</h2>
            <p class="text-sm text-gray-500 mt-1">Je persoonlijke handtekening voor email reacties vanuit de inbox</p>
          </div>

          <div class="p-6">
            <div class="space-y-4">
              <div>
                <label for="signature-input" class="block text-sm font-medium text-gray-700 mb-2">
                  Handtekening
                </label>
                <textarea
                  id="signature-input"
                  rows="4"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-exact-blue focus:border-exact-blue text-sm"
                  placeholder="Met vriendelijke groet,&#10;Naam&#10;Praat met je Boekhouding Support"
                ></textarea>
                <p class="mt-1 text-xs text-gray-500">
                  Deze handtekening wordt automatisch toegevoegd aan je email reacties.
                </p>
              </div>

              <div class="flex items-center justify-between pt-2">
                <button
                  type="button"
                  id="reset-signature-btn"
                  class="text-sm text-gray-600 hover:text-gray-900 underline"
                >
                  Reset naar standaard
                </button>
                <button
                  type="button"
                  id="save-signature-btn"
                  class="px-4 py-2 bg-exact-blue text-white rounded-lg hover:bg-exact-dark transition-colors text-sm font-medium"
                >
                  Opslaan
                </button>
              </div>

              <div id="signature-status" class="hidden mt-3 p-3 rounded-lg text-sm"></div>
            </div>
          </div>
        </div>

        {/* Quick Links */}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
          <div class="p-6 border-b border-gray-100">
            <h2 class="text-lg font-semibold text-gray-900">Andere Instellingen</h2>
          </div>

          <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <a href="/admin/support/settings" class="p-4 border border-gray-200 rounded-lg hover:border-exact-blue hover:bg-blue-50 transition-colors group">
              <div class="flex items-center gap-3">
                <div class="p-2 bg-purple-100 rounded-lg group-hover:bg-purple-200">
                  <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" />
                  </svg>
                </div>
                <div>
                  <h3 class="font-medium text-gray-900">Support Instellingen</h3>
                  <p class="text-sm text-gray-500">AI-respons en systeembeheer</p>
                </div>
              </div>
            </a>

            <a href="/admin/support/patterns" class="p-4 border border-gray-200 rounded-lg hover:border-exact-blue hover:bg-blue-50 transition-colors group">
              <div class="flex items-center gap-3">
                <div class="p-2 bg-amber-100 rounded-lg group-hover:bg-amber-200">
                  <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                  </svg>
                </div>
                <div>
                  <h3 class="font-medium text-gray-900">Support Patterns</h3>
                  <p class="text-sm text-gray-500">Automatische antwoordpatronen</p>
                </div>
              </div>
            </a>

            <a href="/admin/emails" class="p-4 border border-gray-200 rounded-lg hover:border-exact-blue hover:bg-blue-50 transition-colors group">
              <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-100 rounded-lg group-hover:bg-blue-200">
                  <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                </div>
                <div>
                  <h3 class="font-medium text-gray-900">Email Logs</h3>
                  <p class="text-sm text-gray-500">Verstuurde emails bekijken</p>
                </div>
              </div>
            </a>

            <a href="/admin/feedback" class="p-4 border border-gray-200 rounded-lg hover:border-exact-blue hover:bg-blue-50 transition-colors group">
              <div class="flex items-center gap-3">
                <div class="p-2 bg-green-100 rounded-lg group-hover:bg-green-200">
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                  </svg>
                </div>
                <div>
                  <h3 class="font-medium text-gray-900">Feedback Beheer</h3>
                  <p class="text-sm text-gray-500">Klantfeedback en NPS scores</p>
                </div>
              </div>
            </a>
          </div>
        </div>
      </>
    )}
  </div>

  <script>
    // Email Signature handling
    const signatureInput = document.getElementById('signature-input') as HTMLTextAreaElement;
    const saveSignatureBtn = document.getElementById('save-signature-btn');
    const resetSignatureBtn = document.getElementById('reset-signature-btn');
    const signatureStatus = document.getElementById('signature-status');

    let defaultSignature = '';

    // Load current signature on page load
    async function loadSignature() {
      try {
        const res = await fetch('/api/admin/signature');
        const data = await res.json() as { signature?: string; isDefault?: boolean; error?: string };

        if (res.ok && signatureInput) {
          signatureInput.value = data.signature || '';
          if (data.isDefault) {
            defaultSignature = data.signature || '';
          }
        }
      } catch (err) {
        console.error('Error loading signature:', err);
      }
    }

    // Save signature
    saveSignatureBtn?.addEventListener('click', async () => {
      if (!signatureInput) return;

      const signature = signatureInput.value;

      try {
        const res = await fetch('/api/admin/signature', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signature }),
        });

        const result = await res.json() as { success?: boolean; error?: string };

        if (signatureStatus) {
          signatureStatus.classList.remove('hidden');
          if (res.ok && result.success) {
            signatureStatus.className = 'mt-3 p-3 rounded-lg text-sm bg-green-50 border border-green-200 text-green-700';
            signatureStatus.textContent = 'Handtekening opgeslagen!';
          } else {
            signatureStatus.className = 'mt-3 p-3 rounded-lg text-sm bg-red-50 border border-red-200 text-red-700';
            signatureStatus.textContent = 'Fout: ' + (result.error || 'Kon handtekening niet opslaan');
          }

          setTimeout(() => signatureStatus.classList.add('hidden'), 3000);
        }
      } catch (err) {
        if (signatureStatus) {
          signatureStatus.classList.remove('hidden');
          signatureStatus.className = 'mt-3 p-3 rounded-lg text-sm bg-red-50 border border-red-200 text-red-700';
          signatureStatus.textContent = 'Netwerkfout: kon handtekening niet opslaan';
          setTimeout(() => signatureStatus.classList.add('hidden'), 3000);
        }
      }
    });

    // Reset to default
    resetSignatureBtn?.addEventListener('click', async () => {
      if (!signatureInput) return;

      // Save empty signature to reset to default
      try {
        const res = await fetch('/api/admin/signature', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signature: '' }),
        });

        if (res.ok) {
          // Reload to get the default
          await loadSignature();

          if (signatureStatus) {
            signatureStatus.classList.remove('hidden');
            signatureStatus.className = 'mt-3 p-3 rounded-lg text-sm bg-green-50 border border-green-200 text-green-700';
            signatureStatus.textContent = 'Handtekening gereset naar standaard';
            setTimeout(() => signatureStatus.classList.add('hidden'), 3000);
          }
        }
      } catch (err) {
        console.error('Error resetting signature:', err);
      }
    });

    // Load signature on page load
    loadSignature();

    // Handle feature toggle changes
    document.querySelectorAll('.feature-toggle').forEach(toggle => {
      toggle.addEventListener('change', async (e) => {
        const input = e.target as HTMLInputElement;
        const key = input.dataset.key;
        const enabled = input.checked;

        const notification = document.getElementById('notification');

        try {
          const response = await fetch(`/api/admin/settings/${key}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled }),
          });

          const result = await response.json() as { success?: boolean; error?: string; featureFlag?: { name: string } };

          if (notification) {
            notification.classList.remove('hidden');

            if (result.success) {
              notification.className = 'mb-6 p-4 rounded-lg bg-green-50 border border-green-200';
              notification.textContent = `${result.featureFlag?.name || key} is ${enabled ? 'ingeschakeld' : 'uitgeschakeld'}`;

              // Update icon color
              const flagContainer = document.querySelector(`[data-flag-key="${key}"]`);
              const iconContainer = flagContainer?.querySelector('div > div:first-child');
              const icon = iconContainer?.querySelector('svg');

              if (iconContainer && icon) {
                (iconContainer as HTMLElement).className = enabled ? 'p-3 rounded-lg bg-green-100' : 'p-3 rounded-lg bg-gray-100';
                (icon as SVGElement).setAttribute('class', enabled ? 'w-6 h-6 text-green-600' : 'w-6 h-6 text-gray-400');
              }
            } else {
              notification.className = 'mb-6 p-4 rounded-lg bg-red-50 border border-red-200';
              notification.textContent = 'Fout: ' + (result.error || 'Onbekende fout');
              // Revert toggle
              input.checked = !enabled;
            }

            // Hide notification after 3 seconds
            setTimeout(() => {
              notification.classList.add('hidden');
            }, 3000);
          }
        } catch (error) {
          if (notification) {
            notification.classList.remove('hidden');
            notification.className = 'mb-6 p-4 rounded-lg bg-red-50 border border-red-200';
            notification.textContent = 'Netwerkfout: kon instelling niet wijzigen';
          }
          // Revert toggle
          input.checked = !enabled;
        }
      });
    });
  </script>
</Layout>
