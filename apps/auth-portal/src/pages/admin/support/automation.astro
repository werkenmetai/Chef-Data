---
/**
 * Support Automation Dashboard
 *
 * Real-time view of AI automation, error pipeline, and controls.
 */
import Layout from '../../../layouts/Layout.astro';
import { Database } from '../../../lib/database';
// AdminAppLauncher now in Layout.astro header

const env = Astro.locals.runtime?.env;
let db: Database | null = null;
let isAdmin = false;
let settings: Record<string, string> = {};
let userId: string | null = null;

// Automation stats
let automationStats = {
  aiResponsesLast24h: 0,
  aiResolvedLast24h: 0,
  escalationsLast24h: 0,
  errorsLast24h: 0,
  avgResponseTime: 0,
  patternUsageToday: [] as { name: string; uses: number; success_rate: number }[],
  recentErrors: [] as { error_type: string; error_message: string; created_at: string; user_email?: string }[],
  pendingPatternSuggestions: 0,
};

let success: string | null = null;
let error: string | null = null;

try {
  if (env?.DB) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());
        userId = session.user.id;

        if (isAdmin) {
          // Handle form submission for quick toggles
          if (Astro.request.method === 'POST') {
            const formData = await Astro.request.formData();
            const action = formData.get('action');

            if (action === 'toggle_ai') {
              const current = await db.getSystemSetting('support_ai_enabled');
              await db.setSystemSetting('support_ai_enabled', current === 'false' ? 'true' : 'false', userId);
              success = current === 'false' ? 'AI Automation ingeschakeld' : 'AI Automation uitgeschakeld';
            } else if (action === 'toggle_pause') {
              const current = await db.getSystemSetting('support_paused');
              await db.setSystemSetting('support_paused', current === 'true' ? 'false' : 'true', userId);
              success = current === 'true' ? 'Support hervat' : 'Support gepauzeerd';
            } else if (action === 'toggle_support') {
              const current = await db.getSystemSetting('support_enabled');
              await db.setSystemSetting('support_enabled', current === 'false' ? 'true' : 'false', userId);
              success = current === 'false' ? 'Support ingeschakeld' : 'Support uitgeschakeld';
            }
          }

          settings = await db.getAllSystemSettings();

          // Get automation stats
          const aiMessages = await db.all<{ count: number }>(
            `SELECT COUNT(*) as count FROM support_messages
             WHERE sender_type = 'ai' AND created_at > datetime('now', '-24 hours')`
          );
          automationStats.aiResponsesLast24h = aiMessages[0]?.count || 0;

          const aiResolved = await db.all<{ count: number }>(
            `SELECT COUNT(*) as count FROM support_conversations
             WHERE handled_by = 'ai' AND status = 'resolved'
             AND updated_at > datetime('now', '-24 hours')`
          );
          automationStats.aiResolvedLast24h = aiResolved[0]?.count || 0;

          const escalations = await db.all<{ count: number }>(
            `SELECT COUNT(*) as count FROM support_lessons
             WHERE created_at > datetime('now', '-24 hours')`
          );
          automationStats.escalationsLast24h = escalations[0]?.count || 0;

          const errors = await db.all<{ count: number }>(
            `SELECT COUNT(*) as count FROM support_error_log
             WHERE created_at > datetime('now', '-24 hours')`
          );
          automationStats.errorsLast24h = errors[0]?.count || 0;

          // Pattern usage
          const patternStats = await db.all<{ name: string; usage_count: number; success_count: number }>(
            `SELECT name, usage_count, success_count FROM support_patterns
             WHERE usage_count > 0 ORDER BY usage_count DESC LIMIT 5`
          );
          automationStats.patternUsageToday = patternStats.map(p => ({
            name: p.name,
            uses: p.usage_count,
            success_rate: p.usage_count > 0 ? (p.success_count / p.usage_count) : 0,
          }));

          // Recent errors with user info
          const recentErrors = await db.all<{
            error_type: string;
            error_message: string;
            created_at: string;
            user_id: string | null;
          }>(
            `SELECT error_type, error_message, created_at, user_id FROM support_error_log
             ORDER BY created_at DESC LIMIT 10`
          );

          automationStats.recentErrors = await Promise.all(
            recentErrors.map(async (err) => {
              let user_email: string | undefined;
              if (err.user_id) {
                const user = await db!.findUserById(err.user_id);
                user_email = user?.email;
              }
              return {
                error_type: err.error_type,
                error_message: err.error_message,
                created_at: err.created_at,
                user_email,
              };
            })
          );

          // Pending pattern suggestions (resolved by human that could become patterns)
          const pendingSuggestions = await db.all<{ count: number }>(
            `SELECT COUNT(*) as count FROM support_conversations
             WHERE status = 'resolved' AND handled_by = 'admin'
             AND matched_pattern_id IS NULL
             AND updated_at > datetime('now', '-7 days')`
          );
          automationStats.pendingPatternSuggestions = pendingSuggestions[0]?.count || 0;
        }
      }
    }
  }
} catch (e) {
  console.error('Automation dashboard error:', e);
  error = 'Er is een fout opgetreden';
}

const supportEnabled = settings.support_enabled !== 'false';
const supportPaused = settings.support_paused === 'true';
const aiEnabled = settings.support_ai_enabled !== 'false';

function getStatusColor(enabled: boolean, paused: boolean): string {
  if (!enabled) return 'bg-gray-500';
  if (paused) return 'bg-yellow-500';
  return 'bg-green-500';
}

function getStatusText(enabled: boolean, paused: boolean): string {
  if (!enabled) return 'Uitgeschakeld';
  if (paused) return 'Gepauzeerd';
  return 'Actief';
}
---

<Layout title="Support Automation">
  <div class="max-w-7xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          ‚Üê Terug naar Dashboard
        </a>
      </div>
    ) : (
      <>
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Automation Dashboard</h1>
            <p class="text-gray-600">Real-time overzicht van AI automatisering</p>
          </div>
          <div class="flex items-center gap-3">
            <a
              href="/admin/support/settings"
              class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
            >
              Geavanceerde Instellingen
            </a>
            <a href="/admin/support" class="text-gray-600 hover:text-gray-900">
              ‚Üê Support
            </a>
          </div>
        </div>

        {/* Notifications */}
        {success && (
          <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-green-700">{success}</p>
          </div>
        )}
        {error && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-700">{error}</p>
          </div>
        )}

        <!-- Quick Controls -->
        <div class="grid md:grid-cols-3 gap-4 mb-8">
          <!-- Support System Toggle -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <span class={`w-3 h-3 rounded-full ${getStatusColor(supportEnabled, supportPaused)}`}></span>
                <h3 class="font-semibold text-gray-900">Support Systeem</h3>
              </div>
              <span class="text-sm text-gray-500">{getStatusText(supportEnabled, supportPaused)}</span>
            </div>
            <p class="text-sm text-gray-600 mb-4">
              {supportEnabled ? 'Gebruikers kunnen support gesprekken starten' : 'Support systeem is volledig uitgeschakeld'}
            </p>
            <form method="POST" class="flex gap-2">
              <input type="hidden" name="action" value="toggle_support" />
              <button
                type="submit"
                class={`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${
                  supportEnabled
                    ? 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    : 'bg-green-600 text-white hover:bg-green-700'
                }`}
              >
                {supportEnabled ? 'Uitschakelen' : 'Inschakelen'}
              </button>
            </form>
          </div>

          <!-- Pause Toggle -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <span class={`w-3 h-3 rounded-full ${supportPaused ? 'bg-yellow-500' : 'bg-green-500'}`}></span>
                <h3 class="font-semibold text-gray-900">Pauze Modus</h3>
              </div>
              <span class="text-sm text-gray-500">{supportPaused ? 'Gepauzeerd' : 'Normaal'}</span>
            </div>
            <p class="text-sm text-gray-600 mb-4">
              {supportPaused ? 'Nieuwe berichten krijgen pauze melding' : 'Normaal opereren'}
            </p>
            <form method="POST" class="flex gap-2">
              <input type="hidden" name="action" value="toggle_pause" />
              <button
                type="submit"
                class={`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${
                  supportPaused
                    ? 'bg-green-600 text-white hover:bg-green-700'
                    : 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200'
                }`}
              >
                {supportPaused ? 'Hervat Support' : 'Pauzeer Support'}
              </button>
            </form>
          </div>

          <!-- AI Toggle -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <span class={`w-3 h-3 rounded-full ${aiEnabled ? 'bg-purple-500' : 'bg-gray-400'}`}></span>
                <h3 class="font-semibold text-gray-900">AI Automation</h3>
              </div>
              <span class="text-sm text-gray-500">{aiEnabled ? 'Actief' : 'Uit'}</span>
            </div>
            <p class="text-sm text-gray-600 mb-4">
              {aiEnabled ? 'Claude AI beantwoordt vragen automatisch' : 'Alleen handmatige antwoorden'}
            </p>
            <form method="POST" class="flex gap-2">
              <input type="hidden" name="action" value="toggle_ai" />
              <button
                type="submit"
                class={`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${
                  aiEnabled
                    ? 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    : 'bg-purple-600 text-white hover:bg-purple-700'
                }`}
              >
                {aiEnabled ? 'AI Uitschakelen' : 'AI Inschakelen'}
              </button>
            </form>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-xs font-medium text-gray-500 uppercase">AI Responses (24u)</h3>
            <p class="text-3xl font-bold text-purple-600 mt-2">{automationStats.aiResponsesLast24h}</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-xs font-medium text-gray-500 uppercase">AI Opgelost (24u)</h3>
            <p class="text-3xl font-bold text-green-600 mt-2">{automationStats.aiResolvedLast24h}</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-xs font-medium text-gray-500 uppercase">Escalaties (24u)</h3>
            <p class="text-3xl font-bold text-orange-600 mt-2">{automationStats.escalationsLast24h}</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-xs font-medium text-gray-500 uppercase">Errors (24u)</h3>
            <p class="text-3xl font-bold text-red-600 mt-2">{automationStats.errorsLast24h}</p>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
          <!-- Pattern Usage -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-semibold text-gray-900">Pattern Prestaties</h2>
              <a href="/admin/support/patterns" class="text-sm text-exact-blue hover:underline">
                Beheren ‚Üí
              </a>
            </div>

            {automationStats.patternUsageToday.length > 0 ? (
              <div class="space-y-4">
                {automationStats.patternUsageToday.map((pattern) => (
                  <div class="flex items-center justify-between">
                    <div class="flex-1">
                      <p class="font-medium text-gray-900">{pattern.name}</p>
                      <div class="flex items-center gap-2 mt-1">
                        <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                          <div
                            class="h-full bg-green-500"
                            style={`width: ${Math.round(pattern.success_rate * 100)}%`}
                          ></div>
                        </div>
                        <span class="text-xs text-gray-500">
                          {Math.round(pattern.success_rate * 100)}%
                        </span>
                      </div>
                    </div>
                    <span class="text-sm font-medium text-gray-600 ml-4">
                      {pattern.uses}x
                    </span>
                  </div>
                ))}
              </div>
            ) : (
              <p class="text-gray-500">Nog geen pattern data</p>
            )}

            {automationStats.pendingPatternSuggestions > 0 && (
              <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                <p class="text-sm text-blue-800">
                  <strong>{automationStats.pendingPatternSuggestions}</strong> gesprekken kunnen mogelijk nieuwe patterns worden
                </p>
              </div>
            )}
          </div>

          <!-- Recent Errors -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-semibold text-gray-900">Recente Errors</h2>
              <span class="text-xs text-gray-500">MCP Error Pipeline</span>
            </div>

            {automationStats.recentErrors.length > 0 ? (
              <div class="space-y-3 max-h-80 overflow-y-auto">
                {automationStats.recentErrors.map((err) => (
                  <div class="p-3 bg-red-50 rounded-lg border border-red-100">
                    <div class="flex items-center justify-between mb-1">
                      <span class="text-xs font-medium text-red-600 uppercase">
                        {err.error_type}
                      </span>
                      <span class="text-xs text-gray-500">
                        {new Date(err.created_at).toLocaleString('nl-NL', {
                          hour: '2-digit',
                          minute: '2-digit',
                          day: 'numeric',
                          month: 'short'
                        })}
                      </span>
                    </div>
                    <p class="text-sm text-gray-800 line-clamp-2">{err.error_message}</p>
                    {err.user_email && (
                      <p class="text-xs text-gray-500 mt-1">{err.user_email}</p>
                    )}
                  </div>
                ))}
              </div>
            ) : (
              <div class="text-center py-8">
                <span class="text-4xl">‚úì</span>
                <p class="text-gray-500 mt-2">Geen recente errors</p>
              </div>
            )}
          </div>
        </div>

        <!-- AI Agent Info -->
        <div class="mt-8 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl border border-purple-100 p-6">
          <div class="flex items-start gap-4">
            <span class="text-3xl">ü§ñ</span>
            <div class="flex-1">
              <h3 class="font-semibold text-gray-900 mb-2">Claude Support Agent</h3>
              <p class="text-sm text-gray-700 mb-4">
                De AI Support Agent analyseert binnenkomende vragen, zoekt relevante documentatie,
                controleert klantgegevens en geeft automatisch antwoord waar mogelijk.
              </p>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                  <span class="text-gray-500">Beschikbare tools:</span>
                  <p class="font-medium">7 tools</p>
                </div>
                <div>
                  <span class="text-gray-500">Model:</span>
                  <p class="font-medium">Claude Sonnet</p>
                </div>
                <div>
                  <span class="text-gray-500">Max iterations:</span>
                  <p class="font-medium">5</p>
                </div>
                <div>
                  <span class="text-gray-500">Confidence drempel:</span>
                  <p class="font-medium">{Math.round(parseFloat(settings.support_ai_confidence_threshold || '0.8') * 100)}%</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Automation Flow -->
        <div class="mt-8 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h3 class="font-semibold text-gray-900 mb-4">Automation Flow</h3>
          <div class="flex items-center justify-between text-sm overflow-x-auto pb-4">
            <div class="flex items-center min-w-max">
              <div class="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg">
                Gebruiker stuurt bericht
              </div>
              <svg class="w-6 h-6 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
              <div class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-lg">
                Pattern Matching
              </div>
              <svg class="w-6 h-6 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
              <div class="px-4 py-2 bg-purple-100 text-purple-800 rounded-lg">
                Claude Agent
              </div>
              <svg class="w-6 h-6 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
              <div class="px-4 py-2 bg-green-100 text-green-800 rounded-lg">
                Antwoord of Escalatie
              </div>
            </div>
          </div>
          <div class="mt-4 pt-4 border-t border-gray-100 grid md:grid-cols-2 gap-4 text-sm text-gray-600">
            <div>
              <strong>Automatisch:</strong> Pattern match ‚â•{Math.round(parseFloat(settings.support_ai_confidence_threshold || '0.8') * 100)}% ‚Üí Direct antwoord
            </div>
            <div>
              <strong>Agent:</strong> Geen match ‚Üí Claude analyseert en kiest actie
            </div>
          </div>
        </div>
      </>
    )}
  </div>
</Layout>
