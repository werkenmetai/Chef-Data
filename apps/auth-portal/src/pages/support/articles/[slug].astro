---
import Layout from '../../../layouts/Layout.astro';
import { Database, type KnowledgeArticle } from '../../../lib/database';

const env = Astro.locals.runtime?.env;
const { slug } = Astro.params;

let db: Database | null = null;
let article: KnowledgeArticle | null = null;
let relatedArticles: KnowledgeArticle[] = [];

try {
  if (env?.DB && slug) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    article = await db.getArticle(slug);

    if (article && article.published) {
      // Track view
      await db.trackArticleView(slug);

      // Get related articles from same category
      const categoryArticles = await db.getPublishedArticles(article.category);
      relatedArticles = categoryArticles
        .filter(a => a.id !== article?.id)
        .slice(0, 3);
    } else if (article && !article.published) {
      article = null; // Don't show unpublished
    }
  }
} catch (e) {
  console.error('Article page error:', e);
}

// Simple markdown to HTML conversion
function renderMarkdown(content: string): string {
  return content
    // Headers
    .replace(/^### (.*$)/gm, '<h3 class="text-lg font-semibold text-gray-900 mt-6 mb-2">$1</h3>')
    .replace(/^## (.*$)/gm, '<h2 class="text-xl font-semibold text-gray-900 mt-8 mb-3">$1</h2>')
    .replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold text-gray-900 mt-8 mb-4">$1</h1>')
    // Bold
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    // Italic
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    // Code blocks
    .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto my-4"><code>$2</code></pre>')
    // Inline code
    .replace(/`([^`]+)`/g, '<code class="bg-gray-100 text-gray-800 px-1 py-0.5 rounded text-sm">$1</code>')
    // Links
    .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" class="text-exact-blue hover:underline">$1</a>')
    // Lists
    .replace(/^\- (.*$)/gm, '<li class="ml-4">$1</li>')
    .replace(/^(\d+)\. (.*$)/gm, '<li class="ml-4">$2</li>')
    // Paragraphs
    .replace(/\n\n/g, '</p><p class="my-4">')
    // Line breaks
    .replace(/\n/g, '<br>');
}

const categoryLabels: Record<string, string> = {
  connection: 'Verbinding',
  billing: 'Facturatie',
  bug: 'Technisch',
  feature: 'Features',
  account: 'Account',
  other: 'Overig',
};
---

<Layout title={article?.title_nl || 'Artikel niet gevonden'}>
  <div class="max-w-3xl mx-auto px-4 py-8">
    {!article ? (
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center">
        <h1 class="text-2xl font-bold text-gray-900 mb-4">Artikel niet gevonden</h1>
        <p class="text-gray-600 mb-6">Dit artikel bestaat niet of is niet meer beschikbaar.</p>
        <a
          href="/support/articles"
          class="inline-block px-6 py-3 bg-exact-blue text-white font-semibold rounded-lg hover:bg-exact-dark transition-colors"
        >
          Alle artikelen bekijken
        </a>
      </div>
    ) : (
      <>
        <!-- Breadcrumb -->
        <nav class="mb-6">
          <ol class="flex items-center text-sm text-gray-500">
            <li>
              <a href="/support" class="hover:text-gray-700">Support</a>
            </li>
            <li class="mx-2">/</li>
            <li>
              <a href="/support/articles" class="hover:text-gray-700">Artikelen</a>
            </li>
            <li class="mx-2">/</li>
            <li>
              <a href={`/support/articles?category=${article.category}`} class="hover:text-gray-700">
                {categoryLabels[article.category] || article.category}
              </a>
            </li>
          </ol>
        </nav>

        <!-- Article -->
        <article class="bg-white rounded-xl shadow-sm border border-gray-100 p-8">
          <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-3">{article.title_nl}</h1>
            <div class="flex items-center gap-4 text-sm text-gray-500">
              <span>{categoryLabels[article.category] || article.category}</span>
              <span>•</span>
              <span>{article.view_count} views</span>
              {article.updated_at !== article.created_at && (
                <>
                  <span>•</span>
                  <span>Bijgewerkt: {new Date(article.updated_at).toLocaleDateString('nl-NL')}</span>
                </>
              )}
            </div>
          </header>

          <div class="prose prose-lg max-w-none">
            <p class="my-4" set:html={renderMarkdown(article.content_nl)} />
          </div>
        </article>

        <!-- Feedback -->
        <div class="mt-6 bg-gray-50 rounded-xl border border-gray-200 p-6" id="feedbackSection">
          <h3 class="font-semibold text-gray-900 mb-3">Was dit artikel nuttig?</h3>
          <div class="flex items-center gap-3">
            <button
              type="button"
              id="helpfulBtn"
              class="px-4 py-2 border border-green-300 text-green-700 rounded-lg hover:bg-green-50 transition-colors flex items-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
              </svg>
              Ja, nuttig
            </button>
            <button
              type="button"
              id="notHelpfulBtn"
              class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.904 0-.715.211-1.413.608-2.008L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5" />
              </svg>
              Nee
            </button>
          </div>
          <p class="text-sm text-gray-500 mt-3">
            {article.helpful_count} van {article.helpful_count + article.not_helpful_count} vonden dit nuttig
          </p>
        </div>

        <!-- Related Articles -->
        {relatedArticles.length > 0 && (
          <div class="mt-6 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="font-semibold text-gray-900 mb-4">Gerelateerde artikelen</h3>
            <div class="space-y-2">
              {relatedArticles.map(related => (
                <a
                  href={`/support/articles/${related.slug}`}
                  class="block p-3 rounded-lg hover:bg-gray-50 transition-colors group"
                >
                  <span class="text-gray-700 group-hover:text-exact-blue">{related.title_nl}</span>
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- Need more help -->
        <div class="mt-6 text-center">
          <p class="text-gray-600 mb-3">Nog hulp nodig?</p>
          <a
            href="/support/new"
            class="inline-block px-4 py-2 bg-exact-blue text-white rounded-lg hover:bg-exact-dark transition-colors"
          >
            Start een gesprek met support
          </a>
        </div>
      </>
    )}
  </div>

  <script define:vars={{ articleSlug: slug }}>
    const helpfulBtn = document.getElementById('helpfulBtn');
    const notHelpfulBtn = document.getElementById('notHelpfulBtn');
    const feedbackSection = document.getElementById('feedbackSection');

    async function submitFeedback(helpful) {
      try {
        const response = await fetch(`/api/support/articles/${articleSlug}/feedback`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ helpful }),
        });

        if (response.ok) {
          // SEC-001: Use textContent instead of innerHTML for static text
          const thankYou = document.createElement('p');
          thankYou.className = 'text-green-700 font-medium';
          thankYou.textContent = 'Bedankt voor je feedback!';
          feedbackSection.innerHTML = '';
          feedbackSection.appendChild(thankYou);
        }
      } catch (error) {
        console.error('Feedback error:', error);
      }
    }

    helpfulBtn?.addEventListener('click', () => submitFeedback(true));
    notHelpfulBtn?.addEventListener('click', () => submitFeedback(false));
  </script>
</Layout>
