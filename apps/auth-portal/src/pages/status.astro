---
import Layout from '../layouts/Layout.astro';

// Check health of services
type Service = {
  name: string;
  endpoint: string | null;
  status: string;
  external?: boolean;
};

const services: Service[] = [
  {
    name: 'Auth Portal',
    endpoint: null, // Current page
    status: 'operational',
  },
];

// Try to check MCP server health
let mcpStatus = 'unknown';
try {
  const mcpResponse = await fetch('https://api.praatmetjeboekhouding.nl/health', {
    signal: AbortSignal.timeout(5000),
  });
  mcpStatus = mcpResponse.ok ? 'operational' : 'degraded';
} catch {
  mcpStatus = 'down';
}

services.push({
  name: 'MCP Server',
  endpoint: 'https://api.praatmetjeboekhouding.nl',
  status: mcpStatus,
});

// Check Exact Online status (via their status page)
let exactStatus = 'unknown';
try {
  const exactResponse = await fetch('https://start.exactonline.nl', {
    method: 'HEAD',
    signal: AbortSignal.timeout(5000),
  });
  exactStatus = exactResponse.ok ? 'operational' : 'degraded';
} catch {
  exactStatus = 'unknown'; // Can't reliably check external service
}

services.push({
  name: 'Exact Online API',
  endpoint: 'https://start.exactonline.nl',
  status: exactStatus,
  external: true,
});

const overallStatus = services.every(s => s.status === 'operational')
  ? 'All Systems Operational'
  : services.some(s => s.status === 'down')
  ? 'Partial Outage'
  : 'Degraded Performance';

const statusColors: Record<string, { bg: string; text: string; dot: string }> = {
  operational: { bg: 'bg-green-100', text: 'text-green-800', dot: 'bg-green-500' },
  degraded: { bg: 'bg-yellow-100', text: 'text-yellow-800', dot: 'bg-yellow-500' },
  down: { bg: 'bg-red-100', text: 'text-red-800', dot: 'bg-red-500' },
  unknown: { bg: 'bg-gray-100', text: 'text-gray-800', dot: 'bg-gray-500' },
};
---

<Layout title="Status" description="Systeem status van Praat met je Boekhouding">
  <div class="max-w-2xl mx-auto px-4 py-12">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Systeem Status</h1>
    <p class="text-gray-500 text-sm mb-8">
      Laatste update: {new Date().toLocaleString('nl-NL')}
    </p>

    <!-- Overall Status -->
    <div class={`rounded-xl p-6 mb-8 ${services.every(s => s.status === 'operational') ? 'bg-green-50 border border-green-200' : 'bg-yellow-50 border border-yellow-200'}`}>
      <div class="flex items-center">
        <div class={`w-4 h-4 rounded-full mr-3 ${services.every(s => s.status === 'operational') ? 'bg-green-500' : 'bg-yellow-500'}`}></div>
        <span class={`text-lg font-semibold ${services.every(s => s.status === 'operational') ? 'text-green-800' : 'text-yellow-800'}`}>
          {overallStatus}
        </span>
      </div>
    </div>

    <!-- Individual Services -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 divide-y divide-gray-100">
      {services.map((service) => (
        <div class="px-6 py-4 flex items-center justify-between">
          <div>
            <span class="font-medium text-gray-900">{service.name}</span>
            {service.external && (
              <span class="ml-2 text-xs text-gray-400">(extern)</span>
            )}
          </div>
          <div class="flex items-center">
            <span class={`px-3 py-1 rounded-full text-sm font-medium ${statusColors[service.status].bg} ${statusColors[service.status].text}`}>
              <span class={`inline-block w-2 h-2 rounded-full mr-2 ${statusColors[service.status].dot}`}></span>
              {service.status === 'operational' && 'Operationeel'}
              {service.status === 'degraded' && 'Vertraagd'}
              {service.status === 'down' && 'Offline'}
              {service.status === 'unknown' && 'Onbekend'}
            </span>
          </div>
        </div>
      ))}
    </div>

    <!-- Uptime Info -->
    <div class="mt-8 bg-gray-50 rounded-xl p-6">
      <h2 class="font-semibold text-gray-900 mb-4">Over deze pagina</h2>
      <p class="text-gray-600 text-sm mb-4">
        Deze status pagina wordt real-time gegenereerd. Voor historische uptime data,
        zie onze externe monitoring.
      </p>

      <h3 class="font-medium text-gray-900 mt-4 mb-2">Bij storingen</h3>
      <ul class="text-sm text-gray-600 space-y-1">
        <li>• Check <a href="https://www.cloudflarestatus.com" class="text-exact-blue hover:underline" target="_blank">Cloudflare Status</a></li>
        <li>• Volg updates via <a href="mailto:support@praatmetjeboekhouding.nl" class="text-exact-blue hover:underline">support@praatmetjeboekhouding.nl</a></li>
      </ul>
    </div>

    <!-- Subscribe to updates -->
    <div class="mt-8 text-center">
      <p class="text-gray-500 text-sm">
        Wil je alerts bij storingen?
        <a href="mailto:support@praatmetjeboekhouding.nl?subject=Status%20alerts" class="text-exact-blue hover:underline">
          Meld je aan voor notificaties
        </a>
      </p>
    </div>
  </div>
</Layout>
