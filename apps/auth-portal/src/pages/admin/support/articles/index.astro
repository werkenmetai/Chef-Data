---
import Layout from '../../../../layouts/Layout.astro';
import { Database, type KnowledgeArticle } from '../../../../lib/database';
// AdminAppLauncher now in Layout.astro header

const env = Astro.locals.runtime?.env;
let db: Database | null = null;
let isAdmin = false;
let articles: KnowledgeArticle[] = [];
let error: string | null = null;
let success: string | null = null;

const categoryFilter = Astro.url.searchParams.get('category') || '';
const publishedFilter = Astro.url.searchParams.get('published') || '';

try {
  if (env?.DB) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());

        if (isAdmin) {
          // Get all articles (including unpublished)
          const allArticles = await db.all<KnowledgeArticle>(
            `SELECT * FROM knowledge_articles
             ORDER BY category, sort_order, title_nl`
          );
          articles = allArticles;

          // Apply filters
          if (categoryFilter) {
            articles = articles.filter(a => a.category === categoryFilter);
          }
          if (publishedFilter === 'true') {
            articles = articles.filter(a => a.published);
          } else if (publishedFilter === 'false') {
            articles = articles.filter(a => !a.published);
          }
        }
      }
    }
  }
} catch (e) {
  console.error('Admin articles error:', e);
  error = 'Er is een fout opgetreden';
}

const categoryLabels: Record<string, string> = {
  connection: 'Verbinding',
  billing: 'Facturatie',
  bug: 'Technisch',
  feature: 'Features',
  account: 'Account',
  other: 'Overig',
};

function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('nl-NL');
}
---

<Layout title="Artikelen Beheer">
  <div class="max-w-7xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          ← Terug naar Dashboard
        </a>
      </div>
    ) : (
      <>
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Artikelen Beheer</h1>
            <p class="text-gray-600">Beheer kennisbank artikelen</p>
          </div>
          <div class="flex items-center gap-3">
            <a href="/admin/support" class="text-gray-600 hover:text-gray-900">
              ← Terug
            </a>
            <a
              href="/admin/support/articles/new"
              class="px-4 py-2 bg-exact-blue text-white font-medium rounded-lg hover:bg-exact-dark transition-colors"
            >
              + Nieuw artikel
            </a>
          </div>
        </div>

        {error && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-700">{error}</p>
          </div>
        )}

        {success && (
          <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-green-700">{success}</p>
          </div>
        )}

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
          <form method="GET" class="flex flex-wrap items-center gap-4">
            <div>
              <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Categorie</label>
              <select
                name="category"
                id="category"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              >
                <option value="">Alle categorieën</option>
                <option value="connection" selected={categoryFilter === 'connection'}>Verbinding</option>
                <option value="billing" selected={categoryFilter === 'billing'}>Facturatie</option>
                <option value="bug" selected={categoryFilter === 'bug'}>Technisch</option>
                <option value="feature" selected={categoryFilter === 'feature'}>Features</option>
                <option value="account" selected={categoryFilter === 'account'}>Account</option>
                <option value="other" selected={categoryFilter === 'other'}>Overig</option>
              </select>
            </div>

            <div>
              <label for="published" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select
                name="published"
                id="published"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              >
                <option value="">Alle</option>
                <option value="true" selected={publishedFilter === 'true'}>Gepubliceerd</option>
                <option value="false" selected={publishedFilter === 'false'}>Concept</option>
              </select>
            </div>

            <div class="flex items-end gap-2">
              <button
                type="submit"
                class="px-4 py-2 bg-exact-blue text-white font-medium rounded-lg hover:bg-exact-dark transition-colors"
              >
                Filter
              </button>
              {(categoryFilter || publishedFilter) && (
                <a
                  href="/admin/support/articles"
                  class="px-4 py-2 text-gray-600 hover:text-gray-900"
                >
                  Reset
                </a>
              )}
            </div>
          </form>
        </div>

        <!-- Articles Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          {articles.length === 0 ? (
            <div class="p-8 text-center text-gray-500">
              <p class="mb-4">Geen artikelen gevonden</p>
              <a
                href="/admin/support/articles/new"
                class="text-exact-blue hover:underline"
              >
                Maak je eerste artikel
              </a>
            </div>
          ) : (
            <table class="w-full">
              <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Titel</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Categorie</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Views</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Nuttig</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Bijgewerkt</th>
                  <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Acties</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                {articles.map((article) => (
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                      <div>
                        <a
                          href={`/admin/support/articles/${article.id}`}
                          class="font-medium text-gray-900 hover:text-exact-blue"
                        >
                          {article.title_nl}
                        </a>
                        {article.featured && (
                          <span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded text-xs">
                            Uitgelicht
                          </span>
                        )}
                        <p class="text-xs text-gray-500 font-mono">{article.slug}</p>
                      </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">
                      {categoryLabels[article.category] || article.category}
                    </td>
                    <td class="px-4 py-3">
                      {article.published ? (
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                          Gepubliceerd
                        </span>
                      ) : (
                        <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-medium">
                          Concept
                        </span>
                      )}
                    </td>
                    <td class="px-4 py-3 text-center text-sm text-gray-600">
                      {article.view_count}
                    </td>
                    <td class="px-4 py-3 text-center text-sm">
                      {article.helpful_count + article.not_helpful_count > 0 ? (
                        <span class={`${
                          article.helpful_count / (article.helpful_count + article.not_helpful_count) >= 0.7
                            ? 'text-green-600'
                            : article.helpful_count / (article.helpful_count + article.not_helpful_count) >= 0.4
                            ? 'text-yellow-600'
                            : 'text-red-600'
                        }`}>
                          {Math.round((article.helpful_count / (article.helpful_count + article.not_helpful_count)) * 100)}%
                        </span>
                      ) : (
                        <span class="text-gray-400">-</span>
                      )}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                      {formatDate(article.updated_at)}
                    </td>
                    <td class="px-4 py-3 text-right">
                      <div class="flex items-center justify-end gap-2">
                        <a
                          href={`/support/articles/${article.slug}`}
                          target="_blank"
                          class="text-gray-500 hover:text-gray-700 text-sm"
                          title="Bekijken"
                        >
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                          </svg>
                        </a>
                        <a
                          href={`/admin/support/articles/${article.id}`}
                          class="text-exact-blue hover:text-exact-dark text-sm font-medium"
                        >
                          Bewerken
                        </a>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>

        <!-- Stats -->
        <div class="mt-6 grid grid-cols-4 gap-4">
          <div class="bg-white rounded-lg border border-gray-100 p-4 text-center">
            <div class="text-2xl font-bold text-gray-900">{articles.length}</div>
            <div class="text-sm text-gray-600">Totaal</div>
          </div>
          <div class="bg-green-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-900">
              {articles.filter(a => a.published).length}
            </div>
            <div class="text-sm text-green-700">Gepubliceerd</div>
          </div>
          <div class="bg-gray-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-gray-900">
              {articles.filter(a => !a.published).length}
            </div>
            <div class="text-sm text-gray-600">Concept</div>
          </div>
          <div class="bg-yellow-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-yellow-900">
              {articles.filter(a => a.featured).length}
            </div>
            <div class="text-sm text-yellow-700">Uitgelicht</div>
          </div>
        </div>
      </>
    )}
  </div>
</Layout>
