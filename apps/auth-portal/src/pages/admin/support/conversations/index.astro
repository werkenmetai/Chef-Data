---
import Layout from '../../../../layouts/Layout.astro';
import { Database, type SupportConversation } from '../../../../lib/database';
// AdminAppLauncher now in Layout.astro header

const env = Astro.locals.runtime?.env;
let db: Database | null = null;
let isAdmin = false;
let conversations: SupportConversation[] = [];
let error: string | null = null;

// Filters
const statusFilter = Astro.url.searchParams.get('status') || '';
const categoryFilter = Astro.url.searchParams.get('category') || '';
const priorityFilter = Astro.url.searchParams.get('priority') || '';

try {
  if (env?.DB) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());

        if (isAdmin) {
          const result = await db.getAllConversations({
            status: statusFilter || undefined,
            category: categoryFilter || undefined,
          });
          conversations = result.conversations;

          // Apply priority filter in memory if needed
          if (priorityFilter) {
            conversations = conversations.filter(c => c.priority === priorityFilter);
          }
        }
      }
    }
  }
} catch (e) {
  console.error('Admin conversations error:', e);
  error = 'Er is een fout opgetreden';
}

const statusLabels: Record<string, string> = {
  open: 'Open',
  waiting_user: 'Wacht op klant',
  waiting_support: 'Wacht op support',
  resolved: 'Opgelost',
  closed: 'Gesloten',
};

const statusColors: Record<string, string> = {
  open: 'bg-blue-100 text-blue-800',
  waiting_user: 'bg-yellow-100 text-yellow-800',
  waiting_support: 'bg-orange-100 text-orange-800',
  resolved: 'bg-green-100 text-green-800',
  closed: 'bg-gray-100 text-gray-800',
};

const priorityLabels: Record<string, string> = {
  low: 'Laag',
  normal: 'Normaal',
  high: 'Hoog',
  urgent: 'Urgent',
};

const priorityColors: Record<string, string> = {
  low: 'bg-gray-100 text-gray-800',
  normal: 'bg-blue-100 text-blue-800',
  high: 'bg-orange-100 text-orange-800',
  urgent: 'bg-red-100 text-red-800',
};

const categoryLabels: Record<string, string> = {
  connection: 'Verbinding',
  billing: 'Facturatie',
  bug: 'Technisch',
  feature: 'Features',
  account: 'Account',
  other: 'Overig',
};

function formatTimeAgo(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 60) return `${diffMins}m geleden`;
  if (diffHours < 24) return `${diffHours}u geleden`;
  if (diffDays < 7) return `${diffDays}d geleden`;
  return date.toLocaleDateString('nl-NL');
}
---

<Layout title="Conversations Beheer">
  <div class="max-w-7xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          ← Terug naar Dashboard
        </a>
      </div>
    ) : (
      <>
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Conversations Beheer</h1>
            <p class="text-gray-600">Bekijk en beheer alle support gesprekken</p>
          </div>
          <div class="flex items-center gap-3">
            <a href="/admin/support" class="text-gray-600 hover:text-gray-900">
              ← Terug naar Dashboard
            </a>
          </div>
        </div>

        {error && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-700">{error}</p>
          </div>
        )}

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
          <form method="GET" class="flex flex-wrap items-center gap-4">
            <div>
              <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select
                name="status"
                id="status"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              >
                <option value="">Alle statussen</option>
                <option value="open" selected={statusFilter === 'open'}>Open</option>
                <option value="waiting_user" selected={statusFilter === 'waiting_user'}>Wacht op klant</option>
                <option value="waiting_support" selected={statusFilter === 'waiting_support'}>Wacht op support</option>
                <option value="resolved" selected={statusFilter === 'resolved'}>Opgelost</option>
                <option value="closed" selected={statusFilter === 'closed'}>Gesloten</option>
              </select>
            </div>

            <div>
              <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Categorie</label>
              <select
                name="category"
                id="category"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              >
                <option value="">Alle categorieën</option>
                <option value="connection" selected={categoryFilter === 'connection'}>Verbinding</option>
                <option value="billing" selected={categoryFilter === 'billing'}>Facturatie</option>
                <option value="bug" selected={categoryFilter === 'bug'}>Technisch</option>
                <option value="feature" selected={categoryFilter === 'feature'}>Features</option>
                <option value="account" selected={categoryFilter === 'account'}>Account</option>
                <option value="other" selected={categoryFilter === 'other'}>Overig</option>
              </select>
            </div>

            <div>
              <label for="priority" class="block text-sm font-medium text-gray-700 mb-1">Prioriteit</label>
              <select
                name="priority"
                id="priority"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              >
                <option value="">Alle prioriteiten</option>
                <option value="low" selected={priorityFilter === 'low'}>Laag</option>
                <option value="normal" selected={priorityFilter === 'normal'}>Normaal</option>
                <option value="high" selected={priorityFilter === 'high'}>Hoog</option>
                <option value="urgent" selected={priorityFilter === 'urgent'}>Urgent</option>
              </select>
            </div>

            <div class="flex items-end">
              <button
                type="submit"
                class="px-4 py-2 bg-exact-blue text-white font-medium rounded-lg hover:bg-exact-dark transition-colors"
              >
                Filter
              </button>
            </div>

            {(statusFilter || categoryFilter || priorityFilter) && (
              <div class="flex items-end">
                <a
                  href="/admin/support/conversations"
                  class="px-4 py-2 text-gray-600 hover:text-gray-900"
                >
                  Reset
                </a>
              </div>
            )}
          </form>
        </div>

        <!-- Conversations Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          {conversations.length === 0 ? (
            <div class="p-8 text-center text-gray-500">
              Geen gesprekken gevonden
            </div>
          ) : (
            <table class="w-full">
              <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ID</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Onderwerp</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Prioriteit</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Categorie</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Handler</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Tijd</th>
                  <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Acties</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                {conversations.map((conv) => (
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                      <span class="font-mono text-sm text-gray-500">
                        {conv.id.substring(0, 8)}
                      </span>
                    </td>
                    <td class="px-4 py-3">
                      <a
                        href={`/admin/support/conversations/${conv.id}`}
                        class="font-medium text-gray-900 hover:text-exact-blue"
                      >
                        {conv.subject}
                      </a>
                    </td>
                    <td class="px-4 py-3">
                      <span class={`px-2 py-1 rounded-full text-xs font-medium ${statusColors[conv.status]}`}>
                        {statusLabels[conv.status]}
                      </span>
                    </td>
                    <td class="px-4 py-3">
                      <span class={`px-2 py-1 rounded-full text-xs font-medium ${priorityColors[conv.priority]}`}>
                        {priorityLabels[conv.priority]}
                      </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">
                      {conv.category ? categoryLabels[conv.category] || conv.category : '-'}
                    </td>
                    <td class="px-4 py-3">
                      {conv.handled_by === 'ai' && (
                        <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                          AI
                        </span>
                      )}
                      {conv.handled_by === 'human' && (
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                          Human
                        </span>
                      )}
                      {conv.handled_by === 'hybrid' && (
                        <span class="px-2 py-1 bg-teal-100 text-teal-800 rounded-full text-xs font-medium">
                          Hybrid
                        </span>
                      )}
                      {!conv.handled_by && (
                        <span class="text-gray-400 text-sm">-</span>
                      )}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                      {formatTimeAgo(conv.updated_at)}
                    </td>
                    <td class="px-4 py-3 text-right">
                      <a
                        href={`/admin/support/conversations/${conv.id}`}
                        class="text-exact-blue hover:text-exact-dark text-sm font-medium"
                      >
                        Bekijken →
                      </a>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>

        <!-- Stats Summary -->
        <div class="mt-6 grid grid-cols-5 gap-4">
          <div class="bg-blue-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-blue-900">
              {conversations.filter(c => c.status === 'open').length}
            </div>
            <div class="text-sm text-blue-700">Open</div>
          </div>
          <div class="bg-yellow-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-yellow-900">
              {conversations.filter(c => c.status === 'waiting_user').length}
            </div>
            <div class="text-sm text-yellow-700">Wacht op klant</div>
          </div>
          <div class="bg-orange-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-orange-900">
              {conversations.filter(c => c.status === 'waiting_support').length}
            </div>
            <div class="text-sm text-orange-700">Wacht op support</div>
          </div>
          <div class="bg-green-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-900">
              {conversations.filter(c => c.status === 'resolved').length}
            </div>
            <div class="text-sm text-green-700">Opgelost</div>
          </div>
          <div class="bg-gray-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-gray-900">
              {conversations.filter(c => c.status === 'closed').length}
            </div>
            <div class="text-sm text-gray-700">Gesloten</div>
          </div>
        </div>
      </>
    )}
  </div>
</Layout>
