---
/**
 * COMM-002: Customer View (Unified Communications)
 *
 * Complete customer overview with all communications in one place:
 * - Emails (sent/received)
 * - Support conversations
 * - Feedback/NPS responses
 *
 * Design principles:
 * - Most important info immediately visible
 * - Expand for details (click to expand individual items)
 * - Quick actions always accessible
 */
import Layout from '../../../layouts/Layout.astro';
import { Database, type CommunicationEventWithUser, type User, type Connection, type ApiKey } from '../../../lib/database';
// AdminAppLauncher now in Layout.astro header

const env = Astro.locals.runtime?.env;
let db: Database | null = null;
let isAdmin = false;
let error: string | null = null;

// Get customer ID from URL
const { id: customerId } = Astro.params;

// Filter params
const typeFilter = Astro.url.searchParams.get('type') || '';
const searchQuery = Astro.url.searchParams.get('search') || '';

// Customer data
let customer: User | null = null;
let connections: Connection[] = [];
let apiKeys: ApiKey[] = [];
let events: CommunicationEventWithUser[] = [];
let totalEvents = 0;
let apiCallsThisMonth = 0;

// Response templates
interface ResponseTemplate {
  id: string;
  name: string;
  category: string;
  subject_template: string;
  body_template: string;
  variables: string | null;
  is_active: number;
}
let templates: ResponseTemplate[] = [];

try {
  if (env?.DB && customerId) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());

        if (isAdmin) {
          // Load customer details
          const userDetails = await db.getUserWithDetails(customerId);
          if (userDetails) {
            customer = userDetails.user;
            connections = userDetails.connections;
            apiKeys = userDetails.apiKeys;
            apiCallsThisMonth = userDetails.apiCallsThisMonth;
          }

          // Load communication events
          const result = await db.getCommunicationEventsByUser(customerId, {
            type: typeFilter as 'email' | 'support' | 'feedback' | undefined,
            search: searchQuery || undefined,
            limit: 100,
          });
          events = result.events;
          totalEvents = result.total;

          // Load response templates
          const templatesResult = await env.DB.prepare(
            'SELECT * FROM admin_response_templates WHERE is_active = 1 ORDER BY category, name'
          ).all<ResponseTemplate>();
          templates = templatesResult.results || [];
        }
      }
    }
  }
} catch (e) {
  console.error('Customer view error:', e);
  error = 'Er is een fout opgetreden bij het laden van de klantgegevens.';
}

// Helper functions
function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('nl-NL', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}

function formatTimeAgo(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 60) return `${diffMins}m`;
  if (diffHours < 24) return `${diffHours}u`;
  if (diffDays < 7) return `${diffDays}d`;
  return date.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
}

function getTypeIcon(type: string): string {
  switch (type) {
    case 'email': return 'M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z';
    case 'support': return 'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z';
    case 'feedback': return 'M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z';
    default: return 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';
  }
}

function getTypeBadge(type: string): { bg: string; text: string; label: string } {
  switch (type) {
    case 'email': return { bg: 'bg-blue-50', text: 'text-blue-700', label: 'Email' };
    case 'support': return { bg: 'bg-purple-50', text: 'text-purple-700', label: 'Support' };
    case 'feedback': return { bg: 'bg-amber-50', text: 'text-amber-700', label: 'Feedback' };
    default: return { bg: 'bg-gray-50', text: 'text-gray-700', label: type };
  }
}

function parseMetadata(metadataStr: string | null): Record<string, unknown> {
  if (!metadataStr) return {};
  try {
    return JSON.parse(metadataStr);
  } catch {
    return {};
  }
}

// Communication stats
const emailCount = events.filter(e => e.type === 'email').length;
const supportCount = events.filter(e => e.type === 'support').length;
const feedbackCount = events.filter(e => e.type === 'feedback').length;
const inboundCount = events.filter(e => e.direction === 'in').length;
const lastContact = events.length > 0 ? events[0].created_at : null;

// Plan labels
const planLabels: Record<string, { label: string; color: string }> = {
  free: { label: 'Free', color: 'bg-gray-100 text-gray-700' },
  starter: { label: 'Starter', color: 'bg-green-100 text-green-700' },
  pro: { label: 'Pro', color: 'bg-blue-100 text-blue-700' },
  enterprise: { label: 'Enterprise', color: 'bg-purple-100 text-purple-700' },
};

const categoryLabels: Record<string, string> = {
  bug: 'Bug',
  feature: 'Feature',
  question: 'Vraag',
  proactive: 'Proactief',
  general: 'Algemeen',
};

// Group templates by category
const templatesByCategory = templates.reduce((acc, tpl) => {
  if (!acc[tpl.category]) acc[tpl.category] = [];
  acc[tpl.category].push(tpl);
  return acc;
}, {} as Record<string, ResponseTemplate[]>);
---

<Layout title={customer ? `${customer.name || customer.email}` : 'Klant niet gevonden'}>
  <div class="max-w-7xl mx-auto px-4 py-6">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          Terug naar Dashboard
        </a>
      </div>
    ) : !customer ? (
      <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-yellow-900 mb-4">Klant niet gevonden</h1>
        <p class="text-yellow-700">Deze klant bestaat niet of is verwijderd.</p>
        <a href="/admin" class="inline-block mt-4 text-yellow-600 hover:underline">
          Terug naar Admin
        </a>
      </div>
    ) : (
      <>
        {/* Compact Header */}
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
          <div class="flex items-center gap-4">
            <a href="/admin" class="text-gray-400 hover:text-gray-600 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </a>
            <div>
              <div class="flex items-center gap-2">
                <h1 class="text-xl font-bold text-gray-900">{customer.name || customer.email}</h1>
                <span class={`px-2 py-0.5 rounded text-xs font-medium ${planLabels[customer.plan]?.color || 'bg-gray-100 text-gray-700'}`}>
                  {planLabels[customer.plan]?.label || customer.plan}
                </span>
              </div>
              {customer.name && <p class="text-sm text-gray-500">{customer.email}</p>}
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button
              type="button"
              id="openReplyModal"
              class="px-3 py-1.5 bg-exact-blue text-white text-sm font-medium rounded-lg hover:bg-exact-dark transition-colors flex items-center gap-1.5"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              Email
            </button>
          </div>
        </div>

        {error && (
          <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700">
            {error}
          </div>
        )}

        {/* Quick Stats Bar */}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
          <div class="flex flex-wrap items-center gap-6 text-sm">
            <div class="flex items-center gap-2">
              <span class="text-gray-500">Klant sinds</span>
              <span class="font-medium">{new Date(customer.created_at).toLocaleDateString('nl-NL', { day: 'numeric', month: 'short', year: 'numeric' })}</span>
            </div>
            <div class="hidden sm:block w-px h-4 bg-gray-200"></div>
            <div class="flex items-center gap-2">
              <span class="text-gray-500">API calls</span>
              <span class="font-medium">{apiCallsThisMonth.toLocaleString()}</span>
            </div>
            <div class="hidden sm:block w-px h-4 bg-gray-200"></div>
            <div class="flex items-center gap-2">
              <span class="text-gray-500">Connecties</span>
              <span class="font-medium">{connections.length}</span>
            </div>
            <div class="hidden sm:block w-px h-4 bg-gray-200"></div>
            <div class="flex items-center gap-2">
              <span class="text-gray-500">Laatste contact</span>
              <span class="font-medium">{lastContact ? formatTimeAgo(lastContact) : 'geen'}</span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
          {/* Sidebar */}
          <div class="space-y-4">
            {/* Communication Stats */}
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
              <h2 class="text-sm font-semibold text-gray-700 mb-3">Communicatie</h2>
              <div class="space-y-2">
                <a
                  href={`/admin/customer/${customerId}?type=email`}
                  class={`flex items-center justify-between p-2 rounded-lg transition-colors ${typeFilter === 'email' ? 'bg-blue-50' : 'hover:bg-gray-50'}`}
                >
                  <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                    <span class="text-sm">Emails</span>
                  </div>
                  <span class="text-sm font-medium text-gray-600">{emailCount}</span>
                </a>
                <a
                  href={`/admin/customer/${customerId}?type=support`}
                  class={`flex items-center justify-between p-2 rounded-lg transition-colors ${typeFilter === 'support' ? 'bg-purple-50' : 'hover:bg-gray-50'}`}
                >
                  <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-purple-500"></div>
                    <span class="text-sm">Support</span>
                  </div>
                  <span class="text-sm font-medium text-gray-600">{supportCount}</span>
                </a>
                <a
                  href={`/admin/customer/${customerId}?type=feedback`}
                  class={`flex items-center justify-between p-2 rounded-lg transition-colors ${typeFilter === 'feedback' ? 'bg-amber-50' : 'hover:bg-gray-50'}`}
                >
                  <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                    <span class="text-sm">Feedback</span>
                  </div>
                  <span class="text-sm font-medium text-gray-600">{feedbackCount}</span>
                </a>
                {typeFilter && (
                  <a
                    href={`/admin/customer/${customerId}`}
                    class="block text-center text-xs text-gray-500 hover:text-gray-700 pt-2"
                  >
                    Toon alles
                  </a>
                )}
              </div>
            </div>

            {/* Connections */}
            {connections.length > 0 && (
              <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <h2 class="text-sm font-semibold text-gray-700 mb-3">Exact Connecties</h2>
                <div class="space-y-2">
                  {connections.map((conn) => (
                    <div class="p-2 bg-gray-50 rounded-lg">
                      <div class="flex items-center justify-between">
                        <span class="text-sm font-medium">{conn.region.toUpperCase()}</span>
                        <span class={`w-2 h-2 rounded-full ${conn.status === 'active' ? 'bg-green-500' : 'bg-red-500'}`}></span>
                      </div>
                      {conn.exact_user_name && (
                        <p class="text-xs text-gray-500 mt-0.5">{conn.exact_user_name}</p>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* API Keys */}
            {apiKeys.length > 0 && (
              <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <h2 class="text-sm font-semibold text-gray-700 mb-3">API Keys</h2>
                <div class="space-y-1.5">
                  {apiKeys.map((key) => (
                    <div class="flex items-center justify-between text-sm">
                      <span class="font-mono text-gray-600">{key.key_prefix}...</span>
                      <span class="text-xs text-gray-400">{key.last_used_at ? formatTimeAgo(key.last_used_at) : 'nooit'}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* Main Content - Communications */}
          <div class="lg:col-span-3">
            {/* Search */}
            <div class="mb-4">
              <form method="GET" class="flex gap-2">
                <input type="hidden" name="type" value={typeFilter} />
                <div class="flex-1 relative">
                  <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                  <input
                    type="text"
                    name="search"
                    placeholder="Zoeken..."
                    value={searchQuery}
                    class="w-full pl-9 pr-4 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
                  />
                </div>
                {searchQuery && (
                  <a
                    href={typeFilter ? `/admin/customer/${customerId}?type=${typeFilter}` : `/admin/customer/${customerId}`}
                    class="px-3 py-2 text-sm text-gray-500 hover:text-gray-700"
                  >
                    Reset
                  </a>
                )}
              </form>
            </div>

            {/* Events List */}
            {events.length === 0 ? (
              <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
                <svg class="w-10 h-10 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <p class="text-gray-500">Geen communicatie gevonden</p>
                {(typeFilter || searchQuery) && (
                  <a href={`/admin/customer/${customerId}`} class="text-sm text-exact-blue hover:underline mt-2 inline-block">
                    Bekijk alle berichten
                  </a>
                )}
              </div>
            ) : (
              <div class="space-y-2">
                {events.map((event) => {
                  const metadata = parseMetadata(event.metadata);
                  const typeBadge = getTypeBadge(event.type);
                  const isInbound = event.direction === 'in';

                  return (
                    <div
                      class="event-card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden group"
                      data-event-id={event.id}
                    >
                      {/* Collapsed view - always visible */}
                      <button
                        type="button"
                        class="event-toggle w-full text-left p-4 hover:bg-gray-50 transition-colors"
                        data-event-content={event.content}
                        data-event-subject={event.subject || ''}
                      >
                        <div class="flex items-start gap-3">
                          {/* Type indicator */}
                          <div class={`flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center ${typeBadge.bg}`}>
                            <svg class={`w-4 h-4 ${typeBadge.text}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={getTypeIcon(event.type)} />
                            </svg>
                          </div>

                          {/* Content preview */}
                          <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-0.5">
                              <span class={`text-xs font-medium ${typeBadge.text}`}>{typeBadge.label}</span>
                              <span class={`text-xs ${isInbound ? 'text-green-600' : 'text-blue-600'}`}>
                                {isInbound ? '← Inkomend' : '→ Uitgaand'}
                              </span>
                              {metadata.nps_score && (
                                <span class="text-xs text-amber-600 font-medium">NPS {metadata.nps_score}</span>
                              )}
                            </div>

                            {event.subject && (
                              <h3 class="font-medium text-gray-900 text-sm mb-0.5 truncate">{event.subject}</h3>
                            )}

                            <p class="text-gray-500 text-sm line-clamp-1">{event.content}</p>
                          </div>

                          {/* Time + expand indicator */}
                          <div class="flex-shrink-0 text-right">
                            <span class="text-xs text-gray-400">{formatTimeAgo(event.created_at)}</span>
                            <svg class="expand-icon w-4 h-4 text-gray-300 mt-1 ml-auto transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                          </div>
                        </div>
                      </button>

                      {/* Expanded view - hidden by default */}
                      <div class="event-details hidden border-t border-gray-100">
                        <div class="p-4 bg-gray-50">
                          <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                            <span>{formatDate(event.created_at)}</span>
                            {event.related_id && event.type === 'support' && (
                              <a href={`/admin/support/conversations/${event.related_id}`} class="text-exact-blue hover:underline">
                                Bekijk gesprek →
                              </a>
                            )}
                          </div>

                          <div class="bg-white rounded-lg p-3 text-sm text-gray-700 whitespace-pre-wrap max-h-64 overflow-y-auto">
                            {event.content}
                          </div>

                          {/* Quick actions */}
                          <div class="flex items-center justify-end gap-2 mt-3">
                            <button
                              type="button"
                              class="reply-btn px-3 py-1.5 text-sm text-exact-blue border border-exact-blue rounded-lg hover:bg-exact-blue hover:text-white transition-colors flex items-center gap-1"
                              data-subject={event.subject ? `Re: ${event.subject}` : ''}
                              data-context={event.content.substring(0, 300)}
                            >
                              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                              </svg>
                              Beantwoorden
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      </>
    )}
  </div>

  {/* Email Reply Modal */}
  <div id="replyModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Email Sturen</h3>
          <button type="button" id="closeReplyModal" class="text-gray-400 hover:text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <form id="replyForm" class="space-y-4">
          <input type="hidden" name="userId" value={customer?.id || ''} />
          <input type="hidden" name="toEmail" value={customer?.email || ''} />

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Aan</label>
            <input
              type="text"
              value={customer?.email || ''}
              disabled
              class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-gray-600 text-sm"
            />
          </div>

          {/* Template Selector */}
          {templates.length > 0 && (
            <div>
              <label for="templateSelect" class="block text-sm font-medium text-gray-700 mb-1">
                Template <span class="text-gray-400 font-normal">(optioneel)</span>
              </label>
              <select
                id="templateSelect"
                class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              >
                <option value="">-- Selecteer --</option>
                {Object.entries(templatesByCategory).map(([category, categoryTemplates]) => (
                  <optgroup label={categoryLabels[category] || category}>
                    {categoryTemplates.map((tpl) => (
                      <option
                        value={tpl.id}
                        data-subject={tpl.subject_template}
                        data-body={tpl.body_template}
                      >
                        {tpl.name}
                      </option>
                    ))}
                  </optgroup>
                ))}
              </select>
            </div>
          )}

          <div>
            <label for="replySubject" class="block text-sm font-medium text-gray-700 mb-1">Onderwerp</label>
            <input
              type="text"
              id="replySubject"
              name="subject"
              required
              class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              placeholder="Onderwerp..."
            />
          </div>

          <div>
            <label for="replyContent" class="block text-sm font-medium text-gray-700 mb-1">Bericht</label>
            <textarea
              id="replyContent"
              name="content"
              rows="8"
              required
              class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent resize-none"
              placeholder="Schrijf je bericht..."
            ></textarea>
          </div>

          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              id="cancelReply"
              class="px-4 py-2 text-sm border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors"
            >
              Annuleren
            </button>
            <button
              type="submit"
              class="px-4 py-2 text-sm bg-exact-blue text-white font-medium rounded-lg hover:bg-exact-dark transition-colors flex items-center gap-1.5"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
              Versturen
            </button>
          </div>
        </form>

        <div id="replyResult" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
      </div>
    </div>
  </div>

  <script define:vars={{ customerName: customer?.name || customer?.email || '' }}>
    // Event card expand/collapse
    document.querySelectorAll('.event-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const card = btn.closest('.event-card');
        const details = card.querySelector('.event-details');
        const icon = card.querySelector('.expand-icon');

        // Close other open cards
        document.querySelectorAll('.event-card').forEach(otherCard => {
          if (otherCard !== card) {
            otherCard.querySelector('.event-details')?.classList.add('hidden');
            otherCard.querySelector('.expand-icon')?.classList.remove('rotate-180');
          }
        });

        // Toggle this card
        details.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
      });
    });

    // Modal controls
    const replyModal = document.getElementById('replyModal');
    const openBtn = document.getElementById('openReplyModal');
    const closeBtn = document.getElementById('closeReplyModal');
    const cancelBtn = document.getElementById('cancelReply');
    const replyForm = document.getElementById('replyForm');
    const resultDiv = document.getElementById('replyResult');
    const templateSelect = document.getElementById('templateSelect');
    const subjectInput = document.getElementById('replySubject');
    const contentInput = document.getElementById('replyContent');

    function replaceVariables(text) {
      return text
        .replace(/\{\{customer_name\}\}/g, customerName)
        .replace(/\{\{issue_title\}\}/g, '')
        .replace(/\{\{resolution_details\}\}/g, '')
        .replace(/\{\{answer\}\}/g, '');
    }

    function openModal(prefillSubject = '', prefillContext = '') {
      replyModal?.classList.remove('hidden');
      if (prefillSubject && subjectInput) {
        subjectInput.value = prefillSubject;
      }
      if (prefillContext && contentInput) {
        contentInput.value = `\n\n---\nOrigineel:\n${prefillContext}`;
        contentInput.setSelectionRange(0, 0);
      }
    }

    function closeModal() {
      replyModal?.classList.add('hidden');
      resultDiv?.classList.add('hidden');
      replyForm?.reset();
    }

    openBtn?.addEventListener('click', () => openModal());
    closeBtn?.addEventListener('click', closeModal);
    cancelBtn?.addEventListener('click', closeModal);
    replyModal?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal();
    });

    // Template selection
    templateSelect?.addEventListener('change', (e) => {
      const option = e.target.options[e.target.selectedIndex];
      if (option.value) {
        subjectInput.value = replaceVariables(option.dataset.subject || '');
        contentInput.value = replaceVariables(option.dataset.body || '');
      }
    });

    // Reply buttons in expanded cards
    document.querySelectorAll('.reply-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        openModal(btn.dataset.subject, btn.dataset.context);
      });
    });

    // Form submission
    replyForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(replyForm);
      const data = {
        userId: formData.get('userId'),
        toEmail: formData.get('toEmail'),
        subject: replaceVariables(formData.get('subject')),
        content: replaceVariables(formData.get('content')),
      };

      try {
        const response = await fetch('/api/admin/reply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (resultDiv) {
          resultDiv.classList.remove('hidden');
          if (result.success) {
            resultDiv.className = 'mt-4 p-3 rounded-lg text-sm bg-green-50 border border-green-200 text-green-700';
            resultDiv.textContent = 'Email verstuurd!';
            setTimeout(() => window.location.reload(), 1000);
          } else {
            resultDiv.className = 'mt-4 p-3 rounded-lg text-sm bg-red-50 border border-red-200 text-red-700';
            resultDiv.textContent = 'Fout: ' + (result.error || 'Onbekende fout');
          }
        }
      } catch (error) {
        if (resultDiv) {
          resultDiv.classList.remove('hidden');
          resultDiv.className = 'mt-4 p-3 rounded-lg text-sm bg-red-50 border border-red-200 text-red-700';
          resultDiv.textContent = 'Netwerkfout';
        }
      }
    });
  </script>
</Layout>
