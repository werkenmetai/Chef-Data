---
import Layout from '../../layouts/Layout.astro';
import {
  buildAuthorizationUrl,
  generateState,
  encodeState,
  generateCodeVerifier,
  generateCodeChallenge,
  type ExactRegion
} from '../../lib/exact-auth';

// Get environment variables
const env = Astro.locals.runtime.env;

// Validate required environment variables
const clientId = env.EXACT_CLIENT_ID;
const redirectUri = env.EXACT_REDIRECT_URI;

if (!clientId || !redirectUri) {
  console.error('Missing required environment variables:', {
    hasClientId: !!clientId,
    hasRedirectUri: !!redirectUri,
  });
}

// Show error state for configuration issues
const isConfigured = Boolean(clientId && redirectUri);

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const region = (formData.get('region') as ExactRegion) || 'NL';

  // Generate PKCE code verifier and challenge
  const codeVerifier = generateCodeVerifier();
  const codeChallenge = await generateCodeChallenge(codeVerifier);

  // Return URL after OAuth completes
  const returnUrl = '/dashboard';

  // Generate secure state with nonce and HMAC signature
  const nonce = generateState();
  const state = await encodeState({
    region,
    nonce,
    returnUrl,
  }, env.SESSION_SECRET);

  // Store nonce in cookie for verification (httpOnly, secure)
  Astro.cookies.set('oauth_nonce', nonce, {
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 600, // 10 minutes
    path: '/',
  });

  // Store PKCE code verifier in separate cookie (httpOnly, secure)
  Astro.cookies.set('oauth_code_verifier', codeVerifier, {
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 600, // 10 minutes
    path: '/',
  });

  // Check environment variables before redirect
  if (!clientId || !redirectUri) {
    return new Response('OAuth not configured. Please contact support.', { status: 500 });
  }

  // Redirect to Exact Online with PKCE
  const authUrl = await buildAuthorizationUrl(
    clientId,
    redirectUri,
    state,
    region,
    codeChallenge
  );

  return Astro.redirect(authUrl);
}

const regions = [
  { code: 'NL', name: 'Nederland', flag: 'ðŸ‡³ðŸ‡±' },
  { code: 'BE', name: 'BelgiÃ«', flag: 'ðŸ‡§ðŸ‡ª' },
  { code: 'DE', name: 'Duitsland', flag: 'ðŸ‡©ðŸ‡ª' },
  { code: 'UK', name: 'Verenigd Koninkrijk', flag: 'ðŸ‡¬ðŸ‡§' },
  { code: 'FR', name: 'Frankrijk', flag: 'ðŸ‡«ðŸ‡·' },
  { code: 'ES', name: 'Spanje', flag: 'ðŸ‡ªðŸ‡¸' },
  { code: 'US', name: 'Verenigde Staten', flag: 'ðŸ‡ºðŸ‡¸' },
];
---

<Layout title="Verbind met Exact Online" lang="nl">
  <div class="max-w-lg mx-auto px-4 py-16">
    <!-- Exact App Center Badge -->
    <div class="text-center mb-6">
      <span class="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
        Exact Online App Center
      </span>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8">
      <h1 class="text-2xl font-bold text-gray-900 text-center mb-2">
        Start met Praat met je Boekhouding
      </h1>
      <p class="text-gray-600 text-center mb-8">
        Verbind je Exact Online administratie en begin direct met vragen stellen.
      </p>

      {!isConfigured && (
        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-red-700 text-sm">
            OAuth configuratie ontbreekt. Neem contact op met de beheerder.
          </p>
        </div>
      )}

      <form method="POST" class="space-y-6">
        <div>
          <label for="region" class="block text-sm font-medium text-gray-700 mb-2">
            Selecteer je Exact Online regio
          </label>
          <select
            id="region"
            name="region"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-exact-blue"
          >
            {regions.map((region) => (
              <option value={region.code} selected={region.code === 'NL'}>
                {region.flag} {region.name}
              </option>
            ))}
          </select>
          <p class="mt-1 text-xs text-gray-500">
            Dit is de regio waar je Exact Online account is aangemaakt.
          </p>
        </div>

        <button
          type="submit"
          disabled={!isConfigured}
          class={`w-full px-6 py-3 font-semibold rounded-lg transition-colors ${
            isConfigured
              ? 'bg-exact-blue text-white hover:bg-exact-dark'
              : 'bg-gray-300 text-gray-500 cursor-not-allowed'
          }`}
        >
          Verbinden met Exact Online
        </button>
      </form>

      <div class="mt-8 pt-6 border-t border-gray-100">
        <h3 class="text-sm font-medium text-gray-900 mb-3">Wat gebeurt er?</h3>
        <ul class="text-sm text-gray-600 space-y-2">
          <li class="flex items-start">
            <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Je wordt doorgestuurd naar Exact Online om in te loggen
          </li>
          <li class="flex items-start">
            <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Je geeft toestemming voor <strong>alleen-lezen</strong> toegang
          </li>
          <li class="flex items-start">
            <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Je ontvangt een API key voor je AI assistent
          </li>
          <li class="flex items-start">
            <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            We bewaren alleen een token, nooit je wachtwoord
          </li>
        </ul>
      </div>

      <div class="mt-6 pt-6 border-t border-gray-100">
        <div class="flex items-center justify-center gap-4 text-sm text-gray-500">
          <a href="/exact/info" class="hover:text-gray-700 hover:underline">
            Meer informatie
          </a>
          <span>â€¢</span>
          <a href="/privacy" class="hover:text-gray-700 hover:underline">
            Privacybeleid
          </a>
          <span>â€¢</span>
          <a href="/voorwaarden" class="hover:text-gray-700 hover:underline">
            Voorwaarden
          </a>
        </div>
      </div>
    </div>

    <!-- Security note -->
    <div class="mt-6 bg-gray-50 rounded-lg p-4">
      <div class="flex items-start">
        <svg class="w-5 h-5 text-gray-400 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        <div>
          <p class="text-sm font-medium text-gray-700">Beveiligd met OAuth 2.0 + PKCE</p>
          <p class="text-xs text-gray-500 mt-1">
            Je gegevens worden versleuteld verzonden en we volgen de hoogste beveiligingsstandaarden.
          </p>
        </div>
      </div>
    </div>
  </div>
</Layout>
