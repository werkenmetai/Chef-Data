---
/**
 * ADMIN-002: Developer Tab
 *
 * Dedicated developer section for API key management and developer tools.
 * Moved from dashboard to provide better separation of concerns.
 */
import Layout from '../../../layouts/Layout.astro';
// AdminAppLauncher now in Layout.astro header
import { Database } from '../../../lib/database';

const env = Astro.locals.runtime?.env;
let db: Database | null = null;
let isAdmin = false;

// API key data - standalone interface (not extending ApiKey) for admin view with user info
interface ApiKeyWithStats {
  id: string;
  user_id: string;
  name: string;
  key_prefix: string;
  created_at: string;
  last_used_at: string | null;
  user_email: string;
  user_plan: string;
  usage_30d: number;
}

let allApiKeys: ApiKeyWithStats[] = [];
let stats = {
  totalKeys: 0,
  activeKeys: 0,
  totalCalls30d: 0,
  avgCallsPerKey: 0,
};

let error: string | null = null;
let success: string | null = null;

// Handle POST actions
if (Astro.request.method === 'POST' && env?.DB) {
  const formData = await Astro.request.formData();
  const action = formData.get('action');
  const sessionId = Astro.cookies.get('session_id')?.value;

  if (sessionId) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);
    const session = await db.validateSession(sessionId);

    if (session) {
      const adminEmails = (env.ADMIN_EMAILS || '')
        .split(',')
        .map((e: string) => e.trim().toLowerCase())
        .filter((e: string) => e.length > 0);

      if (adminEmails.includes(session.user.email.toLowerCase())) {
        if (action === 'revoke_key') {
          const keyId = formData.get('key_id')?.toString();
          const userId = formData.get('user_id')?.toString();
          if (keyId && userId) {
            await db.revokeApiKey(keyId, userId);
            success = 'API key ingetrokken';
          }
        }
      }
    }
  }
}

try {
  if (env?.DB) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());

        if (isAdmin) {
          // Load all API keys with user info and usage stats
          const keysResult = await env.DB.prepare(`
            SELECT
              ak.id,
              ak.user_id,
              ak.name,
              ak.key_prefix,
              ak.created_at,
              ak.last_used_at,
              u.email as user_email,
              u.plan as user_plan,
              COALESCE(
                (SELECT COUNT(*) FROM api_usage_logs
                 WHERE api_key_id = ak.id
                 AND created_at > datetime('now', '-30 days')),
                0
              ) as usage_30d
            FROM api_keys ak
            JOIN users u ON ak.user_id = u.id
            ORDER BY ak.last_used_at DESC NULLS LAST, ak.created_at DESC
          `).all<{
            id: string;
            user_id: string;
            name: string;
            key_prefix: string;
            created_at: string;
            last_used_at: string | null;
            user_email: string;
            user_plan: string;
            usage_30d: number;
          }>();

          allApiKeys = (keysResult.results || []).map(k => ({
            id: k.id,
            user_id: k.user_id,
            name: k.name,
            key_prefix: k.key_prefix,
            created_at: k.created_at,
            last_used_at: k.last_used_at,
            user_email: k.user_email,
            user_plan: k.user_plan,
            usage_30d: k.usage_30d,
          }));

          // Calculate stats
          stats.totalKeys = allApiKeys.length;
          stats.activeKeys = allApiKeys.filter(k => k.last_used_at).length;
          stats.totalCalls30d = allApiKeys.reduce((sum, k) => sum + k.usage_30d, 0);
          stats.avgCallsPerKey = stats.activeKeys > 0
            ? Math.round(stats.totalCalls30d / stats.activeKeys)
            : 0;
        }
      }
    }
  }
} catch (e) {
  console.error('Developer page error:', e);
  error = 'Er is een fout opgetreden bij het laden van de gegevens.';
}

// Helper functions
function formatDate(dateString: string | null): string {
  if (!dateString) return 'Nooit';
  return new Date(dateString).toLocaleDateString('nl-NL', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}

function getPlanBadgeClass(plan: string): string {
  switch (plan) {
    case 'pro': return 'bg-purple-100 text-purple-700';
    case 'business': return 'bg-blue-100 text-blue-700';
    default: return 'bg-gray-100 text-gray-600';
  }
}

function getActivityStatus(lastUsed: string | null): { label: string; class: string } {
  if (!lastUsed) return { label: 'Nooit gebruikt', class: 'bg-gray-100 text-gray-600' };

  const daysSince = Math.floor((Date.now() - new Date(lastUsed).getTime()) / (1000 * 60 * 60 * 24));

  if (daysSince <= 1) return { label: 'Actief vandaag', class: 'bg-green-100 text-green-700' };
  if (daysSince <= 7) return { label: 'Actief deze week', class: 'bg-green-50 text-green-600' };
  if (daysSince <= 30) return { label: 'Actief deze maand', class: 'bg-yellow-100 text-yellow-700' };
  return { label: `${daysSince}d geleden`, class: 'bg-orange-100 text-orange-700' };
}
---

<Layout title="Developer - Admin">
  <div class="max-w-6xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          Terug naar Dashboard
        </a>
      </div>
    ) : (
      <>
        {/* Header */}
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Developer</h1>
            <p class="text-gray-600">API keys, usage en developer tools</p>
          </div>
          <div class="flex items-center gap-3">
            <a href="/admin" class="text-gray-600 hover:text-gray-900 flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
              &larr; Admin Home
            </a>
          </div>
        </div>

        {/* Notifications */}
        {error && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
            {error}
          </div>
        )}
        {success && (
          <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700">
            {success}
          </div>
        )}

        {/* Stats Grid */}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-blue-100 rounded-lg">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                </svg>
              </div>
              <div>
                <p class="text-2xl font-bold text-gray-900">{stats.totalKeys}</p>
                <p class="text-sm text-gray-500">Totaal keys</p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-green-100 rounded-lg">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div>
                <p class="text-2xl font-bold text-gray-900">{stats.activeKeys}</p>
                <p class="text-sm text-gray-500">Actieve keys</p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-purple-100 rounded-lg">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
              </div>
              <div>
                <p class="text-2xl font-bold text-gray-900">{stats.totalCalls30d.toLocaleString('nl-NL')}</p>
                <p class="text-sm text-gray-500">Calls (30d)</p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-amber-100 rounded-lg">
                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              </div>
              <div>
                <p class="text-2xl font-bold text-gray-900">{stats.avgCallsPerKey}</p>
                <p class="text-sm text-gray-500">Gem. calls/key</p>
              </div>
            </div>
          </div>
        </div>

        {/* API Keys Table */}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          <div class="p-6 border-b border-gray-100">
            <div class="flex justify-between items-center">
              <div>
                <h2 class="text-lg font-semibold text-gray-900">API Keys</h2>
                <p class="text-sm text-gray-500">Alle API keys van alle gebruikers</p>
              </div>
              <div class="flex items-center gap-2">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Zoek op email of key..."
                  class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-exact-blue focus:border-exact-blue"
                />
              </div>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full" id="keysTable">
              <thead class="bg-gray-50 border-b border-gray-100">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Key</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gebruiker</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usage (30d)</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aangemaakt</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acties</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                {allApiKeys.length === 0 ? (
                  <tr>
                    <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                      Geen API keys gevonden
                    </td>
                  </tr>
                ) : (
                  allApiKeys.map((key) => {
                    const activity = getActivityStatus(key.last_used_at);
                    return (
                      <tr class="hover:bg-gray-50 key-row" data-search={`${key.user_email} ${key.key_prefix} ${key.name}`.toLowerCase()}>
                        <td class="px-6 py-4">
                          <div>
                            <p class="font-medium text-gray-900">{key.name}</p>
                            <p class="text-sm text-gray-500 font-mono">{key.key_prefix}...</p>
                          </div>
                        </td>
                        <td class="px-6 py-4">
                          <div class="flex items-center gap-2">
                            <a href={`/admin/customer/${key.user_id}`} class="text-exact-blue hover:underline">
                              {key.user_email}
                            </a>
                            <span class={`px-2 py-0.5 text-xs font-medium rounded-full ${getPlanBadgeClass(key.user_plan)}`}>
                              {key.user_plan}
                            </span>
                          </div>
                        </td>
                        <td class="px-6 py-4">
                          <span class={`px-2 py-1 text-xs font-medium rounded-full ${activity.class}`}>
                            {activity.label}
                          </span>
                        </td>
                        <td class="px-6 py-4">
                          <div class="flex items-center gap-2">
                            <span class="text-gray-900 font-medium">{key.usage_30d.toLocaleString('nl-NL')}</span>
                            {key.usage_30d > 100 && (
                              <span class="text-green-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                </svg>
                              </span>
                            )}
                          </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                          {formatDate(key.created_at)}
                        </td>
                        <td class="px-6 py-4 text-right">
                          <form method="POST" class="inline" onsubmit="return confirm('Weet je zeker dat je deze key wilt intrekken?');">
                            <input type="hidden" name="action" value="revoke_key" />
                            <input type="hidden" name="key_id" value={key.id} />
                            <input type="hidden" name="user_id" value={key.user_id} />
                            <button
                              type="submit"
                              class="text-red-600 hover:text-red-800 text-sm font-medium"
                            >
                              Intrekken
                            </button>
                          </form>
                        </td>
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Quick Links */}
        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center gap-3 mb-4">
              <div class="p-2 bg-blue-100 rounded-lg">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
              </div>
              <h3 class="font-medium text-gray-900">API Documentatie</h3>
            </div>
            <p class="text-sm text-gray-500 mb-4">Bekijk de MCP server documentatie en tool referenties.</p>
            <a href="/docs" class="text-exact-blue hover:underline text-sm font-medium">
              Bekijk docs &rarr;
            </a>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center gap-3 mb-4">
              <div class="p-2 bg-purple-100 rounded-lg">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>
              <h3 class="font-medium text-gray-900">Demo Mode</h3>
            </div>
            <p class="text-sm text-gray-500 mb-4">Test de MCP server met demo data (geen echte API calls).</p>
            <a href="/admin/demo" class="text-exact-blue hover:underline text-sm font-medium">
              Open demo &rarr;
            </a>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center gap-3 mb-4">
              <div class="p-2 bg-green-100 rounded-lg">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              </div>
              <h3 class="font-medium text-gray-900">Usage Analytics</h3>
            </div>
            <p class="text-sm text-gray-500 mb-4">Gedetailleerde usage statistieken per endpoint.</p>
            <span class="text-gray-400 text-sm">Komt eraan</span>
          </div>
        </div>

        {/* Webhook Configuration - Future Feature */}
        <div class="mt-8 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200 p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="p-2 bg-white rounded-lg shadow-sm">
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
            <div>
              <h3 class="font-medium text-gray-900">Webhooks</h3>
              <span class="text-xs text-gray-500">Komt eraan</span>
            </div>
          </div>
          <p class="text-sm text-gray-600">
            Ontvang real-time notificaties wanneer belangrijke events plaatsvinden, zoals nieuwe gebruikers, API errors, of rate limit warnings.
          </p>
        </div>
      </>
    )}
  </div>

  <script>
    // Search functionality
    const searchInput = document.getElementById('searchInput') as HTMLInputElement;
    const keyRows = document.querySelectorAll('.key-row');

    searchInput?.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase();

      keyRows.forEach(row => {
        const searchData = row.getAttribute('data-search') || '';
        if (searchData.includes(query)) {
          (row as HTMLElement).style.display = '';
        } else {
          (row as HTMLElement).style.display = 'none';
        }
      });
    });
  </script>
</Layout>
