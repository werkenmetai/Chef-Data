---
/**
 * Admin Feedback Dashboard
 *
 * Overview of all feedback, testimonials, and NPS scores.
 */
import Layout from '../../../layouts/Layout.astro';
import AdminHeader from '../../../components/AdminHeader.astro';
import { Database } from '../../../lib/database';

const env = Astro.locals.runtime?.env;
let db: Database | null = null;
let isAdmin = false;

interface FeedbackItem {
  id: string;
  user_id: string;
  feedback_type: string;
  trigger_event: string | null;
  nps_score: number | null;
  sentiment: string | null;
  feedback_text: string | null;
  improvement_category: string | null;
  testimonial_quote: string | null;
  testimonial_approved: number;
  testimonial_display_name: string | null;
  permission_website: number;
  source: string;
  status: string;
  created_at: string;
  user_email?: string;
  user_name?: string;
}

interface FeedbackStats {
  total: number;
  nps_responses: number;
  testimonials_pending: number;
  testimonials_approved: number;
  avg_nps: number;
  promoters: number;
  passives: number;
  detractors: number;
}

let feedback: FeedbackItem[] = [];
let stats: FeedbackStats = {
  total: 0,
  nps_responses: 0,
  testimonials_pending: 0,
  testimonials_approved: 0,
  avg_nps: 0,
  promoters: 0,
  passives: 0,
  detractors: 0,
};

// Filters
const filterType = Astro.url.searchParams.get('type') || 'all';
const filterStatus = Astro.url.searchParams.get('status') || 'all';
const filterSentiment = Astro.url.searchParams.get('sentiment') || 'all';
const filterTrigger = Astro.url.searchParams.get('trigger') || 'all';

try {
  if (env?.DB) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());

        if (isAdmin) {
          // Build query with filters
          let whereClause = '1=1';
          const params: string[] = [];

          if (filterType !== 'all') {
            whereClause += ` AND f.feedback_type = ?`;
            params.push(filterType);
          }
          if (filterStatus !== 'all') {
            whereClause += ` AND f.status = ?`;
            params.push(filterStatus);
          }
          if (filterSentiment !== 'all') {
            whereClause += ` AND f.sentiment = ?`;
            params.push(filterSentiment);
          }
          if (filterTrigger !== 'all') {
            whereClause += ` AND f.trigger_event = ?`;
            params.push(filterTrigger);
          }

          const feedbackResult = await env.DB.prepare(`
            SELECT
              f.*,
              u.email as user_email,
              u.name as user_name
            FROM feedback f
            LEFT JOIN users u ON f.user_id = u.id
            WHERE ${whereClause}
            ORDER BY f.created_at DESC
            LIMIT 100
          `).bind(...params).all<FeedbackItem>();

          feedback = feedbackResult.results || [];

          // Get stats
          const statsResult = await env.DB.prepare(`
            SELECT
              COUNT(*) as total,
              SUM(CASE WHEN nps_score IS NOT NULL THEN 1 ELSE 0 END) as nps_responses,
              SUM(CASE WHEN testimonial_quote IS NOT NULL AND testimonial_approved = 0 THEN 1 ELSE 0 END) as testimonials_pending,
              SUM(CASE WHEN testimonial_approved = 1 THEN 1 ELSE 0 END) as testimonials_approved,
              AVG(CASE WHEN nps_score IS NOT NULL THEN nps_score ELSE NULL END) as avg_nps,
              SUM(CASE WHEN nps_score >= 9 THEN 1 ELSE 0 END) as promoters,
              SUM(CASE WHEN nps_score >= 7 AND nps_score < 9 THEN 1 ELSE 0 END) as passives,
              SUM(CASE WHEN nps_score < 7 AND nps_score IS NOT NULL THEN 1 ELSE 0 END) as detractors
            FROM feedback
          `).first<FeedbackStats>();

          if (statsResult) {
            stats = statsResult;
          }
        }
      }
    }
  }
} catch (e) {
  console.error('Admin feedback error:', e);
}

// Calculate NPS score
const npsScore = stats.nps_responses > 0
  ? Math.round(((stats.promoters - stats.detractors) / stats.nps_responses) * 100)
  : 0;

const statusColors: Record<string, { bg: string; text: string }> = {
  received: { bg: 'bg-blue-100', text: 'text-blue-800' },
  reviewed: { bg: 'bg-yellow-100', text: 'text-yellow-800' },
  published: { bg: 'bg-green-100', text: 'text-green-800' },
  archived: { bg: 'bg-gray-100', text: 'text-gray-800' },
  spam: { bg: 'bg-red-100', text: 'text-red-800' },
};

const sentimentColors: Record<string, { bg: string; text: string; emoji: string }> = {
  positive: { bg: 'bg-green-100', text: 'text-green-800', emoji: 'üëç' },
  neutral: { bg: 'bg-gray-100', text: 'text-gray-800', emoji: 'üòê' },
  negative: { bg: 'bg-red-100', text: 'text-red-800', emoji: 'üëé' },
};

const typeLabels: Record<string, string> = {
  nps: 'NPS',
  widget: 'Widget',
  testimonial: 'Testimonial',
  churn: 'Churn',
  support: 'Support',
};
---

<Layout title="Feedback Beheer">
  <div class="max-w-7xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          ‚Üê Terug naar Dashboard
        </a>
      </div>
    ) : (
      <>
        <!-- Header with App Launcher -->
        <AdminHeader
          title="Feedback Beheer"
          subtitle="Beheer feedback, testimonials en NPS scores"
          actions={[{ href: '/admin/feedback/testimonials', label: 'Testimonials Beheren', variant: 'primary' }]}
        />

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <!-- NPS Score -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500 mb-2">NPS Score</h3>
            <p class={`text-3xl font-bold ${npsScore >= 50 ? 'text-green-600' : npsScore >= 0 ? 'text-yellow-600' : 'text-red-600'}`}>
              {npsScore}
            </p>
            <p class="text-sm text-gray-500 mt-1">
              {stats.nps_responses} responses
            </p>
          </div>

          <!-- Promoters/Detractors Breakdown -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500 mb-2">NPS Breakdown</h3>
            <div class="space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-sm text-green-600">Promoters (9-10)</span>
                <span class="font-medium">{stats.promoters}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-yellow-600">Passives (7-8)</span>
                <span class="font-medium">{stats.passives}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-red-600">Detractors (1-6)</span>
                <span class="font-medium">{stats.detractors}</span>
              </div>
            </div>
          </div>

          <!-- Testimonials -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500 mb-2">Testimonials</h3>
            <div class="flex items-baseline gap-2">
              <p class="text-3xl font-bold text-gray-900">{stats.testimonials_approved}</p>
              <span class="text-sm text-gray-500">gepubliceerd</span>
            </div>
            {stats.testimonials_pending > 0 && (
              <p class="text-sm text-amber-600 mt-1">
                {stats.testimonials_pending} wachtend op review
              </p>
            )}
          </div>

          <!-- Total Feedback -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500 mb-2">Totaal Feedback</h3>
            <p class="text-3xl font-bold text-gray-900">{stats.total}</p>
            <p class="text-sm text-gray-500 mt-1">
              alle responses
            </p>
          </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
          <form method="GET" class="flex flex-wrap gap-4 items-center">
            <div>
              <label class="text-sm font-medium text-gray-700 mr-2">Type:</label>
              <select
                name="type"
                class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              >
                <option value="all" selected={filterType === 'all'}>Alle</option>
                <option value="nps" selected={filterType === 'nps'}>NPS</option>
                <option value="widget" selected={filterType === 'widget'}>Widget</option>
                <option value="testimonial" selected={filterType === 'testimonial'}>Testimonial</option>
                <option value="churn" selected={filterType === 'churn'}>Churn</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-medium text-gray-700 mr-2">Status:</label>
              <select
                name="status"
                class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              >
                <option value="all" selected={filterStatus === 'all'}>Alle</option>
                <option value="received" selected={filterStatus === 'received'}>Ontvangen</option>
                <option value="reviewed" selected={filterStatus === 'reviewed'}>Beoordeeld</option>
                <option value="published" selected={filterStatus === 'published'}>Gepubliceerd</option>
                <option value="archived" selected={filterStatus === 'archived'}>Gearchiveerd</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-medium text-gray-700 mr-2">Sentiment:</label>
              <select
                name="sentiment"
                class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              >
                <option value="all" selected={filterSentiment === 'all'}>Alle</option>
                <option value="positive" selected={filterSentiment === 'positive'}>Positief</option>
                <option value="neutral" selected={filterSentiment === 'neutral'}>Neutraal</option>
                <option value="negative" selected={filterSentiment === 'negative'}>Negatief</option>
              </select>
            </div>

            <button
              type="submit"
              class="px-4 py-1.5 bg-exact-blue text-white text-sm font-medium rounded-lg hover:bg-exact-dark transition-colors"
            >
              Filter
            </button>

            {(filterType !== 'all' || filterStatus !== 'all' || filterSentiment !== 'all') && (
              <a href="/admin/feedback" class="text-sm text-gray-500 hover:text-gray-700">
                Reset filters
              </a>
            )}
          </form>
        </div>

        <!-- Feedback List -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gebruiker</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">NPS</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sentiment</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Content</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Datum</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acties</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {feedback.length === 0 ? (
                <tr>
                  <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                    Geen feedback gevonden met deze filters.
                  </td>
                </tr>
              ) : (
                feedback.map((item) => (
                  <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="text-sm font-medium text-gray-900">
                        {item.user_name || 'Onbekend'}
                      </div>
                      <div class="text-sm text-gray-500">
                        {item.user_email}
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded">
                        {typeLabels[item.feedback_type] || item.feedback_type}
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      {item.nps_score !== null ? (
                        <span class={`font-bold ${
                          item.nps_score >= 9 ? 'text-green-600' :
                          item.nps_score >= 7 ? 'text-yellow-600' :
                          'text-red-600'
                        }`}>
                          {item.nps_score}
                        </span>
                      ) : (
                        <span class="text-gray-400">-</span>
                      )}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      {item.sentiment ? (
                        <span class={`inline-flex items-center px-2 py-1 rounded text-xs font-medium ${sentimentColors[item.sentiment]?.bg} ${sentimentColors[item.sentiment]?.text}`}>
                          {sentimentColors[item.sentiment]?.emoji} {item.sentiment}
                        </span>
                      ) : (
                        <span class="text-gray-400">-</span>
                      )}
                    </td>
                    <td class="px-6 py-4 max-w-xs">
                      <div class="text-sm text-gray-900 truncate" title={item.feedback_text || item.testimonial_quote || ''}>
                        {item.testimonial_quote || item.feedback_text || (
                          <span class="text-gray-400 italic">Geen tekst</span>
                        )}
                      </div>
                      {item.improvement_category && (
                        <div class="text-xs text-gray-500 mt-1">
                          Categorie: {item.improvement_category}
                        </div>
                      )}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class={`inline-flex items-center px-2 py-1 rounded text-xs font-medium ${statusColors[item.status]?.bg || 'bg-gray-100'} ${statusColors[item.status]?.text || 'text-gray-800'}`}>
                        {item.status}
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {new Date(item.created_at).toLocaleDateString('nl-NL', {
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric',
                      })}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <button
                        type="button"
                        class="text-exact-blue hover:underline view-feedback-btn"
                        data-id={item.id}
                      >
                        Bekijken
                      </button>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>

        <!-- Campaigns Section -->
        <div class="mt-8">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Email Campagnes</h2>
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex justify-between items-center mb-4">
              <p class="text-gray-600">Automatische feedback verzoeken via email.</p>
              <button
                type="button"
                id="runCronBtn"
                class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors"
              >
                Handmatig Uitvoeren
              </button>
            </div>
            <div id="cronResult" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
              <pre class="text-sm text-gray-700"></pre>
            </div>
          </div>
        </div>
      </>
    )}
  </div>

  <!-- Feedback Detail Modal -->
  <div id="feedbackModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Feedback Details</h3>
          <button type="button" id="closeFeedbackModal" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div id="feedbackModalContent">
          <p class="text-gray-500">Laden...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // SEC-001: Helper functions for safe DOM manipulation
    function createLabeledField(labelText: string, valueText: string, valueClass: string = 'text-gray-900'): HTMLDivElement {
      const div = document.createElement('div');
      const label = document.createElement('label');
      label.className = 'text-sm font-medium text-gray-500';
      label.textContent = labelText;
      const p = document.createElement('p');
      p.className = valueClass;
      p.textContent = valueText;
      div.appendChild(label);
      div.appendChild(p);
      return div;
    }

    function createStatusButton(feedbackId: string, status: string, label: string, colorClass: string): HTMLButtonElement {
      const btn = document.createElement('button');
      btn.className = `px-3 py-1.5 ${colorClass} text-sm rounded hover:opacity-80`;
      btn.textContent = label;
      btn.addEventListener('click', () => (window as any).updateFeedbackStatus(feedbackId, status));
      return btn;
    }

    // View feedback detail
    document.querySelectorAll('.view-feedback-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        const modal = document.getElementById('feedbackModal');
        const content = document.getElementById('feedbackModalContent');

        if (!modal || !content) return;

        modal.classList.remove('hidden');

        // SEC-001: Use textContent for loading state
        const loadingP = document.createElement('p');
        loadingP.className = 'text-gray-500';
        loadingP.textContent = 'Laden...';
        content.innerHTML = '';
        content.appendChild(loadingP);

        try {
          const response = await fetch(`/api/admin/feedback/${id}`);
          const data = await response.json() as { feedback?: Record<string, unknown> };

          if (data.feedback) {
            const f = data.feedback as Record<string, unknown>;

            // SEC-001: Build DOM safely using DOM API instead of innerHTML
            content.innerHTML = '';

            const container = document.createElement('div');
            container.className = 'space-y-4';

            // User info row
            const userRow = document.createElement('div');
            userRow.className = 'grid grid-cols-2 gap-4';

            const userDiv = document.createElement('div');
            const userLabel = document.createElement('label');
            userLabel.className = 'text-sm font-medium text-gray-500';
            userLabel.textContent = 'Gebruiker';
            const userName = document.createElement('p');
            userName.className = 'text-gray-900';
            userName.textContent = String(f.user_name || 'Onbekend');
            const userEmail = document.createElement('p');
            userEmail.className = 'text-sm text-gray-500';
            userEmail.textContent = String(f.user_email || '');
            userDiv.appendChild(userLabel);
            userDiv.appendChild(userName);
            userDiv.appendChild(userEmail);

            const dateDiv = createLabeledField('Datum', new Date(f.created_at as string).toLocaleString('nl-NL'));

            userRow.appendChild(userDiv);
            userRow.appendChild(dateDiv);
            container.appendChild(userRow);

            // Type/NPS/Sentiment row
            const statsRow = document.createElement('div');
            statsRow.className = 'grid grid-cols-3 gap-4';
            statsRow.appendChild(createLabeledField('Type', String(f.feedback_type || '-')));
            statsRow.appendChild(createLabeledField('NPS Score', f.nps_score != null ? String(f.nps_score) : '-'));
            statsRow.appendChild(createLabeledField('Sentiment', String(f.sentiment || '-')));
            container.appendChild(statsRow);

            // Feedback text
            if (f.feedback_text) {
              const feedbackDiv = document.createElement('div');
              const feedbackLabel = document.createElement('label');
              feedbackLabel.className = 'text-sm font-medium text-gray-500';
              feedbackLabel.textContent = 'Feedback';
              const feedbackP = document.createElement('p');
              feedbackP.className = 'text-gray-900 bg-gray-50 p-3 rounded-lg mt-1';
              feedbackP.textContent = String(f.feedback_text);
              feedbackDiv.appendChild(feedbackLabel);
              feedbackDiv.appendChild(feedbackP);
              container.appendChild(feedbackDiv);
            }

            // Testimonial quote
            if (f.testimonial_quote) {
              const quoteDiv = document.createElement('div');
              const quoteLabel = document.createElement('label');
              quoteLabel.className = 'text-sm font-medium text-gray-500';
              quoteLabel.textContent = 'Testimonial Quote';
              const quoteP = document.createElement('p');
              quoteP.className = 'text-gray-900 bg-green-50 p-3 rounded-lg mt-1 italic';
              quoteP.textContent = `"${String(f.testimonial_quote)}"`;
              quoteDiv.appendChild(quoteLabel);
              quoteDiv.appendChild(quoteP);
              if (f.testimonial_display_name) {
                const nameP = document.createElement('p');
                nameP.className = 'text-sm text-gray-600 mt-1';
                nameP.textContent = `‚Äî ${String(f.testimonial_display_name)}`;
                quoteDiv.appendChild(nameP);
              }
              container.appendChild(quoteDiv);
            }

            // Improvement category
            if (f.improvement_category) {
              container.appendChild(createLabeledField('Verbetercategorie', String(f.improvement_category)));
            }

            // Status buttons
            const statusDiv = document.createElement('div');
            statusDiv.className = 'border-t border-gray-200 pt-4';
            const statusLabel = document.createElement('label');
            statusLabel.className = 'text-sm font-medium text-gray-500 block mb-2';
            statusLabel.textContent = 'Status Wijzigen';
            const btnContainer = document.createElement('div');
            btnContainer.className = 'flex gap-2 flex-wrap';

            const feedbackId = String(f.id);
            btnContainer.appendChild(createStatusButton(feedbackId, 'reviewed', 'Reviewed', 'bg-yellow-100 text-yellow-800'));
            btnContainer.appendChild(createStatusButton(feedbackId, 'published', 'Publiceer', 'bg-green-100 text-green-800'));
            btnContainer.appendChild(createStatusButton(feedbackId, 'archived', 'Archiveer', 'bg-gray-100 text-gray-800'));
            btnContainer.appendChild(createStatusButton(feedbackId, 'spam', 'Spam', 'bg-red-100 text-red-800'));

            statusDiv.appendChild(statusLabel);
            statusDiv.appendChild(btnContainer);
            container.appendChild(statusDiv);

            // Testimonial approval checkbox
            if (f.testimonial_quote && f.permission_website) {
              const approvalDiv = document.createElement('div');
              approvalDiv.className = 'border-t border-gray-200 pt-4';
              const checkLabel = document.createElement('label');
              checkLabel.className = 'flex items-center gap-2';
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.id = 'approveTestimonial';
              checkbox.className = 'rounded';
              if (f.testimonial_approved) checkbox.checked = true;
              checkbox.addEventListener('change', () => (window as any).toggleTestimonialApproval(feedbackId, checkbox.checked));
              const checkSpan = document.createElement('span');
              checkSpan.className = 'text-sm font-medium text-gray-700';
              checkSpan.textContent = 'Testimonial goedgekeurd voor website';
              checkLabel.appendChild(checkbox);
              checkLabel.appendChild(checkSpan);
              approvalDiv.appendChild(checkLabel);
              container.appendChild(approvalDiv);
            }

            content.appendChild(container);
          }
        } catch (error) {
          // SEC-001: Use textContent for error message
          const errorP = document.createElement('p');
          errorP.className = 'text-red-600';
          errorP.textContent = 'Fout bij laden van feedback.';
          content.innerHTML = '';
          content.appendChild(errorP);
        }
      });
    });

    // Close modal
    document.getElementById('closeFeedbackModal')?.addEventListener('click', () => {
      document.getElementById('feedbackModal')?.classList.add('hidden');
    });

    document.getElementById('feedbackModal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget && e.currentTarget instanceof HTMLElement) {
        e.currentTarget.classList.add('hidden');
      }
    });

    // Update feedback status
    (window as any).updateFeedbackStatus = async (id: string, status: string) => {
      try {
        const response = await fetch(`/api/admin/feedback/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });

        if (response.ok) {
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to update status:', error);
      }
    };

    // Toggle testimonial approval
    (window as any).toggleTestimonialApproval = async (id: string, approved: boolean) => {
      try {
        await fetch(`/api/admin/feedback/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ testimonial_approved: approved })
        });
      } catch (error) {
        console.error('Failed to update testimonial:', error);
      }
    };

    // Run cron manually
    document.getElementById('runCronBtn')?.addEventListener('click', async () => {
      const resultDiv = document.getElementById('cronResult');
      const pre = resultDiv?.querySelector('pre');

      if (!resultDiv || !pre) return;

      resultDiv.classList.remove('hidden');
      pre.textContent = 'Uitvoeren...';

      try {
        const response = await fetch('/api/cron/feedback-campaigns', {
          method: 'GET'
        });
        const data = await response.json();
        pre.textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        pre.textContent = 'Fout: ' + (error as Error).message;
      }
    });
  </script>
</Layout>
