---
import Layout from '../../layouts/Layout.astro';
import { Database } from '../../lib/database';

const env = Astro.locals.runtime?.env;
let db: Database | null = null;
let isAuthenticated = false;
let user: { id: string; email: string; name: string | null } | null = null;
let supportAvailable = true;
let pauseMessage = '';

try {
  if (env?.DB) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    // Check support status
    const settings = await db.getAllSystemSettings();
    supportAvailable = settings.support_enabled !== 'false' && settings.support_paused !== 'true';
    pauseMessage = settings.support_pause_message || 'Het support systeem is tijdelijk niet beschikbaar.';

    // Check session
    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        isAuthenticated = true;
        user = { id: session.user.id, email: session.user.email, name: session.user.name };
      }
    }
  }
} catch (e) {
  console.error('Support new page error:', e);
}

const categories = [
  { id: 'connection', label: 'Verbinding probleem', description: 'Problemen met de connectie naar Exact Online' },
  { id: 'bug', label: 'Technisch / Bug', description: 'Iets werkt niet zoals verwacht' },
  { id: 'billing', label: 'Account / Facturatie', description: 'Vragen over je abonnement of facturen' },
  { id: 'feature', label: 'Feature verzoek', description: 'Suggestie voor nieuwe functionaliteit' },
  { id: 'other', label: 'Overig', description: 'Andere vragen of opmerkingen' },
];
---

<Layout title="Nieuw Support Gesprek">
  <div class="max-w-2xl mx-auto px-4 py-8">
    <!-- Back link -->
    <a href="/support" class="inline-flex items-center text-gray-600 hover:text-gray-900 mb-6">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Terug naar Support
    </a>

    {!isAuthenticated ? (
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center">
        <h1 class="text-2xl font-bold text-gray-900 mb-4">Inloggen Vereist</h1>
        <p class="text-gray-600 mb-6">
          Log in met je Exact Online account om een support gesprek te starten.
        </p>
        <a
          href="/connect"
          class="inline-block px-6 py-3 bg-exact-blue text-white font-semibold rounded-lg hover:bg-exact-dark transition-colors"
        >
          Inloggen
        </a>
      </div>
    ) : !supportAvailable ? (
      <div class="bg-amber-50 border border-amber-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-amber-900 mb-4">Support Niet Beschikbaar</h1>
        <p class="text-amber-700 mb-4">{pauseMessage}</p>
        <a
          href="/support"
          class="inline-block px-6 py-3 bg-amber-600 text-white font-semibold rounded-lg hover:bg-amber-700 transition-colors"
        >
          Bekijk Help Artikelen
        </a>
      </div>
    ) : (
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Nieuw Support Gesprek</h1>
        <p class="text-gray-600 mb-6">Beschrijf je vraag of probleem en we helpen je zo snel mogelijk.</p>

        <form id="newConversationForm" class="space-y-6">
          <!-- Subject -->
          <div>
            <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">
              Onderwerp <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="subject"
              name="subject"
              required
              placeholder="Bijv. MCP server werkt niet meer"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
            />
          </div>

          <!-- Category -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Categorie
            </label>
            <div class="space-y-2">
              {categories.map((cat, index) => (
                <label class="flex items-start p-3 rounded-lg border border-gray-200 hover:border-exact-blue cursor-pointer transition-colors category-option">
                  <input
                    type="radio"
                    name="category"
                    value={cat.id}
                    checked={index === 0}
                    class="mt-1 text-exact-blue focus:ring-exact-blue"
                  />
                  <div class="ml-3">
                    <span class="font-medium text-gray-900">{cat.label}</span>
                    <p class="text-sm text-gray-500">{cat.description}</p>
                  </div>
                </label>
              ))}
            </div>
          </div>

          <!-- Message -->
          <div>
            <label for="message" class="block text-sm font-medium text-gray-700 mb-1">
              Beschrijf je vraag <span class="text-red-500">*</span>
            </label>
            <textarea
              id="message"
              name="message"
              required
              rows="6"
              placeholder="Beschrijf zo gedetailleerd mogelijk wat je probeert te doen en wat er misgaat..."
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none resize-none"
            ></textarea>
            <p class="text-xs text-gray-500 mt-1">
              Tip: Hoe meer details je geeft, hoe beter we je kunnen helpen.
            </p>
          </div>

          <!-- Suggested Articles (live) -->
          <div id="suggestedArticles" class="hidden">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h3 class="font-medium text-blue-900 mb-2 flex items-center">
                <span class="mr-2">ðŸ’¡</span>
                Mogelijk gerelateerd
              </h3>
              <div id="suggestedArticlesList" class="space-y-2"></div>
              <div class="mt-3 pt-3 border-t border-blue-200">
                <button
                  type="button"
                  id="articleSolvedBtn"
                  class="text-sm text-blue-700 hover:text-blue-900 font-medium"
                >
                  Lost een van deze artikelen je probleem op? â†’
                </button>
              </div>
            </div>
          </div>

          <!-- Error message -->
          <div id="formError" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
            <p class="text-red-700" id="formErrorText"></p>
          </div>

          <!-- Submit -->
          <div class="flex items-center justify-between pt-4">
            <a href="/support" class="text-gray-600 hover:text-gray-900">
              Annuleren
            </a>
            <button
              type="submit"
              id="submitBtn"
              class="px-6 py-3 bg-exact-blue text-white font-semibold rounded-lg hover:bg-exact-dark transition-colors flex items-center gap-2"
            >
              <span class="btn-text">Verstuur</span>
              <svg class="btn-spinner hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
              </svg>
            </button>
          </div>
        </form>
      </div>
    )}
  </div>

  <script>
    const form = document.getElementById('newConversationForm') as HTMLFormElement;
    const messageInput = document.getElementById('message') as HTMLTextAreaElement;
    const subjectInput = document.getElementById('subject') as HTMLInputElement;
    const suggestedArticles = document.getElementById('suggestedArticles');
    const suggestedArticlesList = document.getElementById('suggestedArticlesList');
    const formError = document.getElementById('formError');
    const formErrorText = document.getElementById('formErrorText');
    const submitBtn = document.getElementById('submitBtn');

    let searchTimeout: ReturnType<typeof setTimeout>;

    // Live article suggestions while typing
    messageInput?.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      const query = messageInput.value.trim();

      if (query.length < 10) {
        suggestedArticles?.classList.add('hidden');
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          // Extract keywords from message
          const keywords = query.split(/\s+/).slice(0, 5).join(' ');
          const response = await fetch(`/api/support/articles?q=${encodeURIComponent(keywords)}`);
          const data = await response.json() as { articles?: Array<{ slug: string; title_nl: string }> };

          if (data.articles && data.articles.length > 0) {
            // SEC-001: Build DOM elements safely instead of innerHTML with user data
            suggestedArticlesList!.innerHTML = '';
            data.articles.slice(0, 3).forEach((article) => {
              const link = document.createElement('a');
              link.href = `/support/articles/${encodeURIComponent(article.slug)}`;
              link.target = '_blank';
              link.className = 'block p-2 rounded hover:bg-blue-100 transition-colors';

              const span = document.createElement('span');
              span.className = 'text-blue-800';
              span.textContent = `\u{1F4C4} ${article.title_nl}`;

              link.appendChild(span);
              suggestedArticlesList!.appendChild(link);
            });
            suggestedArticles?.classList.remove('hidden');
          } else {
            suggestedArticles?.classList.add('hidden');
          }
        } catch (error) {
          console.error('Article search error:', error);
        }
      }, 500);
    });

    // Form submission
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const subject = subjectInput.value.trim();
      const message = messageInput.value.trim();
      const category = (form.querySelector('input[name="category"]:checked') as HTMLInputElement)?.value;

      if (!subject || !message) {
        formErrorText!.textContent = 'Vul alle verplichte velden in.';
        formError?.classList.remove('hidden');
        return;
      }

      // Show loading state
      submitBtn?.setAttribute('disabled', 'true');
      submitBtn?.querySelector('.btn-text')?.classList.add('opacity-50');
      submitBtn?.querySelector('.btn-spinner')?.classList.remove('hidden');
      formError?.classList.add('hidden');

      try {
        const response = await fetch('/api/support/conversations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subject, message, category }),
        });

        const data = await response.json() as { error?: string; conversation?: { id: string } };

        if (!response.ok) {
          throw new Error(data.error || 'Er is een fout opgetreden');
        }

        // Redirect to the conversation
        if (data.conversation) {
          window.location.href = `/support/conversations/${data.conversation.id}`;
        }
      } catch (error) {
        formErrorText!.textContent = error instanceof Error ? error.message : 'Er is een fout opgetreden';
        formError?.classList.remove('hidden');

        // Reset button
        submitBtn?.removeAttribute('disabled');
        submitBtn?.querySelector('.btn-text')?.classList.remove('opacity-50');
        submitBtn?.querySelector('.btn-spinner')?.classList.add('hidden');
      }
    });

    // Style selected category
    document.querySelectorAll('.category-option').forEach(option => {
      const radio = option.querySelector('input[type="radio"]') as HTMLInputElement;
      if (radio.checked) {
        option.classList.add('border-exact-blue', 'bg-exact-light');
      }

      radio.addEventListener('change', () => {
        document.querySelectorAll('.category-option').forEach(opt => {
          opt.classList.remove('border-exact-blue', 'bg-exact-light');
        });
        if (radio.checked) {
          option.classList.add('border-exact-blue', 'bg-exact-light');
        }
      });
    });
  </script>
</Layout>
