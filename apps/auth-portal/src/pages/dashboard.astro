---
import Layout from '../layouts/Layout.astro';
import TosAcceptanceModal from '../components/TosAcceptanceModal.astro';
import AiDisclaimer from '../components/AiDisclaimer.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import { Database, type User, type Connection, type ApiKey, type CommunicationEventWithUser } from '../lib/database';
import { TOS_VERSION, PLAN_LIMITS } from '../lib/constants';

// Safely get environment
let env: any;
let db: Database | null = null;
let initError: string | null = null;

try {
  env = Astro.locals.runtime?.env;
  if (!env?.DB) {
    throw new Error('Database binding not available');
  }
  db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);
} catch (e) {
  console.error('Dashboard init error:', e);
  initError = e instanceof Error ? e.message : 'Failed to initialize database';
}

// Check for session
const sessionId = Astro.cookies.get('session_id')?.value;

let isAuthenticated = false;
let user: User | null = null;
let connections: Connection[] = [];
let divisions: Array<{ code: number; name: string; region: string; isDefault: boolean; isActive: boolean; id: string }> = [];
let apiKeys: ApiKey[] = [];
let usageStats: { total: number; byEndpoint: Record<string, number> } | null = null;
let error: string | null = null;
let newApiKey: string | null = null;

// Division limits tracking
let activeDivisionsCount = 0;
let divisionLimit = 2;
let canSwitchDivision = true;
let divisionCooldownUntil: string | null = null;

// Feedback milestone tracking
let firstQueryAt: string | null = null;
let milestoneShown = {
  milestone_10: false,
  milestone_50: false,
  milestone_80pct: false,
  milestone_30d: false,
};

// User communications (Closed Loop principle - transparency)
let userCommunications: CommunicationEventWithUser[] = [];
let totalCommunications = 0;

// Handle POST actions
if (Astro.request.method === 'POST' && db) {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'logout' && sessionId) {
    await db.deleteSession(sessionId);
    Astro.cookies.delete('session_id', { path: '/' });
    return Astro.redirect('/');
  }

  // Generate API key - show result on dashboard with ready-to-copy command
  if (action === 'generate_api_key' && sessionId) {
    const sessionResult = await db.validateSession(sessionId);
    if (sessionResult) {
      const keyName = formData.get('key_name')?.toString() || 'Claude Code';
      try {
        const { plainKey } = await db.createApiKey(sessionResult.user.id, keyName);
        newApiKey = plainKey;
      } catch (e) {
        error = e instanceof Error ? e.message : 'Er is een fout opgetreden bij het aanmaken van de sleutel.';
      }
    }
  }

  // Other API key actions â†’ Developer page
  if (action === 'revoke_api_key' || action === 'rename_api_key') {
    return Astro.redirect('/dashboard/developer');
  }

  if (action === 'set_default_division' && sessionId) {
    const sessionResult = await db.validateSession(sessionId);
    const divisionCode = formData.get('division_code')?.toString();
    const region = formData.get('region')?.toString();
    if (sessionResult && divisionCode && region) {
      await db.setDefaultDivision(sessionResult.user.id, parseInt(divisionCode), region);
    }
  }

  if (action === 'delete_account' && sessionId) {
    const sessionResult = await db.validateSession(sessionId);
    const confirmEmail = formData.get('confirm_email')?.toString();
    if (sessionResult && confirmEmail === sessionResult.user.email) {
      // Delete the user account and all associated data
      await db.deleteUser(sessionResult.user.id);
      // Clear the session cookie
      Astro.cookies.delete('session_id', { path: '/' });
      // Redirect to homepage with success message
      return Astro.redirect('/?account_deleted=true');
    } else {
      error = 'E-mailadres komt niet overeen. Account niet verwijderd.';
    }
  }
}

// AUTH-002: Check for expired session and auto-logout
// First check if session is expired - if so, delete it and redirect to connect page
if (sessionId && db) {
  const wasExpired = await db.checkAndDeleteExpiredSession(sessionId);
  if (wasExpired) {
    Astro.cookies.delete('session_id', { path: '/' });
    return Astro.redirect('/connect?reason=session_expired');
  }
}

// Validate session and load data
if (sessionId && db) {
  try {
    const sessionResult = await db.validateSession(sessionId);

    if (sessionResult) {
      user = sessionResult.user;
      isAuthenticated = true;

      // Load connections
      connections = await db.getConnectionsByUser(user.id);

      // Load divisions across all connections (with active status)
      const allDivisions = await db.getDivisionsByUser(user.id);
      const divisionsWithStatus = await db.getUserDivisionsWithStatus(user.id);

      // Merge data: getDivisionsByUser has region, getUserDivisionsWithStatus has is_active
      divisions = allDivisions.map(d => {
        const statusInfo = divisionsWithStatus.find(ds => ds.division_code === d.division_code);
        return {
          id: d.id,
          code: d.division_code,
          name: d.division_name,
          region: d.region,
          isDefault: Boolean(d.is_default),
          isActive: statusInfo?.is_active ?? true, // Default to active if not found
        };
      });

      // Load division limit status
      activeDivisionsCount = await db.getActiveDivisionsCount(user.id);
      divisionLimit = PLAN_LIMITS[user.plan as keyof typeof PLAN_LIMITS]?.divisions || 2;
      const switchStatus = await db.canSwitchDivision(user.id);
      canSwitchDivision = switchStatus.canSwitch;
      divisionCooldownUntil = switchStatus.cooldownUntil || null;

      // Load API keys
      apiKeys = await db.getApiKeysByUser(user.id);

      // Load usage stats
      usageStats = await db.getApiUsageStats(user.id, 30);

      // Load feedback milestone data for widget triggers
      const milestoneData = await env.DB.prepare(`
        SELECT
          first_query_at,
          milestone_10_shown,
          milestone_50_shown,
          milestone_80pct_shown,
          milestone_30d_shown,
          milestone_80pct_month
        FROM users WHERE id = ?
      `).bind(user.id).first() as {
        first_query_at: string | null;
        milestone_10_shown: number;
        milestone_50_shown: number;
        milestone_80pct_shown: number;
        milestone_30d_shown: number;
        milestone_80pct_month: string | null;
      } | null;

      if (milestoneData) {
        firstQueryAt = milestoneData.first_query_at;

        // For 80% milestone, check if it was shown this month
        const currentMonth = new Date().toISOString().slice(0, 7);
        const was80pctShownThisMonth = milestoneData.milestone_80pct_month === currentMonth;

        milestoneShown = {
          milestone_10: Boolean(milestoneData.milestone_10_shown),
          milestone_50: Boolean(milestoneData.milestone_50_shown),
          milestone_80pct: was80pctShownThisMonth,
          milestone_30d: Boolean(milestoneData.milestone_30d_shown),
        };
      }

      // Load user's communication history (Closed Loop - transparency)
      try {
        const commResult = await db.getCommunicationEventsByUser(user.id, { limit: 10 });
        userCommunications = commResult.events;
        totalCommunications = commResult.total;
      } catch (commError) {
        console.warn('Communications not available:', commError);
        // Keep empty - table might not exist yet
      }
    } else {
      // Session doesn't exist (not in DB) - redirect to connect page
      Astro.cookies.delete('session_id', { path: '/' });
      return Astro.redirect('/connect');
    }
  } catch (e) {
    console.error('Dashboard error:', e);
    error = 'Er is een fout opgetreden bij het laden van je gegevens.';
  }
}

// Plan limits (using shared constants)
const currentPlan = user?.plan || 'free';
const limits = PLAN_LIMITS[currentPlan];
// Use actual usage from api_usage table, not the counter on users table
const apiCallsUsed = usageStats?.total || 0;
const apiCallsPercent = limits.apiCalls === Infinity ? 0 : Math.min((apiCallsUsed / limits.apiCalls) * 100, 100);
const apiKeysCount = apiKeys.length;
const canCreateMoreKeys = limits.apiKeys === Infinity || apiKeysCount < limits.apiKeys;

// Check if user is admin
const adminEmails = (env?.ADMIN_EMAILS || '').split(',').map((e: string) => e.trim().toLowerCase());
const isAdmin = user ? adminEmails.includes(user.email.toLowerCase()) : false;

// Translations
const planLabels: Record<string, string> = {
  free: 'Gratis',
  starter: 'Starter',
  pro: 'Pro',
  enterprise: 'Enterprise',
};

// Communication display helpers
function formatCommTimeAgo(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'zojuist';
  if (diffMins < 60) return `${diffMins} min geleden`;
  if (diffHours < 24) return `${diffHours} uur geleden`;
  if (diffDays === 1) return 'gisteren';
  if (diffDays < 7) return `${diffDays} dagen geleden`;
  return date.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
}

function getCommIcon(type: string): string {
  switch (type) {
    case 'email': return 'M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z';
    case 'support': return 'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z';
    case 'feedback': return 'M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z';
    default: return 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';
  }
}

function getCommTypeLabel(type: string): string {
  switch (type) {
    case 'email': return 'Email';
    case 'support': return 'Support';
    case 'feedback': return 'Feedback';
    default: return type;
  }
}

function getCommTypeColor(type: string): string {
  switch (type) {
    case 'email': return 'bg-blue-100 text-blue-700';
    case 'support': return 'bg-purple-100 text-purple-700';
    case 'feedback': return 'bg-amber-100 text-amber-700';
    default: return 'bg-gray-100 text-gray-700';
  }
}

// Parse metadata JSON and get category
function getCommCategory(metadata: string | null): string | null {
  if (!metadata) return null;
  try {
    const parsed = JSON.parse(metadata);
    return parsed.category || null;
  } catch {
    return null;
  }
}

// Category label mapping
function getCategoryLabel(category: string | null): string {
  if (!category) return '';
  switch (category) {
    case 'bug': return 'Bug';
    case 'feature': return 'Feature';
    case 'question': return 'Vraag';
    case 'feedback': return 'Feedback';
    case 'other': return 'Anders';
    default: return category;
  }
}

// Category color mapping
function getCategoryColor(category: string | null): string {
  if (!category) return '';
  switch (category) {
    case 'bug': return 'bg-red-100 text-red-700';
    case 'feature': return 'bg-emerald-100 text-emerald-700';
    case 'question': return 'bg-cyan-100 text-cyan-700';
    case 'feedback': return 'bg-amber-100 text-amber-700';
    default: return 'bg-gray-100 text-gray-700';
  }
}

// Format full date for modal
function formatFullDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('nl-NL', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}
---

<Layout title="Dashboard">
  <div class="max-w-4xl mx-auto px-4 py-8">
    {initError ? (
      <div class="bg-white rounded-xl shadow-sm border border-red-200 p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Er ging iets mis</h1>
        <p class="text-red-600 mb-6">
          {initError}
        </p>
        <p class="text-gray-500 text-sm">
          Neem contact met ons op om dit op te lossen.
        </p>
      </div>
    ) : !isAuthenticated ? (
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center">
        <h1 class="text-2xl font-bold text-gray-900 mb-4">Niet ingelogd</h1>
        <p class="text-gray-600 mb-6">
          {error || 'Je bent nog niet verbonden met Exact Online.'}
        </p>
        <a
          href="/connect"
          class="inline-block px-6 py-3 bg-exact-blue text-white font-semibold rounded-lg hover:bg-exact-dark transition-colors"
        >
          Verbinden met Exact Online
        </a>
      </div>
    ) : (
      <>
        {/* ToS Acceptance Modal */}
        <TosAcceptanceModal
          currentVersion={TOS_VERSION}
          userAcceptedVersion={user?.tos_accepted_version || null}
        />

        {/* Header */}
        <div class="mb-8">
          <div class="flex items-center gap-4 mb-1">
            <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
            {isAdmin && (
              <a
                href="/admin"
                class="px-3 py-1 text-sm border border-purple-300 text-purple-700 bg-purple-50 rounded-lg hover:bg-purple-100 hover:border-purple-400 transition-colors flex items-center gap-1"
              >
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Admin
              </a>
            )}
            <form method="POST" class="inline">
              <input type="hidden" name="action" value="logout" />
              <button
                type="submit"
                class="px-3 py-1 text-sm border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-100 hover:border-gray-400 transition-colors flex items-center gap-1"
              >
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Uitloggen
              </button>
            </form>
          </div>
          <p class="text-gray-600">Welkom terug, {user?.name || user?.email}</p>
        </div>

        {/* Upgrade Success Message */}
        {Astro.url.searchParams.get('upgraded') === 'true' && (
          <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
              <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              <p class="text-green-800 font-medium">
                Je hebt nu Pro. Je kunt tot 2.500 opdrachten per maand gebruiken.
              </p>
            </div>
          </div>
        )}

        {/* Subscription managed via Exact Online App Store */}

        {/* New API Key Alert - with Claude Configuration */}
        {/* Status Cards */}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-medium text-gray-500">Plan</h3>
              <span class={`px-2 py-1 text-xs font-medium rounded-full ${
                currentPlan === 'enterprise' ? 'bg-purple-100 text-purple-800' :
                currentPlan === 'pro' ? 'bg-blue-100 text-blue-800' :
                currentPlan === 'starter' ? 'bg-green-100 text-green-800' :
                'bg-gray-100 text-gray-800'
              }`}>
                {planLabels[currentPlan]}
              </span>
            </div>
            <p class="text-2xl font-bold text-gray-900">
              {currentPlan === 'enterprise' ? 'Enterprise' : currentPlan === 'pro' ? 'â‚¬25/maand' : currentPlan === 'starter' ? 'â‚¬9/maand' : 'Gratis'}
            </p>
            {currentPlan === 'free' ? (
              <a href="/pricing" class="text-sm text-exact-blue hover:underline">Upgrade â†’</a>
            ) : (
              <p class="text-sm text-gray-500">Via Exact Online App Store</p>
            )}
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500 mb-2 flex items-center gap-1">
              Opdrachten deze maand
              <span class="relative group">
                <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10 pointer-events-none">
                  Elke tool-aanroep telt als 1 opdracht.<br>EÃ©n vraag kan meerdere opdrachten gebruiken.
                  <a href="/faq#opdrachten" class="text-blue-300 hover:underline pointer-events-auto">Meer info</a>
                </span>
              </span>
            </h3>
            <p class="text-2xl font-bold text-gray-900">
              {apiCallsUsed.toLocaleString()}
              <span class="text-sm font-normal text-gray-500">
                / {limits.apiCalls === Infinity ? 'âˆž' : limits.apiCalls.toLocaleString()}
              </span>
            </p>
            {limits.apiCalls !== Infinity && (
              <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden" role="progressbar" aria-valuenow={apiCallsUsed} aria-valuemin={0} aria-valuemax={limits.apiCalls} aria-label="Opdrachten gebruikt">
                <div
                  class={`h-full rounded-full ${apiCallsPercent > 80 ? 'bg-red-500' : apiCallsPercent > 50 ? 'bg-yellow-500' : 'bg-green-500'}`}
                  style={`width: ${apiCallsPercent}%`}
                ></div>
              </div>
            )}
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500 mb-2">Administraties</h3>
            <p class="text-2xl font-bold text-gray-900">
              {divisions.length}
              <span class="text-sm font-normal text-gray-500">
                / {limits.divisions === Infinity ? 'âˆž' : limits.divisions}
              </span>
            </p>
            <p class="text-sm text-gray-500">verbonden</p>
          </div>
        </div>

        {/* Claude Verbinden */}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Je AI-assistent instellen</h2>

          {/* MCP Server URL - algemene URL voor ChatGPT en Claude Desktop */}
          <div class="mb-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-xl">
            <h3 class="font-semibold text-green-900 mb-2">MCP Server URL</h3>
            <p class="text-green-700 text-sm mb-3">
              Gebruik deze URL voor ChatGPT en Claude Desktop:
            </p>
            <div class="flex items-center gap-2 mb-3">
              <input
                type="text"
                value="https://api.praatmetjeboekhouding.nl/mcp"
                readonly
                class="flex-1 bg-white border border-green-300 rounded-lg px-3 py-2 text-sm font-mono"
                id="mcpServerUrl"
              />
              <button
                id="copyMcpUrl"
                data-url="https://api.praatmetjeboekhouding.nl/mcp"
                class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors text-sm whitespace-nowrap"
              >
                Kopieer URL
              </button>
            </div>
            <p class="text-green-600 text-xs">
              Je logt in via OAuth - geen API key nodig in de URL.
            </p>
          </div>

          {/* Claude Code - key creation or ready command */}
          {newApiKey ? (
            <div class="mb-6 p-4 bg-green-50 border-2 border-green-400 rounded-xl">
              <h3 class="font-semibold text-green-900 mb-2 flex items-center gap-2">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Klaar! Voer dit uit in je terminal:
              </h3>
              <div class="bg-gray-900 rounded-lg p-3 mb-3">
                <code class="text-green-400 text-sm break-all block" id="claudeCodeCommand">
                  claude mcp add --transport http exact-online https://api.praatmetjeboekhouding.nl/mcp --header "Authorization: Bearer {newApiKey}"
                </code>
              </div>
              <button
                id="copyClaudeCodeCmd"
                data-cmd={`claude mcp add --transport http exact-online https://api.praatmetjeboekhouding.nl/mcp --header "Authorization: Bearer ${newApiKey}"`}
                class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors text-sm"
              >
                Kopieer Commando
              </button>
              <p class="text-green-700 text-xs mt-3">
                Start daarna Claude Code met: <code class="bg-green-200 px-1 rounded">claude</code>
              </p>
              <p class="text-green-600 text-xs mt-2">
                <a href="/dashboard/developer" class="underline">Beheer je keys</a> (deze key is alleen nu zichtbaar)
              </p>
            </div>
          ) : (
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl">
              <h3 class="font-semibold text-blue-900 mb-2">Claude Code (sleutel nodig)</h3>
              <p class="text-blue-700 text-sm mb-3">
                Druk op de knop om direct een klaar-om-te-kopiÃ«ren commando te krijgen.
              </p>
              <form method="POST" class="flex gap-3">
                <input type="hidden" name="action" value="generate_api_key" />
                <input type="hidden" name="key_name" value="Claude Code" />
                <button
                  type="submit"
                  class="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                  </svg>
                  Maak Claude Code Commando
                </button>
              </form>
              <p class="text-blue-600 text-xs mt-3">
                Al keys? <a href="/dashboard/developer" class="underline">Beheer in Developer</a>
              </p>
            </div>
          )}

            {/* Quick guide - Three options */}
            <div class="grid md:grid-cols-3 gap-4">
              {/* Claude Code (Recommended) */}
              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 bg-green-600 text-white text-xs font-medium rounded">Aanbevolen</span>
                  <h4 class="font-medium text-green-900">Claude Code</h4>
                </div>
                <p class="text-sm text-green-700 mb-3">Werkt betrouwbaar met MCP servers.</p>
                <ol class="text-sm text-green-800 space-y-1 list-decimal list-inside mb-3">
                  <li>Genereer je sleutel hierboven</li>
                  <li>Voer het commando uit in terminal</li>
                  <li>Start met: <code class="bg-green-100 px-1 rounded">claude</code></li>
                </ol>
                <p class="text-xs text-green-600">
                  Installeer: <code class="bg-green-100 px-1 rounded">npm i -g @anthropic-ai/claude-code</code>
                </p>
              </div>

              {/* ChatGPT */}
              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <h4 class="font-medium text-green-900">ChatGPT</h4>
                  <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded">Plus/Team</span>
                </div>
                <p class="text-sm text-green-700 mb-3">Werkt met MCP connectors.</p>
                <ol class="text-sm text-green-800 space-y-1 list-decimal list-inside">
                  <li>Kopieer de URL hierboven</li>
                  <li>Settings â†’ Connectors â†’ Developer mode</li>
                  <li>Create â†’ plak URL â†’ No auth</li>
                  <li>In chat: + â†’ Developer Mode</li>
                </ol>
                <a href="/setup" class="text-xs text-green-600 hover:underline mt-2 inline-block">
                  Volledige instructies â†’
                </a>
              </div>

              {/* Claude Desktop */}
              <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <h4 class="font-medium text-gray-900">Claude Desktop</h4>
                  <span class="px-2 py-0.5 bg-amber-100 text-amber-700 text-xs rounded">lokale config</span>
                </div>
                <p class="text-sm text-amber-700 mb-3">
                  Bekend probleem bij Anthropic met online connectors. Gebruik de lokale config methode.
                </p>
                <a href="/docs/claude-desktop-setup" class="text-sm text-amber-800 font-medium hover:underline">
                  Bekijk instructies â†’
                </a>
                <p class="text-xs text-amber-600 mt-2">
                  We laten weten als dit is opgelost.
                </p>
              </div>
            </div>

            {/* Multi-tool chaining info */}
            <div class="mt-6 p-4 bg-purple-50 border border-purple-200 rounded-xl">
              <div class="flex items-start gap-3">
                <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                </div>
                <div>
                  <h4 class="font-semibold text-purple-900 mb-1">AI Agent Ketens: Combineer met andere tools</h4>
                  <p class="text-sm text-purple-700 mb-2">
                    Via ChatGPT en Claude kun je meerdere MCP tools koppelen en zo complete workflows automatiseren:
                  </p>
                  <ul class="text-sm text-purple-700 space-y-1">
                    <li>â€¢ <strong>Email + Boekhouding:</strong> "Stuur de openstaande facturen naar mijn klanten"</li>
                    <li>â€¢ <strong>To-do + Boekhouding:</strong> "Maak taken aan voor facturen die &gt;30 dagen open staan"</li>
                    <li>â€¢ <strong>Calendar + Boekhouding:</strong> "Plan herinneringen voor vervallende facturen"</li>
                  </ul>
                  <p class="text-xs text-purple-600 mt-2">
                    Tip: Voeg meerdere MCP servers toe aan je AI assistent om ketens te bouwen.
                  </p>
                </div>
              </div>
            </div>

            {/* Claude Cowork announcement */}
            <div class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-xl">
              <div class="flex items-start gap-3">
                <div class="w-8 h-8 bg-amber-500 rounded-lg flex items-center justify-center flex-shrink-0">
                  <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
                  </svg>
                </div>
                <div>
                  <h4 class="font-semibold text-amber-900 mb-1">Binnenkort: Claude Cowork voor Windows</h4>
                  <p class="text-sm text-amber-700">
                    Claude Cowork (nu beschikbaar op Mac) komt binnenkort naar Windows. Laat Claude direct werken in je desktop applicaties met MCP integratie.
                  </p>
                </div>
              </div>
            </div>

          <p class="text-sm text-gray-500 mt-4">
            <a href="/setup" class="text-exact-blue hover:underline">Meer details en andere AI assistants â†’</a>
          </p>
        </div>

        {/* Mijn Berichten - Closed Loop Communication */}
        <section class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-8">
          <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
              </div>
              <div>
                <h2 class="text-lg font-semibold text-gray-900">Mijn Berichten</h2>
                <p class="text-sm text-gray-500">
                  {totalCommunications > 0 ? `${totalCommunications} berichten` : 'Jouw communicatie met ons'}
                </p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              {totalCommunications > 10 && (
                <a
                  href="/berichten"
                  class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
                >
                  Alle berichten
                </a>
              )}
              <button
                type="button"
                id="openNewMessageModal"
                class="px-4 py-2 bg-exact-blue text-white text-sm font-medium rounded-lg hover:bg-exact-dark transition-colors flex items-center gap-2"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Nieuw bericht
              </button>
            </div>
          </div>

          {userCommunications.length > 0 ? (
            <>
              <div class="divide-y divide-gray-50">
                {userCommunications.map((comm) => {
                  const category = getCommCategory(comm.metadata);
                  return (
                    <button
                      type="button"
                      class={`message-item w-full text-left p-4 hover:bg-gray-50 transition-colors border-l-4 cursor-pointer ${
                        comm.direction === 'in' ? 'border-l-green-500' : 'border-l-blue-500'
                      }`}
                      data-id={comm.id}
                      data-subject={comm.subject || ''}
                      data-content={comm.content}
                      data-type={comm.type}
                      data-direction={comm.direction}
                      data-category={category || ''}
                      data-date={formatFullDate(comm.created_at)}
                    >
                      <div class="flex items-start justify-between gap-4">
                        <div class="flex items-start gap-3 flex-1">
                          {/* Type Icon */}
                          <div class={`p-2 rounded-lg flex-shrink-0 ${getCommTypeColor(comm.type)}`}>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={getCommIcon(comm.type)} />
                            </svg>
                          </div>

                          {/* Content */}
                          <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                              <span class={`px-2 py-0.5 rounded text-xs font-medium ${getCommTypeColor(comm.type)}`}>
                                {getCommTypeLabel(comm.type)}
                              </span>
                              <span class={`px-2 py-0.5 rounded text-xs ${
                                comm.direction === 'in' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'
                              }`}>
                                {comm.direction === 'in' ? 'Van ons' : 'Van jou'}
                              </span>
                              {category && (
                                <span class={`px-2 py-0.5 rounded text-xs font-medium ${getCategoryColor(category)}`}>
                                  {getCategoryLabel(category)}
                                </span>
                              )}
                            </div>

                            {comm.subject && (
                              <h3 class="font-medium text-gray-900 text-sm mb-1">{comm.subject}</h3>
                            )}

                            <p class="text-gray-600 text-sm line-clamp-2">{comm.content}</p>
                          </div>
                        </div>

                        {/* Time */}
                        <div class="text-right flex-shrink-0">
                          <p class="text-xs text-gray-500">{formatCommTimeAgo(comm.created_at)}</p>
                          <p class="text-xs text-exact-blue mt-1">Bekijken â†’</p>
                        </div>
                      </div>
                    </button>
                  );
                })}
              </div>
              {/* Footer with "Alle berichten" link */}
              <div class="p-4 bg-gray-50 border-t border-gray-100 text-center">
                <a
                  href="/berichten"
                  class="text-sm text-exact-blue hover:underline font-medium"
                >
                  Alle {totalCommunications} berichten bekijken â†’
                </a>
              </div>
            </>
          ) : (
            <div class="p-8 text-center">
              <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
              </div>
              <h3 class="font-medium text-gray-900 mb-1">Nog geen berichten</h3>
              <p class="text-sm text-gray-500 mb-4">
                Heb je een vraag of feedback? We horen graag van je!
              </p>
              <button
                type="button"
                id="openNewMessageModalEmpty"
                class="px-4 py-2 bg-exact-blue text-white text-sm font-medium rounded-lg hover:bg-exact-dark transition-colors"
              >
                Stuur ons een bericht
              </button>
            </div>
          )}
        </section>

        {/* Connections */}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Exact Online Connecties</h2>
            <a
              href="/connect"
              class="text-sm text-exact-blue hover:underline"
              aria-label="Voeg nieuwe regio toe"
            >
              + Regio toevoegen
            </a>
          </div>
          {connections.length === 0 ? (
            <p class="text-gray-500">Geen connecties gevonden.</p>
          ) : (
            <div class="space-y-3">
              {connections.map(conn => {
                const connDivisions = divisions.filter(d => d.region === conn.region);
                const isExpired = new Date(conn.token_expires_at) < new Date();
                return (
                  <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                      <span class={`w-2 h-2 rounded-full mr-3 ${isExpired ? 'bg-red-500' : 'bg-green-500'}`}></span>
                      <div>
                        <p class="font-medium text-gray-900">{conn.region} Regio</p>
                        <p class="text-sm text-gray-500">
                          {connDivisions.length} administratie{connDivisions.length !== 1 ? 's' : ''} â€¢
                          {conn.exact_user_name || conn.exact_email}
                        </p>
                      </div>
                    </div>
                    <span class={`px-2 py-1 text-xs font-medium rounded ${isExpired ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
                      {isExpired ? 'Verlopen' : 'Actief'}
                    </span>
                  </div>
                );
              })}
            </div>
          )}
        </div>

        {/* Divisions List */}
        {divisions.length > 0 && (
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
              <div>
                <h2 class="text-lg font-semibold text-gray-900">Je Administraties</h2>
                <p class="text-sm text-gray-500">
                  {activeDivisionsCount} van {divisionLimit === Infinity ? 'âˆž' : divisionLimit} actief
                  {!canSwitchDivision && divisionCooldownUntil && (
                    <span class="ml-2 text-amber-600">
                      â€¢ Wisselen weer mogelijk om {new Date(divisionCooldownUntil).toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' })}
                    </span>
                  )}
                </p>
              </div>
              <div class="flex items-center gap-3">
                {/* Activate all button - only show if not all are active */}
                {activeDivisionsCount < divisions.length && (
                  <button
                    id="activate-all-btn"
                    type="button"
                    class="px-4 py-2 bg-exact-blue text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled={!canSwitchDivision}
                    title={!canSwitchDivision ? 'Wisselen in cooldown' : 'Activeer alle administraties'}
                  >
                    Alles activeren
                  </button>
                )}
                {activeDivisionsCount >= divisionLimit && divisionLimit !== Infinity && (
                  <a href="/pricing" class="text-sm text-exact-blue hover:underline">
                    Upgrade voor meer â†’
                  </a>
                )}
              </div>
            </div>

            {/* Plan limit warning */}
            {activeDivisionsCount >= divisionLimit && divisionLimit !== Infinity && (
              <div class="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                <p class="text-sm text-amber-800">
                  <strong>Limiet bereikt:</strong> Je {user?.plan || 'free'} plan ondersteunt {divisionLimit} administraties.
                  Deactiveer een administratie of upgrade je plan.
                </p>
              </div>
            )}

            <div class="space-y-3" id="divisions-list">
              {divisions.map(division => (
                <div
                  class={`flex items-center justify-between p-4 rounded-lg transition-colors ${
                    division.isActive
                      ? division.isDefault
                        ? 'bg-exact-light border-2 border-exact-blue'
                        : 'bg-gray-50 border-2 border-transparent'
                      : 'bg-gray-100 border-2 border-gray-200 opacity-60'
                  }`}
                  data-division-id={division.id}
                >
                  <div class="flex items-center flex-1">
                    {/* Active toggle */}
                    <button
                      type="button"
                      class={`division-toggle relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-exact-blue focus:ring-offset-2 mr-4 ${
                        division.isActive ? 'bg-exact-blue' : 'bg-gray-300'
                      } ${!canSwitchDivision || (!division.isActive && activeDivisionsCount >= divisionLimit && divisionLimit !== Infinity) ? 'opacity-50 cursor-not-allowed' : ''}`}
                      data-division-id={division.id}
                      data-active={division.isActive}
                      disabled={!canSwitchDivision || (!division.isActive && activeDivisionsCount >= divisionLimit && divisionLimit !== Infinity)}
                      title={!canSwitchDivision ? 'Wisselen in cooldown' : (!division.isActive && activeDivisionsCount >= divisionLimit ? 'Limiet bereikt' : (division.isActive ? 'Klik om te deactiveren' : 'Klik om te activeren'))}
                    >
                      <span
                        class={`pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${
                          division.isActive ? 'translate-x-5' : 'translate-x-0'
                        }`}
                      ></span>
                    </button>

                    <div class="flex-1">
                      <p class={`font-medium ${division.isActive ? 'text-gray-900' : 'text-gray-500'}`}>{division.name}</p>
                      <p class="text-sm text-gray-600">Code: {division.code} â€¢ {division.region}</p>
                    </div>
                  </div>

                  <div class="flex items-center gap-2">
                    {division.isDefault && (
                      <span class="px-3 py-1 bg-exact-blue text-white text-xs font-medium rounded-full">Standaard</span>
                    )}
                    {!division.isDefault && division.isActive && (
                      <form method="POST">
                        <input type="hidden" name="action" value="set_default_division" />
                        <input type="hidden" name="division_code" value={division.code} />
                        <input type="hidden" name="region" value={division.region} />
                        <button
                          type="submit"
                          class="px-3 py-1 bg-gray-200 text-gray-600 text-xs font-medium rounded-full hover:bg-gray-300 transition-colors"
                        >
                          Maak standaard
                        </button>
                      </form>
                    )}
                    {!division.isActive && (
                      <span class="px-3 py-1 bg-gray-300 text-gray-500 text-xs font-medium rounded-full">Inactief</span>
                    )}
                  </div>
                </div>
              ))}
            </div>

            <p class="mt-4 text-xs text-gray-500">
              ðŸ’¡ Tip: Schakel administraties uit die je niet gebruikt. Je kunt maximaal {divisionLimit === Infinity ? 'onbeperkt' : divisionLimit} administraties actief hebben op je huidige plan.
              {divisionLimit !== Infinity && ' Na wisselen is er een cooldown van 1 uur.'}
            </p>
          </div>
        )}

        {/* Developer Section - Link to dedicated page */}
        <a href="/dashboard/developer" class="block bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8 hover:border-exact-blue transition-colors group">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="p-3 bg-green-100 rounded-lg group-hover:bg-green-200 transition-colors">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                </svg>
              </div>
              <div>
                <h2 class="text-lg font-semibold text-gray-900">Developer</h2>
                <p class="text-sm text-gray-500">
                  {apiKeysCount} API {apiKeysCount === 1 ? 'key' : 'keys'} â€¢ {usageStats?.total?.toLocaleString('nl-NL') || 0} calls (30d)
                </p>
              </div>
            </div>
            <svg class="w-5 h-5 text-gray-400 group-hover:text-exact-blue transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </div>
        </a>

        {/* Privacy & AI Providers Section */}
        <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Privacy en AI-gebruik</h2>

          <div class="space-y-4">
            {/* Last used provider - will be populated via JavaScript */}
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-medium text-gray-900">Laatst gebruikte AI-assistent</h3>
                <p class="text-sm text-gray-500">Gebaseerd op je meest recente vragen</p>
              </div>
              <div id="lastProviderBadge" class="flex items-center">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600">
                  Laden...
                </span>
              </div>
            </div>

            {/* Data passthrough confirmation */}
            <div class="border-t border-gray-100 pt-4">
              <div class="flex items-start">
                <div class="flex-shrink-0">
                  <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700">
                    <strong>Geen opslag:</strong> Wij slaan geen boekhoudgegevens op.
                    Je gegevens gaan direct naar je AI-assistent.
                  </p>
                </div>
              </div>

              <div class="flex items-start mt-3">
                <div class="flex-shrink-0">
                  <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700">
                    <strong>Je eigen verantwoordelijkheid:</strong> Controleer de privacy-instellingen
                    van je AI-assistent.
                    <a href="/docs/ai-privacy" class="text-exact-blue hover:underline ml-1">
                      Bekijk tips
                    </a>
                  </p>
                </div>
              </div>
            </div>

            {/* Quick links per provider */}
            <div class="border-t border-gray-100 pt-4">
              <p class="text-sm font-medium text-gray-700 mb-2">Privacy-instellingen per AI-assistent:</p>
              <div class="flex flex-wrap gap-2">
                <a href="/docs/ai-privacy#claude"
                   class="inline-flex items-center px-3 py-1.5 text-sm bg-purple-50 hover:bg-purple-100 rounded-md text-purple-700 transition-colors">
                  Claude
                </a>
                <a href="/docs/ai-privacy#chatgpt"
                   class="inline-flex items-center px-3 py-1.5 text-sm bg-green-50 hover:bg-green-100 rounded-md text-green-700 transition-colors">
                  ChatGPT
                </a>
                <a href="/docs/ai-privacy#copilot"
                   class="inline-flex items-center px-3 py-1.5 text-sm bg-blue-50 hover:bg-blue-100 rounded-md text-blue-700 transition-colors">
                  Copilot
                </a>
                <a href="/docs/ai-privacy#lokaal"
                   class="inline-flex items-center px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 rounded-md text-gray-700 transition-colors">
                  Lokaal
                </a>
              </div>
            </div>

            {/* Usage per provider (collapsible for more details) */}
            <details class="border-t border-gray-100 pt-4">
              <summary class="cursor-pointer text-sm font-medium text-gray-700 hover:text-gray-900">
                Bekijk opdrachten per AI-assistent (deze maand)
              </summary>
              <div id="providerUsageBreakdown" class="mt-3 space-y-2">
                <p class="text-sm text-gray-500">Laden...</p>
              </div>
            </details>
          </div>
        </section>

        {/* Email Notificaties */}
        <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Email Notificaties</h2>
          <p class="text-sm text-gray-500 mb-4">Bepaal welke emails je van ons ontvangt</p>

          <div class="space-y-4">
            {/* Support replies toggle */}
            <div class="flex items-center justify-between py-3 border-b border-gray-100">
              <div>
                <p class="font-medium text-gray-900">Support reacties</p>
                <p class="text-sm text-gray-500">Ontvang email als we reageren op je bericht</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="pref_support_replies"
                  class="sr-only peer"
                />
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-exact-blue"></div>
              </label>
            </div>

            {/* Product updates toggle */}
            <div class="flex items-center justify-between py-3 border-b border-gray-100">
              <div>
                <p class="font-medium text-gray-900">Product updates</p>
                <p class="text-sm text-gray-500">Nieuwe functies en verbeteringen</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="pref_product_updates"
                  class="sr-only peer"
                />
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-exact-blue"></div>
              </label>
            </div>

            {/* Privacy tips toggle */}
            <div class="flex items-center justify-between py-3">
              <div>
                <p class="font-medium text-gray-900">Privacy tips</p>
                <p class="text-sm text-gray-500">Tips over AI-privacy en veilig gebruik</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="pref_privacy_tips"
                  class="sr-only peer"
                />
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-exact-blue"></div>
              </label>
            </div>
          </div>

          <p id="prefSaveStatus" class="text-sm text-green-600 mt-4 hidden">Voorkeuren opgeslagen</p>
        </section>

        {/* Juridische documenten sectie */}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Juridisch & Compliance</h3>

          {/* ToS Status */}
          <div class="flex items-center justify-between py-3 border-b border-gray-100">
            <div>
              <p class="font-medium text-gray-900">Algemene Voorwaarden</p>
              <p class="text-sm text-gray-500">
                {user?.tos_accepted_at ? (
                  `Versie ${user.tos_accepted_version} - Geaccepteerd op ${new Date(user.tos_accepted_at).toLocaleDateString('nl-NL')}`
                ) : (
                  'Nog niet geaccepteerd'
                )}
              </p>
            </div>
            <a href="/voorwaarden" class="text-exact-blue hover:underline text-sm">Bekijken</a>
          </div>

          {/* DPA */}
          <div class="flex items-center justify-between py-3 border-b border-gray-100">
            <div>
              <p class="font-medium text-gray-900">Verwerkersovereenkomst</p>
              <p class="text-sm text-gray-500">AVG/GDPR compliant template</p>
            </div>
            <a href="/verwerkersovereenkomst" class="text-exact-blue hover:underline text-sm">Downloaden</a>
          </div>

          {/* Privacy Policy */}
          <div class="flex items-center justify-between py-3">
            <div>
              <p class="font-medium text-gray-900">Privacybeleid</p>
              <p class="text-sm text-gray-500">Laatst bijgewerkt: Januari 2026</p>
            </div>
            <a href="/privacy" class="text-exact-blue hover:underline text-sm">Bekijken</a>
          </div>
        </div>

        {/* AI Disclaimer */}
        <div class="mb-8">
          <AiDisclaimer variant="banner" />
        </div>

        {/* Feedback Widget - shows at strategic query milestones */}
        <FeedbackWidget
          userId={user?.id}
          queryCount={apiCallsUsed}
          planLimit={limits.apiCalls === Infinity ? 999999 : limits.apiCalls}
          firstQueryAt={firstQueryAt || undefined}
          milestoneShown={milestoneShown}
        />

        {/* Setup Help Link */}
        <div class="bg-gray-50 rounded-xl border border-gray-200 p-6 text-center mb-8">
          <p class="text-gray-600 mb-2">Hulp nodig met configureren?</p>
          <a href="/setup" class="text-exact-blue hover:underline font-medium">
            Bekijk alle Setup Instructies voor Claude, ChatGPT, Cursor, Windsurf en meer â†’
          </a>
        </div>

        {/* Danger Zone - Account Deletion */}
        <div class="bg-white rounded-xl shadow-sm border border-red-200 p-6">
          <h2 class="text-lg font-semibold text-red-900 mb-4">Gevarenzone</h2>
          <div class="flex items-center justify-between">
            <div>
              <p class="font-medium text-gray-900">Account verwijderen</p>
              <p class="text-sm text-gray-500">
                Verwijder je account en alle bijbehorende data permanent.
              </p>
            </div>
            <button
              type="button"
              id="deleteAccountBtn"
              data-user-email={user?.email}
              class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-colors"
            >
              Account verwijderen
            </button>
          </div>
        </div>
      </>
    )}
  </div>

  <!-- Toast Notification Container -->
  <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2" aria-live="polite"></div>

  <!-- Rename Modal -->
  <div id="renameModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="renameModalTitle">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
      <h3 id="renameModalTitle" class="text-lg font-semibold text-gray-900 mb-4">Sleutel hernoemen</h3>
      <form method="POST" id="renameForm">
        <input type="hidden" name="action" value="rename_api_key" />
        <input type="hidden" name="key_id" id="renameKeyId" />
        <div class="mb-4">
          <label for="newKeyName" class="block text-sm font-medium text-gray-700 mb-1">Nieuwe naam</label>
          <input
            type="text"
            id="newKeyName"
            name="new_name"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
            required
          />
        </div>
        <div class="flex justify-end gap-3">
          <button type="button" id="cancelRename" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
            Annuleren
          </button>
          <button type="submit" class="px-4 py-2 bg-exact-blue text-white font-medium rounded-lg hover:bg-exact-dark transition-colors">
            Opslaan
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Revoke Confirmation Modal -->
  <div id="revokeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="revokeModalTitle">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
      <div class="flex items-start mb-4">
        <div class="flex-shrink-0 w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
          <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <div>
          <h3 id="revokeModalTitle" class="text-lg font-semibold text-gray-900">Sleutel intrekken</h3>
          <p class="text-gray-600 text-sm mt-1">
            Weet je zeker dat je "<span id="revokeKeyName" class="font-medium"></span>" wilt intrekken?
          </p>
        </div>
      </div>
      <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
        <p class="text-amber-800 text-sm">
          <strong>Let op:</strong> Koppelingen die deze sleutel gebruiken werken niet meer. Dit kun je niet ongedaan maken.
        </p>
      </div>
      <div class="flex justify-end gap-3">
        <button type="button" id="cancelRevoke" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
          Annuleren
        </button>
        <form method="POST" id="revokeForm" class="inline">
          <input type="hidden" name="action" value="revoke_api_key" />
          <input type="hidden" name="key_id" id="revokeKeyId" />
          <button type="submit" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-colors">
            Ja, intrekken
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Account Confirmation Modal -->
  <div id="deleteAccountModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="deleteAccountModalTitle">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
      <div class="flex items-start mb-4">
        <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-3">
          <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </div>
        <div>
          <h3 id="deleteAccountModalTitle" class="text-lg font-semibold text-red-900">Account permanent verwijderen</h3>
          <p class="text-gray-600 text-sm mt-1">
            Dit verwijdert je account en alle bijbehorende data.
          </p>
        </div>
      </div>

      <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
        <p class="text-red-800 text-sm mb-2">
          <strong>Dit wordt verwijderd:</strong>
        </p>
        <ul class="text-red-700 text-sm space-y-1 list-disc list-inside">
          <li>Je account en profiel</li>
          <li>Alle API sleutels</li>
          <li>Exact Online connecties</li>
          <li>Gebruiksstatistieken</li>
        </ul>
        <p class="text-red-800 text-sm mt-3 font-medium">
          âš ï¸ Dit kan NIET ongedaan worden gemaakt!
        </p>
      </div>

      <form method="POST" id="deleteAccountForm">
        <input type="hidden" name="action" value="delete_account" />
        <div class="mb-4">
          <label for="confirmEmail" class="block text-sm font-medium text-gray-700 mb-1">
            Typ je e-mailadres om te bevestigen:
          </label>
          <input
            type="email"
            id="confirmEmail"
            name="confirm_email"
            placeholder={user?.email}
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent focus:outline-none"
            required
          />
          <p class="text-xs text-gray-500 mt-1">
            Je e-mailadres: <strong>{user?.email}</strong>
          </p>
        </div>
        <div class="flex justify-end gap-3">
          <button type="button" id="cancelDeleteAccount" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
            Annuleren
          </button>
          <button
            type="submit"
            id="confirmDeleteAccountBtn"
            class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Account permanent verwijderen
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- New Message Modal -->
  <div id="newMessageModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="newMessageModalTitle">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h3 id="newMessageModalTitle" class="text-lg font-semibold text-gray-900">Stuur ons een bericht</h3>
          <p class="text-sm text-gray-500 mt-1">We reageren meestal binnen 24 uur</p>
        </div>
        <button type="button" id="closeNewMessageModal" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <form id="newMessageForm" class="space-y-4">
        <div>
          <label for="msgCategory" class="block text-sm font-medium text-gray-700 mb-1">Waar gaat het over?</label>
          <select
            id="msgCategory"
            name="category"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
          >
            <option value="">Selecteer een categorie</option>
            <option value="question">Vraag</option>
            <option value="bug">Bug melden</option>
            <option value="feature">Feature verzoek</option>
            <option value="feedback">Algemene feedback</option>
            <option value="other">Anders</option>
          </select>
        </div>

        <div>
          <label for="msgSubject" class="block text-sm font-medium text-gray-700 mb-1">Onderwerp</label>
          <input
            type="text"
            id="msgSubject"
            name="subject"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
            placeholder="Kort onderwerp"
          />
        </div>

        <div>
          <label for="msgContent" class="block text-sm font-medium text-gray-700 mb-1">Bericht</label>
          <textarea
            id="msgContent"
            name="content"
            rows="5"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent resize-none"
            placeholder="Beschrijf je vraag, probleem of feedback..."
          ></textarea>
        </div>

        <div id="msgResult" class="hidden"></div>

        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="cancelNewMessage" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
            Annuleren
          </button>
          <button
            type="submit"
            id="submitNewMessage"
            class="px-4 py-2 bg-exact-blue text-white font-medium rounded-lg hover:bg-exact-dark transition-colors flex items-center gap-2"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
            Versturen
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Message Detail Modal -->
  <div id="messageDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="messageDetailTitle">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[80vh] overflow-hidden flex flex-col">
      <div class="p-6 border-b border-gray-100">
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2" id="messageDetailTags">
              <!-- Tags worden hier dynamisch ingevuld -->
            </div>
            <h3 id="messageDetailTitle" class="text-lg font-semibold text-gray-900">Bericht</h3>
            <p id="messageDetailDate" class="text-sm text-gray-500 mt-1"></p>
          </div>
          <button type="button" id="closeMessageDetailModal" class="text-gray-400 hover:text-gray-600 p-1">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <div class="p-6 overflow-y-auto flex-1">
        <div id="messageDetailContent" class="text-gray-700 whitespace-pre-wrap"></div>
      </div>

      <div class="p-4 bg-gray-50 border-t border-gray-100 flex justify-between items-center">
        <button
          type="button"
          id="replyFromDetail"
          class="px-4 py-2 bg-exact-blue text-white text-sm font-medium rounded-lg hover:bg-exact-dark transition-colors flex items-center gap-2"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
          </svg>
          Reageren
        </button>
        <button type="button" id="closeMessageDetailBtn" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
          Sluiten
        </button>
      </div>
    </div>
  </div>

  <script>
    // SEC-001: XSS Prevention - escape HTML entities
    function escapeHtml(unsafe: string | null | undefined): string {
      if (unsafe === null || unsafe === undefined) return '';
      return String(unsafe)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Toast notification system
    function showToast(message: string, type: 'success' | 'error' | 'info' = 'success') {
      const container = document.getElementById('toast-container');
      if (!container) return;

      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
      const icon = type === 'success'
        ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>'
        : type === 'error'
        ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>'
        : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';

      toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 transform translate-x-full transition-transform duration-300`;
      toast.innerHTML = `${icon}<span>${escapeHtml(message)}</span>`;
      container.appendChild(toast);

      // Animate in
      requestAnimationFrame(() => {
        toast.classList.remove('translate-x-full');
      });

      // Auto remove after 3 seconds
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Copy with toast notification
    function copyWithToast(text: string, successMessage: string = 'Gekopieerd!') {
      navigator.clipboard.writeText(text).then(() => {
        showToast(successMessage, 'success');
      }).catch(() => {
        showToast('KopiÃ«ren mislukt', 'error');
      });
    }

    // Copy new API key
    const copyNewBtn = document.getElementById('copyNewApiKey');
    if (copyNewBtn) {
      copyNewBtn.addEventListener('click', () => {
        const key = copyNewBtn.getAttribute('data-key');
        if (key) {
          copyWithToast(key, 'Sleutel gekopieerd');
          copyNewBtn.textContent = 'âœ“ Gekopieerd';
          setTimeout(() => {
            copyNewBtn.textContent = 'Kopieer sleutel';
          }, 2000);
        }
      });
    }

    // Copy simple URL (Claude Desktop in newApiKey section)
    const copySimpleUrlBtn = document.getElementById('copySimpleUrl');
    if (copySimpleUrlBtn) {
      copySimpleUrlBtn.addEventListener('click', () => {
        const url = copySimpleUrlBtn.getAttribute('data-url');
        if (url) {
          copyWithToast(url, 'Claude URL gekopieerd!');
          copySimpleUrlBtn.textContent = 'âœ“ Gekopieerd';
          setTimeout(() => {
            copySimpleUrlBtn.textContent = 'Kopieer';
          }, 2000);
        }
      });
    }

    // Copy MCP Server URL (general URL for ChatGPT/Claude Desktop)
    const copyMcpUrlBtn = document.getElementById('copyMcpUrl');
    if (copyMcpUrlBtn) {
      copyMcpUrlBtn.addEventListener('click', () => {
        const url = copyMcpUrlBtn.getAttribute('data-url');
        if (url) {
          copyWithToast(url, 'MCP URL gekopieerd!');
          copyMcpUrlBtn.textContent = 'âœ“ Gekopieerd';
          setTimeout(() => {
            copyMcpUrlBtn.textContent = 'Kopieer URL';
          }, 2000);
        }
      });
    }

    // Copy Claude Code command
    const copyClaudeCodeBtn = document.getElementById('copyClaudeCodeCmd');
    if (copyClaudeCodeBtn) {
      copyClaudeCodeBtn.addEventListener('click', () => {
        const cmd = copyClaudeCodeBtn.getAttribute('data-cmd');
        if (cmd) {
          copyWithToast(cmd, 'Claude Code commando gekopieerd!');
          copyClaudeCodeBtn.textContent = 'âœ“ Gekopieerd';
          setTimeout(() => {
            copyClaudeCodeBtn.textContent = 'Kopieer Commando';
          }, 2000);
        }
      });
    }

    // Copy ChatGPT URL
    const copyChatGptUrlBtn = document.getElementById('copyChatGptUrl');
    if (copyChatGptUrlBtn) {
      copyChatGptUrlBtn.addEventListener('click', () => {
        const url = copyChatGptUrlBtn.getAttribute('data-url');
        if (url) {
          copyWithToast(url, 'ChatGPT URL gekopieerd!');
          copyChatGptUrlBtn.textContent = 'âœ“';
          setTimeout(() => {
            copyChatGptUrlBtn.textContent = 'Kopieer';
          }, 2000);
        }
      });
    }

    // Copy Remove Command
    const copyRemoveBtn = document.getElementById('copyRemoveCmd');
    if (copyRemoveBtn) {
      copyRemoveBtn.addEventListener('click', () => {
        copyWithToast('claude mcp remove exact-online', 'Verwijder commando gekopieerd!');
        copyRemoveBtn.textContent = 'âœ“ Gekopieerd';
        setTimeout(() => {
          copyRemoveBtn.textContent = 'Kopieer Verwijder Commando';
        }, 2000);
      });
    }

    // Rename API Key Modal
    const renameModal = document.getElementById('renameModal');
    const renameForm = document.getElementById('renameForm') as HTMLFormElement;
    const renameKeyIdInput = document.getElementById('renameKeyId') as HTMLInputElement;
    const newKeyNameInput = document.getElementById('newKeyName') as HTMLInputElement;
    const cancelRenameBtn = document.getElementById('cancelRename');

    document.querySelectorAll('.rename-key-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const keyId = (btn as HTMLElement).dataset.keyId;
        const keyName = (btn as HTMLElement).dataset.keyName;
        if (keyId && renameModal && renameKeyIdInput && newKeyNameInput) {
          renameKeyIdInput.value = keyId;
          newKeyNameInput.value = keyName || '';
          renameModal.classList.remove('hidden');
          newKeyNameInput.focus();
        }
      });
    });

    cancelRenameBtn?.addEventListener('click', () => {
      renameModal?.classList.add('hidden');
    });

    renameModal?.addEventListener('click', (e) => {
      if (e.target === renameModal) {
        renameModal.classList.add('hidden');
      }
    });

    // Revoke API Key Modal
    const revokeModal = document.getElementById('revokeModal');
    const revokeForm = document.getElementById('revokeForm') as HTMLFormElement;
    const revokeKeyIdInput = document.getElementById('revokeKeyId') as HTMLInputElement;
    const revokeKeyNameSpan = document.getElementById('revokeKeyName');
    const cancelRevokeBtn = document.getElementById('cancelRevoke');
    let currentRevokeKeyId: string | null = null;

    document.querySelectorAll('.revoke-key-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const keyId = (btn as HTMLElement).dataset.keyId;
        const keyName = (btn as HTMLElement).dataset.keyName;
        if (keyId && revokeModal && revokeKeyIdInput && revokeKeyNameSpan) {
          currentRevokeKeyId = keyId;
          revokeKeyIdInput.value = keyId;
          revokeKeyNameSpan.textContent = keyName || 'deze key';
          revokeModal.classList.remove('hidden');
        }
      });
    });

    cancelRevokeBtn?.addEventListener('click', () => {
      revokeModal?.classList.add('hidden');
      currentRevokeKeyId = null;
    });

    revokeModal?.addEventListener('click', (e) => {
      if (e.target === revokeModal) {
        revokeModal.classList.add('hidden');
        currentRevokeKeyId = null;
      }
    });

    // Handle revoke form submission via AJAX to prevent scroll reset
    revokeForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = revokeForm.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.setAttribute('disabled', 'true');
        submitBtn.textContent = 'Bezig...';
      }

      const formData = new FormData(revokeForm);

      try {
        const response = await fetch(window.location.pathname, {
          method: 'POST',
          body: formData,
        });

        if (response.ok) {
          // Remove the key element from DOM
          const keyElement = document.getElementById(`key-${currentRevokeKeyId}`);
          if (keyElement) {
            keyElement.style.transition = 'opacity 0.3s, transform 0.3s';
            keyElement.style.opacity = '0';
            keyElement.style.transform = 'translateX(20px)';
            setTimeout(() => keyElement.remove(), 300);
          }

          // Update the key count in the header
          const keyCountText = document.querySelector('.bg-white.rounded-xl h2 + p');
          if (keyCountText) {
            const match = keyCountText.textContent?.match(/(\d+) van/);
            if (match) {
              const newCount = parseInt(match[1]) - 1;
              keyCountText.textContent = keyCountText.textContent?.replace(/\d+ van/, `${newCount} van`) || '';
            }
          }

          showToast('Sleutel ingetrokken', 'success');
          revokeModal?.classList.add('hidden');
        } else {
          showToast('Er ging iets mis', 'error');
        }
      } catch (error) {
        showToast('Er ging iets mis', 'error');
      } finally {
        if (submitBtn) {
          submitBtn.removeAttribute('disabled');
          submitBtn.textContent = 'Ja, intrekken';
        }
        currentRevokeKeyId = null;
      }
    });

    // Loading states for forms (exclude AJAX-handled forms)
    document.querySelectorAll('form').forEach(form => {
      // Skip forms that are handled via AJAX
      if (form.id === 'revokeForm') return;

      form.addEventListener('submit', () => {
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.setAttribute('disabled', 'true');
          const spinner = submitBtn.querySelector('.btn-spinner');
          const text = submitBtn.querySelector('.btn-text');
          if (spinner) spinner.classList.remove('hidden');
          if (text) text.classList.add('opacity-50');
        }
      });
    });

    // Escape key to close modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        renameModal?.classList.add('hidden');
        revokeModal?.classList.add('hidden');
        deleteAccountModal?.classList.add('hidden');
      }
    });

    // Delete Account Modal
    const deleteAccountModal = document.getElementById('deleteAccountModal');
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    const cancelDeleteAccountBtn = document.getElementById('cancelDeleteAccount');
    const confirmEmailInput = document.getElementById('confirmEmail') as HTMLInputElement;
    const confirmDeleteAccountBtn = document.getElementById('confirmDeleteAccountBtn') as HTMLButtonElement;
    const userEmail = deleteAccountBtn?.getAttribute('data-user-email') || '';

    deleteAccountBtn?.addEventListener('click', () => {
      deleteAccountModal?.classList.remove('hidden');
      confirmEmailInput?.focus();
    });

    cancelDeleteAccountBtn?.addEventListener('click', () => {
      deleteAccountModal?.classList.add('hidden');
      if (confirmEmailInput) confirmEmailInput.value = '';
      if (confirmDeleteAccountBtn) confirmDeleteAccountBtn.disabled = true;
    });

    deleteAccountModal?.addEventListener('click', (e) => {
      if (e.target === deleteAccountModal) {
        deleteAccountModal.classList.add('hidden');
        if (confirmEmailInput) confirmEmailInput.value = '';
        if (confirmDeleteAccountBtn) confirmDeleteAccountBtn.disabled = true;
      }
    });

    // Enable delete button only when email matches
    confirmEmailInput?.addEventListener('input', () => {
      const emailMatches = confirmEmailInput.value.toLowerCase() === userEmail.toLowerCase();
      if (confirmDeleteAccountBtn) {
        confirmDeleteAccountBtn.disabled = !emailMatches;
      }
    });

    // New Message Modal
    const newMessageModal = document.getElementById('newMessageModal');
    const newMessageForm = document.getElementById('newMessageForm') as HTMLFormElement;
    const msgSubjectInput = document.getElementById('msgSubject') as HTMLInputElement;
    const msgContentInput = document.getElementById('msgContent') as HTMLTextAreaElement;
    const msgCategorySelect = document.getElementById('msgCategory') as HTMLSelectElement | null;
    const msgResultDiv = document.getElementById('msgResult');
    const openNewMessageBtns = document.querySelectorAll('#openNewMessageModal, #openNewMessageModalEmpty');
    const closeNewMessageBtn = document.getElementById('closeNewMessageModal');
    const cancelNewMessageBtn = document.getElementById('cancelNewMessage');

    function openMessageModal(prefillSubject = '') {
      if (newMessageModal) {
        newMessageModal.classList.remove('hidden');
        if (prefillSubject && msgSubjectInput) {
          msgSubjectInput.value = prefillSubject;
        }
        msgContentInput?.focus();
      }
    }

    function closeMessageModal() {
      newMessageModal?.classList.add('hidden');
      newMessageForm?.reset();
      if (msgResultDiv) {
        msgResultDiv.classList.add('hidden');
        msgResultDiv.innerHTML = '';
      }
    }

    openNewMessageBtns.forEach(btn => {
      btn.addEventListener('click', () => openMessageModal());
    });

    closeNewMessageBtn?.addEventListener('click', closeMessageModal);
    cancelNewMessageBtn?.addEventListener('click', closeMessageModal);

    newMessageModal?.addEventListener('click', (e) => {
      if (e.target === newMessageModal) closeMessageModal();
    });

    // Message Detail Modal
    const messageDetailModal = document.getElementById('messageDetailModal');
    const messageDetailTitle = document.getElementById('messageDetailTitle');
    const messageDetailDate = document.getElementById('messageDetailDate');
    const messageDetailContent = document.getElementById('messageDetailContent');
    const messageDetailTags = document.getElementById('messageDetailTags');
    const closeDetailModalBtn = document.getElementById('closeMessageDetailModal');
    const closeDetailBtn = document.getElementById('closeMessageDetailBtn');
    const replyFromDetailBtn = document.getElementById('replyFromDetail');
    const messageItems = document.querySelectorAll('.message-item');

    let currentMessageSubject = '';

    // Category color mapping
    const categoryColors: Record<string, string> = {
      bug: 'bg-red-100 text-red-700',
      feature: 'bg-emerald-100 text-emerald-700',
      question: 'bg-cyan-100 text-cyan-700',
      feedback: 'bg-amber-100 text-amber-700',
    };

    const categoryLabels: Record<string, string> = {
      bug: 'Bug',
      feature: 'Feature',
      question: 'Vraag',
      feedback: 'Feedback',
      other: 'Anders',
    };

    const typeColors: Record<string, string> = {
      email: 'bg-blue-100 text-blue-700',
      support: 'bg-purple-100 text-purple-700',
      feedback: 'bg-amber-100 text-amber-700',
    };

    const typeLabels: Record<string, string> = {
      email: 'Email',
      support: 'Support',
      feedback: 'Feedback',
    };

    function openDetailModal(data: {
      subject: string;
      content: string;
      type: string;
      direction: string;
      category: string;
      date: string;
    }) {
      currentMessageSubject = data.subject;

      if (messageDetailTitle) {
        messageDetailTitle.textContent = data.subject || 'Bericht';
      }
      if (messageDetailDate) {
        messageDetailDate.textContent = data.date;
      }
      if (messageDetailContent) {
        messageDetailContent.textContent = data.content;
      }

      // Build tags
      if (messageDetailTags) {
        let tagsHtml = '';

        // Type tag
        const typeColor = typeColors[data.type] || 'bg-gray-100 text-gray-700';
        const typeLabel = typeLabels[data.type] || data.type;
        tagsHtml += `<span class="px-2 py-0.5 rounded text-xs font-medium ${typeColor}">${escapeHtml(typeLabel)}</span>`;

        // Direction tag
        const dirColor = data.direction === 'in' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700';
        const dirLabel = data.direction === 'in' ? 'Van ons' : 'Van jou';
        tagsHtml += `<span class="px-2 py-0.5 rounded text-xs ${dirColor}">${dirLabel}</span>`;

        // Category tag (if present)
        if (data.category) {
          const catColor = categoryColors[data.category] || 'bg-gray-100 text-gray-700';
          const catLabel = categoryLabels[data.category] || data.category;
          tagsHtml += `<span class="px-2 py-0.5 rounded text-xs font-medium ${catColor}">${escapeHtml(catLabel)}</span>`;
        }

        messageDetailTags.innerHTML = tagsHtml;
      }

      // Show/hide reply button based on direction
      if (replyFromDetailBtn) {
        replyFromDetailBtn.style.display = data.direction === 'in' ? 'flex' : 'none';
      }

      messageDetailModal?.classList.remove('hidden');
    }

    function closeDetailModal() {
      messageDetailModal?.classList.add('hidden');
    }

    // Message item click handlers
    messageItems.forEach(item => {
      item.addEventListener('click', () => {
        const el = item as HTMLElement;
        openDetailModal({
          subject: el.dataset.subject || '',
          content: el.dataset.content || '',
          type: el.dataset.type || '',
          direction: el.dataset.direction || '',
          category: el.dataset.category || '',
          date: el.dataset.date || '',
        });
      });
    });

    closeDetailModalBtn?.addEventListener('click', closeDetailModal);
    closeDetailBtn?.addEventListener('click', closeDetailModal);

    messageDetailModal?.addEventListener('click', (e) => {
      if (e.target === messageDetailModal) closeDetailModal();
    });

    // Reply from detail modal
    replyFromDetailBtn?.addEventListener('click', () => {
      closeDetailModal();
      const replySubject = currentMessageSubject ? `Re: ${currentMessageSubject}` : 'Re: Bericht';
      openMessageModal(replySubject);
    });

    // Submit new message
    newMessageForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submitNewMessage') as HTMLButtonElement;
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Versturen...';

      try {
        const response = await fetch('/api/messages/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            category: msgCategorySelect?.value,
            subject: msgSubjectInput?.value,
            content: msgContentInput?.value,
          }),
        });

        const result = await response.json() as { success: boolean; error?: string };

        if (msgResultDiv) {
          msgResultDiv.classList.remove('hidden');
          if (result.success) {
            msgResultDiv.className = 'p-4 bg-green-50 border border-green-200 rounded-lg';
            msgResultDiv.innerHTML = '<p class="text-green-800 text-sm"><strong>Bericht verzonden!</strong> We reageren zo snel mogelijk.</p>';
            setTimeout(() => {
              closeMessageModal();
              window.location.reload();
            }, 2000);
          } else {
            msgResultDiv.className = 'p-4 bg-red-50 border border-red-200 rounded-lg';
            msgResultDiv.innerHTML = `<p class="text-red-800 text-sm"><strong>Fout:</strong> ${escapeHtml(result.error || 'Onbekende fout')}</p>`;
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        }
      } catch (error) {
        if (msgResultDiv) {
          msgResultDiv.classList.remove('hidden');
          msgResultDiv.className = 'p-4 bg-red-50 border border-red-200 rounded-lg';
          msgResultDiv.innerHTML = '<p class="text-red-800 text-sm"><strong>Netwerkfout:</strong> Kon bericht niet versturen</p>';
        }
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });

    // Load provider stats for Privacy section
    async function loadProviderStats() {
      const badgeContainer = document.getElementById('lastProviderBadge');
      const usageContainer = document.getElementById('providerUsageBreakdown');

      if (!badgeContainer || !usageContainer) return;

      try {
        const response = await fetch('/api/stats/providers');
        if (!response.ok) {
          throw new Error('Failed to fetch provider stats');
        }

        const data = await response.json() as {
          lastProvider: string;
          providers: Array<{ provider: string; displayName: string; count: number }>;
        };

        // Provider color mapping
        const providerColors: Record<string, { bg: string; text: string }> = {
          claude: { bg: 'bg-purple-100', text: 'text-purple-800' },
          chatgpt: { bg: 'bg-green-100', text: 'text-green-800' },
          copilot: { bg: 'bg-blue-100', text: 'text-blue-800' },
          cursor: { bg: 'bg-indigo-100', text: 'text-indigo-800' },
          unknown: { bg: 'bg-gray-100', text: 'text-gray-800' },
        };

        const providerNames: Record<string, string> = {
          claude: 'Claude',
          chatgpt: 'ChatGPT',
          copilot: 'Copilot',
          cursor: 'Cursor',
          unknown: 'Onbekend',
        };

        // Update last provider badge
        // SEC-001: Use textContent for badge text content (safe from XSS)
        if (data.lastProvider && data.lastProvider !== 'unknown') {
          const colors = providerColors[data.lastProvider] || providerColors.unknown;
          const name = providerNames[data.lastProvider] || 'Onbekend';
          const span = document.createElement('span');
          span.className = `inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${colors.bg} ${colors.text}`;
          span.textContent = name;
          badgeContainer.innerHTML = '';
          badgeContainer.appendChild(span);
        } else if (data.providers.length === 0) {
          const span = document.createElement('span');
          span.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600';
          span.textContent = 'Nog geen data';
          badgeContainer.innerHTML = '';
          badgeContainer.appendChild(span);
        } else {
          const span = document.createElement('span');
          span.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600';
          span.textContent = 'Onbekend';
          badgeContainer.innerHTML = '';
          badgeContainer.appendChild(span);
        }

        // Update usage breakdown
        // SEC-001: Build DOM elements safely instead of using innerHTML with dynamic data
        if (data.providers.length > 0) {
          const totalCalls = data.providers.reduce((sum: number, p: { count: number }) => sum + p.count, 0);
          usageContainer.innerHTML = '';
          data.providers.forEach((p: { provider: string; displayName: string; count: number }) => {
            const colors = providerColors[p.provider] || providerColors.unknown;
            const percentage = totalCalls > 0 ? Math.round((p.count / totalCalls) * 100) : 0;

            const row = document.createElement('div');
            row.className = 'flex items-center';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'w-24 text-sm text-gray-600';
            nameSpan.textContent = p.displayName;

            const progressContainer = document.createElement('div');
            progressContainer.className = 'flex-1 bg-gray-200 rounded-full h-2 mx-3';

            const progressBar = document.createElement('div');
            progressBar.className = `${colors.bg.replace('100', '500')} h-2 rounded-full`;
            progressBar.style.width = `${percentage}%`;
            progressContainer.appendChild(progressBar);

            const countSpan = document.createElement('span');
            countSpan.className = 'text-sm text-gray-600 w-20 text-right';
            countSpan.textContent = `${p.count} calls`;

            row.appendChild(nameSpan);
            row.appendChild(progressContainer);
            row.appendChild(countSpan);
            usageContainer.appendChild(row);
          });
        } else {
          const p = document.createElement('p');
          p.className = 'text-sm text-gray-500';
          p.textContent = 'Nog geen API calls geregistreerd.';
          usageContainer.innerHTML = '';
          usageContainer.appendChild(p);
        }
      } catch (error) {
        console.error('Failed to load provider stats:', error);
        if (badgeContainer) {
          const span = document.createElement('span');
          span.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600';
          span.textContent = 'Niet beschikbaar';
          badgeContainer.innerHTML = '';
          badgeContainer.appendChild(span);
        }
        if (usageContainer) {
          const p = document.createElement('p');
          p.className = 'text-sm text-gray-500';
          p.textContent = 'Kon statistieken niet laden.';
          usageContainer.innerHTML = '';
          usageContainer.appendChild(p);
        }
      }
    }

    // Load provider stats on page load
    loadProviderStats();

    // Division toggle functionality
    document.querySelectorAll('.division-toggle').forEach(button => {
      button.addEventListener('click', async (e) => {
        const btn = e.currentTarget as HTMLButtonElement;
        if (btn.disabled) return;

        const divisionId = btn.dataset.divisionId;
        const currentlyActive = btn.dataset.active === 'true';
        const newActive = !currentlyActive;

        // Disable button during request
        btn.disabled = true;
        btn.classList.add('opacity-50');

        try {
          const response = await fetch('/api/divisions/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ divisionId, active: newActive }),
          });

          const result = await response.json() as { success: boolean; error?: string };

          if (result.success) {
            // Reload page to show updated state
            window.location.reload();
          } else {
            // Show error
            alert(result.error || 'Er is een fout opgetreden');
            btn.disabled = false;
            btn.classList.remove('opacity-50');
          }
        } catch (err) {
          console.error('Toggle error:', err);
          alert('Er is een fout opgetreden bij het wijzigen van de administratie');
          btn.disabled = false;
          btn.classList.remove('opacity-50');
        }
      });
    });

    // "Alles activeren" button functionality
    const activateAllBtn = document.getElementById('activate-all-btn');
    if (activateAllBtn) {
      activateAllBtn.addEventListener('click', async () => {
        const btn = activateAllBtn as HTMLButtonElement;
        if (btn.disabled) return;

        // Confirm action
        if (!confirm('Weet je zeker dat je alle administraties wilt activeren?')) {
          return;
        }

        // Disable button during request
        btn.disabled = true;
        btn.textContent = 'Bezig...';

        try {
          const response = await fetch('/api/divisions/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'activate_all' }),
          });

          const result = await response.json() as {
            success: boolean;
            error?: string;
            message?: string;
            limited?: boolean;
          };

          if (result.success) {
            // Show message if limited by plan
            if (result.limited) {
              alert(result.message || 'Niet alle administraties konden worden geactiveerd vanwege je plan limiet.');
            }
            // Reload page to show updated state
            window.location.reload();
          } else {
            alert(result.error || 'Er is een fout opgetreden');
            btn.disabled = false;
            btn.textContent = 'Alles activeren';
          }
        } catch (err) {
          console.error('Activate all error:', err);
          alert('Er is een fout opgetreden bij het activeren van alle administraties');
          btn.disabled = false;
          btn.textContent = 'Alles activeren';
        }
      });
    }

    // Email Preferences
    async function loadEmailPreferences() {
      try {
        const response = await fetch('/api/preferences/email');
        const result = await response.json() as {
          success: boolean;
          preferences?: {
            email_support_replies: boolean;
            email_privacy_tips: boolean;
            email_provider_news: boolean;
            email_product_updates: boolean;
          };
        };

        if (result.success && result.preferences) {
          const supportReplies = document.getElementById('pref_support_replies') as HTMLInputElement;
          const productUpdates = document.getElementById('pref_product_updates') as HTMLInputElement;
          const privacyTips = document.getElementById('pref_privacy_tips') as HTMLInputElement;

          if (supportReplies) supportReplies.checked = result.preferences.email_support_replies;
          if (productUpdates) productUpdates.checked = result.preferences.email_product_updates;
          if (privacyTips) privacyTips.checked = result.preferences.email_privacy_tips;
        }
      } catch (err) {
        console.error('Failed to load email preferences:', err);
      }
    }

    async function saveEmailPreference(key: string, value: boolean) {
      const statusEl = document.getElementById('prefSaveStatus');
      try {
        const response = await fetch('/api/preferences/email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [key]: value }),
        });

        const result = await response.json() as { success: boolean };

        if (result.success && statusEl) {
          statusEl.classList.remove('hidden');
          setTimeout(() => statusEl.classList.add('hidden'), 2000);
        }
      } catch (err) {
        console.error('Failed to save email preference:', err);
        showToast('Fout bij opslaan voorkeur', 'error');
      }
    }

    // Load preferences and setup listeners
    loadEmailPreferences();

    const prefSupportReplies = document.getElementById('pref_support_replies') as HTMLInputElement;
    const prefProductUpdates = document.getElementById('pref_product_updates') as HTMLInputElement;
    const prefPrivacyTips = document.getElementById('pref_privacy_tips') as HTMLInputElement;

    if (prefSupportReplies) {
      prefSupportReplies.addEventListener('change', () => {
        saveEmailPreference('email_support_replies', prefSupportReplies.checked);
      });
    }

    if (prefProductUpdates) {
      prefProductUpdates.addEventListener('change', () => {
        saveEmailPreference('email_product_updates', prefProductUpdates.checked);
      });
    }

    if (prefPrivacyTips) {
      prefPrivacyTips.addEventListener('change', () => {
        saveEmailPreference('email_privacy_tips', prefPrivacyTips.checked);
      });
    }
  </script>
</Layout>
