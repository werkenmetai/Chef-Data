---
import Layout from '../../layouts/Layout.astro';
import {
  buildAuthorizationUrl,
  generateState,
  encodeState,
  generateCodeVerifier,
  generateCodeChallenge,
  type ExactRegion
} from '../../lib/exact-auth';
import { t } from '../../lib/i18n';

const lang = 'en';

// Get environment variables
const env = Astro.locals.runtime.env;

// Validate required environment variables
const clientId = env.EXACT_CLIENT_ID;
const redirectUri = env.EXACT_REDIRECT_URI;

if (!clientId || !redirectUri) {
  console.error('Missing required environment variables:', {
    hasClientId: !!clientId,
    hasRedirectUri: !!redirectUri,
  });
}

// Show error state for configuration issues
const isConfigured = Boolean(clientId && redirectUri);

// Get OAuth return URL if present (for MCP OAuth flow)
const pageUrl = new URL(Astro.request.url);
const oauthReturn = pageUrl.searchParams.get('oauth_return');

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const region = (formData.get('region') as ExactRegion) || 'NL';
  const oauthReturnUrl = formData.get('oauth_return') as string | null;

  // Generate PKCE code verifier and challenge
  const codeVerifier = generateCodeVerifier();
  const codeChallenge = await generateCodeChallenge(codeVerifier);

  // Determine return URL (OAuth flow or normal dashboard)
  const returnUrl = oauthReturnUrl || '/en/dashboard';

  // Generate secure state with nonce and HMAC signature
  const nonce = generateState();
  const state = await encodeState({
    region,
    nonce,
    returnUrl,
  }, env.SESSION_SECRET);

  // Store nonce in cookie for verification (httpOnly, secure)
  Astro.cookies.set('oauth_nonce', nonce, {
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 600, // 10 minutes
    path: '/',
  });

  // Store PKCE code verifier in separate cookie (httpOnly, secure)
  Astro.cookies.set('oauth_code_verifier', codeVerifier, {
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 600, // 10 minutes
    path: '/',
  });

  // Check environment variables before redirect
  if (!clientId || !redirectUri) {
    return new Response('OAuth not configured. Please contact support.', { status: 500 });
  }

  // Redirect to Exact Online with PKCE
  const authUrl = await buildAuthorizationUrl(
    clientId,
    redirectUri,
    state,
    region,
    codeChallenge
  );

  return Astro.redirect(authUrl);
}

const regions = [
  { code: 'NL', name: 'Netherlands' },
  { code: 'BE', name: 'Belgium' },
  { code: 'DE', name: 'Germany' },
  { code: 'UK', name: 'United Kingdom' },
  { code: 'FR', name: 'France' },
  { code: 'ES', name: 'Spain' },
  { code: 'US', name: 'United States' },
];
---

<Layout title="Connect" lang="en">
  <div class="max-w-lg mx-auto px-4 py-16">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8">
      <h1 class="text-2xl font-bold text-gray-900 text-center mb-2">
        Connect to Exact Online
      </h1>
      <p class="text-gray-600 text-center mb-8">
        Select your region and log in with your Exact Online account.
      </p>

      {!isConfigured && (
        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-red-700 text-sm">
            OAuth configuration is missing. Please contact the administrator.
          </p>
        </div>
      )}

      <form method="POST" class="space-y-6">
        {oauthReturn && (
          <input type="hidden" name="oauth_return" value={oauthReturn} />
        )}
        <div>
          <label for="region" class="block text-sm font-medium text-gray-700 mb-2">
            Region
          </label>
          <select
            id="region"
            name="region"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-exact-blue"
          >
            {regions.map((region) => (
              <option value={region.code} selected={region.code === 'NL'}>
                {region.name}
              </option>
            ))}
          </select>
        </div>

        <button
          type="submit"
          disabled={!isConfigured}
          class={`w-full px-6 py-3 font-semibold rounded-lg transition-colors ${
            isConfigured
              ? 'bg-exact-blue text-white hover:bg-exact-dark'
              : 'bg-gray-300 text-gray-500 cursor-not-allowed'
          }`}
        >
          Continue to Exact Online
        </button>
      </form>

      <div class="mt-8 pt-6 border-t border-gray-100">
        <h3 class="text-sm font-medium text-gray-900 mb-3">What happens?</h3>
        <ul class="text-sm text-gray-600 space-y-2">
          <li class="flex items-start">
            <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            You will be redirected to Exact Online to log in
          </li>
          <li class="flex items-start">
            <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            You grant read-only access permission
          </li>
          <li class="flex items-start">
            <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            We only store a token, not your password
          </li>
        </ul>
      </div>
    </div>
  </div>
</Layout>
