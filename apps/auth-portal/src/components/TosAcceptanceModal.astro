---
import { TOS_VERSION } from '../lib/constants';

interface Props {
  currentVersion?: string;
  userAcceptedVersion: string | null;
}

const { currentVersion = TOS_VERSION, userAcceptedVersion } = Astro.props;
const needsAcceptance = !userAcceptedVersion || userAcceptedVersion !== currentVersion;
---

{needsAcceptance && (
  <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" id="tos-modal" role="dialog" aria-modal="true" aria-labelledby="tos-title">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] flex flex-col">
      <div class="p-6 border-b border-gray-200">
        <h2 id="tos-title" class="text-xl font-bold text-gray-900">Algemene Voorwaarden</h2>
        <p class="text-gray-600 text-sm mt-1">Versie {currentVersion} - Januari 2026</p>
      </div>

      <div class="p-6 overflow-y-auto flex-1">
        <!-- Samenvatting belangrijkste punten -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
          <h3 class="text-blue-900 font-semibold mb-2">Samenvatting</h3>
          <ul class="text-blue-800 text-sm space-y-2">
            <li class="flex items-start gap-2">
              <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Wij leveren een pass-through dienst - geen opslag van boekhouddata</span>
            </li>
            <li class="flex items-start gap-2">
              <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Jij bent verantwoordelijk voor je AI-provider keuze en instellingen</span>
            </li>
            <li class="flex items-start gap-2">
              <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <span><strong>AI-output is geen financieel advies</strong> - altijd zelf controleren</span>
            </li>
            <li class="flex items-start gap-2">
              <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Onze aansprakelijkheid is beperkt tot het bedrag dat je betaald hebt</span>
            </li>
          </ul>
        </div>

        <p class="text-gray-600 text-sm">
          Door gebruik te maken van Praat met je Boekhouding ga je akkoord met onze{' '}
          <a href="/voorwaarden" target="_blank" class="text-exact-blue hover:underline font-medium">volledige Algemene Voorwaarden</a>.
        </p>
      </div>

      <div class="p-6 border-t border-gray-200 bg-gray-50 rounded-b-xl">
        <label class="flex items-start gap-3 cursor-pointer group">
          <input
            type="checkbox"
            id="tos-checkbox"
            class="mt-1 w-4 h-4 rounded border-gray-300 text-exact-blue focus:ring-exact-blue cursor-pointer"
            required
          />
          <span class="text-sm text-gray-700 group-hover:text-gray-900">
            Ik heb de{' '}
            <a href="/voorwaarden" target="_blank" class="text-exact-blue underline hover:text-exact-dark">Algemene Voorwaarden</a>{' '}
            en het{' '}
            <a href="/privacy" target="_blank" class="text-exact-blue underline hover:text-exact-dark">Privacybeleid</a>{' '}
            gelezen en ga hiermee akkoord.
          </span>
        </label>

        <button
          id="tos-accept-btn"
          disabled
          class="mt-4 w-full bg-exact-blue text-white py-3 px-4 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-exact-dark transition-colors flex items-center justify-center gap-2"
        >
          <span id="tos-btn-text">Akkoord en doorgaan</span>
          <svg id="tos-btn-spinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
)}

<script define:vars={{ currentVersion }}>
  const checkbox = document.getElementById('tos-checkbox');
  const button = document.getElementById('tos-accept-btn');
  const modal = document.getElementById('tos-modal');
  const btnText = document.getElementById('tos-btn-text');
  const btnSpinner = document.getElementById('tos-btn-spinner');

  if (checkbox && button) {
    checkbox.addEventListener('change', (e) => {
      button.disabled = !e.target.checked;
    });
  }

  if (button) {
    button.addEventListener('click', async () => {
      button.disabled = true;
      if (btnText) btnText.textContent = 'Bezig...';
      if (btnSpinner) btnSpinner.classList.remove('hidden');

      try {
        const response = await fetch('/api/legal/accept-tos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ version: currentVersion })
        });

        if (response.ok) {
          if (modal) {
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.3s';
            setTimeout(() => {
              modal.remove();
              // Reload to refresh user state
              window.location.reload();
            }, 300);
          }
        } else {
          const data = await response.json().catch(() => ({}));
          alert(data.error || 'Er ging iets mis. Probeer opnieuw.');
          button.disabled = false;
          if (btnText) btnText.textContent = 'Akkoord en doorgaan';
          if (btnSpinner) btnSpinner.classList.add('hidden');
        }
      } catch (error) {
        console.error('ToS acceptance error:', error);
        alert('Er ging iets mis. Probeer opnieuw.');
        button.disabled = false;
        if (btnText) btnText.textContent = 'Akkoord en doorgaan';
        if (btnSpinner) btnSpinner.classList.add('hidden');
      }
    });
  }

  // Prevent closing modal by clicking outside (user must accept)
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        e.stopPropagation();
      }
    });
  }
</script>
