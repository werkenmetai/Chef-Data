---
import Layout from '../../../../layouts/Layout.astro';
import { Database, type SupportLesson } from '../../../../lib/database';
// AdminAppLauncher now in Layout.astro header

const env = Astro.locals.runtime?.env;
let db: Database | null = null;
let isAdmin = false;
let lessons: SupportLesson[] = [];
let error: string | null = null;

const categoryFilter = Astro.url.searchParams.get('category') || '';

try {
  if (env?.DB) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());

        if (isAdmin) {
          lessons = await db.getLessons(100);
          // Filter by category if specified
          if (categoryFilter) {
            lessons = lessons.filter(l => l.category === categoryFilter);
          }
        }
      }
    }
  }
} catch (e) {
  console.error('Admin lessons error:', e);
  error = 'Er is een fout opgetreden';
}

const categoryLabels: Record<string, string> = {
  connection: 'Verbinding',
  billing: 'Facturatie',
  bug: 'Technisch',
  feature: 'Features',
  account: 'Account',
  other: 'Overig',
};

function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('nl-NL', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
  });
}
---

<Layout title="Lessons Learned">
  <div class="max-w-7xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          ← Terug naar Dashboard
        </a>
      </div>
    ) : (
      <>
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Lessons Learned</h1>
            <p class="text-gray-600">Inzichten uit opgeloste support gesprekken</p>
          </div>
          <div class="flex items-center gap-3">
            <a href="/admin/support" class="text-gray-600 hover:text-gray-900">
              ← Terug
            </a>
            <a
              href="/admin/support/lessons/new"
              class="px-4 py-2 bg-exact-blue text-white font-medium rounded-lg hover:bg-exact-dark transition-colors"
            >
              + Nieuw lesson
            </a>
          </div>
        </div>

        {error && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-700">{error}</p>
          </div>
        )}

        <!-- Info Box -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            <div>
              <h3 class="font-medium text-yellow-900">Wat zijn Lessons Learned?</h3>
              <p class="text-sm text-yellow-700 mt-1">
                Lessons Learned documenteren inzichten uit support gesprekken. Ze kunnen leiden tot nieuwe AI patterns,
                kennisbank artikelen of zelfs code fixes. Dit helpt het systeem continu te verbeteren.
              </p>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
          <form method="GET" class="flex flex-wrap items-center gap-4">
            <div>
              <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Categorie</label>
              <select
                name="category"
                id="category"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              >
                <option value="">Alle categorieën</option>
                <option value="connection" selected={categoryFilter === 'connection'}>Verbinding</option>
                <option value="billing" selected={categoryFilter === 'billing'}>Facturatie</option>
                <option value="bug" selected={categoryFilter === 'bug'}>Technisch</option>
                <option value="feature" selected={categoryFilter === 'feature'}>Features</option>
                <option value="account" selected={categoryFilter === 'account'}>Account</option>
                <option value="other" selected={categoryFilter === 'other'}>Overig</option>
              </select>
            </div>

            <div class="flex items-end gap-2">
              <button
                type="submit"
                class="px-4 py-2 bg-exact-blue text-white font-medium rounded-lg hover:bg-exact-dark transition-colors"
              >
                Filter
              </button>
              {categoryFilter && (
                <a
                  href="/admin/support/lessons"
                  class="px-4 py-2 text-gray-600 hover:text-gray-900"
                >
                  Reset
                </a>
              )}
            </div>
          </form>
        </div>

        <!-- Lessons List -->
        {lessons.length === 0 ? (
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center">
            <p class="text-gray-500 mb-4">Nog geen lessons learned</p>
            <p class="text-sm text-gray-400 mb-6">
              Lessons worden aangemaakt vanuit opgeloste support gesprekken
            </p>
            <a
              href="/admin/support/conversations"
              class="text-exact-blue hover:underline"
            >
              Bekijk gesprekken
            </a>
          </div>
        ) : (
          <div class="space-y-4">
            {lessons.map((lesson) => (
              <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <h3 class="text-lg font-semibold text-gray-900">{lesson.title}</h3>
                    <div class="flex items-center gap-3 mt-1">
                      {lesson.category && (
                        <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">
                          {categoryLabels[lesson.category] || lesson.category}
                        </span>
                      )}
                      <span class="text-sm text-gray-500">{formatDate(lesson.created_at)}</span>
                      {lesson.conversation_id && (
                        <a
                          href={`/admin/support/conversations/${lesson.conversation_id}`}
                          class="text-sm text-exact-blue hover:underline"
                        >
                          Bekijk gesprek →
                        </a>
                      )}
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    {lesson.created_pattern_id && (
                      <a
                        href={`/admin/support/patterns/${lesson.created_pattern_id}`}
                        class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs hover:bg-purple-200"
                        title="Bekijk aangemaakte pattern"
                      >
                        Pattern
                      </a>
                    )}
                    {lesson.created_article_id && (
                      <a
                        href={`/admin/support/articles/${lesson.created_article_id}`}
                        class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200"
                        title="Bekijk aangemaakte artikel"
                      >
                        Artikel
                      </a>
                    )}
                    {lesson.code_fix_pr && (
                      <a
                        href={lesson.code_fix_pr}
                        target="_blank"
                        class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs hover:bg-green-200"
                        title="Bekijk PR"
                      >
                        Code Fix
                      </a>
                    )}
                  </div>
                </div>

                <p class="text-gray-600 mb-4">{lesson.description}</p>

                <div class="grid grid-cols-3 gap-4 text-sm">
                  {lesson.root_cause && (
                    <div class="bg-red-50 rounded-lg p-3">
                      <h4 class="font-medium text-red-800 mb-1">Root Cause</h4>
                      <p class="text-red-700">{lesson.root_cause}</p>
                    </div>
                  )}
                  {lesson.solution && (
                    <div class="bg-green-50 rounded-lg p-3">
                      <h4 class="font-medium text-green-800 mb-1">Oplossing</h4>
                      <p class="text-green-700">{lesson.solution}</p>
                    </div>
                  )}
                  {lesson.prevention && (
                    <div class="bg-blue-50 rounded-lg p-3">
                      <h4 class="font-medium text-blue-800 mb-1">Preventie</h4>
                      <p class="text-blue-700">{lesson.prevention}</p>
                    </div>
                  )}
                </div>

                {lesson.tags && (
                  <div class="mt-4 pt-4 border-t border-gray-100">
                    <div class="flex flex-wrap gap-1">
                      {lesson.tags.split(',').map(tag => (
                        <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">
                          {tag.trim()}
                        </span>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        )}

        <!-- Stats -->
        <div class="mt-6 grid grid-cols-4 gap-4">
          <div class="bg-white rounded-lg border border-gray-100 p-4 text-center">
            <div class="text-2xl font-bold text-gray-900">{lessons.length}</div>
            <div class="text-sm text-gray-600">Totaal lessons</div>
          </div>
          <div class="bg-purple-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-purple-900">
              {lessons.filter(l => l.created_pattern_id).length}
            </div>
            <div class="text-sm text-purple-700">Patterns gemaakt</div>
          </div>
          <div class="bg-blue-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-blue-900">
              {lessons.filter(l => l.created_article_id).length}
            </div>
            <div class="text-sm text-blue-700">Artikelen gemaakt</div>
          </div>
          <div class="bg-green-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-900">
              {lessons.filter(l => l.code_fix_pr).length}
            </div>
            <div class="text-sm text-green-700">Code fixes</div>
          </div>
        </div>
      </>
    )}
  </div>
</Layout>
