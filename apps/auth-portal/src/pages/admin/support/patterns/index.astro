---
import Layout from '../../../../layouts/Layout.astro';
import { Database, type SupportPattern } from '../../../../lib/database';
// AdminAppLauncher now in Layout.astro header

const env = Astro.locals.runtime?.env;
let db: Database | null = null;
let isAdmin = false;
let patterns: SupportPattern[] = [];
let error: string | null = null;

const categoryFilter = Astro.url.searchParams.get('category') || '';
const activeFilter = Astro.url.searchParams.get('active') || '';

try {
  if (env?.DB) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());

        if (isAdmin) {
          patterns = await db.getAllPatterns();

          // Apply filters
          if (categoryFilter) {
            patterns = patterns.filter(p => p.category === categoryFilter);
          }
          if (activeFilter === 'true') {
            patterns = patterns.filter(p => p.active);
          } else if (activeFilter === 'false') {
            patterns = patterns.filter(p => !p.active);
          }
        }
      }
    }
  }
} catch (e) {
  console.error('Admin patterns error:', e);
  error = 'Er is een fout opgetreden';
}

const categoryLabels: Record<string, string> = {
  connection: 'Verbinding',
  billing: 'Facturatie',
  bug: 'Technisch',
  feature: 'Features',
  account: 'Account',
  other: 'Overig',
};

function calculateEffectiveness(pattern: SupportPattern): number {
  const total = pattern.times_triggered;
  if (total === 0) return 0;
  return Math.round((pattern.times_resolved / total) * 100);
}
---

<Layout title="AI Patterns Beheer">
  <div class="max-w-7xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          ← Terug naar Dashboard
        </a>
      </div>
    ) : (
      <>
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">AI Response Patterns</h1>
            <p class="text-gray-600">Beheer automatische AI responses</p>
          </div>
          <div class="flex items-center gap-3">
            <a href="/admin/support" class="text-gray-600 hover:text-gray-900">
              ← Terug
            </a>
            <a
              href="/admin/support/patterns/new"
              class="px-4 py-2 bg-exact-blue text-white font-medium rounded-lg hover:bg-exact-dark transition-colors"
            >
              + Nieuw pattern
            </a>
          </div>
        </div>

        {error && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-700">{error}</p>
          </div>
        )}

        <!-- Info Box -->
        <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 mb-6">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-purple-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
              <h3 class="font-medium text-purple-900">Hoe werken patterns?</h3>
              <p class="text-sm text-purple-700 mt-1">
                Patterns worden gebruikt door de AI om automatisch te reageren op veelvoorkomende vragen.
                De AI zoekt naar keywords in berichten en reageert met het bijbehorende template als de confidence hoog genoeg is.
              </p>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
          <form method="GET" class="flex flex-wrap items-center gap-4">
            <div>
              <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Categorie</label>
              <select
                name="category"
                id="category"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              >
                <option value="">Alle categorieën</option>
                <option value="connection" selected={categoryFilter === 'connection'}>Verbinding</option>
                <option value="billing" selected={categoryFilter === 'billing'}>Facturatie</option>
                <option value="bug" selected={categoryFilter === 'bug'}>Technisch</option>
                <option value="feature" selected={categoryFilter === 'feature'}>Features</option>
                <option value="account" selected={categoryFilter === 'account'}>Account</option>
                <option value="other" selected={categoryFilter === 'other'}>Overig</option>
              </select>
            </div>

            <div>
              <label for="active" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select
                name="active"
                id="active"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent"
              >
                <option value="">Alle</option>
                <option value="true" selected={activeFilter === 'true'}>Actief</option>
                <option value="false" selected={activeFilter === 'false'}>Inactief</option>
              </select>
            </div>

            <div class="flex items-end gap-2">
              <button
                type="submit"
                class="px-4 py-2 bg-exact-blue text-white font-medium rounded-lg hover:bg-exact-dark transition-colors"
              >
                Filter
              </button>
              {(categoryFilter || activeFilter) && (
                <a
                  href="/admin/support/patterns"
                  class="px-4 py-2 text-gray-600 hover:text-gray-900"
                >
                  Reset
                </a>
              )}
            </div>
          </form>
        </div>

        <!-- Patterns Grid -->
        {patterns.length === 0 ? (
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center">
            <p class="text-gray-500 mb-4">Geen patterns gevonden</p>
            <a
              href="/admin/support/patterns/new"
              class="text-exact-blue hover:underline"
            >
              Maak je eerste pattern
            </a>
          </div>
        ) : (
          <div class="space-y-4">
            {patterns.map((pattern) => (
              <div class={`bg-white rounded-xl shadow-sm border ${pattern.active ? 'border-gray-100' : 'border-gray-200 bg-gray-50'} p-6`}>
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <div class="flex items-center gap-3">
                      <h3 class="text-lg font-semibold text-gray-900">{pattern.name}</h3>
                      {pattern.active ? (
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                          Actief
                        </span>
                      ) : (
                        <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">
                          Inactief
                        </span>
                      )}
                      <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                        {categoryLabels[pattern.category] || pattern.category}
                      </span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1 font-mono">ID: {pattern.id.substring(0, 8)}</p>
                  </div>
                  <a
                    href={`/admin/support/patterns/${pattern.id}`}
                    class="text-exact-blue hover:text-exact-dark font-medium"
                  >
                    Bewerken →
                  </a>
                </div>

                <div class="grid grid-cols-2 gap-6">
                  <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Trigger Keywords</h4>
                    <div class="flex flex-wrap gap-1">
                      {pattern.trigger_keywords.split(',').map(keyword => (
                        <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">
                          {keyword.trim()}
                        </span>
                      ))}
                    </div>
                    {pattern.error_codes && (
                      <div class="mt-2">
                        <span class="text-xs text-gray-500">Error codes: </span>
                        <span class="text-xs font-mono text-gray-600">{pattern.error_codes}</span>
                      </div>
                    )}
                  </div>

                  <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Response Preview</h4>
                    <p class="text-sm text-gray-600 line-clamp-3">{pattern.response_template_nl}</p>
                  </div>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-100 flex items-center gap-6 text-sm">
                  <div>
                    <span class="text-gray-500">Triggers:</span>
                    <span class="font-medium text-gray-900 ml-1">{pattern.times_triggered}</span>
                  </div>
                  <div>
                    <span class="text-gray-500">Opgelost:</span>
                    <span class="font-medium text-green-600 ml-1">{pattern.times_resolved}</span>
                  </div>
                  <div>
                    <span class="text-gray-500">Escalaties:</span>
                    <span class="font-medium text-orange-600 ml-1">{pattern.times_escalated}</span>
                  </div>
                  <div>
                    <span class="text-gray-500">Effectiviteit:</span>
                    <span class={`font-medium ml-1 ${
                      calculateEffectiveness(pattern) >= 70 ? 'text-green-600' :
                      calculateEffectiveness(pattern) >= 40 ? 'text-yellow-600' :
                      'text-red-600'
                    }`}>
                      {calculateEffectiveness(pattern)}%
                    </span>
                  </div>
                  <div>
                    <span class="text-gray-500">Min. confidence:</span>
                    <span class="font-medium text-gray-900 ml-1">{Math.round(pattern.min_confidence * 100)}%</span>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}

        <!-- Stats -->
        <div class="mt-6 grid grid-cols-4 gap-4">
          <div class="bg-white rounded-lg border border-gray-100 p-4 text-center">
            <div class="text-2xl font-bold text-gray-900">{patterns.length}</div>
            <div class="text-sm text-gray-600">Totaal</div>
          </div>
          <div class="bg-green-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-900">
              {patterns.filter(p => p.active).length}
            </div>
            <div class="text-sm text-green-700">Actief</div>
          </div>
          <div class="bg-purple-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-purple-900">
              {patterns.reduce((sum, p) => sum + p.times_triggered, 0)}
            </div>
            <div class="text-sm text-purple-700">Totaal triggers</div>
          </div>
          <div class="bg-blue-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-blue-900">
              {patterns.reduce((sum, p) => sum + p.times_triggered, 0) > 0
                ? Math.round((patterns.reduce((sum, p) => sum + p.times_resolved, 0) / patterns.reduce((sum, p) => sum + p.times_triggered, 0)) * 100)
                : 0}%
            </div>
            <div class="text-sm text-blue-700">Gem. effectiviteit</div>
          </div>
        </div>
      </>
    )}
  </div>
</Layout>
