---
import Layout from '../../../../layouts/Layout.astro';
import { Database } from '../../../../lib/database';
// AdminAppLauncher now in Layout.astro header

const env = Astro.locals.runtime?.env;
let db: Database | null = null;
let isAdmin = false;
let success: string | null = null;
let error: string | null = null;
let redirectTo: string | null = null;

try {
  if (env?.DB) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());

        if (isAdmin && Astro.request.method === 'POST') {
          const formData = await Astro.request.formData();

          const name = formData.get('name')?.toString() || '';
          const trigger_keywords = formData.get('trigger_keywords')?.toString() || '';
          const trigger_regex = formData.get('trigger_regex')?.toString() || '';
          const error_codes = formData.get('error_codes')?.toString() || '';
          const category = formData.get('category')?.toString() || 'other';
          const response_template_nl = formData.get('response_template_nl')?.toString() || '';
          const response_template_en = formData.get('response_template_en')?.toString() || '';
          const solution_steps = formData.get('solution_steps')?.toString() || '';
          const related_articles = formData.get('related_articles')?.toString() || '';
          const min_confidence = parseFloat(formData.get('min_confidence')?.toString() || '0.7');
          const active = formData.get('active') === 'on';

          if (!name || !trigger_keywords || !response_template_nl) {
            error = 'Naam, trigger keywords en response template (NL) zijn verplicht';
          } else {
            // Convert comma-separated strings to arrays
            const keywordsArray = trigger_keywords.split(',').map(k => k.trim()).filter(k => k);
            const errorCodesArray = error_codes ? error_codes.split(',').map(c => c.trim()).filter(c => c) : undefined;
            const stepsArray = solution_steps ? solution_steps.split('\n').map(s => s.trim()).filter(s => s) : undefined;
            const articlesArray = related_articles ? related_articles.split(',').map(a => a.trim()).filter(a => a) : undefined;

            const pattern = await db.createPattern({
              name,
              trigger_keywords: keywordsArray,
              trigger_regex: trigger_regex || undefined,
              error_codes: errorCodesArray,
              category,
              response_template_nl,
              response_template_en: response_template_en || undefined,
              solution_steps: stepsArray,
              related_articles: articlesArray,
              min_confidence,
              active,
            });

            if (pattern) {
              redirectTo = `/admin/support/patterns/${pattern.id}`;
            } else {
              error = 'Kon pattern niet aanmaken';
            }
          }
        }
      }
    }
  }
} catch (e) {
  console.error('Admin new pattern error:', e);
  error = 'Er is een fout opgetreden';
}

if (redirectTo) {
  return Astro.redirect(redirectTo);
}

const categoryOptions = [
  { value: 'connection', label: 'Verbinding' },
  { value: 'billing', label: 'Facturatie' },
  { value: 'bug', label: 'Technisch' },
  { value: 'feature', label: 'Features' },
  { value: 'account', label: 'Account' },
  { value: 'other', label: 'Overig' },
];
---

<Layout title="Nieuw Pattern">
  <div class="max-w-4xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          ← Terug naar Dashboard
        </a>
      </div>
    ) : (
      <>
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Nieuw AI Pattern</h1>
            <p class="text-gray-600">Voeg een nieuw automatisch response pattern toe</p>
          </div>
          <div class="flex items-center gap-3">
            <a href="/admin/support/patterns" class="text-gray-600 hover:text-gray-900">
              ← Terug naar overzicht
            </a>
          </div>
        </div>

        {error && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-700">{error}</p>
          </div>
        )}

        <form method="POST" class="space-y-6">
          <!-- Basic Info -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Basis Informatie</h2>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                  Naam <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  name="name"
                  id="name"
                  required
                  placeholder="bijv. Connection Failed"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                />
              </div>

              <div>
                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">
                  Categorie <span class="text-red-500">*</span>
                </label>
                <select
                  name="category"
                  id="category"
                  required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                >
                  {categoryOptions.map(opt => (
                    <option value={opt.value}>{opt.label}</option>
                  ))}
                </select>
              </div>
            </div>
          </div>

          <!-- Trigger Settings -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Trigger Instellingen</h2>
            <p class="text-sm text-gray-500 mb-4">
              De AI zoekt naar deze keywords en patterns in gebruikersberichten.
            </p>

            <div class="space-y-4">
              <div>
                <label for="trigger_keywords" class="block text-sm font-medium text-gray-700 mb-1">
                  Trigger Keywords <span class="text-red-500">*</span>
                </label>
                <textarea
                  name="trigger_keywords"
                  id="trigger_keywords"
                  rows="2"
                  required
                  placeholder="connectie,verbinding,connection,failed,mislukt"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                ></textarea>
                <p class="text-xs text-gray-500 mt-1">Gescheiden door komma's. De AI zoekt naar deze woorden.</p>
              </div>

              <div>
                <label for="trigger_regex" class="block text-sm font-medium text-gray-700 mb-1">
                  Trigger Regex (Optioneel)
                </label>
                <input
                  type="text"
                  name="trigger_regex"
                  id="trigger_regex"
                  placeholder="(connection|verbinding).*(failed|mislukt)"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none font-mono text-sm"
                />
                <p class="text-xs text-gray-500 mt-1">Geavanceerde pattern matching met regex</p>
              </div>

              <div>
                <label for="error_codes" class="block text-sm font-medium text-gray-700 mb-1">
                  Error Codes (Optioneel)
                </label>
                <input
                  type="text"
                  name="error_codes"
                  id="error_codes"
                  placeholder="AUTH001,AUTH002,CONN_FAILED"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none font-mono text-sm"
                />
                <p class="text-xs text-gray-500 mt-1">Specifieke error codes die dit pattern triggeren</p>
              </div>

              <div>
                <label for="min_confidence" class="block text-sm font-medium text-gray-700 mb-1">
                  Minimum Confidence
                </label>
                <div class="flex items-center gap-4">
                  <input
                    type="range"
                    name="min_confidence"
                    id="min_confidence"
                    min="0.5"
                    max="1"
                    step="0.05"
                    value="0.7"
                    class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                  />
                  <span id="confidenceValue" class="text-lg font-medium text-gray-900 w-16 text-right">70%</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Minimum confidence score om dit pattern te gebruiken</p>
              </div>
            </div>
          </div>

          <!-- Response Template -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Response Template</h2>

            <div class="space-y-4">
              <div>
                <label for="response_template_nl" class="block text-sm font-medium text-gray-700 mb-1">
                  Response (NL) <span class="text-red-500">*</span>
                </label>
                <textarea
                  name="response_template_nl"
                  id="response_template_nl"
                  rows="6"
                  required
                  placeholder="Hallo! Ik zie dat je een probleem hebt met de verbinding.

Probeer de volgende stappen:
1. Controleer je internet verbinding
2. Log opnieuw in via Exact Online
3. Vernieuw je API key

Laat me weten of dit helpt!"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                ></textarea>
                <p class="text-xs text-gray-500 mt-1">Variabelen: {"{user_name}"}, {"{error_code}"}, {"{article_link}"}</p>
              </div>

              <div>
                <label for="response_template_en" class="block text-sm font-medium text-gray-700 mb-1">
                  Response (EN) (Optioneel)
                </label>
                <textarea
                  name="response_template_en"
                  id="response_template_en"
                  rows="6"
                  placeholder="English version of the response..."
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                ></textarea>
              </div>
            </div>
          </div>

          <!-- Solution Info -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Aanvullende Informatie</h2>

            <div class="space-y-4">
              <div>
                <label for="solution_steps" class="block text-sm font-medium text-gray-700 mb-1">
                  Oplossings Stappen (JSON)
                </label>
                <textarea
                  name="solution_steps"
                  id="solution_steps"
                  rows="4"
                  placeholder='["Stap 1: Controleer...", "Stap 2: Ga naar...", "Stap 3: Klik op..."]'
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none font-mono text-sm"
                ></textarea>
              </div>

              <div>
                <label for="related_articles" class="block text-sm font-medium text-gray-700 mb-1">
                  Gerelateerde Artikel Slugs
                </label>
                <input
                  type="text"
                  name="related_articles"
                  id="related_articles"
                  placeholder="getting-started,connection-troubleshooting"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                />
                <p class="text-xs text-gray-500 mt-1">Artikel slugs gescheiden door komma's</p>
              </div>
            </div>
          </div>

          <!-- Options -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Status</h2>

            <label class="flex items-center gap-3">
              <input
                type="checkbox"
                name="active"
                checked
                class="w-5 h-5 text-green-500 border-gray-300 rounded focus:ring-green-500"
              />
              <div>
                <span class="font-medium text-gray-900">Actief</span>
                <p class="text-sm text-gray-500">Pattern wordt gebruikt door de AI</p>
              </div>
            </label>
          </div>

          <!-- Submit -->
          <div class="flex justify-end gap-4">
            <a
              href="/admin/support/patterns"
              class="px-6 py-3 text-gray-600 font-medium hover:text-gray-900"
            >
              Annuleren
            </a>
            <button
              type="submit"
              class="px-6 py-3 bg-exact-blue text-white font-semibold rounded-lg hover:bg-exact-dark transition-colors"
            >
              Pattern aanmaken
            </button>
          </div>
        </form>
      </>
    )}
  </div>

  <script>
    const slider = document.getElementById('min_confidence') as HTMLInputElement;
    const display = document.getElementById('confidenceValue');

    slider?.addEventListener('input', () => {
      if (display) {
        display.textContent = `${Math.round(parseFloat(slider.value) * 100)}%`;
      }
    });
  </script>
</Layout>
