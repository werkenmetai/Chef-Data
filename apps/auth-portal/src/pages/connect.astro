---
import Layout from '../layouts/Layout.astro';
import {
  buildAuthorizationUrl,
  generateState,
  encodeState,
  generateCodeVerifier,
  generateCodeChallenge,
  type ExactRegion
} from '../lib/exact-auth';

// Get environment variables
const env = Astro.locals.runtime.env;

// Validate required environment variables
const clientId = env.EXACT_CLIENT_ID;
const redirectUri = env.EXACT_REDIRECT_URI;

if (!clientId || !redirectUri) {
  console.error('Missing required environment variables:', {
    hasClientId: !!clientId,
    hasRedirectUri: !!redirectUri,
  });
}

// Show error state for configuration issues
const isConfigured = Boolean(clientId && redirectUri);

// Get OAuth return URL if present (for MCP OAuth flow)
const pageUrl = new URL(Astro.request.url);
const oauthReturn = pageUrl.searchParams.get('oauth_return');

// AUTH-002: Check for session expired redirect
const reason = pageUrl.searchParams.get('reason');
const sessionExpired = reason === 'session_expired';

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const region = (formData.get('region') as ExactRegion) || 'NL';
  const oauthReturnUrl = formData.get('oauth_return') as string | null;

  // Generate PKCE code verifier and challenge
  const codeVerifier = generateCodeVerifier();
  const codeChallenge = await generateCodeChallenge(codeVerifier);

  // Determine return URL (OAuth flow or normal dashboard)
  const returnUrl = oauthReturnUrl || '/dashboard';

  // Generate secure state with nonce and HMAC signature
  const nonce = generateState();
  const state = await encodeState({
    region,
    nonce,
    returnUrl,
  }, env.SESSION_SECRET);

  // Store nonce in cookie for verification (httpOnly, secure)
  Astro.cookies.set('oauth_nonce', nonce, {
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 600, // 10 minutes
    path: '/',
  });

  // Store PKCE code verifier in separate cookie (httpOnly, secure)
  Astro.cookies.set('oauth_code_verifier', codeVerifier, {
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 600, // 10 minutes
    path: '/',
  });

  // Check environment variables before redirect
  if (!clientId || !redirectUri) {
    return new Response('OAuth not configured. Please contact support.', { status: 500 });
  }

  // Redirect to Exact Online with PKCE
  const authUrl = await buildAuthorizationUrl(
    clientId,
    redirectUri,
    state,
    region,
    codeChallenge
  );

  return Astro.redirect(authUrl);
}

const regions = [
  { code: 'NL', name: 'Nederland' },
  { code: 'BE', name: 'België' },
  { code: 'DE', name: 'Duitsland' },
  { code: 'UK', name: 'Verenigd Koninkrijk' },
  { code: 'FR', name: 'Frankrijk' },
  { code: 'ES', name: 'Spanje' },
  { code: 'US', name: 'Verenigde Staten' },
];
---

<Layout title="Verbinden met Exact Online">
  <div class="max-w-lg mx-auto px-4 py-16">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8">
      <h1 class="text-2xl font-bold text-gray-900 text-center mb-2">
        Verbind je Exact Online
      </h1>
      <p class="text-gray-600 text-center mb-8">
        Kies je regio en log in met je Exact Online account.
      </p>

      {/* AUTH-002: Session expired message */}
      {sessionExpired && (
        <div class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
          <div class="flex items-center">
            <svg class="w-5 h-5 text-amber-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="text-amber-700 text-sm">
              Je sessie is verlopen. Log opnieuw in om door te gaan.
            </p>
          </div>
        </div>
      )}

      {!isConfigured && (
        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-red-700 text-sm">
            Er is een configuratieprobleem. Neem contact met ons op.
          </p>
        </div>
      )}

      <form method="POST" class="space-y-6">
        {oauthReturn && (
          <input type="hidden" name="oauth_return" value={oauthReturn} />
        )}
        <div>
          <label for="region" class="block text-sm font-medium text-gray-700 mb-2">
            In welk land gebruik je Exact Online?
          </label>
          <select
            id="region"
            name="region"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-exact-blue"
          >
            {regions.map((region) => (
              <option value={region.code} selected={region.code === 'NL'}>
                {region.name}
              </option>
            ))}
          </select>
        </div>

        <button
          type="submit"
          disabled={!isConfigured}
          class={`w-full px-6 py-3 font-semibold rounded-lg transition-colors ${
            isConfigured
              ? 'bg-exact-blue text-white hover:bg-exact-dark'
              : 'bg-gray-300 text-gray-500 cursor-not-allowed'
          }`}
        >
          Doorgaan naar Exact Online
        </button>
      </form>

      <div class="mt-8 pt-6 border-t border-gray-100">
        <h3 class="text-sm font-medium text-gray-900 mb-3">Dit gebeurt er</h3>
        <ul class="text-sm text-gray-600 space-y-2">
          <li class="flex items-start">
            <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Je logt in bij Exact Online (wij zien je wachtwoord niet)
          </li>
          <li class="flex items-start">
            <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Je geeft toestemming om je administratie te lezen
          </li>
          <li class="flex items-start">
            <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Je krijgt direct een sleutel om te gebruiken met je AI-assistent
          </li>
        </ul>
      </div>

      <!-- AI Provider Privacy Disclaimer -->
      <div class="mt-6 bg-amber-50 border border-amber-200 rounded-lg p-4">
        <div class="flex items-start">
          <svg class="w-5 h-5 text-amber-600 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <h4 class="font-medium text-amber-900 text-sm">Even over je AI-provider</h4>
            <p class="text-amber-800 text-sm mt-1">
              Je boekhouddata gaat naar de AI-assistent die jij kiest – ChatGPT, Claude, Copilot of een andere tool.
              Wij slaan je boekhouddata niet op, maar jij bepaalt welke AI-provider je data ontvangt.
            </p>
            <p class="text-amber-800 text-sm mt-2">
              <strong>Onze tip:</strong> Gebruik een zakelijk AI-abonnement. Die bieden betere privacy-garanties voor jouw klantdata.
            </p>
            <a href="/docs/ai-privacy" class="text-amber-900 text-sm font-medium hover:underline mt-2 inline-block">
              Bekijk privacy tips per AI-provider →
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>
