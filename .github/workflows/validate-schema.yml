name: DB Schema Validation

# DB-002: Schema Validation Pre-Deploy Check
# Validates that D1 database schema matches expected schema from migrations

on:
  # Run before production deployments
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (production, preview)'
        required: false
        default: 'production'
        type: string
    secrets:
      CLOUDFLARE_API_TOKEN:
        required: true
      CLOUDFLARE_ACCOUNT_ID:
        required: true

  # Manual trigger for on-demand validation
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview
      dry_run:
        description: 'Only analyze migrations (no database check)'
        required: false
        default: false
        type: boolean

  # Run on changes to migrations
  pull_request:
    paths:
      - 'apps/auth-portal/migrations/**'
      - 'scripts/validate-schema.ts'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    name: Validate Database Schema
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      # Dry-run mode: only validate migrations parse correctly
      - name: Validate migrations (dry-run)
        if: ${{ inputs.dry_run == true || github.event_name == 'pull_request' }}
        run: |
          echo "=== Migration Analysis (Dry Run) ==="
          npx tsx scripts/validate-schema.ts --dry-run --verbose

      # Full validation against D1 database
      - name: Validate schema against D1
        if: ${{ inputs.dry_run != true && github.event_name != 'pull_request' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "=== Full Schema Validation ==="
          ENV="${{ inputs.environment || 'production' }}"
          npx tsx scripts/validate-schema.ts --env "$ENV" --verbose

      # Output as JSON for artifact storage
      - name: Generate validation report
        if: always()
        run: |
          npx tsx scripts/validate-schema.ts --dry-run --json > validation-report.json
          cat validation-report.json

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-validation-report
          path: validation-report.json
          retention-days: 30

      # Fail the workflow if schema is out of sync
      - name: Check validation result
        if: ${{ inputs.dry_run != true && github.event_name != 'pull_request' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          ENV="${{ inputs.environment || 'production' }}"
          if ! npx tsx scripts/validate-schema.ts --env "$ENV" --json | jq -e '.validation.success == true' > /dev/null 2>&1; then
            echo "::error::Schema validation failed! Database is out of sync with migrations."
            echo "::error::Run pending migrations before deploying."
            exit 1
          fi
          echo "Schema validation passed!"

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: validate-schema
    if: failure()
    steps:
      - name: Schema validation failed notification
        run: |
          echo "::warning::DB-002: Schema validation failed!"
          echo "The database schema is out of sync with migrations."
          echo ""
          echo "Required actions:"
          echo "1. Check which migrations are pending"
          echo "2. Apply migrations to the target environment"
          echo "3. Re-run this workflow"
          echo ""
          echo "To apply migrations manually:"
          echo "  wrangler d1 execute exact-mcp-db --env ${{ inputs.environment || 'production' }} --file=<migration-file>"
