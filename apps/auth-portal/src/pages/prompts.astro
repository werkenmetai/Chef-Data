---
import Layout from '../layouts/Layout.astro';
import { Database, type User } from '../lib/database';

// Authentication check - only logged-in users can access
const env = Astro.locals.runtime?.env;
const sessionId = Astro.cookies.get('session_id')?.value;
let isAuthenticated = false;
let user: User | null = null;

if (env?.DB && sessionId) {
  try {
    const db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);
    const sessionResult = await db.validateSession(sessionId);

    if (sessionResult) {
      isAuthenticated = true;
      user = sessionResult.user;
    }
  } catch (e) {
    console.error('Prompts auth error:', e);
  }
}

// Redirect unauthenticated users
if (!isAuthenticated) {
  return Astro.redirect('/connect?redirect=/prompts');
}

const categories = [
  {
    id: 'cfo-dashboard',
    title: 'CFO Dashboard & Stuurinformatie',
    icon: 'üëë',
    description: 'Strategische rapportages en forecasts voor directie en management.',
    prompts: [
      {
        id: 'directie-rapportage',
        title: 'Maandelijkse Directie Rapportage',
        prompt: `Maak een complete directie rapportage met de volgende onderdelen:

1. FINANCIEEL OVERZICHT
   - Winst-en-verliesrekening deze maand vs vorige maand vs budget
   - Afwijkingsanalyse: verklaar alle afwijkingen > 10%

2. BALANSRATIO'S
   - Current ratio (vlottende activa / kortlopende schulden)
   - Quick ratio ((vlottende activa - voorraad) / kortlopende schulden)
   - Solvabiliteit (eigen vermogen / totaal vermogen)

3. CASHFLOW INDICATOREN
   - Operationele cashflow deze maand
   - Werkkapitaal mutatie

4. TOP 5 RISICO'S EN KANSEN
   - Identificeer op basis van de cijfers

Gebruik chain-of-thought analyse: leg bij elke conclusie uit HOE je tot die conclusie komt.
Formatteer als executive summary met JSON voor dashboard metrics + markdown narrative.`,
        output: 'JSON + Markdown',
        level: 'CFO'
      },
      {
        id: 'rolling-forecast',
        title: 'Rolling Forecast 12 Maanden',
        prompt: `Analyseer de historische data van de afgelopen 24 maanden en cre√´er een rolling forecast:

ANALYSE:
1. Identificeer seizoenspatronen per maand (index t.o.v. gemiddelde)
2. Bereken de onderliggende groeitrend (CAGR)
3. Identificeer outliers en corrigeer hiervoor

FORECAST:
- Projecteer omzet voor de komende 12 maanden
- Pas seizoenscorrectie toe
- Geef confidence interval (pessimistisch / basis / optimistisch scenario)

OUTPUT:
Formatteer als Excel-compatibele CSV met kolommen:
Maand | Historisch | Forecast_Pessimistisch | Forecast_Basis | Forecast_Optimistisch | Seizoensindex`,
        output: 'CSV + Forecast',
        level: 'Controller'
      },
      {
        id: 'breakeven-analyse',
        title: 'Break-even Analyse',
        prompt: `Voer een complete break-even analyse uit:

STAP 1: KOSTENCATEGORISATIE
- Analyseer alle grootboekrekeningen
- Categoriseer in: VAST (onafhankelijk van omzet) vs VARIABEL (afhankelijk van omzet)
- Bereken vaste kosten per maand
- Bereken variabele kosten als % van omzet

STAP 2: CONTRIBUTION MARGIN
- Contribution margin = Omzet - Variabele kosten
- Contribution margin ratio = CM / Omzet

STAP 3: BREAK-EVEN BEREKENING
- Break-even omzet = Vaste kosten / CM ratio
- Break-even in eenheden (indien relevant)

STAP 4: GEVOELIGHEIDSANALYSE
- Wat als vaste kosten +10%?
- Wat als variabele kosten +5%?

Formatteer als financieel analyserapport met berekeningen.`,
        output: 'Analyse Rapport',
        level: 'Controller'
      },
      {
        id: 'liquiditeitsprognose',
        title: 'Liquiditeitsprognose 90 Dagen',
        prompt: `Cre√´er een gedetailleerde liquiditeitsprognose voor de komende 90 dagen:

ONTVANGSTEN PROJECTIE:
1. Openstaande debiteuren - verwachte inning per week
   - Analyseer historisch betaalgedrag per klant
   - Pas verwachte inningspercentage toe per ouderdomscategorie
2. Verwachte nieuwe omzet (op basis van trend)

UITGAVEN PROJECTIE:
1. Openstaande crediteuren - geplande betaling per vervaldatum
2. Salariskosten (vast, per maand)
3. Huur en vaste lasten
4. Verwachte variabele kosten

CASHFLOW MODEL:
Week | Begin Saldo | Ontvangsten | Uitgaven | Eind Saldo | Cumulatief

Markeer weken met potentieel liquiditeitstekort in het rood.
Output als JSON voor dashboard weergave.`,
        output: 'JSON Dashboard',
        level: 'Treasury'
      }
    ]
  },
  {
    id: 'credit-control',
    title: 'Credit Control & Debiteurenbeheer',
    icon: 'üõ°Ô∏è',
    description: 'Professioneel debiteurenbeheer en credit risk management.',
    prompts: [
      {
        id: 'credit-risk-assessment',
        title: 'Credit Risk Assessment per Klant',
        prompt: `Voer een complete credit risk assessment uit voor [KLANTNAAM]:

1. KLANT 360¬∞ ANALYSE
   - Totale omzet lifetime
   - Omzet laatste 12 maanden vs vorig jaar
   - Gemiddelde ordergrootte

2. BETAALGEDRAG ANALYSE
   - Gemiddelde betaaltermijn (gewogen naar bedrag)
   - Aantal keren te laat betaald
   - Langste betalingsachterstand ooit
   - Trend: verbetert of verslechtert betaalgedrag?

3. OPENSTAANDE POSITIE
   - Totaal openstaand
   - Ouderdomsverdeling
   - % van jaaromzet

4. CREDIT SCORE BEREKENING (1-10)
   Weging:
   - Betaalgedrag historisch: 40%
   - Huidige exposure: 30%
   - Omzettrend: 20%
   - Relatie-duur: 10%

5. CREDIT LIMIT ADVIES
   - Huidige impliciete limiet
   - Geadviseerde limiet op basis van score

Output als structured JSON met alle metrics en eindscore.`,
        output: 'JSON Risk Profile',
        level: 'Credit Manager'
      },
      {
        id: 'collection-matrix',
        title: 'Collection Strategy Matrix',
        prompt: `Cre√´er een actionable collection strategy matrix:

STAP 1: SEGMENTATIE
Segmenteer alle openstaande facturen in:
- Segment A: <30 dagen, grote klanten (>‚Ç¨10k/jaar)
- Segment B: <30 dagen, kleine klanten
- Segment C: 30-60 dagen
- Segment D: 60-90 dagen
- Segment E: >90 dagen

STAP 2: STRATEGIE PER SEGMENT
Segment A: Vriendelijke herinnering, relatiebehoud prioriteit
Segment B: Geautomatiseerde herinnering
Segment C: Telefonisch contact, betaalregeling aanbieden
Segment D: Formele aanmaning, betalingsregeling
Segment E: Incasso overwegen, juridische stappen

STAP 3: ACTIE LIJST
Per factuur: Klantnaam | Email | Telefoon | Factuurnr | Bedrag | Dagen | Segment | Actie | Prioriteit

Sorteer op prioriteit (hoogste eerst).
Formatteer als CSV voor import in CRM/takenlijst.`,
        output: 'CSV Actielijst',
        level: 'Credit Manager'
      },
      {
        id: 'dso-analyse',
        title: 'DSO Trend & Benchmark Analyse',
        prompt: `Analyseer Days Sales Outstanding (DSO) in detail:

1. DSO BEREKENING
   - DSO = (Gemiddeld debiteurensaldo / Omzet) √ó Aantal dagen
   - Bereken per maand voor afgelopen 12 maanden

2. TREND ANALYSE
   - Is DSO aan het stijgen of dalen?
   - Bereken trendlijn (lineaire regressie)
   - Projecteer DSO over 6 maanden als trend doorzet

3. BENCHMARK VERGELIJKING
   - MKB Nederland gemiddelde: 45 dagen
   - Jouw sector benchmark: [schat in op basis van bedrijfstype]
   - Performance vs benchmark

4. TOP 10 DSO BEINVLOEDERS
   - Welke klanten dragen het meest bij aan hoge DSO?
   - Bereken DSO impact per klant: (openstaand klant / totaal openstaand) √ó DSO

5. VERBETERPOTENTIEEL
   - Als DSO daalt naar benchmark, hoeveel werkkapitaal komt vrij?

Output als trend data voor grafiek + insights in markdown.`,
        output: 'Chart Data + Insights',
        level: 'Controller'
      },
      {
        id: 'bad-debt-provision',
        title: 'Bad Debt Provision (IFRS 9)',
        prompt: `Bereken de voorziening voor dubieuze debiteuren volgens IFRS 9 Expected Credit Loss model:

STAP 1: OUDERDOMSMATRIX
Groepeer debiteuren per ouderdomscategorie:
- Niet vervallen
- 1-30 dagen vervallen
- 31-60 dagen vervallen
- 61-90 dagen vervallen
- >90 dagen vervallen

STAP 2: HISTORISCHE LOSS RATES
Analyseer historische afschrijvingen:
- Welk % per ouderdomscategorie wordt uiteindelijk oninbaar?
- Gebruik minimaal 3 jaar historie indien beschikbaar

STAP 3: ECL BEREKENING
Per categorie: Uitstaand bedrag √ó Loss rate = Expected Credit Loss

STAP 4: JOURNAALPOST
Debet: Kosten dubieuze debiteuren
Credit: Voorziening dubieuze debiteuren

Output als:
1. ECL berekening tabel
2. Journaalpost voor boekhouding
3. Toelichting voor jaarrekening`,
        output: 'Journal Entry + Rapport',
        level: 'Accountant'
      }
    ]
  },
  {
    id: 'controller-toolkit',
    title: 'Controller Toolkit & Kostenanalyse',
    icon: 'üßÆ',
    description: 'Management accounting analyses en variantieonderzoek.',
    prompts: [
      {
        id: 'variance-analysis',
        title: 'Variance Analysis (Budget vs Actual)',
        prompt: `Voer een complete variance analysis uit tussen budget en realisatie:

STAP 1: DATA VERZAMELING
- Haal actuele cijfers per grootboekcategorie
- Vergelijk met budget (indien beschikbaar, anders vorig jaar)

STAP 2: VARIANTIE BEREKENING
Per regel:
- Absoluut verschil = Actual - Budget
- Procentueel verschil = (Actual - Budget) / Budget √ó 100%
- Classificatie: Favorable (F) of Unfavorable (U)

STAP 3: MATERIALITY FILTER
Focus analyse op varianties > ‚Ç¨1.000 of > 10%

STAP 4: ROOT CAUSE ANALYSE
Per materi√´le variantie, analyseer mogelijke oorzaken:
- Volume effect (meer/minder verkocht)
- Prijs effect (hogere/lagere prijzen)
- Mix effect (andere productmix)
- Timing effect (vertraging/versnelling)

STAP 5: MANAGEMENT SAMENVATTING
Top 5 favorable varianties
Top 5 unfavorable varianties
Netto impact op resultaat

Formatteer als management rapport met tabellen.`,
        output: 'Management Rapport',
        level: 'Controller'
      },
      {
        id: 'kostenplaats-analyse',
        title: 'Kosten per Kostenplaats/Afdeling',
        prompt: `Analyseer kosten per kostenplaats of afdeling:

ANALYSE:
1. Totale kosten per kostenplaats
2. Uitsplitsing naar kostensoort (personeel, huisvesting, materiaal, etc.)
3. Vergelijking met vorige periode (maand/kwartaal/jaar)
4. Kosten per FTE indien personeelskosten dominant

IDENTIFICATIE:
- Welke kostenplaats heeft hoogste absolute kosten?
- Welke kostenplaats heeft hoogste groei?
- Outliers: kostenplaatsen met afwijkend patroon

BENCHMARK:
- Overhead ratio per kostenplaats: overhead / directe kosten
- Vergelijk ratio's tussen kostenplaatsen

OUTPUT:
Formatteer als pivot-achtige tabel:
Kostenplaats | Kostensoort | Vorige Periode | Deze Periode | Verschil | %

Exporteer als CSV voor verdere Excel analyse.`,
        output: 'Pivot CSV',
        level: 'Controller'
      },
      {
        id: 'marge-analyse',
        title: 'Productgroep Marge Analyse',
        prompt: `Bereken en analyseer de bruto marge per productgroep:

STAP 1: DATA AGGREGATIE
- Groepeer verkopen per productgroep/artikelcategorie
- Koppel inkoopkosten aan verkopen

STAP 2: MARGE BEREKENING
Per productgroep:
- Omzet
- Kostprijs verkopen
- Bruto marge = Omzet - Kostprijs
- Bruto marge % = Bruto marge / Omzet √ó 100

STAP 3: RANKING
Sorteer van hoogste naar laagste marge %

STAP 4: ANALYSE
- Identificeer productgroepen met marge < 20% (risico)
- Identificeer productgroepen met marge > 50% (kans)
- Welke productgroepen hebben dalende marge trend?

STAP 5: AANBEVELINGEN
- Welke productgroepen uitbreiden?
- Welke productgroepen herzien of afbouwen?

Output als JSON voor dashboard + ranking tabel.`,
        output: 'JSON + Ranking',
        level: 'Controller'
      },
      {
        id: 'overhead-analyse',
        title: 'Overhead Absorption Analyse',
        prompt: `Analyseer overhead absorption voor projectmatige bedrijven:

CONTEXT:
Bij projectmatige bedrijven worden overhead kosten doorbelast op basis van gewerkte uren.

STAP 1: OVERHEAD POOL
- Totale overhead kosten (indirecte kosten)
- Totale productieve uren (of andere verdeelsleutel)
- Overhead tarief = Overhead / Productieve uren

STAP 2: ABSORBED OVERHEAD
Per project:
- Gewerkte uren √ó Overhead tarief = Absorbed overhead

STAP 3: VARIANTIE ANALYSE
- Total absorbed overhead (som alle projecten)
- Actual overhead kosten
- Verschil = Under-absorption of Over-absorption

STAP 4: OORZAAK ANALYSE
Under-absorption kan komen door:
- Minder uren gemaakt dan begroot
- Overhead kosten hoger dan begroot
- Mix van beide

Formatteer als analyse rapport met berekeningen.`,
        output: 'Analyse Rapport',
        level: 'Controller'
      }
    ]
  },
  {
    id: 'audit-compliance',
    title: 'Audit & Compliance',
    icon: '‚úÖ',
    description: 'Controles en reconciliaties voor accountant en jaarrekening.',
    prompts: [
      {
        id: 'btw-reconciliatie',
        title: 'BTW Aangifte Reconciliatie',
        prompt: `Voer een complete BTW reconciliatie uit:

STAP 1: BTW OP VERKOPEN
- Totaal verkopen excl. BTW uit facturatie
- BTW berekend (21%, 9%, 0%, verlegd)
- Controleer: opgetelde BTW = BTW in aangifte?

STAP 2: BTW OP INKOPEN
- Totaal inkopen excl. BTW uit boekingen
- Voorbelasting geclaimd
- Controleer: voorbelasting = inkoopfacturen BTW?

STAP 3: INTRACOMMUNAUTAIRE TRANSACTIES
- Intracommunautaire leveringen (ICP)
- Intracommunautaire verwervingen (ICL)
- Check: zijn deze correct verlegd?

STAP 4: RECONCILIATIE
| Omschrijving | Boekhouding | BTW Aangifte | Verschil |
|--------------|-------------|--------------|----------|
| Omzet 21% | | | |
| Omzet 9% | | | |
| etc. | | | |

STAP 5: VERKLARING VERSCHILLEN
- Identificeer oorzaak van elk verschil
- Correcties voor volgende aangifte

Output als audit trail rapport.`,
        output: 'Audit Trail',
        level: 'Accountant'
      },
      {
        id: 'jaarrekening-prep',
        title: 'Jaarrekening Voorbereidingscheck',
        prompt: `Controleer of de administratie klaar is voor jaarrekening:

CHECKLIST:

1. AFSCHRIJVINGEN
   [ ] Zijn alle activa correct afgeschreven?
   [ ] Zijn er activa volledig afgeschreven maar nog in gebruik?

2. VOORZIENINGEN
   [ ] Voorziening dubieuze debiteuren actueel?
   [ ] Garantievoorzieningen nodig?
   [ ] Reorganisatievoorziening nodig?

3. OVERLOPENDE POSTEN
   [ ] Vooruitbetaalde kosten (bijv. verzekeringen)
   [ ] Nog te ontvangen bedragen
   [ ] Nog te betalen kosten
   [ ] Vooruit gefactureerde omzet

4. INTERCOMPANY (indien van toepassing)
   [ ] IC-rekeningen gesaldeerd?
   [ ] IC-verschillen verklaard?

5. AFSLUITING
   [ ] Alle bankrekeningen gereconcilieerd?
   [ ] Kas/kruisposten opgeschoond?
   [ ] Vraagposten uitgezocht?

Per item: status (OK / Actie nodig) + opmerking

Output als checklist voor de accountant.`,
        output: 'Checklist',
        level: 'Accountant'
      },
      {
        id: 'intercompany-recon',
        title: 'Intercompany Reconciliatie',
        prompt: `Reconcilieer intercompany saldi tussen administraties:

AANPAK:
1. Identificeer alle IC-relaties
2. Per IC-relatie:
   - Saldo volgens administratie A (vordering/schuld)
   - Saldo volgens administratie B (schuld/vordering)
   - Verschil

RECONCILIATIE TABEL:
| IC Partner | Onze Vordering | Onze Schuld | Partner Vordering | Partner Schuld | Verschil |

VERSCHIL ANALYSE:
- Timing verschillen (transactie in transit)
- Pricing verschillen
- Omissies (niet geboekt)
- Fouten

ACTIE PUNTEN:
Per verschil: correctie nodig bij wie?

Output als reconciliatie overzicht.`,
        output: 'Reconciliatie Tabel',
        level: 'Accountant'
      },
      {
        id: 'materialiteit-check',
        title: 'Materialiteit & Steekproef Bepaling',
        prompt: `Bepaal materialiteit en steekproefomvang:

STAP 1: MATERIALITEIT BEREKENING
Kies benchmark:
- 5% van resultaat voor belastingen, OF
- 0.5% - 1% van omzet, OF
- 1% - 2% van balanstotaal

Bereken alle drie en kies de meest passende.

STAP 2: PERFORMANCE MATERIALITEIT
Performance materialiteit = 50-75% van materialiteit
(voor steekproef doeleinden)

STAP 3: POSTEN BOVEN MATERIALITEIT
Identificeer alle balansposten en V&W posten > materialiteit
Deze vereisen volledige controle.

STAP 4: STEEKPROEF BEPALING
Voor posten tussen performance materialiteit en materialiteit:
Steekproefomvang op basis van populatie en risico.

Output als materialiteitsberekening + lijst posten voor controle.`,
        output: 'Analyse Rapport',
        level: 'Accountant'
      }
    ]
  },
  {
    id: 'project-finance',
    title: 'Project Winstgevendheid',
    icon: 'üéØ',
    description: 'Voor projectmatige organisaties en professional services.',
    prompts: [
      {
        id: 'project-profitability',
        title: 'Project Profitability Deep Dive',
        prompt: `Analyseer winstgevendheid per project in detail:

PER PROJECT:

1. REVENUE
   - Gefactureerd t/m heden
   - Nog te factureren (onderhanden werk)
   - Totaal verwachte opbrengst

2. KOSTEN
   - Directe uren √ó intern uurtarief
   - Directe kosten (inkoop, reiskosten)
   - Allocated overhead

3. MARGE
   - Bruto marge = Revenue - Directe kosten
   - Netto marge = Bruto marge - Overhead
   - Marge % = Netto marge / Revenue

4. BUDGET VERGELIJKING
   - Budget marge vs actual marge
   - Variantie verklaring

5. STATUS INDICATOREN
   - üü¢ Groen: marge > target
   - üü° Geel: marge 0-target
   - üî¥ Rood: marge < 0

PORTFOLIO OVERZICHT:
Totaal aantal projecten per status
Gewogen gemiddelde marge

Output als JSON voor dashboard.`,
        output: 'JSON Dashboard',
        level: 'Project Controller'
      },
      {
        id: 'ohw-waardering',
        title: 'Onderhanden Werk Waardering',
        prompt: `Bereken onderhanden werk (OHW) waardering voor jaarrekening:

METHODE: Percentage of Completion (PoC)

PER PROJECT:

1. VOORTGANG BEPALING
   - Bestede uren / Begrote uren = % voltooid
   - OF: gerealiseerde kosten / begrote kosten

2. OMZET NAAR RATO
   - Contractwaarde √ó % voltooid = Te verantwoorden omzet

3. ONDERHANDEN WERK
   - Te verantwoorden omzet - Reeds gefactureerd = OHW
   - Positief = Actief (nog te factureren)
   - Negatief = Passief (vooruit gefactureerd)

4. VERLIESLATENDE PROJECTEN
   - Indien verwacht verlies: direct volledig voorzien
   - Voorziening = Verwachte totale kosten - Verwachte opbrengst

BALANSPOST:
- Onderhanden projecten (activa)
- Vooruitgefactureerde projecten (passiva)
- Voorziening verlieslatende projecten

Output als waarderingsrapport voor jaarrekening.`,
        output: 'Valuation Rapport',
        level: 'Accountant'
      },
      {
        id: 'utilization',
        title: 'Resource Utilization Analyse',
        prompt: `Analyseer medewerker bezettingsgraad:

PER MEDEWERKER:

1. BESCHIKBARE UREN
   - Werkdagen √ó 8 uur - verlof - ziekte = Beschikbaar

2. DECLARABELE UREN
   - Uren geboekt op klantprojecten

3. NIET-DECLARABEL
   - Intern (vergaderingen, opleiding, acquisitie)
   - Leegloop

4. UTILIZATION RATE
   - Declarabel / Beschikbaar √ó 100%

5. BENCHMARK
   - Target: [meestal 65-80% voor consultancy]
   - Performance vs target

TEAM OVERZICHT:
| Medewerker | Beschikbaar | Declarabel | Utilization | vs Target |
|------------|-------------|------------|-------------|-----------|

ANALYSE:
- Wie is under-utilized? ‚Üí Meer projecten toewijzen
- Wie is over-utilized? ‚Üí Risico op burnout

Output als CSV + management samenvatting.`,
        output: 'CSV + Analyse',
        level: 'Resource Manager'
      },
      {
        id: 'project-risk',
        title: 'Project Risk Radar',
        prompt: `Identificeer projectrisico's proactief:

RISICO INDICATOREN:

1. BUDGET OVERRUN RISICO
   - Bestede uren > 80% budget maar voortgang < 70%
   - Risicoscore: (besteed% - voortgang%) √ó 10

2. DEADLINE RISICO
   - Geplande einddatum nadert, voortgang onvoldoende
   - Dagen tot deadline vs verwachte resterende doorlooptijd

3. SCOPE CREEP INDICATOREN
   - Aantal wijzigingsverzoeken
   - Uren buiten originele scope

4. CASHFLOW RISICO
   - Grote onderhanden werk positie
   - Klant betaalgedrag historisch

5. RELATIE RISICO
   - Openstaande facturen op dit project
   - Klantcommunicatie frequentie

RISK MATRIX:
| Project | Budget Risk | Deadline Risk | Scope Risk | Cash Risk | Totaal |
|---------|-------------|---------------|------------|-----------|--------|

Score per risico: 1-5 (5 = hoogst)
Sorteer op totaal risico.

Output als risk matrix JSON.`,
        output: 'Risk Matrix JSON',
        level: 'Project Manager'
      }
    ]
  },
  {
    id: 'treasury',
    title: 'Treasury & Cashflow Management',
    icon: 'üíµ',
    description: 'Werkkapitaal optimalisatie en liquiditeitsbeheer.',
    prompts: [
      {
        id: 'working-capital',
        title: 'Working Capital & CCC Analyse',
        prompt: `Bereken en analyseer werkkapitaal en Cash Conversion Cycle:

1. WORKING CAPITAL BEREKENING
   - Vlottende activa (debiteuren + voorraad + liquide middelen)
   - Kortlopende schulden (crediteuren + overige)
   - Working capital = Vlottende activa - Kortlopende schulden

2. WORKING CAPITAL RATIO
   - Current ratio = Vlottende activa / Kortlopende schulden
   - Quick ratio = (Vlottende activa - Voorraad) / Kortlopende schulden
   - Target: Current ratio > 1.5, Quick ratio > 1.0

3. CASH CONVERSION CYCLE (CCC)
   - DIO (Days Inventory Outstanding) = Voorraad / (Kostprijs / 365)
   - DSO (Days Sales Outstanding) = Debiteuren / (Omzet / 365)
   - DPO (Days Payables Outstanding) = Crediteuren / (Inkopen / 365)
   - CCC = DIO + DSO - DPO

4. TREND ANALYSE
   Bereken bovenstaande voor afgelopen 12 maanden.
   Is CCC aan het verbeteren of verslechteren?

5. VERBETERPOTENTIEEL
   - Als DSO daalt met 5 dagen ‚Üí ‚Ç¨X werkkapitaal vrij
   - Als DPO stijgt met 5 dagen ‚Üí ‚Ç¨X werkkapitaal vrij

Output als trend data + analyse.`,
        output: 'Trend Data + Analyse',
        level: 'Treasury'
      },
      {
        id: 'bank-recon',
        title: 'Bank Reconciliatie Check',
        prompt: `Vergelijk banksaldo boekhouding met bankafschriften:

1. SALDO VERGELIJKING
   - Saldo volgens boekhouding (grootboek bank)
   - Saldo volgens laatste bankafschrift
   - Verschil

2. RECONCILIATIE ITEMS
   Verklaar verschil door:
   - Nog niet verwerkte ontvangsten
   - Nog niet verwerkte uitgaven
   - Kruisposten in transit
   - Fouten/correcties

3. RECONCILIATIE FORMAT
   | Datum | Omschrijving | Bedrag | Status |
   |-------|--------------|--------|--------|

   Status: Verwerkt / In transit / Te onderzoeken

4. AANDACHTSPUNTEN
   - Oude reconciliatie items (> 30 dagen)
   - Grote individuele items
   - Ongebruikelijke transacties

Output als reconciliatie rapport.`,
        output: 'Reconciliatie Rapport',
        level: 'Administrateur'
      },
      {
        id: 'cashflow-patterns',
        title: 'Intra-month Cashflow Patterns',
        prompt: `Analyseer cashflow patronen binnen de maand:

1. DAGELIJKSE CASHFLOW
   Analyseer afgelopen 3 maanden dag-voor-dag:
   - Ontvangsten per dag van de maand
   - Uitgaven per dag van de maand

2. PATROON IDENTIFICATIE
   - Wanneer komen de meeste ontvangsten? (begin/midden/eind maand)
   - Wanneer zijn de meeste uitgaven? (salaris, huur, leveranciers)
   - Zijn er vaste "cash dip" momenten?

3. HEATMAP DATA
   Per dag van de maand (1-31):
   - Gemiddelde netto cashflow
   - Kleurcode: groen (positief) / rood (negatief)

4. CASH MANAGEMENT ADVIES
   - Optimale dag voor grote uitgaven
   - Buffer aanhouden voor dip-momenten
   - Debiteuren herinnering timing

Output als heatmap JSON + advies.`,
        output: 'Heatmap JSON + Advies',
        level: 'Treasury'
      },
      {
        id: 'covenant-check',
        title: 'Covenant Compliance Check',
        prompt: `Check financi√´le ratio's tegen bank covenants:

STANDAARD COVENANTS:

1. SOLVABILITEITSRATIO
   - Berekening: Eigen vermogen / Totaal vermogen
   - Typische eis: > 25%
   - Actual: [bereken]
   - Status: ‚úÖ Compliant / ‚ö†Ô∏è Warning (<30%) / ‚ùå Breach

2. CURRENT RATIO
   - Berekening: Vlottende activa / Kortlopende schulden
   - Typische eis: > 1.0
   - Actual: [bereken]
   - Status: [bepaal]

3. DEBT SERVICE COVERAGE RATIO (DSCR)
   - Berekening: EBITDA / (Rente + Aflossing)
   - Typische eis: > 1.2
   - Actual: [bereken]
   - Status: [bepaal]

4. INTEREST COVERAGE RATIO
   - Berekening: EBIT / Rentelasten
   - Typische eis: > 3.0
   - Actual: [bereken]
   - Status: [bepaal]

SAMENVATTING:
| Covenant | Eis | Actual | Marge | Status |
|----------|-----|--------|-------|--------|

EARLY WARNING:
Als ratio's richting breach gaan, welke acties?

Output als covenant compliance rapport.`,
        output: 'Covenant Rapport',
        level: 'CFO'
      }
    ]
  },
  {
    id: 'power-exports',
    title: 'Power User Exports',
    icon: 'üì§',
    description: 'Geavanceerde data exports voor analyse en integratie.',
    prompts: [
      {
        id: 'audit-export',
        title: 'Journaalregels Export voor Audit',
        prompt: `Exporteer alle journaalboekingen voor auditdoeleinden:

SPECIFICATIES:
- Periode: [JAAR] of [KWARTAAL]
- Alle boekingsregels inclusief memoriaal

KOLOMMEN:
1. Boekjaar
2. Periode
3. Boekstuknummer
4. Boekstukdatum
5. Grootboeknummer
6. Grootboeknaam
7. Kostenplaats
8. Relatiecode
9. Relatienaam
10. Omschrijving
11. Debet
12. Credit
13. BTW-code
14. BTW-bedrag
15. Factuurnummer
16. Documentreferentie

VALIDATIE:
- Totaal debet = Totaal credit
- Aantal regels

Formatteer als audit-ready CSV met UTF-8 encoding.`,
        output: 'Audit CSV',
        level: 'Accountant'
      },
      {
        id: 'powerbi-export',
        title: 'Power BI Dataset Generatie',
        prompt: `Genereer datasets voor Power BI import:

DATASET 1: Fact_Invoices
- InvoiceID, InvoiceNumber, InvoiceDate, DueDate
- CustomerID, Amount, VATAmount, TotalAmount
- Status, PaidDate, DaysOverdue

DATASET 2: Dim_Customers
- CustomerID, CustomerName, CustomerCode
- Email, Phone, Address, City
- CustomerGroup, PaymentTerms

DATASET 3: Dim_GLAccounts
- AccountID, AccountNumber, AccountName
- AccountType, Category, Subcategory

DATASET 4: Fact_Transactions
- TransactionID, Date, GLAccountID
- Amount, Description, DocumentNumber
- CostCenterID, ProjectID

Per dataset:
- Correcte data types (string, number, date)
- Relatie sleutels consistent
- Geen null values in key fields

Output als separate JSON arrays per dataset.`,
        output: 'Multi-JSON',
        level: 'Data Analyst'
      },
      {
        id: 'crm-export',
        title: 'CRM Sync Data (Salesforce format)',
        prompt: `Exporteer klantdata voor CRM synchronisatie:

KOLOMMEN (Salesforce compatible):
1. Account_External_ID__c (jouw klant ID)
2. Name (bedrijfsnaam)
3. BillingStreet
4. BillingCity
5. BillingPostalCode
6. BillingCountry
7. Phone
8. Website
9. Industry
10. Annual_Revenue__c (omzet laatste 12 maanden)
11. Outstanding_Balance__c (openstaand saldo)
12. Last_Invoice_Date__c
13. Payment_Score__c (1-10 betaalgedrag)
14. Customer_Since__c (eerste factuur datum)
15. Total_Lifetime_Revenue__c

FILTER:
- Alleen actieve klanten (transactie in afgelopen 24 maanden)
- Exclusief interne relaties

Formatteer als Salesforce Data Loader compatible CSV.`,
        output: 'CRM CSV',
        level: 'Sales Ops'
      },
      {
        id: 'boekhouder-pakket',
        title: 'Boekhouder Maandpakket',
        prompt: `Cre√´er complete maandafsluiting pakket voor externe boekhouder:

DOCUMENT 1: Proefbalans
- Alle grootboekrekeningen met saldo
- Beginbalans | Mutaties Debet | Mutaties Credit | Eindbalans

DOCUMENT 2: Winst & Verliesrekening
- Omzet per categorie
- Kosten per categorie
- Bruto marge, EBITDA, Nettoresultaat

DOCUMENT 3: Debiteurenoverzicht
- Per klant: openstaand saldo, ouderdom
- Totalen per ouderdomscategorie

DOCUMENT 4: Crediteurenoverzicht
- Per leverancier: openstaand saldo
- Vervaldatum overzicht

DOCUMENT 5: Bankstanden
- Per bankrekening: saldo per einde maand
- Vergelijk met vorige maand

DOCUMENT 6: BTW Specificatie
- Omzet per BTW-tarief
- Voorbelasting per tarief
- Afdracht/vordering

Elk document als nette markdown tabel of CSV.`,
        output: 'Multi-format Pakket',
        level: 'Administrateur'
      }
    ]
  },
  {
    id: 'ai-insights',
    title: 'AI-Gestuurde Inzichten',
    icon: 'üß†',
    description: 'Geavanceerde analyses met AI-ondersteuning.',
    prompts: [
      {
        id: 'anomaly-detection',
        title: 'Anomalie Detectie in Transacties',
        prompt: `Analyseer transacties en identificeer anomalie√´n:

ANOMALIE TYPES:

1. BEDRAG ANOMALIE√ãN
   - Transacties > 3√ó standaarddeviatie van gemiddelde
   - Per leverancier/klant: afwijking van normaal patroon
   - Ronde bedragen op ongebruikelijke momenten

2. TIMING ANOMALIE√ãN
   - Boekingen buiten kantooruren
   - Weekend boekingen
   - Ongebruikelijke datum patronen (bijv. altijd op 31e)

3. RELATIE ANOMALIE√ãN
   - Nieuwe relaties met direct grote bedragen
   - Relaties met alleen credit of alleen debet
   - Relaties zonder KvK/BTW-nummer

4. PATROON ANOMALIE√ãN
   - Facturen net onder autorisatiegrens
   - Terugkerende bedragen naar zelfde relatie
   - Dubbelbetalingen

RISK SCORING:
Per anomalie: severity (1-5) √ó likelihood (1-5) = Risk score

OUTPUT:
Alert lijst gesorteerd op risk score:
| Datum | Relatie | Bedrag | Anomalie Type | Risk Score | Actie |

Output als alert JSON.`,
        output: 'Alert JSON',
        level: 'Controller'
      },
      {
        id: 'forecast-model',
        title: 'Seizoenspatroon & Trend Forecast',
        prompt: `Bouw een forecast model met seizoenscorrectie:

STAP 1: DATA PREPARATIE
- Verzamel maandomzet afgelopen 24-36 maanden
- Identificeer en corrigeer outliers

STAP 2: DECOMPOSITIE
Splits tijdreeks in componenten:
- Trend: onderliggende groei/krimp
- Seizoen: maandelijks terugkerend patroon
- Residu: onverklaard

STAP 3: SEIZOENSINDICES
Per maand (jan-dec):
- Seizoensindex = Gemiddelde maand / Totaal gemiddelde
- Index > 1 = sterke maand, < 1 = zwakke maand

STAP 4: FORECAST
Voor komende 6-12 maanden:
- Trendwaarde √ó Seizoensindex = Forecast
- Confidence interval: ¬±1.96 √ó Std.dev residu

STAP 5: VALIDATIE
- Bereken MAPE (Mean Absolute Percentage Error) op historische data
- Model is betrouwbaar als MAPE < 15%

Output als:
1. Seizoensindices tabel
2. Forecast tabel met confidence bands
3. Model parameters en accuracy metrics`,
        output: 'Forecast + Model',
        level: 'Data Analyst'
      },
      {
        id: 'churn-risk',
        title: 'Klant Churn Risico Analyse',
        prompt: `Identificeer klanten met churn risico:

CHURN INDICATOREN:

1. OMZET TREND
   - Vergelijk omzet laatste 3 maanden vs 3 maanden daarvoor
   - Daling > 30% = hoog risico

2. BESTELFREQUENTIE
   - Gemiddelde dagen tussen orders historisch
   - Dagen sinds laatste order
   - Als > 2√ó gemiddelde = risico

3. ORDER GROOTTE
   - Gemiddelde ordergrootte trend
   - Krimpende orders = risico

4. BETAALGEDRAG VERANDERING
   - Was altijd op tijd, nu te laat
   - Betaalgedrag verslechtert = mogelijk cashflow issues

5. COMMUNICATIE
   - Klachten/support tickets recent
   - Afnemend contact

CHURN SCORE (0-100):
Gewogen score van alle indicatoren

ACTIE MATRIX:
| Klant | Omzet Ytd | Trend | Laatste Order | Churn Score | Aanbevolen Actie |
|-------|-----------|-------|---------------|-------------|------------------|

Prioriteer op: Churn Score √ó Klantwaarde

Output als risk lijst met aanbevelingen.`,
        output: 'Risk List + Acties',
        level: 'Customer Success'
      },
      {
        id: 'financial-health',
        title: 'Financial Health Score',
        prompt: `Bereken een samengestelde Financial Health Score:

COMPONENTEN (elk 0-25 punten, totaal 0-100):

1. LIQUIDITEIT (25 punten)
   - Current ratio score
   - Quick ratio score
   - Cashflow trend
   Score = gewogen gemiddelde

2. WINSTGEVENDHEID (25 punten)
   - Netto marge %
   - Trend t.o.v. vorig jaar
   - Marge vs sector benchmark
   Score = gewogen gemiddelde

3. SOLVABILITEIT (25 punten)
   - Eigen vermogen ratio
   - Debt-to-equity ratio
   - Interest coverage
   Score = gewogen gemiddelde

4. GROEI (25 punten)
   - Omzetgroei YoY
   - Klantgroei
   - Orderintake trend
   Score = gewogen gemiddelde

TOTAAL SCORE INTERPRETATIE:
- 80-100: Excellent üü¢
- 60-79: Goed üü¢
- 40-59: Matig üü°
- 20-39: Zorgelijk üü†
- 0-19: Kritiek üî¥

TREND:
Vergelijk met vorige periode - verbeterend/verslechterend?

Output als dashboard widget JSON met:
- Totaalscore
- Scores per component
- Trend indicator
- Top 3 verbeterpunten`,
        output: 'Score JSON + Dashboard',
        level: 'CFO'
      }
    ]
  }
];

// Extended output formats
const outputFormats = [
  {
    name: 'Excel/CSV',
    icon: 'üìä',
    instruction: 'Formatteer als CSV met kolomkoppen die ik direct in Excel kan importeren',
    example: 'Klant;Bedrag;Vervaldatum;Status'
  },
  {
    name: 'JSON Dashboard',
    icon: 'üìã',
    instruction: 'Geef de data als nested JSON object geschikt voor dashboard widgets',
    example: '{"metrics": {"revenue": 50000, "trend": "+5%"}}'
  },
  {
    name: 'Audit Trail',
    icon: '‚úÖ',
    instruction: 'Formatteer als audit-ready tabel met datum, bron, bedrag en referentie',
    example: 'Controleerbaar en traceerbaar format'
  },
  {
    name: 'Mermaid Diagram',
    icon: 'üìà',
    instruction: 'Visualiseer als Mermaid flowchart, sequence diagram of gantt chart',
    example: 'graph TD; A-->B; B-->C'
  },
  {
    name: 'Python Analyse',
    icon: 'üêç',
    instruction: 'Genereer Python code met pandas en matplotlib voor reproduceerbare analyse',
    example: 'import pandas as pd; df.plot()'
  },
  {
    name: 'Power BI Ready',
    icon: 'üìä',
    instruction: 'Formatteer als Power BI-compatible JSON met correcte data types',
    example: 'Fact tables + Dimension tables'
  },
  {
    name: 'Executive Summary',
    icon: 'üìù',
    instruction: 'Schrijf een executive summary met maximaal 5 bullets en key metrics',
    example: 'Kernpunten voor directie'
  },
  {
    name: 'Journal Entry',
    icon: 'üìí',
    instruction: 'Formatteer als boekingsvoorstel met debet/credit en grootboekrekeningen',
    example: 'D: 1300 ‚Ç¨1.000 | C: 8000 ‚Ç¨1.000'
  }
];
---

<Layout title="Expert Prompt Handboek - Praat met je Boekhouding" description="Professionele prompts voor financi√´le analyse van je Exact Online administratie. Voor controllers, CFO's en accountants.">
  <main class="min-h-screen bg-gray-50">
    <!-- Hero -->
    <section class="bg-gradient-to-br from-exact-blue to-blue-700 text-white py-16">
      <div class="max-w-6xl mx-auto px-4">
        <div class="flex items-center gap-2 mb-4">
          <span class="px-3 py-1 bg-white/20 rounded-full text-sm font-medium">Expert Level</span>
          <span class="px-3 py-1 bg-amber-500/80 rounded-full text-sm font-medium">Voor Professionals</span>
        </div>
        <h1 class="text-4xl font-bold mb-4">Expert Prompt Handboek</h1>
        <p class="text-xl text-blue-100 max-w-2xl">
          Professionele prompts voor financi√´le analyse. Ontworpen voor controllers, CFO's, accountants en business analysts.
        </p>
        <p class="text-blue-200 mt-2">
          Welkom, {user?.name || user?.email}
        </p>
        <div class="mt-6 flex flex-wrap gap-2">
          {categories.map(cat => (
            <a href={`#${cat.id}`} class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors text-sm">
              {cat.icon} {cat.title}
            </a>
          ))}
        </div>
      </div>
    </section>

    <!-- Pro Tips Banner -->
    <section class="bg-gradient-to-r from-amber-50 to-orange-50 border-b border-amber-200">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-start gap-3">
          <span class="text-2xl">üí°</span>
          <div>
            <p class="text-amber-900 font-medium">Pro Tips voor Expert Prompts:</p>
            <ul class="text-amber-800 text-sm mt-1 space-y-1">
              <li>‚Ä¢ Vervang [KLANTNAAM], [JAAR], [PERIODE] met concrete waarden</li>
              <li>‚Ä¢ Vraag om een specifiek output format voor direct bruikbare resultaten</li>
              <li>‚Ä¢ Combineer prompts voor diepgaande analyses (bijv. eerst 360¬∞ view, dan risk assessment)</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Categories -->
    <div class="max-w-6xl mx-auto px-4 py-12 space-y-16">
      {categories.map(category => (
        <section id={category.id}>
          <div class="flex items-center gap-3 mb-2">
            <span class="text-3xl">{category.icon}</span>
            <h2 class="text-2xl font-bold text-gray-900">{category.title}</h2>
          </div>
          {category.description && (
            <p class="text-gray-600 mb-6">{category.description}</p>
          )}

          <div class="grid gap-6">
            {category.prompts.map(item => (
              <div class="bg-white rounded-xl border border-gray-200 p-6 hover:shadow-lg transition-shadow">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <h3 class="font-semibold text-gray-900 text-lg">{item.title}</h3>
                    <div class="flex gap-2 mt-2">
                      <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">
                        {item.output}
                      </span>
                      <span class="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded-full">
                        {item.level}
                      </span>
                    </div>
                  </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4 mb-4 max-h-64 overflow-y-auto">
                  <pre class="text-gray-700 text-sm whitespace-pre-wrap font-mono">{item.prompt}</pre>
                </div>
                <button
                  class="copy-btn w-full py-3 px-4 bg-exact-blue text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 font-medium"
                  data-prompt={item.prompt}
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                  <span>Kopieer prompt</span>
                </button>
              </div>
            ))}
          </div>
        </section>
      ))}

      <!-- Output Formats Guide -->
      <section id="formats" class="bg-white rounded-xl border border-gray-200 p-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">üìë Output Formats Guide</h2>
        <p class="text-gray-600 mb-6">
          Voeg deze instructies toe aan je prompt voor specifieke output formats die direct bruikbaar zijn.
        </p>

        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
          {outputFormats.map(format => (
            <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-xl">{format.icon}</span>
                <h3 class="font-semibold text-gray-900">{format.name}</h3>
              </div>
              <p class="text-sm text-gray-600 mb-2">{format.instruction}</p>
              <code class="text-xs bg-gray-100 text-gray-700 p-2 rounded block">
                {format.example}
              </code>
            </div>
          ))}
        </div>
      </section>

      <!-- Quick Reference -->
      <section class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl p-8 text-white">
        <h2 class="text-2xl font-bold mb-4">üöÄ Quick Reference: Combinatie Prompts</h2>
        <p class="text-gray-300 mb-6">
          Combineer prompts voor krachtige analyses. Start breed, zoom dan in.
        </p>
        <div class="grid md:grid-cols-3 gap-4">
          <div class="bg-white/10 rounded-lg p-4">
            <h3 class="font-semibold mb-2">Klant Deep Dive</h3>
            <ol class="text-sm text-gray-300 space-y-1">
              <li>1. Customer 360 View</li>
              <li>2. Credit Risk Assessment</li>
              <li>3. Churn Risk Analyse</li>
            </ol>
          </div>
          <div class="bg-white/10 rounded-lg p-4">
            <h3 class="font-semibold mb-2">Maandafsluiting</h3>
            <ol class="text-sm text-gray-300 space-y-1">
              <li>1. Variance Analysis</li>
              <li>2. BTW Reconciliatie</li>
              <li>3. Boekhouder Pakket</li>
            </ol>
          </div>
          <div class="bg-white/10 rounded-lg p-4">
            <h3 class="font-semibold mb-2">Cash Management</h3>
            <ol class="text-sm text-gray-300 space-y-1">
              <li>1. Liquiditeitsprognose</li>
              <li>2. Working Capital Analyse</li>
              <li>3. Collection Strategy</li>
            </ol>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Toast container -->
  <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-2 z-50">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
    </svg>
    <span>Gekopieerd!</span>
  </div>

  <script>
    // Copy to clipboard functionality
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const prompt = btn.getAttribute('data-prompt');
        if (!prompt) return;

        try {
          await navigator.clipboard.writeText(prompt);

          // Update button text
          const span = btn.querySelector('span');
          const originalText = span?.textContent;
          if (span) span.textContent = '‚úì Gekopieerd!';

          // Show toast
          const toast = document.getElementById('toast');
          if (toast) {
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
              toast.classList.add('translate-y-20', 'opacity-0');
            }, 2000);
          }

          // Reset button text
          setTimeout(() => {
            if (span && originalText) span.textContent = originalText;
          }, 2000);
        } catch (err) {
          console.error('Copy failed:', err);
        }
      });
    });
  </script>
</Layout>
