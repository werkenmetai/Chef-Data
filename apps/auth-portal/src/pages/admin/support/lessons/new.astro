---
import Layout from '../../../../layouts/Layout.astro';
import { Database, type SupportConversation } from '../../../../lib/database';
// AdminAppLauncher now in Layout.astro header

const env = Astro.locals.runtime?.env;
const conversationId = Astro.url.searchParams.get('conversation');

let db: Database | null = null;
let isAdmin = false;
let adminUserId: string | null = null;
let conversation: SupportConversation | null = null;
let success: string | null = null;
let error: string | null = null;
let redirectTo: string | null = null;

try {
  if (env?.DB) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());
        adminUserId = session.user.id;

        if (isAdmin) {
          // Get linked conversation if provided
          if (conversationId) {
            conversation = await db.getConversation(conversationId);
          }

          if (Astro.request.method === 'POST') {
            const formData = await Astro.request.formData();

            const title = formData.get('title')?.toString() || '';
            const description = formData.get('description')?.toString() || '';
            const root_cause = formData.get('root_cause')?.toString() || '';
            const solution = formData.get('solution')?.toString() || '';
            const prevention = formData.get('prevention')?.toString() || '';
            const category = formData.get('category')?.toString() || '';
            const tags = formData.get('tags')?.toString() || '';
            const code_fix_pr = formData.get('code_fix_pr')?.toString() || '';
            const linked_conversation_id = formData.get('conversation_id')?.toString() || '';

            if (!title || !description) {
              error = 'Titel en beschrijving zijn verplicht';
            } else {
              // Convert comma-separated tags to array
              const tagsArray = tags ? tags.split(',').map(t => t.trim()).filter(t => t) : undefined;

              const lesson = await db.createLesson({
                conversation_id: linked_conversation_id || undefined,
                title,
                description,
                root_cause: root_cause || undefined,
                solution: solution || undefined,
                prevention: prevention || undefined,
                category: category || undefined,
                tags: tagsArray,
                code_fix_pr: code_fix_pr || undefined,
                created_by: adminUserId,
              });

              if (lesson) {
                redirectTo = '/admin/support/lessons';
              } else {
                error = 'Kon lesson niet aanmaken';
              }
            }
          }
        }
      }
    }
  }
} catch (e) {
  console.error('Admin new lesson error:', e);
  error = 'Er is een fout opgetreden';
}

if (redirectTo) {
  return Astro.redirect(redirectTo);
}

const categoryOptions = [
  { value: '', label: 'Selecteer categorie' },
  { value: 'connection', label: 'Verbinding' },
  { value: 'billing', label: 'Facturatie' },
  { value: 'bug', label: 'Technisch' },
  { value: 'feature', label: 'Features' },
  { value: 'account', label: 'Account' },
  { value: 'other', label: 'Overig' },
];
---

<Layout title="Nieuw Lesson Learned">
  <div class="max-w-4xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          ← Terug naar Dashboard
        </a>
      </div>
    ) : (
      <>
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Nieuw Lesson Learned</h1>
            <p class="text-gray-600">Documenteer inzichten uit een support gesprek</p>
          </div>
          <div class="flex items-center gap-3">
            <a href="/admin/support/lessons" class="text-gray-600 hover:text-gray-900">
              ← Terug naar overzicht
            </a>
          </div>
        </div>

        {error && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-700">{error}</p>
          </div>
        )}

        {/* Linked Conversation Info */}
        {conversation && (
          <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
            <div class="flex items-start gap-3">
              <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
              </svg>
              <div class="flex-1">
                <h3 class="font-medium text-blue-900">Gekoppeld gesprek</h3>
                <p class="text-sm text-blue-700 mt-1">{conversation.subject}</p>
                <p class="text-xs text-blue-600 font-mono mt-1">ID: {conversation.id}</p>
              </div>
              <a
                href={`/admin/support/conversations/${conversation.id}`}
                target="_blank"
                class="text-blue-600 hover:text-blue-800 text-sm"
              >
                Bekijken →
              </a>
            </div>
          </div>
        )}

        <form method="POST" class="space-y-6">
          {conversation && (
            <input type="hidden" name="conversation_id" value={conversation.id} />
          )}

          <!-- Basic Info -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Basis Informatie</h2>

            <div class="space-y-4">
              <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">
                  Titel <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  name="title"
                  id="title"
                  required
                  placeholder="Korte samenvatting van het probleem"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                />
              </div>

              <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                  Beschrijving <span class="text-red-500">*</span>
                </label>
                <textarea
                  name="description"
                  id="description"
                  rows="4"
                  required
                  placeholder="Beschrijf het probleem en hoe het is opgelost"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                ></textarea>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="category" class="block text-sm font-medium text-gray-700 mb-1">
                    Categorie
                  </label>
                  <select
                    name="category"
                    id="category"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                  >
                    {categoryOptions.map(opt => (
                      <option value={opt.value} selected={conversation?.category === opt.value}>
                        {opt.label}
                      </option>
                    ))}
                  </select>
                </div>

                <div>
                  <label for="tags" class="block text-sm font-medium text-gray-700 mb-1">
                    Tags
                  </label>
                  <input
                    type="text"
                    name="tags"
                    id="tags"
                    placeholder="api, oauth, token (gescheiden door komma's)"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Analysis -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Analyse</h2>

            <div class="space-y-4">
              <div>
                <label for="root_cause" class="block text-sm font-medium text-gray-700 mb-1">
                  Root Cause
                </label>
                <textarea
                  name="root_cause"
                  id="root_cause"
                  rows="3"
                  placeholder="Wat was de onderliggende oorzaak van het probleem?"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                ></textarea>
              </div>

              <div>
                <label for="solution" class="block text-sm font-medium text-gray-700 mb-1">
                  Oplossing
                </label>
                <textarea
                  name="solution"
                  id="solution"
                  rows="3"
                  placeholder="Hoe is het probleem opgelost?"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                ></textarea>
              </div>

              <div>
                <label for="prevention" class="block text-sm font-medium text-gray-700 mb-1">
                  Preventie
                </label>
                <textarea
                  name="prevention"
                  id="prevention"
                  rows="3"
                  placeholder="Hoe kan dit probleem in de toekomst voorkomen worden?"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                ></textarea>
              </div>
            </div>
          </div>

          <!-- Actions Taken -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Acties Ondernomen</h2>
            <p class="text-sm text-gray-500 mb-4">
              Optioneel: link naar gerelateerde acties die uit dit lesson zijn voortgekomen
            </p>

            <div class="space-y-4">
              <div>
                <label for="code_fix_pr" class="block text-sm font-medium text-gray-700 mb-1">
                  Code Fix PR URL
                </label>
                <input
                  type="url"
                  name="code_fix_pr"
                  id="code_fix_pr"
                  placeholder="https://github.com/..."
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                />
              </div>

              <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-600">
                  <strong>Tip:</strong> Je kunt na het aanmaken van dit lesson een nieuw AI pattern of kennisbank artikel aanmaken
                  en deze later aan dit lesson koppelen.
                </p>
              </div>
            </div>
          </div>

          <!-- Submit -->
          <div class="flex justify-end gap-4">
            <a
              href="/admin/support/lessons"
              class="px-6 py-3 text-gray-600 font-medium hover:text-gray-900"
            >
              Annuleren
            </a>
            <button
              type="submit"
              class="px-6 py-3 bg-exact-blue text-white font-semibold rounded-lg hover:bg-exact-dark transition-colors"
            >
              Lesson aanmaken
            </button>
          </div>
        </form>
      </>
    )}
  </div>
</Layout>
