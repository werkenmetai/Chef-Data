---
import Layout from '../../../../layouts/Layout.astro';
import { Database, type SupportConversation, type SupportMessage } from '../../../../lib/database';
// AdminAppLauncher now in Layout.astro header

const env = Astro.locals.runtime?.env;
const { id } = Astro.params;

let db: Database | null = null;
let isAdmin = false;
let adminUserId: string | null = null;
let conversation: SupportConversation | null = null;
let messages: SupportMessage[] = [];
let userInfo: any = null;
let success: string | null = null;
let error: string | null = null;

try {
  if (env?.DB && id) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());
        adminUserId = session.user.id;

        if (isAdmin) {
          conversation = await db.getConversation(id);

          if (conversation) {
            messages = await db.getMessages(id);

            // Get user info
            const userResult = await db.get<any>(
              'SELECT id, email, name, created_at FROM users WHERE id = ?',
              [conversation.user_id]
            );
            if (userResult) {
              userInfo = userResult;
              // Get user's connection count
              const connectionCount = await db.get<{ count: number }>(
                'SELECT COUNT(*) as count FROM connections WHERE user_id = ?',
                [conversation.user_id]
              );
              userInfo.connectionCount = connectionCount?.count || 0;

              // Get user's conversation count
              const convCount = await db.get<{ count: number }>(
                'SELECT COUNT(*) as count FROM support_conversations WHERE user_id = ?',
                [conversation.user_id]
              );
              userInfo.conversationCount = convCount?.count || 0;
            }

            // Handle form actions
            if (Astro.request.method === 'POST') {
              const formData = await Astro.request.formData();
              const action = formData.get('action');

              if (action === 'send_message') {
                const content = formData.get('content')?.toString();
                const isInternal = formData.get('is_internal') === 'on';

                if (content) {
                  await db.addMessage(id, {
                    sender_type: 'admin',
                    sender_id: adminUserId,
                    content,
                    is_internal: isInternal,
                  });

                  // Update conversation status
                  await db.updateConversation(id, {
                    status: 'waiting_user',
                    handled_by: conversation.handled_by === 'ai' ? 'hybrid' : 'human',
                  });

                  success = isInternal ? 'Interne notitie toegevoegd' : 'Bericht verzonden';
                  messages = await db.getMessages(id);
                  conversation = await db.getConversation(id);
                }
              } else if (action === 'update_status') {
                const newStatus = formData.get('status')?.toString() as 'open' | 'waiting_user' | 'waiting_support' | 'resolved' | 'closed' | undefined;
                if (newStatus) {
                  await db.updateConversation(id, { status: newStatus });
                  success = 'Status bijgewerkt';
                  conversation = await db.getConversation(id);
                }
              } else if (action === 'update_priority') {
                const newPriority = formData.get('priority')?.toString() as 'low' | 'normal' | 'high' | 'urgent' | undefined;
                if (newPriority) {
                  await db.updateConversation(id, { priority: newPriority });
                  success = 'Prioriteit bijgewerkt';
                  conversation = await db.getConversation(id);
                }
              } else if (action === 'close') {
                await db.updateConversation(id, {
                  status: 'closed',
                  resolved_at: new Date().toISOString(),
                  resolution_type: 'admin_resolved',
                });
                success = 'Gesprek gesloten';
                conversation = await db.getConversation(id);
              }
            }
          }
        }
      }
    }
  }
} catch (e) {
  console.error('Admin conversation detail error:', e);
  error = 'Er is een fout opgetreden';
}

const statusLabels: Record<string, string> = {
  open: 'Open',
  waiting_user: 'Wacht op klant',
  waiting_support: 'Wacht op support',
  resolved: 'Opgelost',
  closed: 'Gesloten',
};

const statusColors: Record<string, string> = {
  open: 'bg-blue-100 text-blue-800',
  waiting_user: 'bg-yellow-100 text-yellow-800',
  waiting_support: 'bg-orange-100 text-orange-800',
  resolved: 'bg-green-100 text-green-800',
  closed: 'bg-gray-100 text-gray-800',
};

const priorityLabels: Record<string, string> = {
  low: 'Laag',
  normal: 'Normaal',
  high: 'Hoog',
  urgent: 'Urgent',
};

const categoryLabels: Record<string, string> = {
  connection: 'Verbinding',
  billing: 'Facturatie',
  bug: 'Technisch',
  feature: 'Features',
  account: 'Account',
  other: 'Overig',
};

function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleString('nl-NL', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}
---

<Layout title={conversation ? `Gesprek ${conversation.id.substring(0, 8)}` : 'Gesprek niet gevonden'}>
  <div class="max-w-7xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          ← Terug naar Dashboard
        </a>
      </div>
    ) : !conversation ? (
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center">
        <h1 class="text-2xl font-bold text-gray-900 mb-4">Gesprek niet gevonden</h1>
        <p class="text-gray-600 mb-6">Dit gesprek bestaat niet of is verwijderd.</p>
        <a
          href="/admin/support/conversations"
          class="inline-block px-6 py-3 bg-exact-blue text-white font-semibold rounded-lg hover:bg-exact-dark transition-colors"
        >
          Terug naar overzicht
        </a>
      </div>
    ) : (
      <>
        <!-- Header -->
        <div class="flex justify-between items-start mb-6">
          <div>
            <div class="flex items-center gap-3 mb-2">
              <h1 class="text-2xl font-bold text-gray-900">{conversation.subject}</h1>
              <span class={`px-2 py-1 rounded-full text-xs font-medium ${statusColors[conversation.status]}`}>
                {statusLabels[conversation.status]}
              </span>
            </div>
            <p class="text-gray-500 font-mono text-sm">ID: {conversation.id}</p>
          </div>
          <div class="flex items-center gap-3">
            <a href="/admin/support/conversations" class="text-gray-600 hover:text-gray-900">
              ← Terug naar overzicht
            </a>
          </div>
        </div>

        {success && (
          <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-green-700">{success}</p>
          </div>
        )}
        {error && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-700">{error}</p>
          </div>
        )}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Main Content -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Messages -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
              <div class="px-6 py-4 border-b border-gray-100">
                <h2 class="font-semibold text-gray-900">Berichten</h2>
              </div>
              <div class="p-6 space-y-4 max-h-[600px] overflow-y-auto">
                {messages.map((msg) => (
                  <div class={`p-4 rounded-lg ${
                    msg.sender_type === 'user' ? 'bg-gray-50' :
                    msg.sender_type === 'ai' ? 'bg-purple-50 border border-purple-100' :
                    msg.sender_type === 'admin' ? (msg.is_internal ? 'bg-yellow-50 border border-yellow-200' : 'bg-blue-50 border border-blue-100') :
                    'bg-gray-100'
                  }`}>
                    <div class="flex justify-between items-start mb-2">
                      <div class="flex items-center gap-2">
                        <span class={`font-medium ${
                          msg.sender_type === 'user' ? 'text-gray-900' :
                          msg.sender_type === 'ai' ? 'text-purple-900' :
                          msg.sender_type === 'admin' ? 'text-blue-900' :
                          'text-gray-700'
                        }`}>
                          {msg.sender_type === 'user' && 'Klant'}
                          {msg.sender_type === 'ai' && 'AI Support'}
                          {msg.sender_type === 'admin' && 'Admin'}
                          {msg.sender_type === 'system' && 'Systeem'}
                        </span>
                        {msg.is_internal && (
                          <span class="px-2 py-0.5 bg-yellow-200 text-yellow-800 rounded text-xs font-medium">
                            Intern
                          </span>
                        )}
                        {msg.sender_type === 'ai' && msg.ai_confidence && (
                          <span class="text-xs text-purple-600">
                            ({Math.round(msg.ai_confidence * 100)}% confidence)
                          </span>
                        )}
                      </div>
                      <span class="text-xs text-gray-500">{formatDate(msg.created_at)}</span>
                    </div>
                    <div class="text-gray-700 whitespace-pre-wrap">{msg.content}</div>
                  </div>
                ))}
              </div>
            </div>

            <!-- Reply Form -->
            {conversation.status !== 'closed' && (
              <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h2 class="font-semibold text-gray-900 mb-4">Reageren</h2>
                <form method="POST">
                  <input type="hidden" name="action" value="send_message" />
                  <div class="mb-4">
                    <textarea
                      name="content"
                      rows="4"
                      required
                      placeholder="Typ je bericht..."
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                    ></textarea>
                  </div>
                  <div class="flex items-center justify-between">
                    <label class="flex items-center gap-2 text-sm text-gray-600">
                      <input
                        type="checkbox"
                        name="is_internal"
                        class="w-4 h-4 text-yellow-500 border-gray-300 rounded focus:ring-yellow-500"
                      />
                      <span>Interne notitie (niet zichtbaar voor klant)</span>
                    </label>
                    <button
                      type="submit"
                      class="px-4 py-2 bg-exact-blue text-white font-medium rounded-lg hover:bg-exact-dark transition-colors"
                    >
                      Verstuur
                    </button>
                  </div>
                </form>
              </div>
            )}
          </div>

          <!-- Sidebar -->
          <div class="space-y-6">
            <!-- User Info -->
            {userInfo && (
              <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-semibold text-gray-900 mb-4">Klant Info</h3>
                <div class="space-y-3 text-sm">
                  <div>
                    <span class="text-gray-500">Naam</span>
                    <p class="font-medium text-gray-900">{userInfo.name || '-'}</p>
                  </div>
                  <div>
                    <span class="text-gray-500">Email</span>
                    <p class="font-medium text-gray-900">{userInfo.email}</p>
                  </div>
                  <div>
                    <span class="text-gray-500">Lid sinds</span>
                    <p class="font-medium text-gray-900">{formatDate(userInfo.created_at)}</p>
                  </div>
                  <div class="pt-3 border-t border-gray-100">
                    <div class="flex justify-between">
                      <span class="text-gray-500">Connecties</span>
                      <span class="font-medium text-gray-900">{userInfo.connectionCount}</span>
                    </div>
                    <div class="flex justify-between mt-1">
                      <span class="text-gray-500">Support gesprekken</span>
                      <span class="font-medium text-gray-900">{userInfo.conversationCount}</span>
                    </div>
                  </div>
                </div>
              </div>
            )}

            <!-- Conversation Details -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
              <h3 class="font-semibold text-gray-900 mb-4">Gesprek Details</h3>
              <div class="space-y-3 text-sm">
                <div>
                  <span class="text-gray-500">Categorie</span>
                  <p class="font-medium text-gray-900">
                    {conversation.category ? categoryLabels[conversation.category] : '-'}
                  </p>
                </div>
                <div>
                  <span class="text-gray-500">Prioriteit</span>
                  <p class="font-medium text-gray-900">{priorityLabels[conversation.priority]}</p>
                </div>
                <div>
                  <span class="text-gray-500">Behandeld door</span>
                  <p class="font-medium text-gray-900">
                    {conversation.handled_by === 'ai' && 'AI'}
                    {conversation.handled_by === 'human' && 'Mens'}
                    {conversation.handled_by === 'hybrid' && 'AI + Mens'}
                    {!conversation.handled_by && '-'}
                  </p>
                </div>
                <div>
                  <span class="text-gray-500">Aangemaakt</span>
                  <p class="font-medium text-gray-900">{formatDate(conversation.created_at)}</p>
                </div>
                {conversation.first_response_at && (
                  <div>
                    <span class="text-gray-500">Eerste reactie</span>
                    <p class="font-medium text-gray-900">{formatDate(conversation.first_response_at)}</p>
                  </div>
                )}
                {conversation.resolved_at && (
                  <div>
                    <span class="text-gray-500">Opgelost</span>
                    <p class="font-medium text-gray-900">{formatDate(conversation.resolved_at)}</p>
                  </div>
                )}
                {conversation.satisfaction_rating && (
                  <div>
                    <span class="text-gray-500">Beoordeling</span>
                    <p class="font-medium text-gray-900">
                      {'★'.repeat(conversation.satisfaction_rating)}{'☆'.repeat(5 - conversation.satisfaction_rating)}
                    </p>
                  </div>
                )}
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
              <h3 class="font-semibold text-gray-900 mb-4">Acties</h3>
              <div class="space-y-4">
                <!-- Status Change -->
                <form method="POST">
                  <input type="hidden" name="action" value="update_status" />
                  <label class="block text-sm font-medium text-gray-700 mb-1">Status wijzigen</label>
                  <div class="flex gap-2">
                    <select
                      name="status"
                      class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent text-sm"
                    >
                      <option value="open" selected={conversation.status === 'open'}>Open</option>
                      <option value="waiting_user" selected={conversation.status === 'waiting_user'}>Wacht op klant</option>
                      <option value="waiting_support" selected={conversation.status === 'waiting_support'}>Wacht op support</option>
                      <option value="resolved" selected={conversation.status === 'resolved'}>Opgelost</option>
                      <option value="closed" selected={conversation.status === 'closed'}>Gesloten</option>
                    </select>
                    <button type="submit" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                      Opslaan
                    </button>
                  </div>
                </form>

                <!-- Priority Change -->
                <form method="POST">
                  <input type="hidden" name="action" value="update_priority" />
                  <label class="block text-sm font-medium text-gray-700 mb-1">Prioriteit wijzigen</label>
                  <div class="flex gap-2">
                    <select
                      name="priority"
                      class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent text-sm"
                    >
                      <option value="low" selected={conversation.priority === 'low'}>Laag</option>
                      <option value="normal" selected={conversation.priority === 'normal'}>Normaal</option>
                      <option value="high" selected={conversation.priority === 'high'}>Hoog</option>
                      <option value="urgent" selected={conversation.priority === 'urgent'}>Urgent</option>
                    </select>
                    <button type="submit" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                      Opslaan
                    </button>
                  </div>
                </form>

                {conversation.status !== 'closed' && (
                  <form method="POST" class="pt-4 border-t border-gray-100">
                    <input type="hidden" name="action" value="close" />
                    <button
                      type="submit"
                      class="w-full px-4 py-2 bg-red-100 text-red-700 font-medium rounded-lg hover:bg-red-200 transition-colors"
                    >
                      Gesprek sluiten
                    </button>
                  </form>
                )}

                <!-- Create Lesson -->
                <div class="pt-4 border-t border-gray-100">
                  <a
                    href={`/admin/support/lessons/new?conversation=${conversation.id}`}
                    class="block w-full px-4 py-2 text-center bg-purple-100 text-purple-700 font-medium rounded-lg hover:bg-purple-200 transition-colors"
                  >
                    Lesson Learned aanmaken
                  </a>
                </div>

                <!-- Add to Knowledge Base -->
                {(conversation.status === 'resolved' || conversation.status === 'closed') && (
                  <div class="pt-2">
                    <button
                      id="addToKnowledgeBase"
                      data-conversation-id={conversation.id}
                      class="w-full px-4 py-2 bg-emerald-100 text-emerald-700 font-medium rounded-lg hover:bg-emerald-200 transition-colors flex items-center justify-center gap-2"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                      </svg>
                      Toevoegen aan Kennisbank
                    </button>
                    <div id="knowledgeBaseResult" class="hidden mt-3 p-4 bg-gray-50 rounded-lg">
                      <!-- Result will be populated by JavaScript -->
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>

        <!-- Knowledge Base Modal Script -->
        <script>
          const addBtn = document.getElementById('addToKnowledgeBase') as HTMLButtonElement | null;
          const resultDiv = document.getElementById('knowledgeBaseResult');

          if (addBtn && resultDiv) {
            addBtn.addEventListener('click', async () => {
              const conversationId = addBtn.dataset.conversationId;
              addBtn.disabled = true;
              addBtn.innerHTML = `
                <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Genereren...
              `;

              try {
                const response = await fetch('/api/admin/support/to-article', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ conversation_id: conversationId }),
                });

                const data = await response.json() as { error?: string; suggested_article?: { title_nl: string; category: string; tags: string[]; content_nl: string } };

                if (data.error) {
                  resultDiv.innerHTML = `
                    <div class="text-red-600 text-sm">
                      <strong>Fout:</strong> ${data.error}
                    </div>
                  `;
                } else if (data.suggested_article) {
                  const article = data.suggested_article;
                  resultDiv.innerHTML = `
                    <div class="space-y-3">
                      <h4 class="font-semibold text-gray-900">Voorgesteld artikel</h4>
                      <div>
                        <span class="text-xs text-gray-500 uppercase">Titel</span>
                        <p class="font-medium text-gray-900">${article.title_nl}</p>
                      </div>
                      <div>
                        <span class="text-xs text-gray-500 uppercase">Categorie</span>
                        <p class="text-gray-900">${article.category}</p>
                      </div>
                      <div>
                        <span class="text-xs text-gray-500 uppercase">Tags</span>
                        <p class="text-gray-900">${article.tags.join(', ')}</p>
                      </div>
                      <div>
                        <span class="text-xs text-gray-500 uppercase">Inhoud</span>
                        <p class="text-sm text-gray-700 mt-1 whitespace-pre-wrap max-h-40 overflow-y-auto">${article.content_nl}</p>
                      </div>
                      <div class="flex gap-2 pt-2">
                        <a
                          href="/admin/support/articles/new?prefill=${encodeURIComponent(JSON.stringify(article))}"
                          class="flex-1 px-3 py-2 text-center bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors text-sm font-medium"
                        >
                          Bewerken & Opslaan
                        </a>
                        <button
                          onclick="document.getElementById('knowledgeBaseResult').classList.add('hidden')"
                          class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm"
                        >
                          Sluiten
                        </button>
                      </div>
                    </div>
                  `;
                }

                resultDiv.classList.remove('hidden');
              } catch (err) {
                resultDiv.innerHTML = `
                  <div class="text-red-600 text-sm">
                    <strong>Fout:</strong> Kon niet genereren. Probeer het opnieuw.
                  </div>
                `;
                resultDiv.classList.remove('hidden');
              }

              addBtn.disabled = false;
              addBtn.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                Toevoegen aan Kennisbank
              `;
            });
          }
        </script>
      </>
    )}
  </div>
</Layout>
