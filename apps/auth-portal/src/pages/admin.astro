---
import Layout from '../layouts/Layout.astro';
import { Database, type CommunicationEventWithUser } from '../lib/database';
import { createOutreachEngine } from '../lib/outreach';

const env = Astro.locals.runtime?.env;
const db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

// Admin email check - set ADMIN_EMAILS in Cloudflare environment (comma-separated)
// Security: filter empty strings and default to DENY if ADMIN_EMAILS is not configured
const adminEmails = (env.ADMIN_EMAILS || '')
  .split(',')
  .map((e: string) => e.trim().toLowerCase())
  .filter((e: string) => e.length > 0); // Remove empty strings
const sessionId = Astro.cookies.get('session_id')?.value;

let isAdmin = false;
let currentUser: { id: string; email: string } | null = null;
let error: string | null = null;
let success: string | null = null;

// Validate session and check if admin
if (sessionId) {
  const sessionResult = await db.validateSession(sessionId);
  if (sessionResult) {
    const userEmail = sessionResult.user.email.toLowerCase();
    // Security: default deny - admin access requires explicit ADMIN_EMAILS configuration
    // If ADMIN_EMAILS is empty or not set, NO ONE has admin access
    isAdmin = adminEmails.length > 0 && adminEmails.includes(userEmail);
    currentUser = { id: sessionResult.user.id, email: sessionResult.user.email };

    if (!isAdmin) {
      error = 'Je hebt geen toegang tot deze pagina.';
    }
  } else {
    error = 'Niet ingelogd.';
  }
} else {
  error = 'Niet ingelogd.';
}

// Handle admin actions
if (isAdmin && Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action') as string;
  const userId = formData.get('userId') as string;

  try {
    switch (action) {
      case 'updatePlan': {
        const newPlan = formData.get('plan') as 'free' | 'starter' | 'pro' | 'enterprise';
        if (newPlan && ['free', 'starter', 'pro', 'enterprise'].includes(newPlan)) {
          await db.updateUserPlan(userId, newPlan);
          success = `Plan gewijzigd naar ${newPlan}`;
        }
        break;
      }
      case 'resetApiCalls': {
        await db.resetUserApiCalls(userId);
        success = 'API calls gereset naar 0';
        break;
      }
      case 'deleteUser': {
        if (userId !== currentUser?.id) {
          await db.deleteUser(userId);
          success = 'Gebruiker verwijderd';
        } else {
          error = 'Je kunt jezelf niet verwijderen';
        }
        break;
      }
    }
  } catch (e) {
    console.error('Admin action error:', e);
    error = 'Actie mislukt: ' + (e instanceof Error ? e.message : 'Onbekende fout');
  }
}

// Load data if admin
let stats: {
  totalUsers: number;
  usersByPlan: { plan: string; count: number }[];
  totalConnections: number;
  totalApiCalls: number;
  apiCallsToday: number;
  recentActivity: { endpoint: string; count: number }[];
} | null = null;

let allUsers: {
  id: string;
  email: string;
  name: string | null;
  plan: string;
  api_calls_used: number;
  created_at: string;
}[] = [];

// Outreach stats
let outreachStats = {
  activeCampaigns: 0,
  emailsSentToday: 0,
  emailsSentWeek: 0,
  openRate: 0,
};

// Communication stats
let recentCommunications: CommunicationEventWithUser[] = [];
let commStats = {
  totalToday: 0,
  emailsToday: 0,
  supportToday: 0,
  feedbackToday: 0,
};

if (isAdmin) {
  try {
    // Stats
    const totalUsersResult = await db.get<{ count: number }>('SELECT COUNT(*) as count FROM users');
    const usersByPlanResult = await db.all<{ plan: string; count: number }>(
      'SELECT plan, COUNT(*) as count FROM users GROUP BY plan'
    );
    const totalConnectionsResult = await db.get<{ count: number }>('SELECT COUNT(*) as count FROM connections');
    const totalApiCallsResult = await db.get<{ count: number }>('SELECT COUNT(*) as count FROM api_usage');
    const apiCallsTodayResult = await db.get<{ count: number }>(
      "SELECT COUNT(*) as count FROM api_usage WHERE timestamp > datetime('now', '-1 day')"
    );
    const recentActivityResult = await db.all<{ endpoint: string; count: number }>(
      "SELECT endpoint, COUNT(*) as count FROM api_usage WHERE timestamp > datetime('now', '-7 day') GROUP BY endpoint ORDER BY count DESC LIMIT 10"
    );

    stats = {
      totalUsers: totalUsersResult?.count || 0,
      usersByPlan: usersByPlanResult || [],
      totalConnections: totalConnectionsResult?.count || 0,
      totalApiCalls: totalApiCallsResult?.count || 0,
      apiCallsToday: apiCallsTodayResult?.count || 0,
      recentActivity: recentActivityResult || [],
    };

    // All users for management
    allUsers = await db.all<{
      id: string;
      email: string;
      name: string | null;
      plan: string;
      api_calls_used: number;
      created_at: string;
    }>('SELECT id, email, name, plan, api_calls_used, created_at FROM users ORDER BY created_at DESC');

    // Load outreach stats (wrapped in try-catch for graceful degradation if tables don't exist yet)
    try {
      const outreachEngine = createOutreachEngine(env.DB, env);
      outreachStats = await outreachEngine.getStats();
    } catch (outreachError) {
      console.warn('Outreach stats not available:', outreachError);
      // Keep default values
    }

    // Load recent communications (wrapped in try-catch for graceful degradation)
    try {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayStr = today.toISOString();

      // Get recent communications (last 15)
      const commResult = await db.getCommunicationEvents({ limit: 15 });
      recentCommunications = commResult.events;

      // Get today's stats
      const todayResult = await db.getCommunicationEvents({ startDate: todayStr });
      commStats.totalToday = todayResult.total;
      commStats.emailsToday = todayResult.events.filter(e => e.type === 'email').length;
      commStats.supportToday = todayResult.events.filter(e => e.type === 'support').length;
      commStats.feedbackToday = todayResult.events.filter(e => e.type === 'feedback').length;
    } catch (commError) {
      console.warn('Communication stats not available:', commError);
      // Keep default values - table might not exist yet
    }
  } catch (e) {
    console.error('Admin stats error:', e);
    error = 'Fout bij laden van data.';
  }
}

const planLimits: Record<string, number> = {
  free: 200,
  starter: 750,
  pro: 2500,
  enterprise: Infinity,
};

// Helper functions for communication display
function formatTimeAgo(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'zojuist';
  if (diffMins < 60) return `${diffMins}m`;
  if (diffHours < 24) return `${diffHours}u`;
  if (diffDays < 7) return `${diffDays}d`;
  return date.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
}

function getCommTypeIcon(type: string): string {
  switch (type) {
    case 'email': return 'M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z';
    case 'support': return 'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z';
    case 'feedback': return 'M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z';
    default: return 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';
  }
}

function getCommTypeColor(type: string): string {
  switch (type) {
    case 'email': return 'bg-blue-100 text-blue-600';
    case 'support': return 'bg-purple-100 text-purple-600';
    case 'feedback': return 'bg-amber-100 text-amber-600';
    default: return 'bg-gray-100 text-gray-600';
  }
}
---

<Layout title="Admin Dashboard">
  <div class="max-w-7xl mx-auto px-4 py-8">
    {error && !isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">{error}</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          ← Terug naar Dashboard
        </a>
      </div>
    ) : stats && (
      <>
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Admin Dashboard</h1>
            <p class="text-gray-600">Beheer gebruikers en bekijk statistieken</p>
          </div>
          <div class="flex items-center gap-3">
            {/* App Launcher - Google Style */}
            <div class="relative" id="appLauncherContainer">
              <button
                type="button"
                id="appLauncherBtn"
                class="p-2 rounded-full hover:bg-gray-100 transition-colors"
                aria-label="Admin secties"
                title="Admin secties"
              >
                <svg class="w-6 h-6 text-gray-600" viewBox="0 0 24 24" fill="currentColor">
                  <circle cx="5" cy="5" r="2" />
                  <circle cx="12" cy="5" r="2" />
                  <circle cx="19" cy="5" r="2" />
                  <circle cx="5" cy="12" r="2" />
                  <circle cx="12" cy="12" r="2" />
                  <circle cx="19" cy="12" r="2" />
                  <circle cx="5" cy="19" r="2" />
                  <circle cx="12" cy="19" r="2" />
                  <circle cx="19" cy="19" r="2" />
                </svg>
              </button>

              {/* Dropdown */}
              <div
                id="appLauncherDropdown"
                class="absolute right-0 top-full mt-2 w-80 bg-white rounded-2xl shadow-xl border border-gray-200 p-4 hidden z-50"
              >
                <div class="grid grid-cols-3 gap-2">
                  <a href="/admin/demo" class="flex flex-col items-center p-3 rounded-xl hover:bg-orange-50 transition-colors group">
                    <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-amber-500 rounded-xl flex items-center justify-center mb-2 group-hover:scale-105 transition-transform">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 text-center">Demo</span>
                  </a>

                  <a href="/admin/support" class="flex flex-col items-center p-3 rounded-xl hover:bg-purple-50 transition-colors group">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-blue-500 rounded-xl flex items-center justify-center mb-2 group-hover:scale-105 transition-transform">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 text-center">AI Support</span>
                  </a>

                  <a href="/admin/support/conversations" class="flex flex-col items-center p-3 rounded-xl hover:bg-green-50 transition-colors group">
                    <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center mb-2 group-hover:scale-105 transition-transform">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 text-center">Gesprekken</span>
                  </a>

                  <a href="/admin/feedback" class="flex flex-col items-center p-3 rounded-xl hover:bg-amber-50 transition-colors group">
                    <div class="w-12 h-12 bg-gradient-to-br from-amber-400 to-yellow-500 rounded-xl flex items-center justify-center mb-2 group-hover:scale-105 transition-transform">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 text-center">Feedback</span>
                  </a>

                  <a href="/admin/inbox" class="flex flex-col items-center p-3 rounded-xl hover:bg-indigo-50 transition-colors group">
                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center mb-2 group-hover:scale-105 transition-transform">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 text-center">Inbox</span>
                  </a>

                  <a href="/admin/emails" class="flex flex-col items-center p-3 rounded-xl hover:bg-blue-50 transition-colors group">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center mb-2 group-hover:scale-105 transition-transform">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 text-center">Emails</span>
                  </a>

                  <a href="/admin/outreach" class="flex flex-col items-center p-3 rounded-xl hover:bg-teal-50 transition-colors group">
                    <div class="w-12 h-12 bg-gradient-to-br from-teal-500 to-cyan-500 rounded-xl flex items-center justify-center mb-2 group-hover:scale-105 transition-transform">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 text-center">Outreach</span>
                  </a>

                  <a href="/admin/settings" class="flex flex-col items-center p-3 rounded-xl hover:bg-gray-100 transition-colors group">
                    <div class="w-12 h-12 bg-gradient-to-br from-gray-500 to-gray-600 rounded-xl flex items-center justify-center mb-2 group-hover:scale-105 transition-transform">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 text-center">Instellingen</span>
                  </a>

                  <a href="/dashboard" class="flex flex-col items-center p-3 rounded-xl hover:bg-exact-light transition-colors group">
                    <div class="w-12 h-12 bg-gradient-to-br from-exact-blue to-exact-dark rounded-xl flex items-center justify-center mb-2 group-hover:scale-105 transition-transform">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 text-center">Dashboard</span>
                  </a>
                </div>
              </div>
            </div>

            <a href="/dashboard" class="text-gray-600 hover:text-gray-900 text-sm">
              ← Terug
            </a>
          </div>
        </div>

        {/* Notifications */}
        {success && (
          <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-green-700">{success}</p>
          </div>
        )}
        {error && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-700">{error}</p>
          </div>
        )}

        {/* Stats Cards */}
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500">Gebruikers</h3>
            <p class="text-3xl font-bold text-gray-900 mt-2">{stats.totalUsers}</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500">Connecties</h3>
            <p class="text-3xl font-bold text-gray-900 mt-2">{stats.totalConnections}</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500">API Calls (24u)</h3>
            <p class="text-3xl font-bold text-gray-900 mt-2">{stats.apiCallsToday.toLocaleString()}</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500">API Calls (Totaal)</h3>
            <p class="text-3xl font-bold text-gray-900 mt-2">{stats.totalApiCalls.toLocaleString()}</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-medium text-gray-500">Per Plan</h3>
            <div class="mt-2 text-sm">
              {stats.usersByPlan.map(({ plan, count }) => (
                <span class="mr-2">
                  <span class="font-semibold">{count}</span>
                  <span class="text-gray-500 capitalize"> {plan}</span>
                </span>
              ))}
            </div>
          </div>
        </div>

        {/* Recent Communications Widget */}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-8">
          <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
              </div>
              <div>
                <h2 class="text-lg font-semibold text-gray-900">Recente Communicatie</h2>
                <p class="text-sm text-gray-500">
                  Vandaag: {commStats.totalToday} totaal
                  {commStats.emailsToday > 0 && <span class="ml-2">• {commStats.emailsToday} emails</span>}
                  {commStats.supportToday > 0 && <span class="ml-2">• {commStats.supportToday} support</span>}
                  {commStats.feedbackToday > 0 && <span class="ml-2">• {commStats.feedbackToday} feedback</span>}
                </p>
              </div>
            </div>
          </div>

          {recentCommunications.length > 0 ? (
            <div class="divide-y divide-gray-50">
              {recentCommunications.slice(0, 10).map((comm) => (
                <a
                  href={`/admin/customer/${comm.user_id}`}
                  class="flex items-center gap-3 p-3 hover:bg-gray-50 transition-colors"
                >
                  {/* Type Icon */}
                  <div class={`p-2 rounded-lg flex-shrink-0 ${getCommTypeColor(comm.type)}`}>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={getCommTypeIcon(comm.type)} />
                    </svg>
                  </div>

                  {/* Content */}
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-gray-900 text-sm truncate">
                        {comm.user_email || 'Onbekend'}
                      </span>
                      <span class={`px-1.5 py-0.5 rounded text-xs ${
                        comm.direction === 'in' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'
                      }`}>
                        {comm.direction === 'in' ? '←' : '→'}
                      </span>
                    </div>
                    <p class="text-gray-600 text-xs truncate">
                      {comm.subject || comm.content.substring(0, 60)}
                    </p>
                  </div>

                  {/* Time */}
                  <span class="text-xs text-gray-400 flex-shrink-0">
                    {formatTimeAgo(comm.created_at)}
                  </span>
                </a>
              ))}
            </div>
          ) : (
            <div class="p-8 text-center text-gray-500">
              <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
              <p class="text-sm">Nog geen communicatie</p>
              <p class="text-xs text-gray-400 mt-1">Communicatie verschijnt hier zodra klanten contact opnemen</p>
            </div>
          )}
        </div>

        {/* User Management */}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Gebruikersbeheer</h2>

          {allUsers.length > 0 ? (
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-2 font-medium text-gray-500">Email</th>
                    <th class="text-left py-3 px-2 font-medium text-gray-500">Plan</th>
                    <th class="text-left py-3 px-2 font-medium text-gray-500">API Calls</th>
                    <th class="text-left py-3 px-2 font-medium text-gray-500">Aangemeld</th>
                    <th class="text-right py-3 px-2 font-medium text-gray-500">Acties</th>
                  </tr>
                </thead>
                <tbody>
                  {allUsers.map(user => {
                    const limit = planLimits[user.plan] || 200;
                    const usagePercent = limit === Infinity ? 0 : Math.round((user.api_calls_used / limit) * 100);
                    const isCurrentUser = user.id === currentUser?.id;

                    return (
                      <tr class="border-b border-gray-50 hover:bg-gray-50">
                        <td class="py-3 px-2">
                          <div class="font-medium text-gray-900">{user.email}</div>
                          {user.name && <div class="text-gray-500 text-xs">{user.name}</div>}
                          {isCurrentUser && <span class="text-xs text-blue-600">(jij)</span>}
                        </td>
                        <td class="py-3 px-2">
                          <form method="POST" class="inline">
                            <input type="hidden" name="action" value="updatePlan" />
                            <input type="hidden" name="userId" value={user.id} />
                            <select
                              name="plan"
                              onchange="this.form.submit()"
                              class={`text-xs font-medium px-2 py-1 rounded-full border-0 cursor-pointer ${
                                user.plan === 'enterprise' ? 'bg-purple-100 text-purple-800' :
                                user.plan === 'pro' ? 'bg-blue-100 text-blue-800' :
                                user.plan === 'starter' ? 'bg-green-100 text-green-800' :
                                'bg-gray-100 text-gray-800'
                              }`}
                            >
                              <option value="free" selected={user.plan === 'free'}>Free</option>
                              <option value="starter" selected={user.plan === 'starter'}>Starter</option>
                              <option value="pro" selected={user.plan === 'pro'}>Pro</option>
                              <option value="enterprise" selected={user.plan === 'enterprise'}>Enterprise</option>
                            </select>
                          </form>
                        </td>
                        <td class="py-3 px-2">
                          <div class="flex items-center gap-2">
                            <span class="text-gray-900">{user.api_calls_used.toLocaleString()}</span>
                            <span class="text-gray-400">/</span>
                            <span class="text-gray-500">
                              {limit === Infinity ? '∞' : limit.toLocaleString()}
                            </span>
                            {usagePercent > 80 && (
                              <span class="text-xs text-orange-600">({usagePercent}%)</span>
                            )}
                          </div>
                        </td>
                        <td class="py-3 px-2 text-gray-500">
                          {new Date(user.created_at).toLocaleDateString('nl-NL')}
                        </td>
                        <td class="py-3 px-2 text-right">
                          <div class="flex justify-end gap-2">
                            {/* View Customer Timeline (COMM-002) */}
                            <a
                              href={`/admin/customer/${user.id}`}
                              class="text-xs px-2 py-1 text-purple-600 hover:bg-purple-50 rounded"
                              title="Bekijk klant timeline"
                            >
                              Timeline
                            </a>

                            {/* Reset API Calls */}
                            <form method="POST" class="inline">
                              <input type="hidden" name="action" value="resetApiCalls" />
                              <input type="hidden" name="userId" value={user.id} />
                              <button
                                type="submit"
                                class="text-xs px-2 py-1 text-blue-600 hover:bg-blue-50 rounded"
                                title="Reset API calls naar 0"
                              >
                                Reset
                              </button>
                            </form>

                            {/* Delete User */}
                            {!isCurrentUser && (
                              <form method="POST" class="inline" onsubmit="return confirm('Weet je zeker dat je deze gebruiker wilt verwijderen? Dit kan niet ongedaan worden gemaakt.')">
                                <input type="hidden" name="action" value="deleteUser" />
                                <input type="hidden" name="userId" value={user.id} />
                                <button
                                  type="submit"
                                  class="text-xs px-2 py-1 text-red-600 hover:bg-red-50 rounded"
                                  title="Verwijder gebruiker"
                                >
                                  Verwijder
                                </button>
                              </form>
                            )}
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          ) : (
            <p class="text-gray-500">Nog geen gebruikers</p>
          )}
        </div>

        {/* API Activity */}
        <div class="grid md:grid-cols-2 gap-6 mb-8">
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">API Activiteit (7 dagen)</h2>
            {stats.recentActivity.length > 0 ? (
              <div class="space-y-2">
                {stats.recentActivity.map(({ endpoint, count }) => (
                  <div class="flex items-center justify-between">
                    <code class="text-sm text-gray-700">{endpoint}</code>
                    <span class="text-gray-600">{count}</span>
                  </div>
                ))}
              </div>
            ) : (
              <p class="text-gray-500">Nog geen API activiteit</p>
            )}
          </div>

          {/* System Status */}
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Systeem Status</h2>
            <div class="space-y-3">
              <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                <span class="w-3 h-3 bg-green-500 rounded-full mr-3"></span>
                <div>
                  <p class="font-medium text-gray-900">Database</p>
                  <p class="text-sm text-gray-500">Cloudflare D1</p>
                </div>
              </div>
              <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                <span class={`w-3 h-3 rounded-full mr-3 ${env.EXACT_CLIENT_ID ? 'bg-green-500' : 'bg-yellow-500'}`}></span>
                <div>
                  <p class="font-medium text-gray-900">Exact Online OAuth</p>
                  <p class="text-sm text-gray-500">{env.EXACT_CLIENT_ID ? 'Geconfigureerd' : 'Niet geconfigureerd'}</p>
                </div>
              </div>
              <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                <span class={`w-3 h-3 rounded-full mr-3 ${env.TOKEN_ENCRYPTION_KEY ? 'bg-green-500' : 'bg-yellow-500'}`}></span>
                <div>
                  <p class="font-medium text-gray-900">Token Encryptie</p>
                  <p class="text-sm text-gray-500">{env.TOKEN_ENCRYPTION_KEY ? 'Actief (AES-256-GCM)' : 'Niet actief'}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Admin Sections */}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Admin Secties</h2>
          <div class="grid md:grid-cols-2 gap-4">
            <a
              href="/admin/demo"
              class="flex items-center p-4 bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-xl hover:from-orange-100 hover:to-amber-100 transition-colors group"
            >
              <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-4 group-hover:bg-orange-200 transition-colors">
                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-gray-900">Demo Mode</h3>
                <p class="text-sm text-gray-600">4 fictieve bedrijven, 46 tools, geen Exact koppeling nodig</p>
              </div>
              <svg class="w-5 h-5 text-gray-400 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
            <a
              href="/admin/support"
              class="flex items-center p-4 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-xl hover:from-purple-100 hover:to-blue-100 transition-colors group"
            >
              <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4 group-hover:bg-purple-200 transition-colors">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-gray-900">AI Support Beheer</h3>
                <p class="text-sm text-gray-600">Automation, patronen, kennisbank & instellingen</p>
              </div>
              <svg class="w-5 h-5 text-gray-400 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
            <a
              href="/admin/support/conversations"
              class="flex items-center p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl hover:from-green-100 hover:to-emerald-100 transition-colors group"
            >
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4 group-hover:bg-green-200 transition-colors">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-gray-900">Support Gesprekken</h3>
                <p class="text-sm text-gray-600">Bekijk en beheer alle klantgesprekken</p>
              </div>
              <svg class="w-5 h-5 text-gray-400 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
            <a
              href="/admin/feedback"
              class="flex items-center p-4 bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200 rounded-xl hover:from-amber-100 hover:to-yellow-100 transition-colors group"
            >
              <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center mr-4 group-hover:bg-amber-200 transition-colors">
                <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-gray-900">Feedback & NPS</h3>
                <p class="text-sm text-gray-600">Feedback, testimonials en NPS scores</p>
              </div>
              <svg class="w-5 h-5 text-gray-400 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
            <a
              href="/admin/emails"
              class="flex items-center p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl hover:from-blue-100 hover:to-indigo-100 transition-colors group"
            >
              <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4 group-hover:bg-blue-200 transition-colors">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-gray-900">Email Logs</h3>
                <p class="text-sm text-gray-600">Overzicht van alle verzonden emails</p>
              </div>
              <svg class="w-5 h-5 text-gray-400 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
            <a
              href="/admin/outreach"
              class="flex items-center p-4 bg-gradient-to-r from-teal-50 to-cyan-50 border border-teal-200 rounded-xl hover:from-teal-100 hover:to-cyan-100 transition-colors group"
            >
              <div class="w-12 h-12 bg-teal-100 rounded-lg flex items-center justify-center mr-4 group-hover:bg-teal-200 transition-colors">
                <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-gray-900">Proactive Outreach</h3>
                <p class="text-sm text-gray-600">
                  {outreachStats.activeCampaigns} actief, {outreachStats.emailsSentToday} vandaag, {outreachStats.openRate.toFixed(0)}% open
                </p>
              </div>
              <svg class="w-5 h-5 text-gray-400 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          </div>
        </div>

        {/* Quick Links */}
        <div class="p-6 bg-gray-50 rounded-xl">
          <h3 class="font-semibold text-gray-900 mb-4">Externe Dashboards</h3>
          <div class="flex flex-wrap gap-4">
            <a
              href="https://dash.cloudflare.com"
              target="_blank"
              rel="noopener"
              class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
            >
              Cloudflare Dashboard →
            </a>
            <a
              href="https://dashboard.stripe.com"
              target="_blank"
              rel="noopener"
              class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
            >
              Stripe Dashboard →
            </a>
            <a
              href="https://github.com/werkenmetai/Exact-online-MCP"
              target="_blank"
              rel="noopener"
              class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
            >
              GitHub Repo →
            </a>
          </div>
        </div>
      </>
    )}
  </div>

  <script>
    // App Launcher Dropdown
    const launcherBtn = document.getElementById('appLauncherBtn');
    const launcherDropdown = document.getElementById('appLauncherDropdown');
    const launcherContainer = document.getElementById('appLauncherContainer');

    function toggleDropdown() {
      launcherDropdown?.classList.toggle('hidden');
    }

    function closeDropdown() {
      launcherDropdown?.classList.add('hidden');
    }

    launcherBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleDropdown();
    });

    // Close on click outside
    document.addEventListener('click', (e) => {
      if (launcherContainer && !launcherContainer.contains(e.target as Node)) {
        closeDropdown();
      }
    });

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeDropdown();
      }
    });
  </script>
</Layout>
