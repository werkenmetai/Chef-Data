---
/**
 * Exact Online App Centre Review Checklist
 *
 * Verzamelt alle vereisten voor de Exact Online App Store goedkeuring.
 */
import Layout from '../../layouts/Layout.astro';
import { Database } from '../../lib/database';
// AdminAppLauncher now in Layout.astro header

const env = Astro.locals.runtime?.env;
let db: Database | null = null;
let isAdmin = false;
let userCount = 0;
let connectionCount = 0;

try {
  if (env?.DB) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());

        if (isAdmin) {
          // Get some stats
          const usersResult = await env.DB.prepare('SELECT COUNT(*) as count FROM users').first<{ count: number }>();
          userCount = usersResult?.count || 0;

          const connectionsResult = await env.DB.prepare('SELECT COUNT(*) as count FROM connections WHERE status = ?').bind('active').first<{ count: number }>();
          connectionCount = connectionsResult?.count || 0;
        }
      }
    }
  }
} catch (e) {
  console.error('Exact check error:', e);
}

// Checklist items met status
interface CheckItem {
  id: string;
  title: string;
  description: string;
  status: 'done' | 'partial' | 'todo' | 'na';
  details?: string;
  action?: string;
  actionUrl?: string;
}

interface CheckSection {
  title: string;
  icon: string;
  items: CheckItem[];
}

const sections: CheckSection[] = [
  {
    title: 'Stap 1: Data & Security Review',
    icon: 'üîí',
    items: [
      {
        id: 'doel',
        title: 'App Doel',
        description: 'Korte beschrijving wat de app doet (1-2 zinnen)',
        status: 'done',
        details: 'Praat met je Boekhouding koppelt Exact Online aan AI-assistenten zoals ChatGPT en Claude, zodat gebruikers in natuurlijke taal vragen kunnen stellen over hun boekhouding.',
      },
      {
        id: 'scopes',
        title: 'API Scopes',
        description: 'Welke Exact Online domeinen gebruikt de app en met welke rechten (Read/Write)',
        status: 'done',
        details: `READ-ONLY toegang tot:
‚Ä¢ Financial (Grootboek, Journaalposten)
‚Ä¢ CRM (Relaties, Contacten)
‚Ä¢ Sales (Facturen, Orders)
‚Ä¢ Purchase (Inkoopfacturen)
‚Ä¢ Logistics (Artikelen, Voorraad)
‚Ä¢ Projects (Projecten, Uren)

GEEN write/manage rechten - alleen lezen.`,
      },
      {
        id: 'third-party',
        title: 'Verbindingen met Derden',
        description: 'Externe services die klantdata verwerken',
        status: 'done',
        details: `‚Ä¢ Cloudflare Workers (hosting) - EU region
‚Ä¢ Cloudflare D1 (database) - alleen session/user data, GEEN Exact data
‚Ä¢ AI providers (OpenAI/Anthropic) - data wordt NIET opgeslagen door ons, gebruiker verbindt direct

Exact Online data wordt NIET opgeslagen of gecached.`,
      },
      {
        id: 'encryption-transit',
        title: 'Encryptie in Transit',
        description: 'Is data beschermd tijdens transport?',
        status: 'done',
        details: 'Ja - Alle verbindingen via HTTPS/TLS 1.3. Cloudflare SSL certificaat.',
      },
      {
        id: 'encryption-rest',
        title: 'Encryptie at Rest',
        description: 'Is opgeslagen data versleuteld?',
        status: 'done',
        details: 'Ja - OAuth tokens versleuteld met AES-256-GCM. Database via Cloudflare D1 (encrypted at rest). Exact Online data wordt NIET opgeslagen.',
      },
      {
        id: 'access-control',
        title: 'Toegangscontrole',
        description: 'Hoe wordt ongeautoriseerde toegang voorkomen?',
        status: 'done',
        details: `‚Ä¢ OAuth 2.0 authenticatie met Exact Online
‚Ä¢ Session-based auth met secure cookies
‚Ä¢ Tokens verlopen automatisch (30 dagen)
‚Ä¢ Refresh tokens encrypted opgeslagen
‚Ä¢ Gebruiker kan verbinding altijd intrekken`,
      },
      {
        id: 'version-control',
        title: 'Versiebeheer',
        description: 'Is er version control voor code changes?',
        status: 'done',
        details: 'Ja - Git (GitHub) met branch protection, code reviews, en automated CI/CD via GitHub Actions.',
      },
      {
        id: 'change-management',
        title: 'Change Management',
        description: 'Hoe worden wijzigingen getest en uitgerold?',
        status: 'done',
        details: `‚Ä¢ Feature branches met pull requests
‚Ä¢ Automated tests (unit, integration)
‚Ä¢ Staging environment voor testing
‚Ä¢ Gradual rollout mogelijk
‚Ä¢ Rollback procedure beschikbaar`,
      },
    ],
  },
  {
    title: 'Stap 2: App Store Marketing',
    icon: 'üé®',
    items: [
      {
        id: 'app-name',
        title: 'App Naam',
        description: 'Naam zoals getoond in App Store',
        status: 'done',
        details: 'Praat met je Boekhouding',
      },
      {
        id: 'short-description',
        title: 'Korte Beschrijving',
        description: 'Max 150 karakters voor zoekresultaten',
        status: 'todo',
        details: '',
        action: 'Schrijven',
      },
      {
        id: 'long-description',
        title: 'Lange Beschrijving',
        description: 'Volledige beschrijving voor app pagina',
        status: 'todo',
        details: '',
        action: 'Schrijven',
      },
      {
        id: 'logo',
        title: 'App Logo',
        description: '512x512 pixels, PNG of JPG',
        status: 'todo',
        details: '',
        action: 'Maken/uploaden',
      },
      {
        id: 'screenshots',
        title: 'Screenshots',
        description: 'Minimaal 3, aanbevolen 1280x800 pixels',
        status: 'todo',
        details: 'Screenshots nodig van: Dashboard, Chat interface, Verbindingsflow',
        action: 'Maken',
      },
      {
        id: 'categories',
        title: 'Categorie√´n',
        description: 'Juiste categorie√´n selecteren',
        status: 'partial',
        details: 'Suggestie: Rapportage, Business Intelligence, AI/Automatisering',
      },
      {
        id: 'pricing-info',
        title: 'Prijsinformatie',
        description: 'Prijsmodel voor App Store',
        status: 'done',
        details: 'Gratis (‚Ç¨0, ~60 vragen) + Starter (‚Ç¨9) + Pro (‚Ç¨25) + Enterprise (op aanvraag)',
        actionUrl: '/pricing',
      },
      {
        id: 'support-url',
        title: 'Support URL',
        description: 'Link naar support/help pagina',
        status: 'done',
        details: 'https://praatmetjeboekhouding.nl/support',
        actionUrl: '/support',
      },
      {
        id: 'privacy-url',
        title: 'Privacy Policy URL',
        description: 'Link naar privacy beleid',
        status: 'done',
        details: 'https://praatmetjeboekhouding.nl/privacy',
        actionUrl: '/privacy',
      },
      {
        id: 'terms-url',
        title: 'Algemene Voorwaarden URL',
        description: 'Link naar terms of service',
        status: 'done',
        details: 'https://praatmetjeboekhouding.nl/terms',
        actionUrl: '/terms',
      },
    ],
  },
  {
    title: 'Stap 3: Technische Vereisten',
    icon: '‚öôÔ∏è',
    items: [
      {
        id: 'oauth-impl',
        title: 'OAuth 2.0 Implementatie',
        description: 'Correcte OAuth flow met Exact Online',
        status: 'done',
        details: 'Authorization Code flow ge√Ømplementeerd met PKCE. Refresh token rotation.',
      },
      {
        id: 'rate-limits',
        title: 'API Rate Limits',
        description: 'Respecteert 60/min en 5000/dag per bedrijf',
        status: 'done',
        details: 'Rate limiting ge√Ømplementeerd. Retry logic met exponential backoff.',
      },
      {
        id: 'error-handling',
        title: 'Error Handling',
        description: 'Graceful handling van API errors',
        status: 'done',
        details: 'Alle API calls hebben try/catch. Gebruiksvriendelijke foutmeldingen.',
      },
      {
        id: 'token-refresh',
        title: 'Token Refresh',
        description: 'Automatisch vernieuwen van verlopen tokens',
        status: 'done',
        details: 'Automatic token refresh voor verlopen access tokens.',
      },
      {
        id: 'multi-tenant',
        title: 'Multi-tenant Support',
        description: 'Ondersteuning voor meerdere Exact administraties',
        status: 'done',
        details: 'Gebruikers kunnen meerdere administraties koppelen.',
      },
      {
        id: 'consent-screen',
        title: 'Consent Screen',
        description: 'Duidelijk toestemmingsscherm bij eerste gebruik',
        status: 'done',
        details: 'Exact Online consent screen + eigen TOS acceptatie.',
        actionUrl: '/connect',
      },
    ],
  },
  {
    title: 'Stap 4: Demo & Goedkeuring',
    icon: '‚úÖ',
    items: [
      {
        id: 'demo-account',
        title: 'Demo Account',
        description: 'Test account voor Exact partnermanager',
        status: 'todo',
        details: 'Maak een demo account aan met voorbeelddata',
        action: 'Aanmaken',
      },
      {
        id: 'demo-script',
        title: 'Demo Script',
        description: 'Scenario voor demonstratie',
        status: 'todo',
        details: 'Schrijf een script met use cases om te demonstreren',
        action: 'Schrijven',
      },
      {
        id: 'contact-exact',
        title: 'Contact Partnermanager',
        description: 'Afspraak maken voor review',
        status: 'todo',
        details: 'Neem contact op met Exact partnermanager voor demo afspraak',
        action: 'Contact opnemen',
      },
      {
        id: 'billing-setup',
        title: 'Facturatie Gegevens',
        description: 'Bedrijfsgegevens en betaalinfo voor partner fee',
        status: 'todo',
        details: 'KvK, BTW-nummer, IBAN voor domicili√´ring',
        action: 'Invullen',
      },
    ],
  },
];

// Calculate totals
const allItems = sections.flatMap(s => s.items);
const doneCount = allItems.filter(i => i.status === 'done').length;
const partialCount = allItems.filter(i => i.status === 'partial').length;
const todoCount = allItems.filter(i => i.status === 'todo').length;
const totalCount = allItems.length;
const progressPercent = Math.round(((doneCount + partialCount * 0.5) / totalCount) * 100);

const statusStyles = {
  done: { bg: 'bg-green-100', text: 'text-green-800', icon: '‚úì', label: 'Klaar' },
  partial: { bg: 'bg-yellow-100', text: 'text-yellow-800', icon: '‚óê', label: 'Deels' },
  todo: { bg: 'bg-red-100', text: 'text-red-800', icon: '‚óã', label: 'Todo' },
  na: { bg: 'bg-gray-100', text: 'text-gray-600', icon: '‚Äî', label: 'N.v.t.' },
};
---

<Layout title="Exact Check - App Store Review">
  <div class="max-w-5xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          ‚Üê Terug naar Dashboard
        </a>
      </div>
    ) : (
      <>
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Exact Check</h1>
            <p class="text-gray-600">Checklist voor Exact Online App Store goedkeuring</p>
          </div>
          <a href="/dashboard" class="text-gray-600 hover:text-gray-900">
            ‚Üê Dashboard
          </a>
        </div>

        <!-- Progress Overview -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Voortgang</h2>
            <span class="text-2xl font-bold text-exact-blue">{progressPercent}%</span>
          </div>

          <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
            <div
              class="bg-exact-blue h-4 rounded-full transition-all duration-500"
              style={`width: ${progressPercent}%`}
            ></div>
          </div>

          <div class="grid grid-cols-3 gap-4 text-center">
            <div class="bg-green-50 rounded-lg p-3">
              <p class="text-2xl font-bold text-green-600">{doneCount}</p>
              <p class="text-sm text-green-700">Klaar</p>
            </div>
            <div class="bg-yellow-50 rounded-lg p-3">
              <p class="text-2xl font-bold text-yellow-600">{partialCount}</p>
              <p class="text-sm text-yellow-700">Deels klaar</p>
            </div>
            <div class="bg-red-50 rounded-lg p-3">
              <p class="text-2xl font-bold text-red-600">{todoCount}</p>
              <p class="text-sm text-red-700">Te doen</p>
            </div>
          </div>
        </div>

        <!-- Current Stats -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-8">
          <h3 class="font-semibold text-blue-900 mb-2">Huidige Status</h3>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span class="text-blue-700">Gebruikers:</span>
              <span class="font-medium text-blue-900 ml-2">{userCount}</span>
            </div>
            <div>
              <span class="text-blue-700">Actieve verbindingen:</span>
              <span class="font-medium text-blue-900 ml-2">{connectionCount}</span>
            </div>
          </div>
          <p class="text-xs text-blue-600 mt-2">
            Let op: Voordat de app is goedgekeurd door Exact, kunnen alleen gebruikers uit dezelfde Exact instance verbinden.
          </p>
        </div>

        <!-- Sections -->
        {sections.map((section, sectionIndex) => {
          const sectionDone = section.items.filter(i => i.status === 'done').length;
          const sectionTotal = section.items.length;

          return (
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6 overflow-hidden">
              <div class="bg-gray-50 px-6 py-4 border-b border-gray-100">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <span class="text-2xl">{section.icon}</span>
                    <h2 class="text-lg font-semibold text-gray-900">{section.title}</h2>
                  </div>
                  <span class="text-sm text-gray-500">
                    {sectionDone}/{sectionTotal} klaar
                  </span>
                </div>
              </div>

              <div class="divide-y divide-gray-100">
                {section.items.map((item) => {
                  const style = statusStyles[item.status];
                  return (
                    <div class="px-6 py-4 hover:bg-gray-50 transition-colors">
                      <div class="flex items-start gap-4">
                        <div class={`flex-shrink-0 w-8 h-8 rounded-full ${style.bg} flex items-center justify-center`}>
                          <span class={`text-sm font-bold ${style.text}`}>{style.icon}</span>
                        </div>

                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-medium text-gray-900">{item.title}</h3>
                            <span class={`px-2 py-0.5 text-xs rounded ${style.bg} ${style.text}`}>
                              {style.label}
                            </span>
                          </div>
                          <p class="text-sm text-gray-500 mb-2">{item.description}</p>

                          {item.details && (
                            <div class="bg-gray-50 rounded-lg p-3 text-sm">
                              <pre class="whitespace-pre-wrap text-gray-700 font-mono text-xs">{item.details}</pre>
                            </div>
                          )}

                          {(item.action || item.actionUrl) && (
                            <div class="mt-2 flex gap-2">
                              {item.action && (
                                <button
                                  type="button"
                                  class="px-3 py-1 text-xs bg-exact-blue text-white rounded hover:bg-exact-dark transition-colors"
                                  data-item-id={item.id}
                                >
                                  {item.action}
                                </button>
                              )}
                              {item.actionUrl && (
                                <a
                                  href={item.actionUrl}
                                  target="_blank"
                                  class="px-3 py-1 text-xs border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors"
                                >
                                  Bekijken ‚Üí
                                </a>
                              )}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          );
        })}

        <!-- Security Review Vragen (collapsed) -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6 overflow-hidden">
          <button
            type="button"
            class="w-full bg-gray-50 px-6 py-4 border-b border-gray-100 flex items-center justify-between hover:bg-gray-100 transition-colors"
            id="securityToggle"
          >
            <div class="flex items-center gap-3">
              <span class="text-2xl">üõ°Ô∏è</span>
              <h2 class="text-lg font-semibold text-gray-900">Mogelijke Security Review Vragen</h2>
            </div>
            <svg class="w-5 h-5 text-gray-500 transform transition-transform" id="securityArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div id="securityContent" class="hidden">
            <div class="p-6 space-y-6">
              <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                <p class="text-sm text-amber-800">
                  Dit zijn typische vragen die Exact stelt tijdens de Data & Security Review. Bereid je antwoorden voor.
                </p>
              </div>

              <div class="space-y-4">
                <div class="border-l-4 border-exact-blue pl-4">
                  <h4 class="font-medium text-gray-900 mb-1">Is data beschermd tegen ongeautoriseerde toegang?</h4>
                  <p class="text-sm text-gray-600">
                    <strong>Antwoord:</strong> Ja. Alle data in transit is versleuteld met TLS 1.3. OAuth tokens zijn encrypted met AES-256-GCM. Exact Online data wordt niet opgeslagen, alleen doorgegeven aan de AI.
                  </p>
                </div>

                <div class="border-l-4 border-exact-blue pl-4">
                  <h4 class="font-medium text-gray-900 mb-1">Welke data wordt opgeslagen en voor hoe lang?</h4>
                  <p class="text-sm text-gray-600">
                    <strong>Antwoord:</strong> Alleen: gebruikersaccount (email, naam), OAuth refresh tokens (encrypted), en session data. Exact Online data wordt NIET opgeslagen. Tokens verlopen na 30 dagen.
                  </p>
                </div>

                <div class="border-l-4 border-exact-blue pl-4">
                  <h4 class="font-medium text-gray-900 mb-1">Hoe kan een gebruiker zijn data verwijderen?</h4>
                  <p class="text-sm text-gray-600">
                    <strong>Antwoord:</strong> Gebruiker kan verbinding intrekken via dashboard. Account verwijderen via support. Alle data wordt dan permanent verwijderd.
                  </p>
                </div>

                <div class="border-l-4 border-exact-blue pl-4">
                  <h4 class="font-medium text-gray-900 mb-1">Wordt data gedeeld met derden?</h4>
                  <p class="text-sm text-gray-600">
                    <strong>Antwoord:</strong> Exact Online data wordt alleen gedeeld met de AI-provider die de gebruiker zelf configureert (OpenAI/Anthropic). Wij slaan deze data niet op en hebben er geen toegang toe.
                  </p>
                </div>

                <div class="border-l-4 border-exact-blue pl-4">
                  <h4 class="font-medium text-gray-900 mb-1">Hoe wordt version control toegepast?</h4>
                  <p class="text-sm text-gray-600">
                    <strong>Antwoord:</strong> Git via GitHub met branch protection. Alle changes via pull requests met code review. Automated tests moeten slagen. CI/CD pipeline voor deployments.
                  </p>
                </div>

                <div class="border-l-4 border-exact-blue pl-4">
                  <h4 class="font-medium text-gray-900 mb-1">Wat zijn de API rate limits?</h4>
                  <p class="text-sm text-gray-600">
                    <strong>Antwoord:</strong> Wij respecteren de Exact Online limits (60/min, 5000/dag per bedrijf). Onze app implementeert rate limiting en retry logic met exponential backoff.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Next Steps -->
        <div class="bg-gradient-to-r from-exact-blue to-exact-dark rounded-xl p-6 text-white">
          <h2 class="text-xl font-bold mb-4">Volgende Stappen</h2>
          <ol class="space-y-3">
            <li class="flex items-start gap-3">
              <span class="flex-shrink-0 w-6 h-6 bg-white/20 rounded-full flex items-center justify-center text-sm">1</span>
              <span>Marketing content maken (beschrijvingen, logo, screenshots)</span>
            </li>
            <li class="flex items-start gap-3">
              <span class="flex-shrink-0 w-6 h-6 bg-white/20 rounded-full flex items-center justify-center text-sm">2</span>
              <span>Demo account en script voorbereiden</span>
            </li>
            <li class="flex items-start gap-3">
              <span class="flex-shrink-0 w-6 h-6 bg-white/20 rounded-full flex items-center justify-center text-sm">3</span>
              <span>Data & Security Review formulier invullen in App Centre</span>
            </li>
            <li class="flex items-start gap-3">
              <span class="flex-shrink-0 w-6 h-6 bg-white/20 rounded-full flex items-center justify-center text-sm">4</span>
              <span>Toestemming aanvragen bij Exact</span>
            </li>
            <li class="flex items-start gap-3">
              <span class="flex-shrink-0 w-6 h-6 bg-white/20 rounded-full flex items-center justify-center text-sm">5</span>
              <span>Demo geven aan partnermanager</span>
            </li>
            <li class="flex items-start gap-3">
              <span class="flex-shrink-0 w-6 h-6 bg-white/20 rounded-full flex items-center justify-center text-sm">6</span>
              <span>Na goedkeuring: App live in App Store</span>
            </li>
          </ol>

          <div class="mt-6 flex flex-wrap gap-3">
            <a
              href="https://apps.exactonline.com/"
              target="_blank"
              class="px-4 py-2 bg-white text-exact-blue font-medium rounded-lg hover:bg-gray-100 transition-colors"
            >
              Open App Centre ‚Üí
            </a>
            <a
              href="https://support.exactonline.com/community/s/article/All-All-DNO-Process-appcenter-eol-appcenter-dev-registerapp-p"
              target="_blank"
              class="px-4 py-2 border border-white/30 text-white font-medium rounded-lg hover:bg-white/10 transition-colors"
            >
              Exact Documentatie ‚Üí
            </a>
            <a
              href="https://github.com/werkenmetai/Exact-online-MCP/tree/main/docs/exact-app-store"
              target="_blank"
              class="px-4 py-2 border border-white/30 text-white font-medium rounded-lg hover:bg-white/10 transition-colors"
            >
              Alle Documenten ‚Üí
            </a>
          </div>
        </div>
      </>
    )}
  </div>

  <script>
    // Toggle security section
    const toggle = document.getElementById('securityToggle');
    const content = document.getElementById('securityContent');
    const arrow = document.getElementById('securityArrow');

    toggle?.addEventListener('click', () => {
      content?.classList.toggle('hidden');
      arrow?.classList.toggle('rotate-180');
    });
  </script>
</Layout>
