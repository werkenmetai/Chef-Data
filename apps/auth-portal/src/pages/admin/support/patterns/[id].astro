---
import Layout from '../../../../layouts/Layout.astro';
import { Database, type SupportPattern } from '../../../../lib/database';
// AdminAppLauncher now in Layout.astro header

const env = Astro.locals.runtime?.env;
const { id } = Astro.params;

let db: Database | null = null;
let isAdmin = false;
let pattern: SupportPattern | null = null;
let success: string | null = null;
let error: string | null = null;
let deleted = false;
let testResult: { matched: boolean; confidence: number } | null = null;

try {
  if (env?.DB && id) {
    db = new Database(env.DB, env.TOKEN_ENCRYPTION_KEY);

    const sessionId = Astro.cookies.get('session_id')?.value;
    if (sessionId) {
      const session = await db.validateSession(sessionId);
      if (session) {
        const adminEmails = (env.ADMIN_EMAILS || '')
          .split(',')
          .map((e: string) => e.trim().toLowerCase())
          .filter((e: string) => e.length > 0);

        isAdmin = adminEmails.includes(session.user.email.toLowerCase());

        if (isAdmin) {
          pattern = await db.get<SupportPattern>(
            'SELECT * FROM support_patterns WHERE id = ?',
            [id]
          );

          if (pattern && Astro.request.method === 'POST') {
            const formData = await Astro.request.formData();
            const action = formData.get('action');

            if (action === 'delete') {
              await db.deletePattern(id);
              deleted = true;
            } else if (action === 'test') {
              const testMessage = formData.get('test_message')?.toString() || '';
              if (testMessage && pattern) {
                // Simple test matching
                const keywords = pattern.trigger_keywords.split(',').map(k => k.trim().toLowerCase());
                const messageLower = testMessage.toLowerCase();
                const matchedKeywords = keywords.filter(k => messageLower.includes(k));
                const confidence = matchedKeywords.length / keywords.length;

                testResult = {
                  matched: confidence >= pattern.min_confidence,
                  confidence,
                };
              }
            } else if (action === 'update') {
              const name = formData.get('name')?.toString() || '';
              const trigger_keywords = formData.get('trigger_keywords')?.toString() || '';
              const trigger_regex = formData.get('trigger_regex')?.toString() || '';
              const error_codes = formData.get('error_codes')?.toString() || '';
              const category = formData.get('category')?.toString() || 'other';
              const response_template_nl = formData.get('response_template_nl')?.toString() || '';
              const response_template_en = formData.get('response_template_en')?.toString() || '';
              const solution_steps = formData.get('solution_steps')?.toString() || '';
              const related_articles = formData.get('related_articles')?.toString() || '';
              const min_confidence = parseFloat(formData.get('min_confidence')?.toString() || '0.7');
              const active = formData.get('active') === 'on';

              if (!name || !trigger_keywords || !response_template_nl) {
                error = 'Naam, trigger keywords en response template (NL) zijn verplicht';
              } else {
                await db.updatePattern(id, {
                  name,
                  trigger_keywords,
                  trigger_regex: trigger_regex || null,
                  error_codes: error_codes || null,
                  category,
                  response_template_nl,
                  response_template_en: response_template_en || null,
                  solution_steps: solution_steps || null,
                  related_articles: related_articles || null,
                  min_confidence,
                  active,
                });

                success = 'Pattern bijgewerkt';
                pattern = await db.get<SupportPattern>(
                  'SELECT * FROM support_patterns WHERE id = ?',
                  [id]
                );
              }
            }
          }
        }
      }
    }
  }
} catch (e) {
  console.error('Admin edit pattern error:', e);
  error = 'Er is een fout opgetreden';
}

if (deleted) {
  return Astro.redirect('/admin/support/patterns');
}

const categoryOptions = [
  { value: 'connection', label: 'Verbinding' },
  { value: 'billing', label: 'Facturatie' },
  { value: 'bug', label: 'Technisch' },
  { value: 'feature', label: 'Features' },
  { value: 'account', label: 'Account' },
  { value: 'other', label: 'Overig' },
];

function calculateEffectiveness(p: SupportPattern): number {
  const total = p.times_triggered;
  if (total === 0) return 0;
  return Math.round((p.times_resolved / total) * 100);
}
---

<Layout title={pattern ? `Bewerk: ${pattern.name}` : 'Pattern niet gevonden'}>
  <div class="max-w-4xl mx-auto px-4 py-8">
    {!isAdmin ? (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <h1 class="text-2xl font-bold text-red-900 mb-4">Toegang Geweigerd</h1>
        <p class="text-red-700">Je hebt geen toegang tot deze pagina.</p>
        <a href="/dashboard" class="inline-block mt-4 text-red-600 hover:underline">
          ← Terug naar Dashboard
        </a>
      </div>
    ) : !pattern ? (
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center">
        <h1 class="text-2xl font-bold text-gray-900 mb-4">Pattern niet gevonden</h1>
        <p class="text-gray-600 mb-6">Dit pattern bestaat niet of is verwijderd.</p>
        <a
          href="/admin/support/patterns"
          class="inline-block px-6 py-3 bg-exact-blue text-white font-semibold rounded-lg hover:bg-exact-dark transition-colors"
        >
          Terug naar overzicht
        </a>
      </div>
    ) : (
      <>
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Pattern Bewerken</h1>
            <p class="text-gray-500 font-mono text-sm">ID: {pattern.id}</p>
          </div>
          <div class="flex items-center gap-3">
            <a href="/admin/support/patterns" class="text-gray-600 hover:text-gray-900">
              ← Terug naar overzicht
            </a>
          </div>
        </div>

        {error && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-700">{error}</p>
          </div>
        )}

        {success && (
          <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-green-700">{success}</p>
          </div>
        )}

        <!-- Stats Bar -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
          <div class="flex items-center gap-8 text-sm">
            <div>
              <span class="text-gray-500">Triggers:</span>
              <span class="font-medium text-gray-900 ml-1">{pattern.times_triggered}</span>
            </div>
            <div>
              <span class="text-gray-500">Opgelost:</span>
              <span class="font-medium text-green-600 ml-1">{pattern.times_resolved}</span>
            </div>
            <div>
              <span class="text-gray-500">Escalaties:</span>
              <span class="font-medium text-orange-600 ml-1">{pattern.times_escalated}</span>
            </div>
            <div>
              <span class="text-gray-500">Effectiviteit:</span>
              <span class={`font-medium ml-1 ${
                calculateEffectiveness(pattern) >= 70 ? 'text-green-600' :
                calculateEffectiveness(pattern) >= 40 ? 'text-yellow-600' :
                'text-red-600'
              }`}>
                {calculateEffectiveness(pattern)}%
              </span>
            </div>
            <div class="flex-1"></div>
            <div>
              <span class="text-gray-500">Aangemaakt:</span>
              <span class="text-gray-700 ml-1">{new Date(pattern.created_at).toLocaleDateString('nl-NL')}</span>
            </div>
          </div>
        </div>

        <!-- Test Pattern -->
        <div class="bg-purple-50 border border-purple-200 rounded-xl p-6 mb-6">
          <h3 class="font-semibold text-purple-900 mb-3">Test Pattern</h3>
          <form method="POST" class="flex gap-4">
            <input type="hidden" name="action" value="test" />
            <input
              type="text"
              name="test_message"
              placeholder="Typ een testbericht..."
              class="flex-1 px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent focus:outline-none bg-white"
            />
            <button
              type="submit"
              class="px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-colors"
            >
              Test
            </button>
          </form>
          {testResult && (
            <div class={`mt-3 p-3 rounded-lg ${testResult.matched ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
              {testResult.matched ? (
                <p>Match! Confidence: {Math.round(testResult.confidence * 100)}%</p>
              ) : (
                <p>Geen match. Confidence: {Math.round(testResult.confidence * 100)}% (minimum: {Math.round(pattern.min_confidence * 100)}%)</p>
              )}
            </div>
          )}
        </div>

        <form method="POST" class="space-y-6">
          <input type="hidden" name="action" value="update" />

          <!-- Basic Info -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Basis Informatie</h2>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                  Naam <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  name="name"
                  id="name"
                  required
                  value={pattern.name}
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                />
              </div>

              <div>
                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">
                  Categorie <span class="text-red-500">*</span>
                </label>
                <select
                  name="category"
                  id="category"
                  required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                >
                  {categoryOptions.map(opt => (
                    <option value={opt.value} selected={pattern.category === opt.value}>
                      {opt.label}
                    </option>
                  ))}
                </select>
              </div>
            </div>
          </div>

          <!-- Trigger Settings -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Trigger Instellingen</h2>

            <div class="space-y-4">
              <div>
                <label for="trigger_keywords" class="block text-sm font-medium text-gray-700 mb-1">
                  Trigger Keywords <span class="text-red-500">*</span>
                </label>
                <textarea
                  name="trigger_keywords"
                  id="trigger_keywords"
                  rows="2"
                  required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                >{pattern.trigger_keywords}</textarea>
              </div>

              <div>
                <label for="trigger_regex" class="block text-sm font-medium text-gray-700 mb-1">
                  Trigger Regex
                </label>
                <input
                  type="text"
                  name="trigger_regex"
                  id="trigger_regex"
                  value={pattern.trigger_regex || ''}
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none font-mono text-sm"
                />
              </div>

              <div>
                <label for="error_codes" class="block text-sm font-medium text-gray-700 mb-1">
                  Error Codes
                </label>
                <input
                  type="text"
                  name="error_codes"
                  id="error_codes"
                  value={pattern.error_codes || ''}
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none font-mono text-sm"
                />
              </div>

              <div>
                <label for="min_confidence" class="block text-sm font-medium text-gray-700 mb-1">
                  Minimum Confidence
                </label>
                <div class="flex items-center gap-4">
                  <input
                    type="range"
                    name="min_confidence"
                    id="min_confidence"
                    min="0.5"
                    max="1"
                    step="0.05"
                    value={pattern.min_confidence}
                    class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                  />
                  <span id="confidenceValue" class="text-lg font-medium text-gray-900 w-16 text-right">
                    {Math.round(pattern.min_confidence * 100)}%
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Response Template -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Response Template</h2>

            <div class="space-y-4">
              <div>
                <label for="response_template_nl" class="block text-sm font-medium text-gray-700 mb-1">
                  Response (NL) <span class="text-red-500">*</span>
                </label>
                <textarea
                  name="response_template_nl"
                  id="response_template_nl"
                  rows="6"
                  required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                >{pattern.response_template_nl}</textarea>
              </div>

              <div>
                <label for="response_template_en" class="block text-sm font-medium text-gray-700 mb-1">
                  Response (EN)
                </label>
                <textarea
                  name="response_template_en"
                  id="response_template_en"
                  rows="6"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                >{pattern.response_template_en || ''}</textarea>
              </div>
            </div>
          </div>

          <!-- Solution Info -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Aanvullende Informatie</h2>

            <div class="space-y-4">
              <div>
                <label for="solution_steps" class="block text-sm font-medium text-gray-700 mb-1">
                  Oplossings Stappen (JSON)
                </label>
                <textarea
                  name="solution_steps"
                  id="solution_steps"
                  rows="4"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none font-mono text-sm"
                >{pattern.solution_steps || ''}</textarea>
              </div>

              <div>
                <label for="related_articles" class="block text-sm font-medium text-gray-700 mb-1">
                  Gerelateerde Artikel Slugs
                </label>
                <input
                  type="text"
                  name="related_articles"
                  id="related_articles"
                  value={pattern.related_articles || ''}
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-exact-blue focus:border-transparent focus:outline-none"
                />
              </div>
            </div>
          </div>

          <!-- Options -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Status</h2>

            <label class="flex items-center gap-3">
              <input
                type="checkbox"
                name="active"
                checked={pattern.active}
                class="w-5 h-5 text-green-500 border-gray-300 rounded focus:ring-green-500"
              />
              <div>
                <span class="font-medium text-gray-900">Actief</span>
                <p class="text-sm text-gray-500">Pattern wordt gebruikt door de AI</p>
              </div>
            </label>
          </div>

          <!-- Submit -->
          <div class="flex justify-between">
            <button
              type="button"
              onclick="document.getElementById('deleteModal').classList.remove('hidden')"
              class="px-4 py-2 text-red-600 hover:text-red-800 font-medium"
            >
              Verwijderen
            </button>
            <div class="flex gap-4">
              <a
                href="/admin/support/patterns"
                class="px-6 py-3 text-gray-600 font-medium hover:text-gray-900"
              >
                Annuleren
              </a>
              <button
                type="submit"
                class="px-6 py-3 bg-exact-blue text-white font-semibold rounded-lg hover:bg-exact-dark transition-colors"
              >
                Opslaan
              </button>
            </div>
          </div>
        </form>

        <!-- Delete Modal -->
        <div id="deleteModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
          <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" onclick="document.getElementById('deleteModal').classList.add('hidden')"></div>
            <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Pattern verwijderen?</h3>
              <p class="text-gray-600 mb-6">
                Weet je zeker dat je "{pattern.name}" wilt verwijderen? Deze actie kan niet ongedaan worden gemaakt.
              </p>
              <div class="flex justify-end gap-4">
                <button
                  type="button"
                  onclick="document.getElementById('deleteModal').classList.add('hidden')"
                  class="px-4 py-2 text-gray-600 hover:text-gray-900"
                >
                  Annuleren
                </button>
                <form method="POST">
                  <input type="hidden" name="action" value="delete" />
                  <button
                    type="submit"
                    class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-colors"
                  >
                    Verwijderen
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </>
    )}
  </div>

  <script>
    const slider = document.getElementById('min_confidence') as HTMLInputElement;
    const display = document.getElementById('confidenceValue');

    slider?.addEventListener('input', () => {
      if (display) {
        display.textContent = `${Math.round(parseFloat(slider.value) * 100)}%`;
      }
    });
  </script>
</Layout>
