---
/**
 * Feedback Widget Component
 *
 * Shows strategic feedback prompts at key milestone moments.
 *
 * Triggers based on FEEDBACK-LOOP-STRATEGY.md:
 * - After 10 queries: NPS score (0-10)
 * - After 50 queries: "Wat missen we?" open veld
 * - At 80% limit: "Niet upgraden? Vertel waarom"
 * - After 30 days active: Quote request with permission checkboxes
 */

interface Props {
  userId?: string;
  queryCount?: number;
  planLimit?: number;
  firstQueryAt?: string;
  milestoneShown?: {
    milestone_10: boolean;
    milestone_50: boolean;
    milestone_80pct: boolean;
    milestone_30d: boolean;
  };
}

const {
  userId,
  queryCount = 0,
  planLimit = 200,
  firstQueryAt,
  milestoneShown = {
    milestone_10: false,
    milestone_50: false,
    milestone_80pct: false,
    milestone_30d: false,
  }
} = Astro.props;

// Calculate which trigger should be active
type TriggerType = 'milestone_10' | 'milestone_50' | 'upgrade_prompt_80pct' | 'retention_30d' | null;
let activeTrigger: TriggerType = null;

// Check 80% limit first (highest priority when near limit)
const usagePercent = (queryCount / planLimit) * 100;
if (usagePercent >= 80 && usagePercent < 100 && !milestoneShown.milestone_80pct) {
  activeTrigger = 'upgrade_prompt_80pct';
}
// Check 30 day retention
else if (firstQueryAt) {
  const firstQuery = new Date(firstQueryAt);
  const daysSinceFirst = (Date.now() - firstQuery.getTime()) / (1000 * 60 * 60 * 24);
  if (daysSinceFirst >= 30 && !milestoneShown.milestone_30d) {
    activeTrigger = 'retention_30d';
  }
}
// Check 50 queries milestone
if (!activeTrigger && queryCount >= 50 && !milestoneShown.milestone_50) {
  activeTrigger = 'milestone_50';
}
// Check 10 queries milestone
else if (!activeTrigger && queryCount >= 10 && !milestoneShown.milestone_10) {
  activeTrigger = 'milestone_10';
}

const shouldShowWidget = activeTrigger !== null;
---

<!-- Feedback Widget Container - hidden by default, shown via JS -->
<div id="feedback-widget" class="hidden fixed bottom-4 right-4 z-40 max-w-sm" role="dialog" aria-labelledby="feedback-title" aria-describedby="feedback-desc" data-trigger={activeTrigger}>

  {/* ========================== */}
  {/* MILESTONE 10: NPS Score    */}
  {/* ========================== */}
  <div id="feedback-nps" class={`${activeTrigger !== 'milestone_10' ? 'hidden' : ''} bg-white rounded-xl shadow-xl border border-gray-200 p-5 animate-slide-up`}>
    <button
      type="button"
      id="feedback-close-nps"
      class="feedback-close-btn absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition-colors"
      aria-label="Sluiten"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <h3 id="feedback-title" class="text-lg font-semibold text-gray-900 mb-2 pr-6">
      Je hebt al 10 vragen gesteld!
    </h3>
    <p id="feedback-desc" class="text-sm text-gray-600 mb-4">
      Hoe waarschijnlijk is het dat je ons aanbeveelt?
    </p>

    <form id="feedback-nps-form" class="space-y-4">
      <input type="hidden" name="trigger_type" value="milestone_10" />

      <!-- NPS Score 0-10 -->
      <div class="flex justify-between gap-1">
        {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map((score) => (
          <button
            type="button"
            class={`nps-btn w-8 h-8 text-sm font-medium rounded-lg border-2 transition-all hover:scale-110 ${
              score <= 6 ? 'border-red-200 hover:border-red-400 hover:bg-red-50' :
              score <= 8 ? 'border-yellow-200 hover:border-yellow-400 hover:bg-yellow-50' :
              'border-green-200 hover:border-green-400 hover:bg-green-50'
            }`}
            data-score={score}
          >
            {score}
          </button>
        ))}
      </div>
      <div class="flex justify-between text-xs text-gray-500">
        <span>Zeer onwaarschijnlijk</span>
        <span>Zeer waarschijnlijk</span>
      </div>

      <input type="hidden" name="nps_score" id="nps-score-input" value="" />

      <div class="flex justify-between items-center text-xs pt-2 border-t border-gray-100">
        <button
          type="button"
          class="feedback-later-btn text-gray-500 hover:text-gray-700 transition-colors"
        >
          Later herinneren
        </button>
        <button
          type="button"
          class="feedback-never-btn text-gray-400 hover:text-gray-600 transition-colors"
        >
          Nooit meer tonen
        </button>
      </div>
    </form>
  </div>

  {/* ========================== */}
  {/* MILESTONE 50: Power User   */}
  {/* ========================== */}
  <div id="feedback-poweruser" class={`${activeTrigger !== 'milestone_50' ? 'hidden' : ''} bg-white rounded-xl shadow-xl border border-purple-200 p-5 animate-slide-up`}>
    <button
      type="button"
      class="feedback-close-btn absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition-colors"
      aria-label="Sluiten"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <div class="flex items-center gap-2 mb-2">
      <span class="text-2xl">ðŸš€</span>
      <h3 class="text-lg font-semibold text-purple-900">
        Wauw, je bent een power user!
      </h3>
    </div>
    <p class="text-sm text-purple-700 mb-4">
      Al {queryCount} vragen gesteld. Wat zouden we kunnen toevoegen of verbeteren?
    </p>

    <form id="feedback-poweruser-form" class="space-y-4">
      <input type="hidden" name="trigger_type" value="milestone_50" />

      <textarea
        name="feedback_text"
        rows="3"
        class="w-full px-3 py-2 border border-purple-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent focus:outline-none resize-none"
        placeholder="Bijv: 'Het zou fijn zijn als...' of 'Ik mis de mogelijkheid om...'"
      ></textarea>

      <button
        type="submit"
        class="w-full px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-colors text-sm"
      >
        Versturen
      </button>

      <div class="flex justify-between items-center text-xs">
        <button
          type="button"
          class="feedback-later-btn text-purple-500 hover:text-purple-700 transition-colors"
        >
          Later
        </button>
        <button
          type="button"
          class="feedback-skip-btn text-purple-400 hover:text-purple-600 transition-colors"
        >
          Overslaan
        </button>
      </div>
    </form>
  </div>

  {/* ========================== */}
  {/* 80% LIMIT: Churn Feedback  */}
  {/* ========================== */}
  <div id="feedback-upgrade" class={`${activeTrigger !== 'upgrade_prompt_80pct' ? 'hidden' : ''} bg-white rounded-xl shadow-xl border border-amber-200 p-5 animate-slide-up`}>
    <button
      type="button"
      class="feedback-close-btn absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition-colors"
      aria-label="Sluiten"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <div class="flex items-center gap-2 mb-2">
      <span class="text-2xl">âš¡</span>
      <h3 class="text-lg font-semibold text-amber-900">
        Je hebt al {Math.round(usagePercent)}% gebruikt
      </h3>
    </div>
    <p class="text-sm text-amber-700 mb-4">
      Je zit bijna aan je limiet. Niet upgraden? We horen graag waarom.
    </p>

    <form id="feedback-upgrade-form" class="space-y-4">
      <input type="hidden" name="trigger_type" value="upgrade_prompt_80pct" />

      <div class="space-y-2">
        <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-amber-50 transition-colors">
          <input type="radio" name="churn_reason" value="too_expensive" class="text-amber-600 focus:ring-amber-500" />
          <span class="text-sm text-gray-700">Te duur</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-amber-50 transition-colors">
          <input type="radio" name="churn_reason" value="not_needed" class="text-amber-600 focus:ring-amber-500" />
          <span class="text-sm text-gray-700">Heb niet meer nodig dan gratis tier</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-amber-50 transition-colors">
          <input type="radio" name="churn_reason" value="missing_features" class="text-amber-600 focus:ring-amber-500" />
          <span class="text-sm text-gray-700">Mist functionaliteit die ik nodig heb</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-amber-50 transition-colors">
          <input type="radio" name="churn_reason" value="trying_alternative" class="text-amber-600 focus:ring-amber-500" />
          <span class="text-sm text-gray-700">Probeer een alternatief</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-amber-50 transition-colors">
          <input type="radio" name="churn_reason" value="other" class="text-amber-600 focus:ring-amber-500" />
          <span class="text-sm text-gray-700">Anders</span>
        </label>
      </div>

      <textarea
        name="feedback_text"
        rows="2"
        class="w-full px-3 py-2 border border-amber-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500 focus:border-transparent focus:outline-none resize-none"
        placeholder="Optioneel: vertel meer..."
      ></textarea>

      <div class="flex gap-2">
        <a
          href="/pricing"
          class="flex-1 px-4 py-2 bg-amber-600 text-white font-medium rounded-lg hover:bg-amber-700 transition-colors text-sm text-center"
        >
          Bekijk plannen
        </a>
        <button
          type="submit"
          class="flex-1 px-4 py-2 border border-amber-300 text-amber-700 font-medium rounded-lg hover:bg-amber-50 transition-colors text-sm"
        >
          Verstuur feedback
        </button>
      </div>
    </form>
  </div>

  {/* ========================== */}
  {/* 30 DAYS: Quote Request     */}
  {/* ========================== */}
  <div id="feedback-quote" class={`${activeTrigger !== 'retention_30d' ? 'hidden' : ''} bg-white rounded-xl shadow-xl border border-green-200 p-5 animate-slide-up`}>
    <button
      type="button"
      class="feedback-close-btn absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition-colors"
      aria-label="Sluiten"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <div class="flex items-center gap-2 mb-2">
      <span class="text-2xl">ðŸŽ‰</span>
      <h3 class="text-lg font-semibold text-green-900">
        Je gebruikt ons nu een maand!
      </h3>
    </div>
    <p class="text-sm text-green-700 mb-4">
      Zou je in 1-2 zinnen willen delen wat je ervan vindt?
      We gebruiken dit mogelijk op onze website (met je toestemming).
    </p>

    <form id="feedback-quote-form" class="space-y-4">
      <input type="hidden" name="trigger_type" value="retention_30d" />

      <textarea
        name="testimonial_quote"
        rows="3"
        class="w-full px-3 py-2 border border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent focus:outline-none resize-none"
        placeholder="Bijv: 'Eindelijk snel antwoord op mijn boekhoudvragen. Bespaart me uren per week!'"
      ></textarea>

      <div class="space-y-2">
        <label class="flex items-start gap-2 cursor-pointer">
          <input
            type="checkbox"
            name="permission_website"
            value="1"
            class="mt-1 rounded border-green-300 text-green-600 focus:ring-green-500"
          />
          <span class="text-xs text-green-700">
            Mag gedeeld worden op onze website
          </span>
        </label>
        <label class="flex items-start gap-2 cursor-pointer">
          <input
            type="checkbox"
            name="permission_linkedin"
            value="1"
            class="mt-1 rounded border-green-300 text-green-600 focus:ring-green-500"
          />
          <span class="text-xs text-green-700">
            Mag gedeeld worden op LinkedIn
          </span>
        </label>
        <label class="flex items-start gap-2 cursor-pointer">
          <input
            type="checkbox"
            name="permission_internal"
            value="1"
            class="mt-1 rounded border-green-300 text-green-600 focus:ring-green-500"
            checked
          />
          <span class="text-xs text-green-700">
            Alleen intern gebruiken
          </span>
        </label>
      </div>

      <div class="flex gap-2">
        <input
          type="text"
          name="display_name"
          placeholder="Je naam (optioneel)"
          class="flex-1 px-3 py-2 border border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent focus:outline-none"
        />
        <input
          type="text"
          name="user_title"
          placeholder="Functie (bijv. ZZP'er)"
          class="flex-1 px-3 py-2 border border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent focus:outline-none"
        />
      </div>

      <button
        type="submit"
        class="w-full px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors text-sm"
      >
        Versturen
      </button>

      <div class="flex justify-between items-center text-xs">
        <button
          type="button"
          class="feedback-later-btn text-green-500 hover:text-green-700 transition-colors"
        >
          Later
        </button>
        <button
          type="button"
          class="feedback-skip-btn text-green-400 hover:text-green-600 transition-colors"
        >
          Overslaan
        </button>
      </div>
    </form>
  </div>

  {/* ========================== */}
  {/* NPS Follow-up (Promoter)   */}
  {/* ========================== */}
  <div id="feedback-nps-followup" class="hidden bg-white rounded-xl shadow-xl border border-green-200 p-5 animate-slide-up">
    <h3 class="text-lg font-semibold text-green-900 mb-2 text-center">
      Fijn om te horen! ðŸŽ‰
    </h3>
    <p class="text-sm text-green-700 mb-4 text-center">
      Wil je in 1 zin vertellen wat je het beste vindt?
    </p>

    <form id="feedback-nps-followup-form" class="space-y-4">
      <textarea
        name="testimonial_quote"
        rows="2"
        class="w-full px-3 py-2 border border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent focus:outline-none resize-none"
        placeholder="Bijv: 'Bespaart me uren per week!'"
      ></textarea>

      <label class="flex items-start gap-2 cursor-pointer">
        <input
          type="checkbox"
          name="permission_website"
          value="1"
          class="mt-1 rounded border-green-300 text-green-600 focus:ring-green-500"
        />
        <span class="text-xs text-green-700">
          Mag gedeeld worden op onze website
        </span>
      </label>

      <button
        type="submit"
        class="w-full px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors text-sm"
      >
        Versturen
      </button>

      <button
        type="button"
        class="feedback-skip-btn w-full text-sm text-green-600 hover:text-green-800 transition-colors"
      >
        Overslaan
      </button>
    </form>
  </div>

  {/* ========================== */}
  {/* NPS Follow-up (Detractor)  */}
  {/* ========================== */}
  <div id="feedback-nps-detractor" class="hidden bg-white rounded-xl shadow-xl border border-red-200 p-5 animate-slide-up">
    <h3 class="text-lg font-semibold text-gray-900 mb-2 text-center">
      Wat kunnen we verbeteren?
    </h3>
    <p class="text-sm text-gray-600 mb-4 text-center">
      We gebruiken je feedback om beter te worden.
    </p>

    <form id="feedback-nps-detractor-form" class="space-y-4">
      <div class="space-y-2">
        <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-gray-50 transition-colors">
          <input type="radio" name="improvement_category" value="setup" class="text-red-600 focus:ring-red-500" />
          <span class="text-sm text-gray-700">Moeilijk in te stellen</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-gray-50 transition-colors">
          <input type="radio" name="improvement_category" value="accuracy" class="text-red-600 focus:ring-red-500" />
          <span class="text-sm text-gray-700">Antwoorden niet accuraat</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-gray-50 transition-colors">
          <input type="radio" name="improvement_category" value="features" class="text-red-600 focus:ring-red-500" />
          <span class="text-sm text-gray-700">Mist functionaliteit</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-gray-50 transition-colors">
          <input type="radio" name="improvement_category" value="speed" class="text-red-600 focus:ring-red-500" />
          <span class="text-sm text-gray-700">Te langzaam</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-gray-50 transition-colors">
          <input type="radio" name="improvement_category" value="other" class="text-red-600 focus:ring-red-500" />
          <span class="text-sm text-gray-700">Anders</span>
        </label>
      </div>

      <textarea
        name="feedback_text"
        rows="2"
        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-red-500 focus:border-transparent focus:outline-none resize-none"
        placeholder="Optioneel: vertel meer..."
      ></textarea>

      <button
        type="submit"
        class="w-full px-4 py-2 bg-exact-blue text-white font-medium rounded-lg hover:bg-exact-dark transition-colors text-sm"
      >
        Versturen
      </button>
    </form>
  </div>

  {/* ========================== */}
  {/* Thank You State            */}
  {/* ========================== */}
  <div id="feedback-thanks" class="hidden bg-white rounded-xl shadow-xl border border-green-200 p-5 animate-slide-up text-center">
    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
      <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
    </div>
    <h3 class="text-lg font-semibold text-gray-900 mb-1">Bedankt!</h3>
    <p class="text-sm text-gray-600 mb-3">Je feedback helpt ons verbeteren.</p>
    <button
      type="button"
      id="feedback-thanks-close"
      class="text-sm text-exact-blue hover:underline"
    >
      Sluiten
    </button>
  </div>
</div>

<style>
  @keyframes slide-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-slide-up {
    animation: slide-up 0.3s ease-out;
  }

  #feedback-widget > div {
    position: relative;
  }

  .nps-btn.selected {
    transform: scale(1.1);
  }
  .nps-btn.selected[data-score="0"],
  .nps-btn.selected[data-score="1"],
  .nps-btn.selected[data-score="2"],
  .nps-btn.selected[data-score="3"],
  .nps-btn.selected[data-score="4"],
  .nps-btn.selected[data-score="5"],
  .nps-btn.selected[data-score="6"] {
    background-color: #fee2e2;
    border-color: #ef4444;
  }
  .nps-btn.selected[data-score="7"],
  .nps-btn.selected[data-score="8"] {
    background-color: #fef3c7;
    border-color: #f59e0b;
  }
  .nps-btn.selected[data-score="9"],
  .nps-btn.selected[data-score="10"] {
    background-color: #dcfce7;
    border-color: #22c55e;
  }
</style>

<script define:vars={{ userId, shouldShowWidget, activeTrigger }}>
  // Feedback Widget Logic
  (function() {
    const STORAGE_KEY = 'feedback_widget_state';
    const LATER_DELAY = 7 * 24 * 60 * 60 * 1000; // 7 days

    let currentNpsScore = null;

    // Get stored state
    function getState() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        return stored ? JSON.parse(stored) : {};
      } catch {
        return {};
      }
    }

    // Save state
    function saveState(state) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch {
        // Ignore storage errors
      }
    }

    // Check if widget should be shown
    function shouldShow() {
      if (!shouldShowWidget) return false;

      const state = getState();

      // Never show again
      if (state.optedOut) return false;

      // Show later
      if (state.laterUntil && Date.now() < state.laterUntil) return false;

      // Check if this trigger was already shown (stored locally)
      if (activeTrigger && state[`${activeTrigger}_shown`]) return false;

      return true;
    }

    // Show widget
    function showWidget() {
      const widget = document.getElementById('feedback-widget');
      if (widget) {
        widget.classList.remove('hidden');
      }
    }

    // Hide widget
    function hideWidget() {
      const widget = document.getElementById('feedback-widget');
      if (widget) {
        widget.classList.add('hidden');
      }
    }

    // Show specific step
    function showStep(stepId) {
      const steps = [
        'feedback-nps', 'feedback-poweruser', 'feedback-upgrade', 'feedback-quote',
        'feedback-nps-followup', 'feedback-nps-detractor', 'feedback-thanks'
      ];
      steps.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.toggle('hidden', id !== stepId);
        }
      });
    }

    // Submit feedback to API
    async function submitFeedback(data) {
      try {
        const response = await fetch('/api/feedback/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: data.type || 'widget',
            ...data
          })
        });

        if (response.ok) {
          const state = getState();
          state.lastSubmitted = Date.now();
          // Mark this trigger as shown
          if (activeTrigger) {
            state[`${activeTrigger}_shown`] = true;
          }
          saveState(state);

          // Also notify server that milestone was shown
          if (activeTrigger) {
            fetch('/api/feedback/mark-milestone', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ milestone: activeTrigger })
            }).catch(() => {});
          }

          showStep('feedback-thanks');

          // Auto-close after 3 seconds
          setTimeout(() => {
            hideWidget();
          }, 3000);

          return await response.json();
        }
      } catch (error) {
        console.error('Failed to submit feedback:', error);
      }
      return null;
    }

    // Mark milestone as shown (without submitting feedback)
    async function markMilestoneShown() {
      if (activeTrigger) {
        const state = getState();
        state[`${activeTrigger}_shown`] = true;
        saveState(state);

        fetch('/api/feedback/mark-milestone', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ milestone: activeTrigger })
        }).catch(() => {});
      }
    }

    // Initialize
    function init() {
      if (!shouldShow()) return;

      // Delay showing widget by 2 seconds after page load
      setTimeout(() => {
        showWidget();
      }, 2000);

      // Close buttons
      document.querySelectorAll('.feedback-close-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          markMilestoneShown();
          hideWidget();
        });
      });
      document.getElementById('feedback-thanks-close')?.addEventListener('click', hideWidget);

      // Later buttons
      document.querySelectorAll('.feedback-later-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const state = getState();
          state.laterUntil = Date.now() + LATER_DELAY;
          saveState(state);
          hideWidget();
        });
      });

      // Never buttons
      document.querySelectorAll('.feedback-never-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const state = getState();
          state.optedOut = true;
          saveState(state);
          hideWidget();

          // Also update server-side preference
          fetch('/api/feedback/opt-out', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ opt_out: true })
          }).catch(() => {});
        });
      });

      // Skip buttons
      document.querySelectorAll('.feedback-skip-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          markMilestoneShown();
          showStep('feedback-thanks');
          setTimeout(hideWidget, 2000);
        });
      });

      // NPS Score buttons
      document.querySelectorAll('.nps-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const score = parseInt(btn.getAttribute('data-score') || '0');
          currentNpsScore = score;

          // Update UI
          document.querySelectorAll('.nps-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          document.getElementById('nps-score-input').value = score;

          // Submit and show follow-up based on score
          submitFeedback({
            type: 'nps',
            trigger_event: 'milestone_10',
            nps_score: score
          }).then(() => {
            // Show follow-up based on score
            if (score >= 9) {
              showStep('feedback-nps-followup');
            } else if (score <= 6) {
              showStep('feedback-nps-detractor');
            } else {
              showStep('feedback-thanks');
              setTimeout(hideWidget, 3000);
            }
          });
        });
      });

      // Power user form (milestone 50)
      document.getElementById('feedback-poweruser-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        submitFeedback({
          type: 'widget',
          trigger_event: 'milestone_50',
          feedback_text: formData.get('feedback_text')
        });
      });

      // Upgrade/churn form (80% limit)
      document.getElementById('feedback-upgrade-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        submitFeedback({
          type: 'churn',
          trigger_event: 'upgrade_prompt_80pct',
          improvement_category: formData.get('churn_reason'),
          feedback_text: formData.get('feedback_text')
        });
      });

      // Quote form (30 days)
      document.getElementById('feedback-quote-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        submitFeedback({
          type: 'testimonial',
          trigger_event: 'retention_30d',
          testimonial_quote: formData.get('testimonial_quote'),
          testimonial_display_name: formData.get('display_name'),
          testimonial_role: formData.get('user_title'),
          permission_website: formData.get('permission_website') === '1',
          permission_marketing: formData.get('permission_linkedin') === '1'
        });
      });

      // NPS follow-up form (promoters)
      document.getElementById('feedback-nps-followup-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        submitFeedback({
          type: 'testimonial',
          trigger_event: 'milestone_10_followup',
          nps_score: currentNpsScore,
          testimonial_quote: formData.get('testimonial_quote'),
          permission_website: formData.get('permission_website') === '1'
        });
      });

      // NPS detractor form
      document.getElementById('feedback-nps-detractor-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        submitFeedback({
          type: 'widget',
          trigger_event: 'milestone_10_followup',
          nps_score: currentNpsScore,
          improvement_category: formData.get('improvement_category'),
          feedback_text: formData.get('feedback_text')
        });
      });
    }

    // Run on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
